# =============================================================================
# Claude Code Tool Permissions Configuration
# =============================================================================
#
# This file controls which tool calls Claude Code can execute automatically,
# which require user approval, and which are blocked entirely.
#
# Location: .claude/hooks/tool_permissions.yaml
#
# =============================================================================
# IMPORTANT: RULE ORDERING MATTERS!
# =============================================================================
# Rules are processed IN ORDER, and the FIRST MATCHING RULE WINS.
# Order: DENY rules first → Specific ALLOW rules → General ALLOW → ASK rules last
#
# =============================================================================
# CATEGORIES
# =============================================================================
# read: Only reads data | write: Modifies data | other: Everything else
#
# =============================================================================
# LOGGING CONFIGURATION
# =============================================================================

logging:
  enabled: true
  log_file: "~/inavflight/.claude/hooks/tool_permissions.log"  # Project-local log file
  log_inputs: true     # Log incoming hook JSON
  log_outputs: true    # Log hook decisions
  max_log_size_kb: 64  # Rotate log when it exceeds this size (in KB)


# =============================================================================
# DEFAULT PERMISSIONS BY CATEGORY
# =============================================================================
# These apply when no specific rule matches.
# Options: "allow", "deny", "ask"

defaults:
  read: allow      # Tools/commands that only read data (Read, Glob, Grep, git status, etc.)
  write: ask       # Tools/commands that modify data (Write, Edit, git commit, etc.)
  other: ask       # Everything else

# =============================================================================
# GENERAL TOOL RULES (Non-Bash Tools)
# =============================================================================
# Rules for Claude Code tools (Read, Write, Edit, etc.). First match wins.

rules:
  # ===================================================================
  # Always-Allow Tools (Task Management, Skills, Read Operations)
  # ===================================================================

  - name: "Allow TodoWrite for task tracking"
    tool_name_pattern: "^TodoWrite$"
    category: other
    decision: allow

  - name: "Allow TaskOutput for retrieving task results"
    tool_name_pattern: "^TaskOutput$"
    category: read
    decision: allow

  - name: "Allow Skill tool (always allow skills)"
    tool_name_pattern: "^Skill$"
    category: other
    decision: allow

  - name: "Allow Task tool for agents"
    tool_name_pattern: "^Task$"
    category: other
    decision: allow

  - name: "Allow TaskCreate operations (launch specialized agents)"
    tool_name_pattern: "^TaskCreate$"
    category: other
    decision: allow

  - name: "Allow TaskList operations (view active tasks and agents)"
    tool_name_pattern: "^TaskList$"
    category: read
    decision: allow

  - name: "Allow TaskUpdate operations (manage existing tasks)"
    tool_name_pattern: "^TaskUpdate$"
    category: other
    decision: allow

  - name: "Allow Write/Edit to /tmp for agents"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: "^/tmp/.*"
    category: write
    decision: allow
    message: "/tmp access for temporary files and agent operations"

  - name: "Allow read-only file operations"
    tool_name_pattern: "^(Read|Glob|Grep)$"
    category: read
    decision: allow

  - name: "Allow web operations"
    tool_name_pattern: "^(WebSearch|WebFetch)$"
    category: read
    decision: allow

  - name: "Allow Chrome DevTools MCP tools"
    tool_name_pattern: "^mcp__chrome-devtools__.*$"
    category: other
    decision: allow

  # ===================================================================
  # Deny Rules (Dangerous Patterns)
  # ===================================================================

  - name: "Block git add -A"
    tool_name_pattern: "^Bash$"
    tool_input_patterns:
      command: "git add -A"
    category: write
    decision: deny
    message: "git add -A is not allowed. Please add files explicitly."

  - name: "Block Write/Edit to wrong claude paths"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at ~/inavflight/claude/, NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct path: ~/inavflight/claude/"

  # ===================================================================
  # Allow Rules (Safe File Modifications)
  # ===================================================================

  - name: "Allow editing tool permissions configuration"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*tool_permissions\\.yaml.*"
    category: write
    decision: allow

  - name: "Allow editing SITL build configuration"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*/cmake/sitl\\.cmake.*"
    category: write
    decision: allow

  - name: "Allow Write/Edit to email directories"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*/claude/(developer|manager|release-manager|security-analyst)/(inbox|sent|inbox-archive|email)/.*"
    category: write
    decision: allow

  - name: "Allow editing .cjs test files"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*(test|tests)/.*\\.cjs$"
    category: write
    decision: allow
    message: "CommonJS test file modification allowed"

  - name: "Allow editing projects/INDEX.md"
    tool_name_pattern: "^(Write|Edit)$"
    tool_input_patterns:
      file_path: ".*/claude/projects/INDEX\\.md$"
    category: write
    decision: allow

  # ===================================================================
  # Ask Rules (File Modifications)
  # ===================================================================

  - name: "Confirm file modifications"
    tool_name_pattern: "^(Write|Edit)$"
    category: write
    decision: ask
    message: "File modification requested"

# =============================================================================
# BASH-SPECIFIC RULES
# =============================================================================
# Rules for Bash commands. First match wins. Can use precondition_script for runtime checks.

bash_rules:
  # ===================================================================
  # Path Safety Rules (Project-Specific)
  # ===================================================================
  # IMPORTANT: These must come first to catch dangerous patterns early

  - name: "Block mkdir to wrong claude paths"
    command_pattern: "^mkdir$"
    argument_pattern: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at ~/inavflight/claude/, NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct path when creating directories."

  - name: "Allow mkdir for new projects in claude/projects/active"
    command_pattern: "^mkdir$"
    argument_pattern: ".*(claude/)?projects/active/.*"
    category: write
    decision: allow
    precondition_script: |
      # Verify that the parent directory (claude/projects/active) exists
      # This prevents creating projects in the wrong location
      if [ -d "claude/projects/active" ] || [ -d "/home/raymorris/Documents/planes/inavflight/claude/projects/active" ]; then
        echo "allow"
      else
        echo "deny"
      fi
    message: "Creating new project directory under claude/projects/active/"

  - name: "Block cp/mv to wrong claude paths"
    command_pattern: "^(cp|mv)$"
    argument_pattern: ".*(inav/claude|inav-configurator/claude|inavwiki/claude).*"
    category: write
    decision: deny
    message: "STOP! The claude/ directory is at ~/inavflight/claude/, NOT inside inav/, inav-configurator/, or inavwiki/. Use the correct destination path."

  - name: "Allow project moves between active/completed"
    command_pattern: "^(cp|mv)$"
    argument_pattern: ".*(claude/projects/(active|completed)).*"
    category: write
    decision: allow
    message: "Manager project organization - moving between active and completed directories"

  # ===================================================================
  # Git Safety Rules (Deny before Allow)
  # ===================================================================

  - name: "Block git add -A"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?add -A"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT run 'git add -A'. Add the specific files you actually want."

  - name: "Block git push to maintenance/master"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?push.*(maintenance|master).*"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT push to a version branch (maintenance-9.x, maintenance-10.x) or to master (except for inavwiki). Use your create-pr skill with a feature branch."

  - name: "Block git force push"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?push.*force.*"
    category: write
    decision: deny
    message: "STOP! IMPORTANT: Do NOT force push! That will break public history!"

  # Git read operations (safe)
  - name: "Allow git read operations"
    command_pattern: "^git$"
    argument_pattern: "^(-c\\s+safe\\.directory=\\S+\\s+)?(-C\\s+\\S+\\s+)?(status|log|diff|show|branch|remote|describe|rev-parse|rev-list|cat-file|ls-tree|ls-files|grep|merge-base|blame|tag|fetch).*"
    category: read
    decision: allow

  - name: "Allow git pull"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?pull.*"
    category: write
    decision: allow

  - name: "Allow git checkout/stash/cherry-pick"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?(checkout|stash|cherry-pick|restore).*"
    category: write
    decision: allow

  - name: "Git commit reminder"
    command_pattern: "^git$"
    argument_pattern: "^(-C\\s+\\S+\\s+)?commit.*"
    category: write
    decision: allow
    message: "Git commit detected - reminder added about not mentioning Claude/AI in commit messages"

  # ===================================================================
  # Find and Echo Command Rules
  # ===================================================================

  - name: "Allow find -exec with read commands, ask for others"
    command_pattern: "^find$"
    argument_pattern: ".*-exec\\s+(grep|egrep|cat|ls|head|tail|file|stat|wc|diff)\\s+.*"
    category: read
    decision: allow

  - name: "Ask for find -exec with non-read commands"
    command_pattern: "^find$"
    argument_pattern: ".*-exec.*"
    category: other
    decision: ask
    message: "find with -exec requires approval"

  - name: "Ask for echo with file redirection, allow otherwise"
    command_pattern: "^echo$"
    argument_pattern: ".*>>?.*"
    category: write
    decision: ask
    message: "echo with file redirection requires approval"

  - name: "Allow echo without redirection"
    command_pattern: "^echo$"
    category: read
    decision: allow

  # ===================================================================
  # Cat/Heredoc Write Rules
  # ===================================================================
  # Handle patterns like: cat > file << 'EOF' or cat > file <<EOF

  - name: "Allow cat > to claude/ and lock files, ask for others"
    command_pattern: "^cat$"
    argument_pattern: "^>\\s+.*(claude/|locks/.*\\.lock).*"
    category: write
    decision: allow

  - name: "Ask for cat > to other locations"
    command_pattern: "^cat$"
    argument_pattern: "(^|\\s)>>?"
    category: write
    decision: ask
    message: "cat with stdout redirection requires approval"

  # ===================================================================
  # Email/Inbox File Operations
  # ===================================================================

  - name: "Allow cp/mv within role email directories"
    command_pattern: "^(cp|mv)$"
    argument_pattern: ".*(claude/(developer|manager|release-manager|security-analyst)/(inbox|sent|inbox-archive|email)).*"
    category: write
    decision: allow

  # ===================================================================
  # Safe File Operations
  # ===================================================================

  - name: "Allow safe file operations (tmp, SITL, CMake)"
    command_pattern: "^(rm|cp|mv|touch|mkdir)$"
    argument_pattern: ".*/tmp/.*|^/tmp/.*|^-[pf] /tmp/.*|.*eeprom\\.bin.*|^-f CMakeCache\\.txt$"
    category: write
    decision: allow

  # ===================================================================
  # Dangerous Recursive Operations
  # ===================================================================

  - name: "Block dangerous recursive operations"
    command_pattern: "^(rm|mv|cp)$"
    argument_pattern: ".*-r.*"
    category: write
    decision: deny
    message: "Recursive file operations require manual approval"

  # ===================================================================
  # Build Tools & Compilers
  # ===================================================================

  - name: "Allow build tools and compilers"
    command_pattern: "^(cd|cmake|make|dfu-util|npm|pip|pio|gcc|g\\+\\+|clang|arm-none-eabi-.*)$"
    category: other
    decision: allow

  - name: "Allow python3 and scripts in claude/ directories"
    command_pattern: "^(python3|.*(\\.claude/|claude/).*)"
    argument_pattern: ".*(\\.claude/|claude/|fetch_issues\\.py).*"
    category: other
    decision: allow

  - name: "Allow parameter group analysis scripts"
    command_pattern: "^bash$"
    argument_pattern: ".*\\.github/scripts/(extract-pg-sizes-nm|check-pg-struct-sizes)\\.sh.*"
    category: read
    decision: allow
    message: "Parameter group analysis - reads ELF binaries with nm to extract size information"

  - name: "Allow SITL and special executables"
    command_pattern: "^(pkill|kill|.*SITL\\.elf$|.*pdf_indexer\\.py$)"
    category: other
    decision: allow

  - name: "Allow .cjs test file operations"
    command_pattern: "^(chmod|node)$"
    argument_pattern: ".*(test|tests)/.*\\.cjs.*"
    category: other
    decision: allow
    message: "CommonJS test file operations (chmod +x, node execution)"

  # ===================================================================
  # Common Read-Only Commands (Broad Allow List)
  # ===================================================================
  # These are safe commands that only read/display data

  - name: "Allow common read commands"
    command_pattern: "^(grep|egrep|find|cat|ls|head|tail|less|more|wc|sort|uniq|diff|stat|file|du|df|awk|sed|cut|xargs|printf|pwd|whoami|md5sum|lsusb|sleep|ss|date|touch|ld|rg|fd|pdfgrep|jq)$"
    category: read
    decision: allow

  - name: "Allow blackbox_decode command"
    command_pattern: "^blackbox_decode$"
    category: other
    decision: allow
    message: "blackbox_decode is allowed for decoding INAV/Betaflight blackbox flight logs"

  # ===================================================================
  # Shell Control Structures & Parser Artifacts
  # ===================================================================
  # These handle bash syntax elements and parser edge cases

  - name: "Allow shell syntax elements"
    command_pattern: "^(#.*|\\(.*|if|then|else|elif|fi|for|while|do|done|case|esac|break|continue|\\[|\\[\\[|test|[0-9]>|[0-9]|>>|>|\\s*)$"
    category: read
    decision: allow

  # ===================================================================
  # GitHub CLI Commands
  # ===================================================================

  - name: "Block gh pr create targeting master"
    command_pattern: "^gh$"
    argument_pattern: ".*pr\\s+create.*--base\\s+master.*"
    category: other
    decision: deny
    message: "pull requests should never target master. Read CRITICAL-BEFORE-PR.md"

  - name: "Allow gh api for repository queries"
    command_pattern: "^gh$"
    argument_pattern: "^api\\s+.*"
    category: read
    decision: allow
    message: "GitHub API queries"

  - name: "Allow GitHub CLI read operations"
    command_pattern: "^gh$"
    argument_pattern: "^(pr|issue|run|release|workflow|repo).*(list|view|diff|checks|download).*"
    category: read
    decision: allow

  # ===================================================================
  # GitHub API Commands (curl)
  # ===================================================================

  - name: "Allow curl queries to GitHub API"
    command_pattern: "^curl$"
    argument_pattern: ".*api\\.github\\.com.*"
    category: read
    decision: allow
    message: "GitHub API read-only queries (authenticated or public)"

  - name: "Allow curl queries to localhost debugging endpoints"
    command_pattern: "^curl$"
    argument_pattern: ".*http://(localhost|127\\.0\\.0\\.1):(9222|5174).*"
    category: read
    decision: allow
    message: "Chrome DevTools Protocol (port 9222) and development server (port 5174) debugging queries (localhost or 127.0.0.1)"

  # ===================================================================
  # Runtime Conditional Rules (Using precondition_script)
  # ===================================================================

  - name: "Allow mkdir if directory exists"
    command_pattern: "^mkdir$"
    category: write
    precondition_script: |
      # Extract directory path from arguments (handles -p flag and multiple dirs)
      DIR=$(echo "{ARGS}" | sed 's/^-p *//' | awk '{print $1}')
      if [ -d "$DIR" ]; then
        echo "allow"
      else
        echo "ask"
      fi
