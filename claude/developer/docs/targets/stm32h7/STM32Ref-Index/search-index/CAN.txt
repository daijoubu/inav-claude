Keyword: CAN
Occurrences: 5624
================================================================================

Page   58: 55         FD controller area network (FDCAN) . . . . . . . . . . . . . . . . . . . . . . . . . 2428
Page   58: 55.2   FDCAN main features . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2431
Page   58: 55.3   FDCAN functional description . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2432
Page   58: 55.3.5       Clock calibration on CAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2455
Page   58: 55.3.6       TTCAN operations (FDCAN1 only) . . . . . . . . . . . . . . . . . . . . . . . . . . 2460
Page   58: 55.3.7       TTCAN configuration . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2461
Page   58: 55.3.9       TTCAN gap control . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2470
Page   58: 55.3.12 TTCAN error level . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2474
Page   58: 55.3.13 TTCAN message handling . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2475
Page   58: 55.3.14 TTCAN interrupt and error handling . . . . . . . . . . . . . . . . . . . . . . . . . 2478
Page   58: 55.3.17 FDCAN Rx buffer and FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . 2482
Page   58: 55.3.18 FDCAN Tx buffer element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2484
Page   58: 55.3.19 FDCAN Tx event FIFO element . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2486
Page   58: 55.3.20 FDCAN standard message ID filter element . . . . . . . . . . . . . . . . . . . 2487
Page   58: 55.3.21 FDCAN extended message ID filter element . . . . . . . . . . . . . . . . . . . 2489
Page   58: 55.3.22 FDCAN trigger memory element . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2490
Page   58: 55.4   FDCAN registers . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2492
Page   58: 55.4.1       FDCAN core release register (FDCAN_CREL) . . . . . . . . . . . . . . . . . 2492
Page   58: 55.4.2       FDCAN Endian register (FDCAN_ENDN) . . . . . . . . . . . . . . . . . . . . . 2492
Page   58: 55.4.3       FDCAN data bit timing and prescaler register (FDCAN_DBTP) . . . . 2492
Page   59: 55.4.4     FDCAN test register (FDCAN_TEST) . . . . . . . . . . . . . . . . . . . . . . . . 2493
Page   59: 55.4.5     FDCAN RAM watchdog register (FDCAN_RWD) . . . . . . . . . . . . . . . 2494
Page   59: 55.4.6     FDCAN CC control register (FDCAN_CCCR) . . . . . . . . . . . . . . . . . . 2495
Page   59: 55.4.7     FDCAN nominal bit timing and prescaler register (FDCAN_NBTP) . 2497
Page   59: 55.4.8     FDCAN timestamp counter configuration register (FDCAN_TSCC) . 2498
Page   59: 55.4.9     FDCAN timestamp counter value register (FDCAN_TSCV) . . . . . . . 2498
Page   59: 55.4.10 FDCAN timeout counter configuration register (FDCAN_TOCC) . . . 2499
Page   59: 55.4.11 FDCAN timeout counter value register (FDCAN_TOCV) . . . . . . . . . 2500
Page   59: 55.4.12 FDCAN error counter register (FDCAN_ECR) . . . . . . . . . . . . . . . . . 2500
Page   59: 55.4.13 FDCAN protocol status register (FDCAN_PSR) . . . . . . . . . . . . . . . . 2501
Page   59: 55.4.14 FDCAN transmitter delay compensation register (FDCAN_TDCR) . . 2504
Page   59: 55.4.15 FDCAN interrupt register (FDCAN_IR) . . . . . . . . . . . . . . . . . . . . . . . 2504
Page   59: 55.4.16 FDCAN interrupt enable register (FDCAN_IE) . . . . . . . . . . . . . . . . . 2507
Page   59: 55.4.17 FDCAN interrupt line select register (FDCAN_ILS) . . . . . . . . . . . . . . 2510
Page   59: 55.4.18 FDCAN interrupt line enable register (FDCAN_ILE) . . . . . . . . . . . . . 2511
Page   59: 55.4.19 FDCAN global filter configuration register (FDCAN_GFC) . . . . . . . . 2512
Page   59: 55.4.20 FDCAN standard ID filter configuration register (FDCAN_SIDFC) . . 2513
Page   59: 55.4.21 FDCAN extended ID filter configuration register (FDCAN_XIDFC) . . 2513
Page   59: 55.4.22 FDCAN extended ID and mask register (FDCAN_XIDAM) . . . . . . . . 2514
Page   59: 55.4.23 FDCAN high priority message status register (FDCAN_HPMS) . . . . 2515
Page   59: 55.4.24 FDCAN new data 1 register (FDCAN_NDAT1) . . . . . . . . . . . . . . . . . 2515
Page   59: 55.4.25 FDCAN new data 2 register (FDCAN_NDAT2) . . . . . . . . . . . . . . . . . 2516
Page   59: 55.4.26 FDCAN Rx FIFO 0 configuration register (FDCAN_RXF0C) . . . . . . . 2516
Page   59: 55.4.27 FDCAN Rx FIFO 0 status register (FDCAN_RXF0S) . . . . . . . . . . . . 2517
Page   59: 55.4.28 FDCAN Rx FIFO 0 acknowledge register (FDCAN_RXF0A) . . . . . . 2518
Page   59: 55.4.29 FDCAN Rx buffer configuration register (FDCAN_RXBC) . . . . . . . . . 2518
Page   59: 55.4.30 FDCAN Rx FIFO 1 configuration register (FDCAN_RXF1C) . . . . . . . 2519
Page   59: 55.4.31 FDCAN Rx FIFO 1 status register (FDCAN_RXF1S) . . . . . . . . . . . . 2520
Page   59: 55.4.32 FDCAN Rx FIFO 1 acknowledge register (FDCAN_RXF1A) . . . . . . 2521
Page   59: 55.4.33 FDCAN Rx buffer element size configuration register
Page   59: (FDCAN_RXESC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2521
Page   59: 55.4.34 FDCAN Tx buffer configuration register (FDCAN_TXBC) . . . . . . . . . 2522
Page   59: 55.4.35 FDCAN Tx FIFO/queue status register (FDCAN_TXFQS) . . . . . . . . 2523
Page   59: 55.4.36 FDCAN Tx buffer element size configuration register
Page   59: (FDCAN_TXESC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2524
Page   59: 55.4.37 FDCAN Tx buffer request pending register (FDCAN_TXBRP) . . . . . 2525
Page   59: 55.4.38 FDCAN Tx buffer add request register (FDCAN_TXBAR) . . . . . . . . . 2526
Page   59: 55.4.39 FDCAN Tx buffer cancellation request register (FDCAN_TXBCR) . . 2526
Page   60: 55.4.40 FDCAN Tx buffer transmission occurred register (FDCAN_TXBTO) 2527
Page   60: 55.4.41 FDCAN Tx buffer cancellation finished register (FDCAN_TXBCF) . . 2527
Page   60: 55.4.42 FDCAN Tx buffer transmission interrupt enable register
Page   60: (FDCAN_TXBTIE) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2527
Page   60: 55.4.43 FDCAN Tx buffer cancellation finished interrupt enable register
Page   60: (FDCAN_ TXBCIE) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2528
Page   60: 55.4.44 FDCAN Tx event FIFO configuration register (FDCAN_TXEFC) . . . 2528
Page   60: 55.4.45 FDCAN Tx event FIFO status register (FDCAN_TXEFS) . . . . . . . . . 2529
Page   60: 55.4.46 FDCAN Tx event FIFO acknowledge register (FDCAN_TXEFA) . . . 2530
Page   60: 55.4.47 FDCAN TT trigger memory configuration register (FDCAN_TTTMC) 2530
Page   60: 55.4.48 FDCAN TT reference message configuration register
Page   60: (FDCAN_TTRMC) . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2531
Page   60: 55.4.49 FDCAN TT operation configuration register (FDCAN_TTOCF) . . . . . 2532
Page   60: 55.4.50 FDCAN TT matrix limits register (FDCAN_TTMLM) . . . . . . . . . . . . . 2533
Page   60: 55.4.51 FDCAN TUR configuration register (FDCAN_TURCF) . . . . . . . . . . . 2534
Page   60: 55.4.52 FDCAN TT operation control register (FDCAN_TTOCN) . . . . . . . . . 2536
Page   60: 55.4.53 FDCAN TT global time preset register (FDCAN_TTGTP) . . . . . . . . . 2537
Page   60: 55.4.54 FDCAN TT time mark register (FDCAN_TTTMK) . . . . . . . . . . . . . . . 2538
Page   60: 55.4.55 FDCAN TT interrupt register (FDCAN_TTIR) . . . . . . . . . . . . . . . . . . 2539
Page   60: 55.4.56 FDCAN TT interrupt enable register (FDCAN_TTIE) . . . . . . . . . . . . . 2541
Page   60: 55.4.57 FDCAN TT interrupt line select register (FDCAN_TTILS) . . . . . . . . . 2543
Page   60: 55.4.58 FDCAN TT operation status register (FDCAN_TTOST) . . . . . . . . . . 2544
Page   60: 55.4.59 FDCAN TUR numerator actual register (FDCAN_TURNA) . . . . . . . . 2546
Page   60: 55.4.60 FDCAN TT local and global time register (FDCAN_TTLGT) . . . . . . . 2547
Page   60: 55.4.61 FDCAN TT cycle time and count register (FDCAN_TTCTC) . . . . . . . 2547
Page   60: 55.4.62 FDCAN TT capture time register (FDCAN_TTCPT) . . . . . . . . . . . . . 2548
Page   60: 55.4.63 FDCAN TT cycle sync mark register (FDCAN_TTCSM) . . . . . . . . . . 2548
Page   60: 55.4.64 FDCAN TT trigger select register (FDCAN_TTTS) . . . . . . . . . . . . . . 2549
Page   60: 55.4.65 FDCAN register map and reset value table . . . . . . . . . . . . . . . . . . . . 2550
Page   60: 55.5.1      Clock calibration unit core release register (FCCAN_CCU_CREL) . . 2556
Page   60: 55.5.2      Calibration configuration register (FCCAN_CCU_CCFG) . . . . . . . . . 2556
Page   60: 55.5.3      Calibration status register (FCCAN_CCU_CSTAT) . . . . . . . . . . . . . . 2558
Page   60: 55.5.4      Calibration watchdog register (FCCAN_CCU_CWD) . . . . . . . . . . . . 2558
Page   60: 55.5.5      Clock calibration unit interrupt register (FCCAN_CCU_IR) . . . . . . . . 2559
Page   60: 55.5.6      Clock calibration unit interrupt enable register (FCCAN_CCU_IE) . . 2560
Page   77: Table 459.   CAN subsystem I/O signals . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2428
Page   77: Table 460.   CAN subsystem I/O pins. . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2429
Page   77: Table 461.   DLC coding in FDCAN . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2436
Page   77: Table 485.   FDCAN register map and reset values . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2550
Page   81: Figure 54.   Kernel clock distribution For ADCs, SWPMI, RNG and FDCAN (2) . . . . . . . . . . . . . . . . . 343
Page   84: Figure 239. Pixel raster scan order . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 1164
Page   94: Figure 729. CAN subsystem . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2430
Page   94: Figure 730. FDCAN block diagram . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2432
Page   94: Figure 743. TTCAN level 0 and level 2 drift compensation . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . . 2473
Page   97: read/write (rw)                      Software can read and write to this bit.
Page   97: read-only (r)                        Software can only read this bit.
Page   97: write-only (w)                       Software can only write to this bit. Reading this bit returns the reset value.
Page   97: read/clear write0 (rc_w0)            Software can read as well as clear this bit by writing 0. Writing 1 has no
Page   97: read/clear write1 (rc_w1)            Software can read as well as clear this bit by writing 1. Writing 0 has no
Page   97: read/clear write (rc_w)              Software can read as well as clear this bit by writing to the register. The
Page   97: read/clear by read (rc_r)            Software can read this bit. Reading this bit automatically clears it to 0.
Page   97: read/set by read (rs_r)              Software can read this bit. Reading this bit automatically sets it to 1.
Page   97: read/set (rs)                        Software can read as well as set this bit. Writing 0 has no effect on the bit
Page   97: read/write once (rwo)                Software can only write once to this bit and can also read it at any time.
Page   97: Only a reset can return the bit to its reset value.
Page   97: toggle (t)                           The software can toggle this bit by writing 1. Writing 0 has no effect.
Page   97: read-only write trigger (rt_w1) Software can read this bit. Writing 1 triggers an event but has no effect on
Page  101: dedicated TCM buses directly to the Cortex-M7 core. The MDMA controller can access the
Page  102: the DTCM memory. It can also fetch instructions.
Page  103: The SDMMC1 uses a 32-bit bus, connected to the AXI bus matrix, through which it can
Page  103: the system bus matrices, it can access the internal AXI SRAM, SRAM1, SRAM2, SRAM3
Page  103: MDMA can access all internal and external memories through the Quad-SPI controller and
Page  103: matrices, the memory bus can access all internal memories except ITCM and DTCM, and
Page  103: peripheral bus can access all internal memories except ITCM and DTCM, external
Page  103: peripheral and a memory. BDMA transfers are limited to the D3 domain resources. It can
Page  104: through which it can access internal AXI SRAM and Flash memories, and external
Page  104: Through the system bus matrices, it can access all internal memories except ITCM and
Page  104: in the D2 domain. Through the system bus matrices, they can access all internal memories
Page  106: initiated by the associated bus master. This can be useful for real-time-constrained tasks,
Page  106: such as graphics processing (LTDC, DMA2D). Assigning a high priority to masters that can
Page  106: make many and frequent accesses to the same slave (such as the Cortex-M7 CPU) can
Page  112: 0: Long bursts can not be generated at the output of the ASIB
Page  112: 1: Long bursts can be generated at the output of the ASIB
Page  124: is considered the word’s least significant byte and the highest numbered byte the most
Page  124: significant.
Page  129: 0x4000AC00 - 0x4000D3FF           CAN Message RAM                    Section 55.4: FDCAN registers
Page  129: 0x4000A800 - 0x4000ABFF                CAN CCU                       Section 55.4: FDCAN registers
Page  129: 0x4000A400 - 0x4000A7FF                 FDCAN2                       Section 55.4: FDCAN registers
Page  129: 0x4000A000 - 0x4000A3FF                 FDCAN1                       Section 55.4: FDCAN registers
Page  130: masters except BDMA through D1 domain AXI bus matrix. AXI SRAM can be
Page  130: masters except BDMA through D2 domain AHB matrix. AHB SRAM1 can be used
Page  130: masters except BDMA through D2 domain AHB matrix. AHB SRAM2 can be used
Page  130: masters except BDMA through D2 domain AHB matrix. AHB SRAM3 can be used
Page  130: system masters through D3 domain AHB matrix. AHB SRAM4 can be used as
Page  130: BDMA buffers to store peripheral input/output data in D3 domain. It can also be
Page  130: The system AHB SRAM can be accessed as bytes, half-words (16-bit units) or words (32-bit
Page  130: units), while the system AXI SRAM can be accessed as bytes, half-words, words or double-
Page  130: words (64-bit units). These memories can be addressed at maximum system clock
Page  130: The AHB masters can read/write-access an SRAM section concurrently with the Ethernet
Page  130: DTCM-RAM can be used as read-write segment to host critical real-time data (such as
Page  131: ITCM-RAM can be used to host code for time-critical routines (such as interrupt
Page  131: the backup SRAM can be used to retain data during low-power mode (Standby and VBAT
Page  131: In the STM32H743/753 and STM32H750, two different boot areas can be selected through
Page  132: The BOOT_ADD0 / BOOT_ADD1 option bytes can be modified after reset in order to boot
Page  133: –    Bank swapping: the address mapping of the user Flash memory of each bank can
Page  135: Note:    The application can simultaneously request a read and a write operation through each AXI
Page  136: can be executed at a time on a given bank.
Page  138: 2. Cannot be erased by application software.
Page  138: 2. Cannot be erased by application software.
Page  139: •    In Secure access mode, dedicated libraries can be used for secure boot. They are
Page  140: As shown in Figure 6, the embedded Flash memory offers a bank swapping feature that can
Page  140: memory. A PCROP and a secure-only are a can be defined for each bank. The properties of
Page  141: The embedded Flash memory can perform read operations on the whole non-volatile
Page  141: Thanks to its dual bank architecture, the embedded Flash memory can perform any of the
Page  142: feature can be used after a firmware upgrade to restart the microcontroller on the new
Page  142: Note:      The embedded Flash memory can perform single error correction and double error
Page  145: supports programming operations that can change (reset) any memory bitcell to 0. However
Page  145: Note:    The application can decide to write as little as 8 bits to a 256 Flash word. In this case, a
Page  145: System Flash memory bank 1 cannot be written by the application software. System Flash
Page  145: memory bank 2 can be written by STMicroelectronics secure firmware only.
Page  146: •    If a write protection violation is detected, the write operation is canceled and write
Page  147: The application software can use three status flags located in FLASH_SR1/2 in order to
Page  147: If needed, the application software can update the programming delay and programming
Page  147: If step 4 is executed incrementally (e.g. byte per byte), the write buffer can become partially
Page  147: filled. In this case the application software can decide to force-write what is stored in the
Page  148: The parallelism is the maximum number of bits that can be written to 0 in one shot during a
Page  148: There is no hardware limitation on programming parallelism. The user can select different
Page  148: distinct values can be defined for bank 1 and 2 (refer to Table 13).
Page  148: When a program operation fails, an error can be reported as described in Section 3.7:
Page  149: The embedded Flash memory can perform erase operations on 128-Kbyte user sectors, on
Page  149: system Flash memory (bank 2 only) can also be erased, but by STMicroelectronics secure
Page  149: Note:    System Flash memory bank 1 cannot be erased by the application software.
Page  149: A user sector can be erased only if it does not contain PCROP, secure-only or write-
Page  150: Note:      BER1/2 and START1/2 bits can be set together, so above steps 3 and 4 can be merged.
Page  151: Note:    BER1/2 and START1/2 bits can be set together, so above steps 8 and 9 can be merged.
Page  151: those containing secure-only and protected data, the application software can set the MER
Page  152: memory interface can drive different operations at the same time on each bank. For
Page  152: example a read, write or erase operation can be executed on bank 1 while another read,
Page  153: The area processed by the CRC module can be defined either by sectors or by start/end
Page  153: addresses. It can also be defined as the whole bank (user Flash memory area only).
Page  153: Note:    Only one CRC check operation on bank 1 or 2 can be launched at a time. To avoid
Page  153: The CRC can be computed for a whole bank by setting the ALL_BANK bit in the
Page  154: The embedded Flash memory bank 1 and bank 2 can be swapped in the memory map
Page  154: accessible through AXI interface. This feature can be used after a firmware upgrade to
Page  154: Table 14 shows the memory map that can be accessed from the embedded Flash memory
Page  155: Note:        The SWAP_BANK bit in FLASH_OPTCR is read-only and cannot be modified by the
Page  155: The SWAP_BANK_OPT option bit in FLASH_OPTSR_PRG can be modified whatever the
Page  156: 1. As shown above, some registers are not dedicated to a specific bank and can be accessed at two different addresses.
Page  157: The embedded Flash memory can be reset by a D1 domain reset (d1_rst), driven by the
Page  157: The embedded Flash memory can be reset by a power-on reset (po_rst), driven by the reset
Page  157: The Reset signal can have a critical impact on the embedded Flash memory:
Page  157: power-on reset and can be read and modified only through configuration registers.
Page  157: •   How application software can modify them
Page  158: reset and the embedded Flash memory cannot be accessed.
Page  158: A user option byte change operation can be used to modify the configuration and the
Page  158: contain the _PRG extension. All “_PRG” registers can be accessed in read/write mode.
Page  158: not overwritten by current option value. The user application can check what was wrong in
Page  159: When requiring a regression to level 0, an option byte change error can occur if
Page  159: registers. They can be changed without any restriction when the RDP protection level
Page  159: registers. They can be increased without any restriction by the Arm® Cortex®-M7 core.
Page  160: There are no restrictions in setting DMEP1/2 bit. Resetting DMEP1/2 bit from 1 to 0 can
Page  160: Section 3.5.5. This option bit can be freely set by the application software if such mode
Page  160: SECURITY option bit can be freely reset.
Page  160: FLASH_SCAR_CUR1/2 registers. They can be changed without any restriction by the
Page  160: secure application, the secure-only area size can be removed by performing a bank
Page  160: DMES1/2 bits can be set without any restriction. Resetting DMES1/2 bit from 1 to 0 can
Page  160: SECURITY option bit is set. It can be modified only when the CPU is running the ST
Page  163: Below the list of the general-purpose option bytes that can be used by the application:
Page  163: Depending on the configuration of IWDG_STOP and IWDG_STBY options, the IWDG can
Page  163: When the IWDG is kept running during Stop or Standby mode, it can wake up the device
Page  164: Below the list of the option bytes that can be used to enhance data protection:
Page  164: •   SECURITY: this non-volatile option can be used by the application to manage secure
Page  165: Below the list of option bytes that can be used to configure the appropriate boot address for
Page  165: Since sensitive information can be stored in the Flash memory, it is important to protect it
Page  165: The embedded Flash memory implements the following protection mechanisms that can be
Page  166: The FLASH_CR1/2 (respectively FLASH_OPTCR) register can be locked again by software
Page  167: Any 128-Kbyte Flash sector can be independently write-protected or unprotected by
Page  167: A write-protected sector can neither be erased nor programmed. As a result, a bank erase
Page  167: cannot be performed if one sector is write-protected, unless a bank erase is executed during
Page  167: The embedded Flash memory write-protection user option bits can be modified without any
Page  167: protection bitfield can no more be changed in the option bytes.
Page  168: •    When an intrusion is detected, no accesses to the user Flash memory can be
Page  168: memory. In addition, no accesses to other secured regions (read or write) can be
Page  169: •     The user option bits described in Section 3.4 can no longer be changed except for the
Page  169: level of protection cannot be changed back to level 0 or level 1.
Page  172: One PCROP area can be defined in bank 1 (respectively bank 2) by setting the
Page  172: The minimum execute-only PCROP area that can be set is 16 Flash words (or 512 bytes).
Page  172: •    Only the CPU can access it (Master ID filtering), using only instruction fetch
Page  173: –    No mass erase can be performed if a single valid PCROP area is defined, except
Page  173: •   Only the CPU can modify the PCROP area definition and DMEP1/2 bits, as explained
Page  173: each Flash memory bank. This area can be accessed only while the CPU executes secure
Page  173: example, they can be used to protect a customer secure firmware upgrade code, a custom
Page  173: One secure-only area can be defined in bank 1 (respectively bank 2) by setting the
Page  173: Note:    These option bytes can be modified only by the CPU running ST security library or
Page  173: The minimum secure-only area that can be set is 16 Flash words (or 512 bytes). The
Page  174: •     Only the CPU executing ST secure library or user secure application can access it
Page  174: –      No mass erase can be performed if a single valid secure-only area is defined,
Page  174: •     Only the CPU can modify the secure-only area definition and DMES1/2 bits, as
Page  175: (RCC) that it is busy (i.e. BSY1/2, QW1/2, WBNE1/2 is set), the microcontroller cannot
Page  175: The microcontroller can then switch the domain to DStop or DStandby mode.
Page  176: The application software can individually enable the interrupt for each error, as detailed in
Page  178: byte data replace the old ones. The application can ignore the error, proceed with the
Page  179: flag is raised, the corrected read data are returned. Hence the application can ignore the
Page  180: can request new read operations. If a read burst was ongoing, RDPERR1/2 is raised each
Page  180: can request new read operations. If a read burst was ongoing, RDSERR1/2 is raised each
Page  181: The embedded Flash memory can generate a maskable interrupt to signal the following
Page  181: You can individually enable or disable embedded Flash memory interrupt sources by
Page  182: option byte error) can be read from the FLASH_SR1/2 register. They can be cleared by
Page  186: completed on bank 1. CRCENDIE1 can be programmed only when LOCK1 is cleared to 0.
Page  186: detection error occurs during a read operation from bank 1. DBECCERRIE1 can be
Page  186: error occurs during a read operation from bank 1. SNECCERRIE1 can be programmed only
Page  186: can be programmed only when LOCK1 is cleared to 0.
Page  186: operation from bank 1. RDPERRIE1 can be programmed only when LOCK1 is cleared to 0.
Page  186: write/erase operation to bank 1. OPERRIE1 can be programmed only when LOCK1 is
Page  186: occurs during a write operation to bank 1. INCERRIE1 can be programmed only when
Page  187: bank 1. STRBERRIE1 can be programmed only when LOCK1 is cleared to 0.
Page  187: during a program operation to bank 1. PGSERRIE1 can be programmed only when LOCK1 is
Page  187: during a program operation to bank 1. WRPERRIE1 can be programmed only when LOCK1
Page  187: operation to bank 1. EOPIE1 can be programmed only when LOCK1 is cleared to 0.
Page  187: When CRC calculation is performed on bank 1, it can only be disabled by setting CRC_EN bit
Page  187: CRC_EN can be programmed only when LOCK1 is cleared to 0.
Page  187: otherwise). SNB1 can be programmed only when LOCK1 is cleared to 0.
Page  187: START1 bit is used to start a sector erase or a bank erase operation. START1 can be
Page  187: acknowledged. The user application cannot access any embedded Flash memory register
Page  188: are set to 1 by hardware. FW1 can be programmed only when LOCK1 is cleared to 0.
Page  188: acknowledged. The user application cannot access any embedded Flash memory register
Page  188: operations to bank 1. PSIZE1 can be programmed only when LOCK1 is cleared to 0.
Page  188: BER1 can be programmed only when LOCK1 is cleared to 0.
Page  189: Setting SER1 bit to 1 requests a sector erase on bank 1. SER1 can be programmed only
Page  189: PG1 can be programmed only when LOCK1 is cleared to 0. When PG1 is reset, the internal
Page  189: LOCK1 can be set by programming it to 1. When set to 1, a new unlock sequence is
Page  191: CRC_BUSY1 flag is set when a CRC calculation is ongoing on bank 1. This bit cannot be
Page  192: been executed and thus removed from the waiting queue(s). This bit cannot be forced to 0. It
Page  192: This bit cannot be forced to 0. To reset it, clear the write buffer by performing any of the
Page  192: BSY1 cannot be forced to 0. It is automatically reset by hardware every time a step in a write,
Page  195: OPTSTART triggers an option byte change operation. The user can set OPTSTART only
Page  195: The user application cannot modify any embedded Flash memory register until the option
Page  198: it is enabled, the security feature can be disabled if no areas are protected by PCROP or
Page  205: This register can be modified only if CRC_EN bit is set to 1 in FLASH_CR1 register.
Page  206: CRC calculation can launched when an option byte change operation is ongoing because all
Page  206: on which the CRC is calculated. The CRC can be computed either between two addresses
Page  206: The list of sectors can be erased either by setting CLEAN_SECT bit or by disabling the CRC
Page  206: computation. CRC_SECT can be set only when CRC_EN of FLASH_CR register is set to 1.
Page  209: completed on bank 2. CRCENDIE2 can be programmed only when LOCK2 is cleared to 0.
Page  209: detection error occurs during a read operation from bank 2. DBECCERRIE2 can be
Page  209: error occurs during a read operation from bank 2. SNECCERRIE2 can be programmed only
Page  209: can be programmed only when LOCK2 is cleared to 0.
Page  209: operation from bank 2. RDPERRIE2 can be programmed only when LOCK2 is cleared to 0.
Page  210: write/erase operation to bank 2. OPERRIE2 can be programmed only when LOCK2 is
Page  210: occurs during a write operation to bank 2. INCERRIE2 can be programmed only when
Page  210: bank 2. STRBERRIE2 can be programmed only when LOCK2 is cleared to 0.
Page  210: during a program operation to bank 2. PGSERRIE2 can be programmed only when LOCK2 is
Page  210: during a program operation to bank 2. WRPERRIE2 can be programmed only when LOCK2
Page  210: operation to bank 2. EOPIE2 can be programmed only when LOCK2 is cleared to 0.
Page  210: When CRC calculation is performed on bank 2, it can only be disabled by setting CRC_EN bit
Page  210: CRC_EN can be programmed only when LOCK2 is cleared to 0.
Page  210: Set this bit when accessing non-user sectors of the Flash memory. This bit can be
Page  211: otherwise). SNB2 can be programmed only when LOCK2 is cleared to 0.
Page  211: START2 bit is used to start a sector erase or a bank erase operation. START2 can be
Page  211: acknowledged. The user application cannot access any embedded Flash memory register
Page  211: FW2 forces a write operation even if the write buffer is not full. FW2 can be programmed only
Page  211: acknowledged. The user application cannot access any Flash register until the operation is
Page  211: PSIZE2 selects the maximum number of bits that can be written to 0 in one shot during a
Page  211: write operation (programming parallelism). PSIZE2 can be programmed only when LOCK2 is
Page  211: BER2 can be programmed only when LOCK2 is cleared to 0.
Page  212: Setting SER2 bit to 1 requests a sector erase on bank 2. SER2 can be programmed only
Page  212: PG2 can be programmed only when LOCK2 is cleared to 0. When PG2 is reset, the internal
Page  212: LOCK2 can be set by programming it to 1. When set to 1, a new unlock sequence is
Page  214: CRC_BUSY2 flag is set when a CRC calculation is ongoing on bank 2. This bit cannot be
Page  215: from the waiting queue(s). This bit cannot be forced to 0. It is reset after a deterministic time if
Page  215: This bit cannot be forced to 0. To reset it, clear the write buffer by performing any of the
Page  215: BSY2 cannot be forced to 0. It is automatically reset by hardware every time a step in a write,
Page  221: The values in this register can be changed only if CRC_EN bit is set to 1 in FLASH_CR2
Page  222: calculation. The CRC can be computed either between two addresses (using registers
Page  222: The list of sectors can be erased either by setting CLEAN_SECT bit or by disabling the CRC
Page  222: computation. CRC_SECT can be set only when CRC_EN of FLASH_CR register is set to 1.
Page  229: This area can be configured to be accessed once after reset and be
Page  230: User software executed once after reset, which can be used to store SFU
Page  230: Three protection mechanisms can be used in the end-user application or during
Page  230: This mechanism can be set on specific Flash memory areas that must be execute-only.
Page  230: This protection can be set at Flash sector level. It prevents code or data from being
Page  231: backup SRAM can be performed when the debugger is
Page  231: RDP             (All sectors of all banks + – Protection can be removed by performing Flash mass erase
Page  232: 1. The protected areas that can only be accessed in Secure access mode are shown in blue.
Page  232: The Secure access mode can be configured through option bytes. When it is set, it enables
Page  233: Disabling Secure access mode is a more sensitive task as it can only be done if no more
Page  233: Protected areas can be removed either by performing a Flash mass erase, a bank erase or
Page  234: RSS software cannot be accessed (read, write, execute and debug) when the
Page  234: cannot be accessed anymore (no other code can jump directly to RSS). Any RSS routine is
Page  235: Arguments Secure user areas start and end addresses. One or two Secure user areas can be set.
Page  235: This service can be used only when a secure area is set for the first time.
Page  236: Only one user secure area per bank can be configured.
Page  236: Only root secure services have higher priority and can preempt secure user software
Page  236: One secure area of configurable size can be set in each bank. The size of each area can be
Page  236: per bank) can be set in the same operation.
Page  236: In this case, the secure user area code can update its own secure user area size or
Page  236: Note that RSS_resetAndInitializeSecureAreas function cannot be used to create a
Page  236: Secure user areas can only be erased by performing a Flash mass erase or a bank erase
Page  237: two boot addresses can be defined, several use-cases have to be considered.
Page  246: Run mode, write accesses to RAMs are allowed and VOS can be changed.
Page  247: 2. Write operations to RAM are allowed and VOS can be changed only when ACTVOSRDY is valid.
Page  247: The VCORE core domain supply can be provided by the voltage regulator or by an external
Page  248: memories and digital peripherals). The regulator output voltage can be scaled by
Page  248: maximum frequency. By default VOS3 is selected after system reset. VOS can be
Page  248: The regulator can be kept in Main mode to allow fast exit from Stop mode, or can be set
Page  248: lower voltage level for SVOS4 and SVOS5 scaling, the Stop mode consumption can be
Page  248: When VCORE is supplied from an external source, different operating modes can be used
Page  249: internal memories. The regulator can select a lower VCORE supply level to reduce the
Page  249: VDD is turned off, VBAT pin can be connected to an optional standby voltage which is
Page  249: If the power supply/battery connected to the VBAT pin cannot
Page  249: •   PC14 and PC15 can be used either as GPIO or as LSE pins.
Page  249: •   PC13 can be used either as GPIO or as RTC_AF1 or RTC_TAMP1 pin assuming they
Page  250: PI8 GPIOs is restricted: only one I/O can be used as an output at a time, at a speed limited
Page  250: •   PC14 and PC15 can be used as LSE pins only.
Page  250: •   PC13 can be used as RTC_AF1 or RTC_TAMP1 pin assuming they have been
Page  250: (PWR_CR2), the backup RAM content is retained even in Standby and/or VBAT mode (it can
Page  250: The Backup regulator can be ON or OFF depending whether the application needs the
Page  250: erased. The backup RAM can be erased:
Page  251: When VDD is present, the external battery connected to VBAT can be charged through an
Page  251: VBAT charging can be performed either through a 5 k Ω resistor or through a 1.5 k Ω resistor,
Page  251: reference voltage, available on VREF+ pin. The user can connect a separate external
Page  252: buffer. The internal voltage reference buffer can also deliver a reference voltage to external
Page  252: The USB transceivers are supplied from a dedicated VDD33USB supply that can be provided
Page  252: When the USB regulator is disabled through USBREGEN bit, VDD33USB can be provided
Page  253: The PDR can be enabled/disabled by the device PDR_ON input pin.
Page  253: following programmable VBOR thresholds can be selected:
Page  254: BOR can be disabled by programming the system option bytes. To disable the BOR
Page  254: The PVD can be used to monitor the VDD power supply by comparing it to a threshold
Page  254: selected by the PLS[2:0] bits in the PWR control register 1 (PWR_CR1). The PVD can also
Page  254: connected to the EXTI and can generate an interrupt, assuming it has been enabled through
Page  254: the EXTI registers. The pwr_pvd_wkup output interrupt can be generated when VDD or
Page  256: The AVD can be used to monitor the VDDA supply by comparing it to a threshold selected by
Page  256: to the EXTI and can generate an interrupt if enabled through the EXTI registers. The
Page  256: pwr_avd_wkup interrupt can be generated when VDDA drops below the AVD threshold and/or
Page  257: The VBAT battery voltage supply can be monitored by comparing it with two threshold levels:
Page  257: indicate if VBAT is higher or lower than the threshold. The VBAT supply monitoring can be
Page  258: The junction temperature can be monitored by comparing it with two threshold levels,
Page  258: The temperature monitoring can be enabled/disabled via MONEN bit in PWR control
Page  259: The D1, D2 and system D3 power domains can operate in one of the following operating
Page  259: D1 domain and/or D2 domain supply can be powered down individually when the domains
Page  260: domain and system D3 autonomous wakeup. The CPU subsystem can include multiple
Page  261: In Run mode, power consumption can be reduced by one of the following means:
Page  263: scaling can then be changed on-the-fly by software by programming VOS bits in PWR D3
Page  263: Before entering Stop mode, the software can preselect the SVOS level in PWR control
Page  263: preselecting SVOS3, the use of the voltage regulator low-power mode (LP) can be selected
Page  264: The domain operating mode can depend on the CPU subsystem when peripherals are
Page  264: (PWR_CPUCR). The CPU can choose to keep a domain in DStop, or allow a domain to
Page  264: All the domains can be configured for the system mode (Stop or Standby) through
Page  266: features a set of flags which can be read from PWR CPU control register (PWR_CPUCR).
Page  267: 6.   The system performance can then be increased to high-speed clock from the PLL. To
Page  268: clock frequency can be increased by enabling the PLL.
Page  268: c)      Once the PLL is locked, the system clock can be switched.
Page  270: c)      Once the PLL is locked, the system clock can be switched.
Page  273: In Run mode, the speed of the system clock ck_sys can be reduced. For more details refer
Page  273: In Run mode, the HCLKx and PCLKx for individual peripherals can be stopped by
Page  273: To reduce power consumption in CSleep mode, the individual peripheral clocks can be
Page  273: For the peripherals still receiving a clock in CSleep mode, their clock can be slowed down
Page  273: A domain can enter DStop or DStandby low-power mode when the CPU subsystem has an
Page  273: The system can enter Stop or Standby low-power mode when all EXTI wakeup sources are
Page  274: peripheral interrupt acknowledged by the NVIC can wake up the system.
Page  274: power mode as soon as an event occurs. The wakeup event can be generated either
Page  274: The system can wakeup from Stop mode by enabling an EXTI wakeup, without waking up a
Page  274: The D2 domain can exit from DStop or DStandby mode when the CPU allocates a first
Page  276: In CStop mode, the CPU subsystem peripherals that have a kernel clock request can still
Page  277: The Flash memory can enter low-power Stop mode when it is enabled through FLPS in
Page  278: In system Stop mode, the following features can be selected to remain active by
Page  278: cannot be stopped except by a Reset (see Section 44.3 in Section 44: Independent
Page  279: •     The ADC or DAC can also consume power during Stop mode, unless they are disabled
Page  281: state can be checked in RCC_CR register:
Page  281: and can be accessed only when SBF_Dn is cleared. Below an example of code:
Page  282: In system Standby mode, the following features can be selected by programming individual
Page  282: started, it cannot be stopped except by a reset (see Section 44.3 in Section 44:
Page  283: •            WKUP pins (if enabled). The WKUP pin pull configuration can be defined through
Page  284: The PWR registers can be accessed in word, half-word and byte format, unless otherwise
Page  287: If BREN is reset, the backup regulator is switched off. The backup RAM can still be used in
Page  289: set, this bit can be cleared only when the D2 domain is no longer in DStandby mode.
Page  289: set, this bit can be cleared only when the D1 domain is no longer in DStandby mode.
Page  294: can be used to free the CPU is also provided.
Page  296: Three kinds of signals are exchanged between the peripherals. They can be used to wake
Page  296: Some peripherals can generate interrupt events, even if their bus interface clock is not
Page  297: requests are synchronized thanks to trigger events (dmamux2_evtx) which can be
Page  297: These events can also trigger DMAMUX2 request generators (REQ_GEN[3:0]), and thus
Page  297: chain several BDMA transfers. In fact REQ_GEN[3:0] can be triggered indirectly by all the
Page  297: connected to the EXTI. They can be used to switch the D3 domain from DRun to DStop
Page  298: The D3 domain features 64 Kbytes of SRAM (SRAM4), which can be used to retain data
Page  298: This feature can be used in several use-cases:
Page  299: Note:           In the above example described in this section, the D3 domain cannot be kept in Run mode
Page  299: Run mode must be triggered by a wakeup event so that the D3 domain can clear this event
Page  299: LPUART1 can use its own APB clock as kernel clock. Since the system will not enter Stop
Page  299: mode before LPUART1 has completed data transfer, PLLx can be used to provide clocks to
Page  300: avoid spurious wakeup. To prevent the GPIO to disturb, the following sequence can be
Page  303: TX-FIFO. In parallel, serial data transmission can start.
Page  304: can be stopped once the data have been transferred to LPUART1 TX-FIFO, instead of
Page  304: when its TX-FIFO in almost empty. This asynchronous interrupt can be used as trigger by
Page  304: implementation is possible because the LPUART1 can request the kernel clock as long as
Page  305: Other peripherals located in D3 domain, such as I2C4, SPI6, SAI4 or ADC3, can be used to
Page  307: NRST                               I/O           System reset, can be used to provide reset to external devices
Page  308: reason, the Table 48 only shows the most significant internal signals.
Page  309: Several sources can generate a reset:
Page  309: reset function can be disabled through PDR_ON pin (see Section 5.5: Power supply
Page  310: A system reset can be generated from one of the following sources:
Page  311: The CPU can reset itself by means of the CPURST bit in RCC AHB3 Reset Register
Page  312: – The backup domain reset can be
Page  313: The CPU can identify the reset source by checking the reset flags in the RCC_RSR (or
Page  313: The CPU can reset the flags by setting RMVF bit.
Page  314: The power-on wakeup sequence shown in Figure 40 gives the most significant phases of
Page  315: •    The Flash memory power recovery delay can also be skipped if the Flash memory was
Page  315: reloading cannot be skipped.
Page  315: 2.   HSI/CSI restart delay. This step can be skipped if HSIKERON or CSIKERON bit, in
Page  317: To optimize the power consumption, each clock source can be switched ON or OFF
Page  317: The RCC provides up to 3 PLLs; each of them can be configured with integer or fractional
Page  318: D The selected input can be changed on-the-fly without spurs on the output signal          x Represents the selected mux input after a system reset
Page  319: the specific interface needs, is that the bus clock can be changed without
Page  319: The HSE block can generate a clock from two possible sources:
Page  320: The HSE can be used when the product requires a very accurate high-speed clock.
Page  320: by hardware. An interrupt can be generated if enabled in the RCC Clock Source Interrupt
Page  320: The HSE can be switched ON and OFF through the HSEON bit. Note that the HSE cannot
Page  320: In addition, the HSE clock can be driven to the MCO1 and MCO2 outputs and used as clock
Page  320: The LSE block can generate a clock from two possible sources:
Page  320: can have a frequency up to 1 MHz. This mode is selected by setting the LSEBYP and
Page  321: released until this bit is set by hardware. An interrupt can be generated if enabled in the
Page  321: In addition, the LSE clock can be driven to the MCO1 output and used as clock source for
Page  321: The LSE also offers a programmable driving capability (LSEDRV[1:0]) that can be used to
Page  321: modulate the amplifier driving capability. The driving capability can be changed dynamically
Page  321: The HSI is a high-speed internal RC oscillator which can be used directly as system clock,
Page  321: The HSI can be switched ON and OFF using the HSION bit. Note that the HSI cannot be
Page  321: Note that the HSIDIV cannot be changed if the HSI is selected as reference clock for at least
Page  321: The HSI clock can also be used as a backup source (auxiliary clock) if the HSE fails (refer to
Page  321: Section : CSS on HSE). The HSI can be disabled or not when the system enters Stop mode,
Page  321: In addition, the HSI clock can be driven to the MCO1 output and used as clock source for
Page  322: Note:      The HSI can remain enabled when the system is in Stop mode (see Section 7.5.7 for
Page  322: RC oscillator frequencies can vary from one chip to another due to manufacturing process
Page  322: oscillator frequency. The user application can trim the HSI frequency using the
Page  322: The CSI is a low-power RC oscillator which can be used directly as system clock, peripheral
Page  322: The CSI can be switched ON and OFF through the CSION bit. The CSIRDY flag indicates
Page  322: The CSI cannot be switched OFF if one of the two conditions is met:
Page  322: The CSI can be disabled or not when the system enters Stop mode (refer to Section 7.5.7:
Page  322: In addition, the CSI clock can be driven to the MCO2 output and used as clock source for
Page  323: RC oscillator frequencies can vary from one chip to another due to manufacturing process
Page  323: oscillator frequency. The user application can trim the CSI frequency using the
Page  323: The HSI48 is an RC oscillator that delivers a 48 MHz clock that can be used directly as
Page  323: The HSI48 can be switched ON and OFF using the HSI48ON bit.
Page  323: The HSI48 clock can also be driven to the MCO1 multiplexer and used as clock source for
Page  324: The LSI acts as a low-power clock source that can be kept running when the system is in
Page  324: The LSI can be switched ON and OFF using the LSION bit. The LSIRDY flag indicates
Page  324: hardware or software, the LSI is forced ON and cannot be disabled.
Page  324: can be generated if enabled in the RCC Clock Source Interrupt Enable Register
Page  324: In addition, the LSI clock can be driven to the MCO2 output and used as a clock source for
Page  324: The clock security system can be enabled by software via the HSECSSON bit. The
Page  324: HSECSSON bit can be enabled even when the HSEON is set to ‘0’.
Page  325: A clock security system on the LSE oscillator can be enabled by software by programming
Page  325: This bit can be disabled only by hardware when the following conditions are met:
Page  325: A wakeup is generated in Standby mode. In other modes an interrupt (rcc_lsecss_it) can
Page  325: the defective LSE (clear LSEON bit), and can change the RTC clock source (no clock or LSI
Page  325: source can be selected for each output.The selected clock can be divided thanks to
Page  326: •       The Sigma-Delta modulator can be updated on-the-fly, without generating frequency
Page  327: The user application can then configure the proper VCO: if the frequency of the reference
Page  327: The PLLs can be enabled by setting PLLxON to ‘1’. The bits PLLxRDY indicate that the PLL
Page  327: The following PLL parameters cannot be changed once the PLL is enabled: DIVNx,
Page  328: This feature can be used either to generate a specific frequency from any crystal value with
Page  328: Note:      For PLL1, DIVP can only take odd values.
Page  329: Init pre-divider (RCC_CKSELR)                    Init pre-divider (RCC_CKSELR)               Can be repeated
Page  330: Of course, the system clock can be stopped by the hardware when the System enters Stop
Page  330: When the system is running, the user application can select the system clock (sys_ck)
Page  330: dividers shown in the block diagram can be changed on-the-fly without generating timing
Page  330: The D1CPRE divider can be used to adjust the CPU clock. However this also impacts the
Page  330: In the same way, HPRE divider can be used to adjust the clock for D1 domain bus matrix,
Page  331: (1) Can be changed on-the-fly                            x Represents the selected mux input after a system reset
Page  332: When the microcontroller exits system Stop mode via a wake-up event, the application can
Page  333: There are two specific cases where the HSI or CSI can be enabled during system Stop
Page  334: As a consequence, the user application can change the bus frequency without
Page  334: Table 55 shows the kernel clock that the RCC can deliver to the peripherals. Each row of
Page  335: FDCAN          FDCANSEL        100                  1                       2                                                                                      0
Page  336: 1. The bus clocks are the bus interface clocks to which the peripherals are connected, it can be APB, AHB or AXI clocks.
Page  336: As shown in Figure 46, the kernel clock of the SAIs or SPI(I2S)s can be generated by:
Page  336: DFSDM1 can use the same clock as SAI1A. This is useful when DFSDM1 is used for audio
Page  336: To improve the flexibility, SAI4 can use different clock for each sub-block.
Page  337: interface. For that purpose the source can be selected among:
Page  340: The FMC, QUADSPI and SDMMC1/2 can also use a clock different from the bus interface
Page  341: The USBxOTG blocks receive the clock for USB communications which can be selected
Page  343: Figure 54. Kernel clock distribution For ADCs, SWPMI, RNG and FDCAN (2)
Page  343: FDCANSEL
Page  343: FDCANEN          Logic               FDCAN
Page  343: hse_ck            0                    FDCANLPEN
Page  343: pll1_q_ck                                                                  fdcan_ker_ck
Page  344: The rtc_ck clock source can be:
Page  344: This selection cannot be modified without resetting the Backup domain.
Page  345: is forced ON and cannot be disabled. After the LSI oscillator setup delay, the clock is
Page  345: Most of the clock source generator frequencies can be measured by means of the input
Page  345: can determine the internal clock frequency with the same resolution, and trim the
Page  346: the HSI or CSI are used via the PLLx, the system clock can also be fine-tuned by using
Page  346: The LSI frequency can also be measured: this is useful for applications that do not
Page  346: frequency with the precision of the HSI. The measured value can be used to have more
Page  346: For each peripheral, the application can control the activation/deactivation of its kernel and
Page  347: The D3 domain can be kept in DRun mode while the CPU is in CStop mode and D1 and D2
Page  347: Note that the CPU can control if D1, D2 or D3 domains are allowed to enter in DStandby
Page  347: In addition, more autonomy can be given to some peripherals located into D3 domain (refer
Page  348: For example, the CPU can enter CStop mode, while the SAI4 is filling the SRAM4 with data
Page  348: the CPU can be activated by a wakeup event. This can be done by setting the SAI4, the
Page  348: expecting messages via I2C4, the whole system can be put in Stop mode. When the I2C4
Page  348: amount of data transferred into memory reached the transfer count, the BDMA can also
Page  348: The CPU can access all the memory areas available in the product:
Page  349: Note:    The memory interface clocks (Flash and RAM interfaces) can be stopped by software during
Page  349: •     When the D1 domain is in DRun, the D2 domain can be in DRun, DStop or DStandby.
Page  349: When the D1 domain is in DStop or DStandby, the D2 domain can no longer remain in
Page  349: •     D3 can run while D1 and D2 are in DStop/DStandby mode thanks to RUN_D3 bits of
Page  350: The CPU can allocate a peripheral and hence control its kernel and bus interface clock.
Page  350: The CPU can allocate a peripheral by setting the dedicated PERxEN bit located into:
Page  350: The CPU can control the peripheral clocks gating when it is in CSleep mode via the
Page  350: The input selected by the kernel clock switches can be changed dynamically without
Page  350: the new input can only be performed if a clock is present on both inputs. If it not the
Page  350: PERx                                        In this area ck_in0 clock can be
Page  351: enable command and the first rising edge of the clock. The enable command can
Page  351: disable command and the last falling edge of the clock. The disable command can
Page  351: mode. The domain must be switched to DRun mode before the application can use this
Page  351: The following sequence can be followed to avoid this issue:
Page  351: e)   The peripheral can then be used.
Page  352: rcc_perx_bus_ck (for peripheral ‘x’). This clock can be an APB, AHB or AXI clock,
Page  352: named kernel clock (perx_ker_ckreq). Both clocks can be gated according to several
Page  352: PERxEN represents the peripheral enable (allocation) bit for the CPU. The CPU can
Page  355: As a summary, we can state that the kernel clock is provided to the peripherals located on
Page  356: As a summary, we can state that the kernel clock is provided to the peripherals of D3 if the
Page  359: The interrupt flags can be checked via RCC Clock Source Interrupt Flag Register
Page  359: (RCC_CIFR), and those flags can be cleared via RCC Clock Source Interrupt Clear
Page  360: Note that the control of PERxEN and PERxLPEN bits can be performed at two different
Page  360: address offset:0x0D0 and 0x130. So the application can use the registers named:
Page  362: The HSEBYP bit can be written only if the HSE oscillator is disabled.
Page  362: This bit cannot be cleared if the HSE is used directly (via SW mux) as system clock or if the HSE is
Page  363: This bit cannot be cleared if the CSI is used directly (via SW mux) as system clock or if the CSI is
Page  363: HSIDIV cannot be changed if the HSI is selected as reference clock for at least one enabled PLL
Page  364: This bit cannot be cleared if the HSI is used directly (via SW mux) as system clock or if the HSI is
Page  370: slowest APB clock among rcc_pclk[4:1] after D1CPRE update. The application can check if the
Page  375: These bits can be written only when all PLLs are disabled.
Page  376: This bit can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  376: This bit can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  376: This bit can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  376: This bit can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  376: This bit can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  377: This bit can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  377: This bit can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  377: This bit can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  377: This bit can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  379: These bits can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  380: These bits can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  380: These bits can be written only when the PLL1 is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  380: These bits can be written only when the PLL is disabled (PLL1ON = ‘0’ and PLL1RDY = ‘0’).
Page  381: These bits can be written at any time, allowing dynamic fine-tuning of the PLL1 VCO.
Page  381: –   FRACN1 can be between 0 and 213- 1
Page  382: These bits can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  383: These bits can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  383: These bits can be written only when the PLL2 is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  383: These bits can be written only when the PLL is disabled (PLL2ON = ‘0’ and PLL2RDY = ‘0’).
Page  384: These bits can be written at any time, allowing dynamic fine-tuning of the PLL2 VCO.
Page  384: –    FRACN2 can be between 0 and 213 - 1
Page  385: These bits can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  386: These bits can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  386: These bits can be written only when the PLL3 is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  386: These bits can be written only when the PLL is disabled (PLL3ON = ‘0’ and PLL3RDY = ‘0’).
Page  387: These bits can be written at any time, allowing dynamic fine-tuning of the PLL3 VCO.
Page  387: –    FRACN3 can be between 0 and 213 - 1
Page  389: FDCANSEL[1:0] (1)
Page  389: Bits 29:28 FDCANSEL: FDCAN kernel clock source selection
Page  389: 00: hse_ck clock is selected as FDCAN kernel clock (default after reset)
Page  389: 01: pll1_q_ck clock is selected as FDCAN kernel clock
Page  389: 10: pll2_q_ck clock is selected as FDCAN kernel clock
Page  403: Set by software to select the clock source for the RTC. These bits can be written only one time
Page  403: enabled. The BDRST bit can be used to reset them, then it can be written one time again.
Page  404: Once enabled this bit cannot be disabled, except after a LSE failure detection (LSECSSD = ‘1’). In
Page  405: This bit can be set even when LSION is not enabled if there is a request for LSI clock by the Clock
Page  417: FDCANRST
Page  417: Bit 8 FDCANRST: FDCAN block reset
Page  417: 0: does not reset the FDCAN block (default after reset)
Page  417: 1: resets the FDCAN block
Page  422: This bit can be set by software but is cleared by hardware during a system reset
Page  426: This register can be accessed via two different offset address.
Page  427: Set by hardware when the system reset is due to CPU.The CPU can generate a system reset by
Page  428: This register can be accessed via two different offset address.
Page  430: This register can be accessed via two different offset address.
Page  432: This register can be accessed via two different offset address.
Page  434: This register can be accessed via two different offset address.
Page  437: This register can be accessed via two different offset address.
Page  438: This register can be accessed via two different offset address.
Page  442: This register can be accessed via two different offset address.
Page  442: FDCANEN
Page  442: Bit 8 FDCANEN: FDCAN Peripheral Clocks Enable
Page  442: 0: FDCAN peripheral clocks disable (default after reset)
Page  442: 1: FDCAN peripheral clocks enabled:
Page  442: The peripheral clocks of the FDCAN are: the kernel clock selected by FDCANSEL and provided to
Page  442: fdcan_ker_ck input, and the rcc_pclk1 bus interface clock.
Page  444: This register can be accessed via two different offset address.
Page  447: This register can be accessed via two different offset address.
Page  450: This register can be accessed via two different offset address.
Page  452: This register can be accessed via two different offset address.
Page  454: This register can be accessed via two different offset address.
Page  456: This register can be accessed via two different offset address.
Page  459: This register can be accessed via two different offset address.
Page  460: This register can be accessed via two different offset address.
Page  464: This register can be accessed via two different offset address.
Page  464: FDCANLPEN
Page  464: Bit 8 FDCANLPEN: FDCAN Peripheral Clocks Enable During CSleep Mode
Page  464: 0: FDCAN peripheral clocks disabled during CSleep mode
Page  464: 1: FDCAN peripheral clocks enabled during CSleep mode (default after reset)
Page  464: The peripheral clocks of the FDCAN are: the kernel clock selected by FDCANSEL and provided to
Page  464: fdcan_ker_ck input, and the rcc_pclk1 bus interface clock.
Page  466: This register can be accessed via two different offset address.
Page  469: This register can be accessed via two different offset address.
Page  473: FDCANSEL[1:0]                       CKPERSEL[1:0]
Page  475: Res.                            Res.                        Res.                    FDCANRST                              TIM14RST                     Res.                              GPIOIRST                      Res.        8
Page  477: Res.                             Res.                       FLASHLPEN                            Res.                      Res.                  FDCANEN                              TIM14EN      8
Page  478: Res.                                    Res.                        Res.                      FDCANLPEN                               TIM14LPEN                       Res.                                GPIOILPEN      8
Page  479: Res.                      Res.                  FDCANEN                              TIM14EN                      Res.                              GPIOIEN                     Res.                         Res.         8
Page  480: FDCANLPEN                               TIM14LPEN                       Res.                                GPIOILPEN                       Res.                             Res.                       FLASHLPEN      8
Page  482: synchronization signal can be derived from the start-of-frame (SOF) packet signalization on
Page  482: The synchronization signal can also be derived from the LSE oscillator output or it can be
Page  484: The CRS synchronization (SYNC) source, selectable through the CRS_CFGR register, can
Page  484: the OTG HS2 SOF signal. This source signal also has a configurable polarity and can then
Page  486: frequency is out of the trimming range. This can also happen when the SYNC input is
Page  487: size, expressed as a number of HSI48 oscillator clock ticks. The following formula can be
Page  487: trimming hysteresis can be increased by increasing slightly the FELIM value.
Page  487: fields which can lead to an erratic trimming response. The expected operational mode
Page  488: The peripheral registers can be accessed by words (32-bit).
Page  488: These bits provide a user-programmable trimming value to the HSI48 oscillator. They can be
Page  488: TRIM value can be adjusted by hardware by one or two steps at a time, depending on the
Page  488: 0: Automatic trimming disabled, TRIM bits can be adjusted by the user.
Page  488: When this bit is set, the CRS_CFGR register is write-protected and cannot be modified.
Page  489: This register can be written only when the frequency error counter is disabled (CEN bit is
Page  494: The semaphores can be used to ensure synchronization between different processes
Page  494: •   Locking a semaphore can be done in two ways:
Page  496: The two procedures (1-step and 2-step) can be used concurrently.
Page  496: A semaphore can only be locked when it is free.
Page  496: A semaphore can be locked when the ProcessID is ‘0’.
Page  497: A semaphore can only be locked when it is free. When Read locking a free semaphore the
Page  497: In the first register address bank the semaphore can be written (locked/cleared) and read
Page  497: In the second register address bank the semaphore can be read (locked) through the
Page  498: All semaphores locked by a AHB bus master can be cleared all at once by using the
Page  498: AHB bus master can free the locked semaphores by writing the MasterID into the
Page  498: With the Interrupt enable (HSEM_CnIER) the semaphores affecting the interrupt line can be
Page  500: against the valid bus master IDs. Only the valid bus master IDs can write to the
Page  502: This bit can be written and read by firmware.
Page  506: This bit can be written by firmware. Will always read 0.
Page  506: This field can be written by firmware, will always read 0.
Page  506: This bit can be written and read by firmware.
Page  508: port bit of the general-purpose I/O (GPIO) ports can be individually configured by software in
Page  511: All GPIO pins have weak internal pull-up and pull-down resistors, which can be activated or
Page  511: this way, there can be no conflict between peripherals available on the same I/O pin.
Page  511: can be configured through the GPIOx_AFRL (for pin 0 to 7) and GPIOx_AFRH (for pin 8 to
Page  512: “one-shot” effect that does not lock the GPIOx_ODR bits. The GPIOx_ODR bits can always
Page  513: bit can no longer be modified until the next MCU reset or peripheral reset. Each
Page  513: (GPIOx_LCKR) (x = A to K)) can only be performed using a word (32-bit long) access to the
Page  513: each I/O. With these registers, the user can connect an alternate function to some other pin
Page  513: using the GPIOx_AFRL and GPIOx_AFRH alternate function registers. The application can
Page  515: block can be read when the READY flag of the SYSCFG_CCSR is set.
Page  515: •     The output buffer can be configured in open-drain or push-pull mode
Page  517: oscillator pins can be used as normal GPIOs.
Page  517: OSC32_IN pin is reserved for clock input and the OSC_OUT or OSC32_OUT pin can still be
Page  518: The peripheral registers can be written in word, half word or byte mode.
Page  520: These bits can be read and written by software.
Page  520: Note: For atomic bit set/reset, the ODR bits can be individually set and/or reset by writing to
Page  521: LOCK sequence has been applied on a port bit, the value of this port bit can no longer be
Page  522: This bit can be read any time. It can only be modified using the lock key write sequence.
Page  522: These bits are read/write but can only be written when the LCKK bit is ‘0.
Page  532: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  532: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  532: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  532: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  533: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  533: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  533: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  533: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  533: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  534: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  534: This bit is set by software and cleared only by a system reset. It can be used to enable
Page  536: This value is provided by the cell and can be used by the CPU to compute an I/O
Page  536: This value is provided by the cell and can be used by the CPU to compute an I/O
Page  538: and boundary scan disabled)
Page  538: features and boundary scan enabled)
Page  552: CAN
Page  552: CAN     -      -      -      A      -       -              -     -     -      -      -       -       -       -        A       -      -      A          -      -        -        -        -        -       -
Page  553: CAN
Page  555: CAN          SOC         ITR6                                  S            -
Page  555: CAN          TMP        TI1_1                                  A            -
Page  555: CAN          RTP        TI1_2                                  A            -
Page  559: CAN        TTCAN_TMP     hrtim_evt83                               A            -
Page  559: APB1     CAN        TTCAN_RTP     hrtim_evt93                               A            -
Page  559: D2      APB1     CAN        TTCAN_SOC                                               A            -
Page  569: FDCAN       APB1       D2
Page  569: APB1        CAN             TMP             PTP3                                           A            -
Page  570: •   The wake up signals. These signals can be generated by the peripheral without any
Page  570: •   The interrupt signals. These signals can be generated only if the peripheral bus
Page  570: •   CPU wakeup (CPU): the input event can be enabled to wake up the CPU
Page  570: •   CPU and D3 domain wakeup for autonomous Run mode (ANY): the input event can be
Page  574: the D3 domain for autonomous Run mode have a pending request logic that can be cleared
Page  575: In D1 domain, the MDMA allows the memory to transfer data. It can be triggered by software
Page  575: •   DMA requests can be generated on a stream by the DMAMUX1 itself. This event can
Page  586: transfer between memory and memory or between peripherals and memory. Data can be
Page  586: •   Each channel request can be selected among any of the request sources. This
Page  586: requests. The trigger selection can be automatically changed at the end of one block
Page  586: •   All the channels are identical and can be connected either to a standard DMA or a
Page  586: the current channel block transfer (up to the block transfer size). The 2nd FIFO can be
Page  586: can pack/unpack the necessary data to optimize the bandwidth.
Page  586: •   The size and address increment for both source and destination can be independently
Page  587: at software level. As an example, 2 x 16-bit data blocks can be interleaved together using
Page  587: significant byte. This is independent of the address increment/decrement mode of both
Page  587: Transfer Error) are available and can generate interrupts.
Page  589: The MDMA controller performs a direct memory transfer: as an AXI/AHB master, it can take
Page  589: It can carry out the following transactions:
Page  589: For the last two transaction types, the memory can also be replaced by a memory-mapped
Page  589: 1.   Burst size: this is the length of the data transfer which can be performed in burst mode.
Page  589: This burst length defines the maximum transfer length which cannot be interrupted at
Page  589: bus arbitration level and can block other masters from accessing the bus)
Page  589: lengths which cannot be interrupted at MDMA level (from other channel requests).
Page  589: 3.   Block size: this value has two meanings which can be used together:
Page  590: Each channel can perform:
Page  590: Both the source and destination transfers can address peripherals and memories in the
Page  590: The source/destination addresses can be fixed (e.g. FIFO/single data register peripherals)
Page  590: or incremented/decremented. The transfer can be done in single access or in burst mode
Page  590: The source and destination memory pointers can optionally be automatically post-
Page  591: If the mask address register is not set (0x00 value), the request can be reset by simply
Page  591: priority) could start the read phase. Because of this, lower priority channels can be
Page  592: •   Software: each stream priority can be configured in the MDMA_CxCR register. There
Page  592: transferred can be read to the FIFO.
Page  593: transfer is completed, one of the following three actions can be executed:
Page  593: The trigger source can be automatically changed, when loading the CxTBR value.
Page  593: Different events can generate an end of transfer by setting the CTCIF bit in the status
Page  594: At any time, a MDMA transfer can be suspended in order to be to be restarted later on or to
Page  594: register to disable the channel. The stream can take time to be disabled (on going
Page  594: software can determine how many data items have been transferred before the
Page  594: The MDMA controller can detect the following errors:
Page  594: (which cannot be done)
Page  594: For each MDMA channel, an interrupt can be produced on the following events:
Page  595: The MDMA registers can be accessed in word/half-word or byte format.
Page  596: This can be used as a debug feature (without interrupt), indicating that (at least) an MDMA
Page  599: It can be used by software to retrieve the failing address, by adding this value (truncated to
Page  600: 0x40 × channel number can be used for SWRQ activation.
Page  600: This bit is protected and can be written only if EN is 0.
Page  600: This bit is protected and can be written only if EN is 0.
Page  600: This bit is protected and can be written only if EN is 0.
Page  601: These bits are protected and can be written only if EN is 0.
Page  601: This bit can be cleared by hardware:
Page  602: This bit is protected and can be written only if EN is 0.
Page  602: This bit is protected and can be written only if EN is 0.
Page  602: These bits are protected and can be written only if EN is 0.
Page  603: These bits are protected and can be written only if EN is 0
Page  603: This bit is protected and can be written only if EN is 0
Page  603: These bits are protected and can be written only if EN is 0
Page  603: These bits are protected and can be written only if EN is 0
Page  604: These bits are protected and can be written only if EN is 0
Page  604: These bits are protected and can be written only if EN = '0'.
Page  604: These bits are protected and can be written only if EN = '0'.
Page  604: These bits are protected and can be written only if EN is 0.
Page  605: These bits are protected and can be written only if EN is 0
Page  605: These bits are protected and can be written only if EN is 0
Page  605: These bits are protected and can be written only if EN is 0
Page  606: Once the last block transfer has completed, this register can either stay at zero or be
Page  606: These bits are protected and can be written only if EN is 0.
Page  606: These bits are protected and can be written only if EN is 0.
Page  606: These bits are protected and can be written only if EN is 0.
Page  606: Once the block transfer has completed, this register can either stay at zero or be reloaded
Page  606: If the value of this register is zero, no transaction can be served even if the stream is
Page  606: These bits are protected and can be written only if EN is 0.
Page  607: These bits are write-protected and can be written only when bit EN = '0' in the DMA_SxCR register.
Page  608: These bits are write-protected and can be written only when bit EN = '0' in the DMA_SxCR register.
Page  609: These bits are write-protected and can be written only when bit EN = '0' in the MDMA_CxCR
Page  609: These bits are write-protected and can be written only when bit EN = '0' in the MDMA_CxCR
Page  610: protected and can be written only when bit EN = '0' in the MDMA_CxCR register.
Page  611: This bit is protected and can be written only if EN is 0.
Page  611: This bit is protected and can be written only if EN is 0.
Page  611: These bits are write-protected and can be written only when bit EN = '0' in the MDMA_CxCR
Page  612: If the value of this register is 0, this function is disabled. These bits are write-protected and can be
Page  612: These bits are write-protected and can be written only when bit EN = '0' in the MDMA_CxCR
Page  615: peripherals and memory and between memory and memory. Data can be quickly moved by
Page  615: output request can be individually programmed in order to select the DMA request source
Page  615: •   Four-word depth 32 first-in, first-out memory buffers (FIFOs) per stream, that can be
Page  615: •   Each stream can be configured to be:
Page  616: •   Each stream request can be selected among up to 115 possible channel requests. This
Page  616: •   The number of data items to be transferred can be managed either by the DMA
Page  618: The DMA controller performs direct memory transfer: as an AHB master, it can take the
Page  618: peripheral can initiate the next transaction.
Page  619: •      Software: each stream priority can be configured in the DMA_SxCR register. There are
Page  619: Each stream can be configured to perform:
Page  619: the memory (while the DMA is reading/writing from/to a buffer, the application can
Page  619: Both source and destination transfers can address peripherals and memories in the entire
Page  622: The DMA channels can also work without being triggered by a request from a peripheral.
Page  622: Peripheral and memory pointers can optionally be automatically post-incremented or kept
Page  623: ADC scan mode). This feature can be enabled using the CIRC bit in the DMA_SxCR
Page  623: area is being filled/used by the DMA transfer. The double-buffer stream can work in both
Page  623: directions (the memory can be either the source or the destination) as described in
Page  624: •   When the CT bit is ‘0’ in the DMA_SxCR register, the DMA_SxM1AR register can be
Page  624: •   When the CT bit is ‘1’ in the DMA_SxCR register, the DMA_SxM0AR register can be
Page  624: programmable through the PSIZE and MSIZE bits in the DMA_SxCR register (can be 8-,
Page  625: will not be incomplete. This can occur when the data width of the peripheral port (PSIZE
Page  626: The DMA controller can generate single transfers or incremental burst transfers of 4, 8 or 16
Page  626: In direct mode, the stream can only generate single transfers and the MBURST[1:0] and
Page  626: that can be allocated to a single slave is 1 Kbyte. This means that the 1 Kbyte address
Page  628: size can be: 1 (byte), 2 (half-word) or 4 (word)).
Page  629: The FIFO can be flushed when the stream is disabled by resetting the EN bit in the
Page  629: Different events can generate an end of transfer by setting the TCIFx bit in the DMA_LISR
Page  630: At any time, a DMA transfer can be suspended to be restarted later on or to be definitively
Page  630: when the stream was stopped so that the software can determine how many data items
Page  631: The flow controller can be:
Page  631: maximum of 65535 data items can be managed by the DMA in a single transaction,
Page  632: be cleared before the stream can be re-enabled.
Page  633: As soon as the stream is enabled, it can serve any DMA request from the peripheral
Page  633: Only then can the peripheral be safely disabled.
Page  633: The DMA controller can detect the following errors:
Page  633: •    Direct mode error: the direct mode error interrupt flag (DMEIFx) can only be set in the
Page  633: In direct mode, the FIFO error flag can also be set under the following conditions:
Page  633: •    In the peripheral-to-memory mode, the FIFO can be saturated (overrun) if the memory
Page  634: For each DMA stream, an interrupt can be produced on the following events:
Page  638: These bits are protected and can be written only if EN is ‘0’.
Page  638: These bits are protected and can be written only if EN is ‘0’.
Page  638: This bit is set and cleared by hardware. It can also be written by software.
Page  638: This bit can be written only if EN is ‘0’ to indicate the target memory area of the first transfer.
Page  639: This bit is protected and can be written only if EN is ‘0’.
Page  639: These bits are protected and can be written only if EN is ‘0’.
Page  639: This bit is protected and can be written only if EN = '0'.
Page  639: These bits are protected and can be written only if EN is ‘0’.
Page  639: These bits are protected and can be written only if EN is ‘0’.
Page  639: This bit is protected and can be written only if EN is ‘0’.
Page  639: This bit is protected and can be written only if EN is ‘0’.
Page  640: This bit is set and cleared by software and can be cleared by hardware.
Page  640: These bits are protected and can be written only if EN is ‘0’.
Page  640: This bit is protected and can be written only if EN is ‘0’.
Page  641: This register can be written only when the stream is disabled. When the stream is enabled,
Page  641: Once the transfer is completed, this register can either stay at zero (when the stream is in
Page  641: If the value of this register is zero, no transaction can be served even if the stream is
Page  642: These bits are write-protected and can be written only when bit EN = '0' in the DMA_SxCR
Page  642: These bits are write-protected. They can be written only if:
Page  643: These bits are write-protected. They can be written only if:
Page  643: This bit is set and cleared by software. It can be set by hardware.
Page  643: This bit is protected and can be written only if EN is ‘0’.
Page  644: These bits are protected and can be written only if EN is ‘0’.
Page  654: hardware. This EN bit can not be set again by software to re-activate the channel x, until the
Page  654: ADC scan mode). This feature is enabled using the CIRC bit in the BDMA_CCRx register.
Page  654: DMA requests (such as quit the ADC scan mode), before disabling the DMA channel.
Page  654: The BDMA channels can operate in double-buffer mode.
Page  654: transfer operates in both directions, so the target memory can be either the source or the
Page  655: Any BDMA channel can operate in peripheral-to-peripheral mode:
Page  657: The EN bit of the BDMA_CCRx register can not be set again by software (channel x re-
Page  658: An interrupt can be generated on a half transfer, transfer complete or transfer error for each
Page  665: When a channel transfer error occurs, this bit is cleared by hardware. It can not be set again
Page  666: If this field is zero, no transfer can be served whatever the channel status (enabled or not).
Page  678: Each DMAMUX request line multiplexer channel x can be individually synchronized by
Page  680: Trigger events on a DMA request trigger input can be rising edge, falling edge or either
Page  681: An interrupt can be generated upon:
Page  692: manipulation. It can perform the following operations:
Page  692: •   Alpha value can be modified (source value, fixed value or modulated value)
Page  693: The DMA2D controller performs direct memory transfer. As an AXI master, it can take the
Page  693: The DMA2D can operate in the following modes:
Page  695: The user application can perform the following operations:
Page  695: perform the pixel format conversion to generate a 32-bit per pixel value. The PFC can also
Page  697: Once the 32-bit value is generated, the alpha channel can be modified according to the
Page  697: The alpha channel can be:
Page  697: Note:       To support the alternate format, the incoming alpha value can be inverted setting the AI bit
Page  697: The R and B fields can also be swapped setting the RBS bit of the
Page  698: The CLUT memory loading can be done in two different ways:
Page  698: The CLUT format can be 24 or 32 bits. It is configured through the CCM bit of the
Page  699: Note:    To support the alternate format, the calculated alpha value can be inverted setting the AI bit
Page  699: The R and B fields can also be swapped setting the RBS bit of the DMA2D_OPFCCR
Page  700: The output FIFO bytes can be reordered to support display frame buffer update through a
Page  700: The reordering of bytes can be done using:
Page  702: number of data and the width can be programmed by software.
Page  702: Both source and destination data transfers can target peripherals and memories in the
Page  702: The DMA2D can operate in any of the four following modes selected through MODE[1:0]
Page  703: The CLUT loading can be done automatically by following the sequence below:
Page  703: loading process can not work in parallel with classical DMA2D transfers.
Page  703: The CLUT can also be filled by the CPU or by any other master through the AHB port. The
Page  703: In parallel to the color conversion process, the alpha value can be added or changed
Page  704: to obtain a fully opaque pixel. The alpha value can be modified according to the AM[1:0] bits
Page  704: •   It can be unchanged.
Page  704: •   It can be replaced by the value defined in the ALPHA[7:0] value of the
Page  704: •   It can be replaced by the original value multiplied by the ALPHA[7:0] value of the
Page  704: CM[2:0] field of the DMA2D_OPFCCR register. The output pixel format cannot be the
Page  704: memory mode. Their configurations can be different as each pixel format converter are
Page  704: The alpha value can be replaced or modified according to the AM[1:0] and ALPHA[7:0]
Page  705: memory mode. Their configurations can be different as each pixel format converter are
Page  705: The alpha value can be replaced or modified according to the AM[1:0] and ALPHA[7:0]
Page  705: memory mode. Their configurations can be different as each pixel format converter are
Page  705: The wrong configurations that can be detected are listed below:
Page  706: The DMA2D foreground plane can support 8x8 block based YCbCr as output by the JPEG
Page  707: Once the DMA2D is configured, the transfer can be launched by setting the START bit of the
Page  707: and the TCIF flag of the DMA2D_ISR register is raised. An interrupt can be generated if the
Page  707: The user application can suspend the DMA2D at any time by setting the SUSP bit of the
Page  707: DMA2D_CR register. The transaction can then be aborted by setting the ABORT bit of the
Page  707: DMA2D_CR register or can be restarted by resetting the SUSP bit of the DMA2D_CR
Page  707: The user application can abort at any time an ongoing transaction by setting the ABORT bit
Page  707: Automatic CLUT transfers can also be aborted or suspended by using their own START bits
Page  707: A watermark can be programmed to generate an interrupt when the last pixel of a given line
Page  707: Two kind of errors can be triggered:
Page  707: To limit the AXI bandwidth usage, a dead time between two consecutive AXI accesses can
Page  707: This feature can be enabled by setting the EN bit in the DMA2D_AMTCR register.
Page  708: An interrupt can be generated on the following events:
Page  709: This bit is set and cleared by software. It cannot be modified while a transfer is ongoing.
Page  710: This bit is set and cleared by software. It can not be modified while a transfer is on
Page  710: This bit can be used to abort the current transfer. This bit is set by software and is
Page  710: This bit can be used to suspend the current transfer. This bit is set and reset by
Page  710: This bit can be used to launch the DMA2D according to the parameters loaded in the
Page  713: Address of the data used for the foreground image. This register can only be written
Page  713: These bits can only be written when data transfers are disabled. Once the data transfer
Page  714: Address of the data used for the background image. This register can only be written
Page  714: These bits can only be written when data transfers are disabled. Once the data transfer
Page  715: These bits define a fixed alpha channel value which can replace the original alpha value
Page  715: These bits can only be written when data transfers are disabled. Once a transfer has
Page  715: can only be written data the transfer are disabled. Once the transfer has started, they
Page  716: This bit can be set to start the automatic loading of the CLUT. It is automatically reset:
Page  716: This bit defines the color format of the CLUT. It can only be written when the transfer is
Page  716: These bits defines the color format of the foreground image. They can only be written
Page  717: can only be written when data transfers are disabled. Once the transfer has started,
Page  717: can only be written when data transfers are disabled. Once the transfer has started,
Page  717: can only be written when data transfers are disabled. Once the transfer has started,
Page  718: These bits define a fixed alpha channel value which can replace the original alpha value
Page  718: bits AM[1: 0]. These bits can only be written when data transfers are disabled. Once the
Page  718: These bits can only be written when data transfers are disabled. Once the transfer has
Page  719: These bits define the color format of the CLUT. This register can only be written when
Page  719: These bits define the color format of the foreground image. These bits can only be
Page  720: can only be written when data transfers are disabled. Once the transfer has started,
Page  720: can only be written when data transfers are disabled. Once the transfer has started,
Page  720: can only be written when data transfers are disabled. Once the transfer has started,
Page  721: register can only be written when no transfer is ongoing. Once the CLUT transfer has
Page  721: This register can only be written when no transfer is on going. Once the CLUT transfer
Page  722: This register can only be written when the transfer is disabled. Once the transfer has
Page  722: These bits define the color format of the output image. These bits can only be written
Page  723: These bits define the alpha channel of the output color. These bits can only be written
Page  723: These bits define the red value of the output image. These bits can only be written when
Page  723: These bits define the green value of the output image. These bits can only be written
Page  723: These bits define the blue value of the output image. These bits can only be written
Page  724: Address of the data used for the output FIFO. These bits can only be written when data
Page  724: These bits can only be written when data transfers are disabled. Once data transfer has
Page  725: Number of pixels per lines of the area to be transferred. These bits can only be written
Page  725: Number of lines of the area to be transferred. These bits can only be written when data
Page  725: These bits can only be written when data transfers are disabled. Once the transfer has
Page  731: ttfdcan_intr0_it   26           19          FDCAN1_IT0      FDCAN1 Interrupt 0             0x0000 008C
Page  731: fdcan_intr0_it    27           20          FDCAN2_IT0      FDCAN2 Interrupt 0             0x0000 0090
Page  731: ttfdcan_intr1_it   28           21          FDCAN1_IT1      FDCAN1 Interrupt 1             0x0000 0094
Page  731: fdcan_intr1_it    29           22          FDCAN2_IT1      FDCAN2 Interrupt 1             0x0000 0098
Page  733: fdcan_cal_it    70           63          FDCAN_CAL       FDCAN calibration interrupts   0x0000 013C
Page  738: Both the interrupt request and event request generation can also be used in Run modes.
Page  742: that can wakeup D3 domain for autonomous Run mode and/or CPU (“Any” target). It
Page  746: request logic that can be cleared by the selected D3 pendclear source. For each D3
Page  746: Pending request a D3 domain pendclear source can be selected from four different inputs.
Page  746: The wakeup capabilities of each Event input are detailed in Table 141. An Event input can
Page  746: either wake up the CPU, and in the case of “Any” can also wake up D3 domain for
Page  750: For the Configurable Event inputs an event input request can be generated by software
Page  751: A pending D3 domain wakeup signal can also be cleared by FW clearing the
Page  751: Any of the Configurable Event inputs can be triggered from the software interrupt/event
Page  751: A software trigger can be used to set the D3 Pending request logic, keeping the D3 domain
Page  752: Every register can only be accessed with 32-bit (word). A byte or half-word cannot be read
Page  752: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  752: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  755: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  756: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  759: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  760: Rising and falling edge triggers can be set for the same Configurable Event input. In this case, both edges generate a
Page  770: •   General-purpose 8-bit register (can be used for temporary storage)
Page  771: The CRC_DR register can be accessed by word, right-aligned half-word and right-aligned
Page  771: The data size can be dynamically adjusted to minimize the number of write accesses for a
Page  771: given number of bytes. For instance, a CRC for 5 bytes can be computed with a word write
Page  772: The input data can be reversed, to manage the various endianness schemes. The reversing
Page  772: operation can be performed on 8 bits, 16 bits and 32 bits depending on the REV_IN[1:0] bits
Page  772: The output data can also be reversed by setting the REV_OUT bit in the CRC_CR register.
Page  772: The CRC calculator can be initialized to a programmable value using the RESET control bit
Page  772: The initial CRC value can be programmed with the CRC_INIT register. The CRC_DR
Page  772: The CRC_IDR register can be used to hold a temporary value related to CRC calculation. It
Page  772: polynomial size can be configured to be 7, 8, 16 or 32 bits by programming the
Page  772: If the CRC data is less than 32-bit, its value can be read from the least significant bits of the
Page  772: To obtain a reliable CRC calculation, the change on-fly of the polynomial value or size can
Page  773: If the data size is less than 32 bits, the least significant bits are used to write/read the
Page  773: These bits can be used as a temporary storage location for four bytes.
Page  774: stored in the CRC_INIT register. This bit can only be set, it is automatically cleared by hardware
Page  775: If the polynomial size is less than 32 bits, the least significant bits have to be used to program the
Page  776: are not used by the application can be used for other purposes.
Page  777: can be changed on-the-fly:
Page  780: The requested AXI transaction data size can be 8-, 16-, 32- or 64-bit wide whereas the
Page  780: Therefore, some simple transaction rules can be followed, depending on AXI transaction
Page  780: memory. Since the device cannot be accessed in Byte mode (only 16-bit words
Page  780: can be read/written from/to the Flash memory), write transactions are not allowed
Page  780: not all masters can issue wrap transactions.
Page  780: The FMC can be configured through a set of registers. Refer to Section 21.7.6, for a
Page  781: For each bank the type of memory to be used can be configured by the user application
Page  782: The FMC bank mapping can be modified through the BMAP[1:0] bits in the FMC_BCR1
Page  784: address can be 4 or 5 bytes long (depending on the actual memory size), several
Page  788: The FMC output Clock (FMC_CLK) is a sub-multiple of the fmc_ker_ck clock. It can be
Page  792: modes for read and write operations. For example, read operation can be performed in
Page  792: FMC can operate in Mode1 or Mode2 as follows:
Page  810: The data setup phase must be programmed so that WAIT can be detected 4 fmc_ker_ck
Page  812: space can be programmed to cacheable.
Page  812: the exact relation between the NOR Flash latency and the FMC DATLAT parameter can be
Page  812: Some recent memories assert NWAIT during the latency phase. In such cases DATLAT can
Page  820: Note: When the Extended mode is disabled, the FMC can operate in Mode1 or Mode2 as
Page  823: other asynchronous /synchronous read or write to or from a static bank. The bank can be the
Page  823: same or different in case of read, in case of write the bank can be different except for muxed
Page  823: to or from static memory bank (the bank can be the same or different for the case of
Page  824: This method can be used also with the latest generation of synchronous Flash memories
Page  825: any other asynchronous /synchronous read or write transfer to or from a static bank. The bank can
Page  825: be the same or different in case of read, in case of write the bank can be different expect for muxed
Page  828: Theoretically, there is no capacity limitation as the FMC can manage as many address
Page  828: Note:      Theoretically, there is no capacity limitation as the FMC can manage as many address
Page  830: 3.   The CPU can send the start address (STARTAD) for a read operation by writing four
Page  830: makes it possible to use a different timing configuration of the FMC, which can be used
Page  831: 5.   The CPU can then perform byte read operations from the common memory space to
Page  831: 6.   The next NAND Flash page can be read without any CPU command or address write
Page  831: operation. This can be done in three different ways:
Page  831: –     a new random address can be accessed by restarting the operation at step 3
Page  831: –     a new command can be sent to the NAND Flash device by restarting at step 2
Page  832: When this function is required, it can be performed by programming the MEMHOLD value to
Page  832: To cope with this timing constraint, the attribute memory space can be used by
Page  832: The ECC algorithm implemented in the FMC can perform 1-bit error correction and 2-bit
Page  833: can be corrected or not.
Page  839: •    SDRAM clock can be fmc_ker_ck/2 or fmc_ker_ck/3
Page  839: I/O pins which are not used by the application, can be used for other purposes.
Page  847: TRAS and can remain in Self-refresh mode for an indefinite period beyond that. To
Page  849: The SDRAM device cannot remain in Power-down mode longer than the refresh period and
Page  849: cannot perform the Auto-refresh cycles by itself. Therefore, the SDRAM controller carries
Page  859: Flash memories. It can operate in any of the three following modes:
Page  859: an interrupt can be generated in case of flag setting
Page  859: Both throughput and capacity can be increased two-fold using dual-flash mode, where two
Page  859: •   Dual-flash mode, where 8 bits can be sent/received simultaneously by accessing two
Page  861: Chip select (active low) for FLASH 1. Can also be
Page  861: Chip select (active low) for FLASH 2. Can also be
Page  861: can include 5 phases: instruction, address, alternate byte, dummy, data. Any of these
Page  861: phases can be configured to be skipped, but at least one of the instruction, address,
Page  862: Though most Flash memories can receive instructions only one bit at a time from the
Page  862: IO0/SO signal (single SPI mode), the instruction phase can optionally send 2 bits at a time
Page  862: mode). This can be configured using the IMODE[1:0] field of QUADSPI_CCR[9:8] register.
Page  862: The address phase can send 1 bit at a time (over SO in single SPI mode), 2 bits at a time
Page  862: mode). This can be configured using the ADMODE[1:0] field of QUADSPI_CCR[11:10]
Page  862: The alternate-bytes phase can send 1 bit at a time (over SO in single SPI mode), 2 bits at a
Page  862: mode). This can be configured using the ABMODE[1:0] field of QUADSPI_CCR[15:14]
Page  863: for the alternate bytes. In this case, firmware can use quad-mode (ABMODE = 11) and send
Page  863: During the data phase, any number of bytes can be sent to, or received from the Flash
Page  863: The data phase can send/receive 1 bit at a time (over SO/SI in single SPI mode), 2 bits at a
Page  863: mode). This can be configured using the ABMODE[1:0] field of QUADSPI_CCR[15:14]
Page  864: The different phases can each be configured separately to use this single bit mode by
Page  864: The different phases can each be configured separately to use dual SPI mode by setting the
Page  864: The different phases can each be configured separately to use quad SPI mode by setting
Page  864: Quad SPI mode, then the pins corresponding to IO2 and IO3 can be used for other functions
Page  865: Dual-flash mode can be used in conjunction with single-bit, dual-bit, and quad-bit modes, as
Page  866: bits of both Flash memories in dual-flash mode. The least-significant byte of the result (in
Page  866: the data register) is the least-significant byte of FLASH 1 status register, while the next byte
Page  866: is the least-significant byte of FLASH 2 status register. Then, the third byte of the data
Page  867: Byte/halfword accesses to QUADSPI_DR must be done only to the least significant
Page  867: memory does not restart until 4 bytes become vacant in the FIFO (when FLEVEL ≤ 11).
Page  868: number of status bytes (up to 4). The received bytes can be masked to isolate some status
Page  868: bits and an interrupt can be generated when the selected bits have a defined value.
Page  868: No more than 256MB can addressed even if the Flash memory capacity is larger.
Page  869: The device configuration register (QUADSPI_DCR) can be used to specify the
Page  869: The Flash memory capacity can be up to 4GB (addressed using 32 bits) in indirect mode,
Page  869: (CSHT) field can be used to specify the minimum number of CLK cycles (up to 8) that nCS
Page  870: SSHIFT bit (bit 4 of QUADSPI_CR), the sampling of the data can be shifted by half of a CLK
Page  870: Once configured and enabled, the QUADSPI can be used in one of its three operating
Page  870: DDR mode can be set through the DDRM bit. Once enabled, the address and the alternate
Page  870: If timeout counter is needed, the TCEN bit can be set and the timeout value programmed in
Page  870: Dual-flash mode can be activated by setting DFM to 1.
Page  870: When FMODE is programmed to 00, indirect write mode is selected and data can be sent to
Page  870: the Flash memory. With FMODE = 01, indirect read mode is selected where data can be
Page  872: Once the status data has been retrieved, it can internally be processed i order to:
Page  872: The received value can be masked with the value stored in the QUADSPI_PSMKR and
Page  872: the QUADSPI can be automatically stopped if the AMPS bit is set.
Page  872: the address. One can take advantage of such a feature using the SIOO bit
Page  873: An error can be generated in the following case:
Page  873: Any operation can be aborted by setting the ABORT bit in the QUADSPI_CR. Once the
Page  875: may use BK1_nCS and the pin outputting BK2_nCS can be used for other functions.
Page  875: An interrupt can be produced on the following events:
Page  876: This field can be modified only when BUSY = 0.
Page  876: This bit can be modified only when BUSY = 0.
Page  876: This bit can be modified only when BUSY = 0.
Page  877: 0: FTF is set if there are 1 or more valid bytes that can be read from the FIFO
Page  877: 1: FTF is set if there are 2 or more valid bytes that can be read from the FIFO
Page  877: 31: FTF is set if there are 32 valid bytes that can be read from the FIFO
Page  877: This bit can be modified only when BUSY = 0.
Page  877: This bit can be modified only when BUSY = 0.
Page  878: This field can be modified only when BUSY = 0.
Page  878: This bit can be modified only when BUSY = 0.
Page  879: memory. The Flash memory capacity can be up to 4GB (addressed using 32 bits) in
Page  879: This field can be modified only when BUSY = 0.
Page  879: This field can be modified only when BUSY = 0.
Page  879: This field can be modified only when BUSY = 0.
Page  882: This field can be written only when BUSY = 0.
Page  882: This field can be written only when BUSY = 0.
Page  882: This field can be written only when BUSY = 0.
Page  882: This bit can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  883: This field can be written only when BUSY = 0.
Page  884: This field can be written only when BUSY = 0.
Page  884: This field can be written only when BUSY = 0.
Page  884: This field can be written only when BUSY = 0.
Page  885: This field can be written only when BUSY = 0.
Page  886: This field can be written only when BUSY = 0.
Page  886: This field can be written only when BUSY = 0.
Page  887: This field can be written only when BUSY = 0.
Page  887: This field can be written only when BUSY = 0.
Page  890: Note that the UNIT bits can be programmed only when the output clock is disabled (SEN =
Page  890: DLYB_CFGR register. Note that SEL can be programmed only when the output clock is
Page  890: clock period. The delay line length can be configured by enabling the length sampler
Page  890: Once the delay line length has been configured, a dephased output clock can be selected
Page  890: 1. The unit delay can only be changed when SEN = ‘1’.
Page  890: 2. The output clock phase can only be changed when SEN = ‘1’.
Page  891: can be selected between the unit delays spanning one Input clock period.
Page  892: All registers can be accessed in word, half-word and byte access.
Page  893: These bits can only be written when SEN = ‘1’.
Page  893: These bits can only be written when SEN = ‘1’.
Page  894: •    ADC1 and ADC2 are tightly coupled and can operate in dual mode (ADC1 is master).
Page  894: Each ADC has up to 20 multiplexed channels. A/D conversion of the various channels can
Page  894: be performed in single, continuous, scan or discontinuous mode. The result of the ADC is
Page  895: –   Up to 2x ADCs which can operate in dual mode
Page  895: –   Can manage Single-ended or differential inputs (programmable per channels)
Page  895: –   Data can be managed by GP-DMA for regular channel conversions with FIFO
Page  895: –   Data can be routed to DFSDM for post processing
Page  895: •   Start-of-conversion can be initiated:
Page  895: –   Each ADC can convert a single channel or can scan a sequence of channels
Page  897: VINN[19:0]   scan control
Page  898: Up to 21 external trigger inputs for the regular conversions (can
Page  898: Up to 21 external trigger inputs for the injected conversions (can
Page  899: The input clock is the same for the three ADCs and can be selected between two different
Page  899: 1.   The ADC clock can be a specific clock source, named adc_ker_ck which is
Page  899: It can be configured in the RCC (refer to RCC Section for more information on how to
Page  899: 2.   The ADC clock can be derived from the AHB clock of the ADC bus interface, divided by
Page  899: a programmable factor (1, 2 or 4). In this mode, a programmable divider factor can be
Page  899: Note:    For option 2), a prescaling factor of 1 (CKMODE[1:0]=01) can be used only if the AHB
Page  899: AHB clock scheme selected. The ADC clock can eventually be divided by the following ratio:
Page  899: Option 2) has the advantage of bypassing the clock domain resynchronizations. This can be
Page  900: 1. Refer to the RCC section to see how adc_hclk and adc_ker_ck can be generated.
Page  900: 20 MHz, this bit can be cleared to save power.
Page  901: 1. ADCx_INNy signal can only be used when the corresponding ADC input channel is configured as
Page  902: 1. ADCx_INNy signal can only be used when the corresponding ADC input channel is configured as
Page  903: 1. ADCx_INNy signal can only be used when the corresponding ADC input channel is configured as
Page  904: After ADC operations are complete, the ADC can be disabled (ADEN=0). It is possible to
Page  905: Channels can be configured to be either single-ended input or differential input by writing
Page  905: ADC1/ADC2: this can make the channel on the other ADC unusable.
Page  906: The calibration is then initiated by software by setting bit ADCAL=1. Calibration can only be
Page  906: single-ended or differential input calibration). The 160-bit linearity calibration factor can be
Page  906: The calibration factor can be written if the ADC is enabled but not converting (ADEN=1 and
Page  906: 6.   The offset calibration factor can be read from ADC_CALFACT register.
Page  906: 7.   The linearity calibration factor can be read from ADC_CALFACT2 register, following the
Page  908: bit linearity correction factor can be read using the ADC_CALFACT2 30-bit registers (6 read
Page  908: be reset by hardware when the ADC_CALFACT2 register can be read (software must poll
Page  909: The software can access the linearity calibration factor by writing LINCALRDYW1..6 bits
Page  911: Once DEEPPWD=0 and ADVREGEN=1, the ADC can be enabled and the ADC needs a
Page  911: Regular conversion can then start either by setting ADSTART=1 (refer to Section 24.3.19:
Page  911: 3.    Wait until ADRDY=1 (ADRDY is set after the ADC startup time). This can be done
Page  912: The software can write the RCC control bits to configure and enable the ADC clock (refer to
Page  912: The software can write ADSTP or JADSTP control bits in the ADC_CR register only if the
Page  912: The software can write the register ADC_JSQR at any time, when the ADC is enabled
Page  912: consists of a sequence of conversions that can be done on any channel and in any order.
Page  913: ADC_SQRy registers must not be modified while regular conversions can occur. For this,
Page  913: analog switch integrated in the IO cannot react as fast as ADC mux do. To avoid the delay
Page  914: Each channel can be sampled with a different sampling time which is programmable using
Page  914: characteristics). This resistance can be minimized at low VDDA by enabling an internal
Page  915: Injected channels cannot be converted continuously. The only exception is when an injected
Page  917: The software can decide to stop regular conversions ongoing by setting ADSTP=1 and
Page  917: Stopping conversions will reset the ongoing ADC operation. Then the ADC can be
Page  917: The scan sequence is also aborted and reset (meaning that relaunching the ADC would re-
Page  919: A conversion or a sequence of conversions can be triggered either by software or by an
Page  919: Note:     The polarity of the regular trigger cannot be changed on-the-fly.
Page  919: Note:     The polarity of the injected trigger can be anticipated and changed on-the-fly when the
Page  919: The EXTSEL[4:0] and JEXTSEL[4:0] control bits select which out of 21 possible events can
Page  919: A regular group conversion can be interrupted by an injected trigger.
Page  920: Note:          The regular trigger selection cannot be changed on-the-fly.
Page  920: The injected trigger selection can be anticipated and changed on-the-fly. Refer to
Page  923: are automatically converted after the regular group of channels. This can be used to convert
Page  924: 1. The maximum latency value can be found in the electrical characteristics of the device datasheet.
Page  925: subgroup of the sequence can have less than n conversions).
Page  926: •    The JSQR register can be written at any moment even when injected conversions are
Page  926: of context is unchanged. An interrupt can be generated if bit JQOVFIE is set.
Page  926: –   If JQM=0, the Queue is empty just after enabling the ADC, but then it can never be
Page  926: –   If JQM=1, the Queue can be empty after the end of an injected sequence or if the
Page  926: Note:      When queue of context enabled (bit JQDIS=0), only hardware trigger can be used.
Page  929: ignored or not (an interrupt can be generated).
Page  929: can happen that the conversion is launched considering the context P2. To avoid this
Page  934: The resolution can be configured to be either 16, 14, 12, 10, 8 bits by programming the
Page  934: ADC_DR register. An interrupt can be generated if bit EOCIE is set. EOC flag is cleared by
Page  934: of the ADC_JDRy register. An interrupt can be generated if bit JEOCIE is set. JEOC flag is
Page  934: can be generated if bit EOSMPIE is set.
Page  934: available in the ADC_DR register. An interrupt can be generated if bit EOSIE is set. EOS
Page  934: complete. An interrupt can be generated if bit JEOSIE is set. JEOS flag is cleared by the
Page  936: of the data stored after conversion. Data can be right- or left-aligned as shown in
Page  936: Note:               The data can be re-aligned in normal and in oversampling mode.
Page  937: An offset y (y=1,2,3,4) can be applied to a channel by programming a value different from 0
Page  940: Sign-extended 17-bit significant data
Page  940: Sign-extended right-shifted 16-bit significant
Page  940: Sign-extended saturated 16-bit significant data
Page  941: An interrupt can be generated if bit OVRIE=1.
Page  941: When an overrun condition occurs, the ADC is still operating and can continue to convert
Page  941: If the conversions are slow enough, the conversion sequence can be handled by the
Page  941: register can be read. OVRMOD should be configured to 0 to manage overrun events as an
Page  942: the data transferred to the RAM can be considered as valid.
Page  942: •    Scan sequence is stopped and reset.
Page  943: available, “BREQ burst request” generated. DMA2 can be programmed either single
Page  943: The ADC conversion results can be transferred directly to the Digital Filter for Sigma Delta
Page  943: The ADC transfers 16 least significant bits of the regular data register data to the DFSDM,
Page  943: When AUTDLY=1, a new conversion can start only if all the previous data of the same group
Page  944: conversion can start only when the automatic delay of the previous injected sequence of
Page  944: can read all the data of a given sequence before starting a new sequence (see Figure 170).
Page  944: If this procedure is not respected, a new regular sequence can re-start if JEOS is cleared
Page  948: An interrupt can be enabled for each of the 3 analog watchdogs by setting AWDyIE in the
Page  949: The threshold can be up to 26-bits (16-bit resolution with oversampling, OSR=1024).
Page  949: The second and third analog watchdogs are more flexible and can guard several selected
Page  949: The threshold can be up to 26-bits (16-bit resolution with oversampling, OSR=1024) and are
Page  950: generation of ADCx_AWDy_OUT (ex: ADCy_AWDy_OUT can toggle while AWDx flag
Page  951: It provides a result with the following form, where N and M can be adjusted:
Page  952: and can range from 2x to 1024x. The division coefficient M consists of a right bit shift up to
Page  952: The summation unit can yield a result up to 26 bits (1024 x 16-bit results), which can be left
Page  952: least significant bits left apart by the shifting, before being transferred into the ADC_DR data
Page  953: aligned, the effective analog watchdog comparison can only be performed on 8 bits. The
Page  953: The averager can also be used for basic filtering purpose. Although not a very powerful filter
Page  953: (slow roll-off and limited stop band attenuation), it can be used as a notch filter to reject
Page  953: power supply). For this purpose, a specific discontinuous mode can be enabled with
Page  954: sequencers. The oversampling can be enabled for both sequencers with some limitations if
Page  954: least one regular conversion can be completed between triggers);
Page  954: not respected, the oversampling cannot be completed and the regular sequencer
Page  957: In devices with two ADCs or more, dual ADC modes can be used (see Figure 182):
Page  957: •   ADC1 and ADC2 can be used together in dual mode (ADC1 is master)
Page  958: In dual ADC mode, the converted data of the master and slave ADC can be read in parallel,
Page  958: by reading the ADC common data register (ADCx_CDR). The status bits can be also read in
Page  960: Regular conversions can be performed on one or all ADCs. In that case, they are
Page  960: This mode can be combined with AUTDLY mode:
Page  961: Software is notified by interrupts when it can read the data:
Page  961: is generated (if EOCIE is enabled) and software can read the ADC_DR of the master
Page  961: generated (if EOCIE is enabled) and software can read the ADC_DR of the slave ADC.
Page  962: This mode can be combined with AUTDLY mode:
Page  962: This mode can be started only on a regular group (usually one channel). The external
Page  962: sampling phase of the master conversion. This way, an ADC cannot start a conversion if the
Page  963: complementary ADC is still sampling its input (only one ADC can sample the input signal at
Page  963: The software is notified by interrupts when it can read the data at the end of each
Page  963: generated (if EOCIE is enabled) and the software can read the ADC_DR of the slave/master
Page  963: requests on each ADC cannot be used and it is mandatory to use the MDMA mode, as
Page  964: This mode can be started only on an injected group. The source of external trigger comes
Page  965: JEOC interrupts, if enabled, can also be generated after each injected conversion.
Page  965: Note:    Regular conversions can be enabled on one or all ADCs. In this case the regular
Page  966: JEOC interrupts, if enabled, can also be generated after each injected conversions.
Page  970: slave converter will be truncated to the least 16 significant bits.
Page  971: In dual ADC interleaved modes, the ADC conversion results can be transferred directly to
Page  972: The ADC transfers alternatively the 16 least significant bits of the regular data register from
Page  972: The temperature sensor can measure the junction temperature (TJ) of the device in the –40
Page  972: When not in use, the sensor can be put in power-down mode.
Page  973: Note:     The sensor has a startup time after waking from power-down mode before it can output
Page  974: The internal voltage reference can be monitored to have a reference point for evaluating the
Page  975: calibration data acquired by the ADC during the manufacturing process at VDDA = 3.3 V can
Page  975: absolute voltage value can be obtained by using the following formula:
Page  976: For each ADC, an interrupt can be generated:
Page  981: The software can program this bit field only when the ADC is disabled (ADCAL=0, JADSTART=0,
Page  982: hardware when the ADC_CALFACT2 register can be read (software must poll the bit until it is
Page  982: When the LINCALRDYW6 bit is reset, a new linearity factor 6 value can be written into the
Page  983: sequence and triggers can be re-configured. The ADC is then ready to accept a new start of injected
Page  983: sequence and triggers can be re-configured. The ADC is then ready to accept a new start of regular
Page  987: 1: JSQR Mode 1: The Queue can be empty and when this occurs, the software and hardware
Page  988: 00: Hardware trigger detection disabled (conversions can be launched by software)
Page  991: This bitfield is set and cleared by software to right-shift 1-bit data after offset1 correction. This bit can
Page 1002: 00: If JQDIS=1 (queue disabled), Hardware trigger detection disabled (conversions can be
Page 1003: This bit can be enabled only for 8-bit and 16-bit data format (see Section : Data register, data
Page 1003: converted data when converting a channel (can be regular or injected). The channel to which
Page 1003: result can be read from in the ADC_DR (regular conversion) or from in the ADC_JDRyi
Page 1008: Software can write these bits with a new calibration factor. If the new calibration factor is different
Page 1008: Software can write these bits with a new calibration factor. If the new calibration factor is different
Page 1009: Software can write these bits with a new calibration factor. If the new calibration factor is different
Page 1020: The DAC module is a 12-bit, voltage output digital-to-analog converter. The DAC can be
Page 1020: available for better resolution. An internal reference can also be set on the same input.
Page 1020: The DAC_OUTx pin can be used as general purpose input/output (GPIO) when the DAC
Page 1020: output buffer can be optionally enabled to allow a high drive output current. An individual
Page 1020: calibration can be applied on each DAC output channel. The DAC output channels support
Page 1020: •   Each DAC output can be disconnected from the DAC_OUTx output pin
Page 1023: •      The DAC_OUTx can be disconnected from the output pin and used as an ordinary
Page 1023: •      The dac_outx can use an internal pin connection to on-chip peripherals such as
Page 1023: The DAC includes up to two separate output channels. Each output channel can be
Page 1023: available). In this case, the DAC output channel can be disconnected from the DAC_OUTx
Page 1023: output pin and the corresponding GPIO can be used for another purpose.
Page 1023: The DAC output can be buffered or not. The Sample and Hold block and its associated
Page 1023: registers can run in Stop mode using the LSI clock source.
Page 1024: Each DAC channel can be powered on by setting its corresponding ENx bit in the DAC_CR
Page 1025: The DAC_DORx cannot be written directly and any data transfer to the DAC channelx must
Page 1026: If the TENx control bit is set, conversion can then be triggered by an external event (timer
Page 1026: Note:       TSELx[3:0] bit cannot be changed when the ENx bit is set.
Page 1027: application can manage both DAC channels in dual mode by using one DMA request and a
Page 1029: The MAMPx[3:0] bits must be configured before enabling the DAC, otherwise they cannot
Page 1029: Each DAC channel can be configured in Normal mode or Sample and Hold mode. The
Page 1029: output buffer can be enabled to allow a high drive capability. Before enabling output buffer,
Page 1029: after reset) and can be adjusted by software during application operation.
Page 1030: The sample/hold mode operations can be divided into 3 phases:
Page 1033: The user trimming can be done when the operating conditions differs from nominal
Page 1033: VREF+ values change and can be done at any point during application by software.
Page 1034: output channels can be used either independently or simultaneously.
Page 1034: registers. All the conversion modes can nevertheless be obtained using separate DHRx
Page 1039: Sleep                     No effect, DAC can be used with DMA
Page 1040: This bit is set and cleared by software to enable/disable DAC channel 2 calibration, it can be
Page 1040: written only if EN2 bit is set to 0 into DAC_CR (the calibration mode can be entered/exit only
Page 1042: This bit is set and cleared by software to enable/disable DAC channel 1 calibration, it can be
Page 1042: written only if bit EN1=0 into DAC_CR (the calibration mode can be entered/exit only when
Page 1050: 0:There is no write operation of DAC_SHSR2 ongoing: DAC_SHSR2 can be written
Page 1050: 1:There is a write operation of DAC_SHSR2 ongoing: DAC_SHSR2 cannot be written
Page 1050: 0:There is no write operation of DAC_SHSR1 ongoing: DAC_SHSR1 can be written
Page 1050: 1:There is a write operation of DAC_SHSR1 ongoing: DAC_SHSR1 cannot be written
Page 1052: These bits can be written only when the DAC is disabled and not in the calibration mode
Page 1052: They can be set and cleared by software to select the DAC Channel 2 mode:
Page 1052: Note: This register can be modified only when EN2=0.
Page 1052: These bits can be written only when the DAC is disabled and not in the calibration mode
Page 1052: They can be set and cleared by software to select the DAC Channel 1 mode:
Page 1052: Note: This register can be modified only when EN1=0.
Page 1053: These bits can be written when the DAC channel1 is disabled or also during normal operation.
Page 1053: in the latter case, the write can be done only when BWSTx of DAC_SCR register is low, If
Page 1053: These bits can be written when the DAC channel2 is disabled or also during normal
Page 1053: operation. in the latter case, the write can be done only when BWSTx of DAC_SR register is
Page 1054: Note: This register can be modified only when EN2=0.
Page 1054: Note: This register can be modified only when EN2=0.
Page 1054: Note:          These bits can be written only when the DAC channel is disabled and in Normal operating
Page 1055: Note: This register can be modified only when EN2=0.
Page 1055: Note: This register can be modified only when EN2=0.
Page 1055: Note:        These bits can be written only when the DAC channel is disabled and in Normal operating
Page 1058: can be used as voltage reference for ADCs, DACs and also as voltage reference for
Page 1058: The internal voltage reference can be configured in four different modes depending on
Page 1061: can be used for a variety of functions including:
Page 1062: The comparator outputs can be connected to the I/Os through their alternate functions.
Page 1063: The outputs can also be internally redirected to a variety of timer inputs for the following
Page 1063: The comparator output can be routed simultaneously internally and to the I/O pins.
Page 1064: work. In absence of the APB clock, the interrupt signal comp_it cannot be generated.
Page 1064: The comparators can be used for safety purposes, such as over-current or thermal
Page 1064: configuration can be protected against undesired alteration that could happen, for example,
Page 1064: For this purpose, the comparator configuration registers can be write-protected (read-only).
Page 1064: The write protection can only be removed through the MCU reset.
Page 1064: inverting input of the COMP channel 2 can be connected internally with the non-inverting
Page 1064: input of the COMP channel 1 by enabling WINMODE bit. This can save the input pins of
Page 1064: case of noisy signals. The hysteresis can be disabled if it is not needed (for instance when
Page 1066: PA6              AF10, AF12 (can be used as timer break in)
Page 1066: PA8              AF12 (can be used as timer break in)
Page 1066: PB12              AF13 (can be used as timer break in)
Page 1066: PE6              AF11 (can be used as timer break in)
Page 1066: PE15              AF13 (can be used as timer break in)
Page 1066: PG2              AF11 (can be used as timer break in)
Page 1066: PG3              AF11 (can be used as timer break in)
Page 1066: PG4              AF11 (can be used as timer break in)
Page 1066: PI1              AF11 (can be used as timer break in)
Page 1066: PI4              AF11 (can be used as timer break in)
Page 1066: PK2              AF10, AF11 (can be used as timer break in)
Page 1066: PA6              AF10, AF12 (can be used as timer break in)
Page 1066: PA8              AF12 (can be used as timer break in)
Page 1066: PB12              AF13 (can be used as timer break in)
Page 1066: PE6              AF11 (can be used as timer break in)
Page 1066: PE15              AF13 (can be used as timer break in)
Page 1066: PG2              AF11 (can be used as timer break in)
Page 1066: PG3              AF11 (can be used as timer break in)
Page 1066: PG4              AF11 (can be used as timer break in)
Page 1066: PI1              AF11 (can be used as timer break in)
Page 1066: PI4              AF11 (can be used as timer break in)
Page 1066: PK2              AF10, AF11 (can be used as timer break in)
Page 1067: The outputs of either COMP channel can be redirected to timer break inputs (TIMx_BKIN or
Page 1067: selected GPIO can be used as timer break input logic OR-ed with the comparator output.
Page 1067: The power consumption of the COMP channels versus propagation delay can be adjusted
Page 1067: The bits PWRMODE[1:0] in COMP_CFGRx registers can be programmed as follows:
Page 1068: Note:       The comparators cannot be used to exit the device from Sleep or Stop mode when the
Page 1068: controller. Each comparator has its own EXTI line and can generate either interrupts or
Page 1069: The amplifier and the resistor bridge can be enabled separately. The amplifier is enabled by
Page 1069: When the resistor divided voltage is not used, the resistor bridge can be disconnected in
Page 1078: three I/Os can be connected to the external pins, thus enabling any type of external
Page 1078: interconnections. The operational amplifiers can be configured internally as a follower, as an
Page 1078: Each OPAMP can be individually enabled, when disabled the output is high-impedance.
Page 1078: When enabled, it can be in calibration mode, all input and output of the OPAMP are then
Page 1078: application does not need to have read or write access to those registers, the clock can be
Page 1078: When the output of the operational amplifier is no more needed the operational amplifier can
Page 1079: and the voltage is 3 V. The trimming values can be adjusted, see Section 28.3.5: Calibration
Page 1079: provides the standard performance. The bit OPAHSM can be set in order to switch the
Page 1079: Signal routing and the default connection settings can be changed.
Page 1080: can be used in multiple configuration environments:
Page 1080: impedance. When the amplifier is enabled, it cannot be used as a general purpose I/O, even
Page 1080: leakage to create significant artifacts (due to a resistive drop in the source). Please refer to
Page 1080: (highest performance). The behavior of the OPAMP can be changed as follows:
Page 1080: •    OPAHSM can be set to “operational amplifier high-speed” mode in order to have high
Page 1080: •    USERTRIM can be set to modify the trimming values for input offsets.
Page 1081: OPAMP configured in follower mode can be used to perform impedance adaptation on input
Page 1083: Any external connection on INM can be used in parallel with the internal PGA, for
Page 1083: example a capacitor can be connected between opamp_out and INM for filtering
Page 1085: Any external connection on VM1 can be used in parallel with the internal PGA, for
Page 1085: example a capacitor can be connected between opamp_out and VM1 for filtering
Page 1086: Each operational amplifier can be trimmed by the user. Specific registers allow to have
Page 1086: The aim of the calibration is to cancel as much as possible the OPAMP inputs offset voltage.
Page 1087: All operational amplifier can be calibrated at the same time.
Page 1088: When OPAMP is configured as PGA mode, it can select the gain of x2,x4,x8,x16 for non-
Page 1088: When OPAMP is configured as non-inverting mode, the Gain error can be refer to the
Page 1096: mode and continuous mode. The data can be automatically stored in a system RAM buffer
Page 1096: A flexible timer triggering system can be used to control the start of conversion of DFSDM.
Page 1096: DFSDM features an analog watchdog function. Analog watchdog can be assigned to any of
Page 1096: values from the output data values. The extremes values stored can be restarted by
Page 1097: –    “regular” conversions can be requested at any time or even in continuous mode
Page 1102: The DFSDM serial channel transceivers can receive an external serial clock to sample an
Page 1102: DFSDM can provide one external output clock signal to drive external Σ∆ modulator(s) clock
Page 1102: There are 8 multiplexed serial data channels which can be selected for conversion by each
Page 1102: stream from external Σ∆ modulator. Data stream can be sent in SPI format or Manchester
Page 1102: Serial inputs (data and clock signals) from DATINy and CKINy pins can be redirected from
Page 1102: Channel redirection can be used to collect audio data from PDM (pulse density modulation)
Page 1103: A clock signal can be provided on CKOUT pin to drive external Σ∆ modulator clock inputs.
Page 1103: set to low state (output clock can be stopped by CKOUTDIV=0 in DFSDM_CHyCFGR1
Page 1104: signal is always provided from DATINy pin. A clock signal can be provided externally from
Page 1104: Note:       An internal clock source can only be used when the external Σ∆ modulator uses CKOUT
Page 1104: Internal clock source usage can save CKINy pin connection (CKINy pins can be used for
Page 1106: Channels serial clock inputs can be checked for clock absence/presence to ensure the
Page 1106: correct operation of conversion and error reporting. Clock absence detection can be
Page 1106: channel. A clock absence flag is set (CKABF[y] = 1) and an interrupt can be invoked (if
Page 1106: When the transceiver is not yet synchronized, the clock absence flag is set and cannot be
Page 1107: A clock absence flag is set (CKABF[y] = 1) and an interrupt can be invoked (if CKABIE=1) in
Page 1108: end of the synchronization can be checked by polling CKABF[y]=0 for a given channel after
Page 1108: Note:       When the transceiver is not yet synchronized, the clock absence flag is set and cannot be
Page 1109: An external serial clock input frequency can be measured by a timer counting DFSDM
Page 1109: The user can then compute the data rate according to the digital filter settings (FORD,
Page 1111: input). Each 16-bit parallel input can be sourced from internal data sources only:
Page 1111: Each channel contains a 32-bit data input register DFSDM_CHyDATINR in which it can be
Page 1111: written a 16-bit data. Data are in 16-bit signed format. Those data can be used as input to
Page 1112: can be used as data input in order to process digital data streams from memory or
Page 1112: Data can be written by CPU or DMA into DFSDM_CHyDATINR register:
Page 1112: DMA can be used at the same time - first DMA (configured as memory-to-memory
Page 1112: The accesses to DFSDM_CHyDATINR can be either 16-bit or 32-bit wide, allowing to load
Page 1112: (DFSDM_CHyDATINR) can be filled with one or two 16-bit data samples, depending on the
Page 1113: There are 8 multiplexed channels which can be selected for conversion using the injected
Page 1113: Injected conversions can operate in scan mode (JSCAN=1) or single mode (JSCAN=0). In
Page 1113: scan mode, each of the selected channels is converted, one after another. The lowest
Page 1113: (JSCAN=0), only one channel from the selected channels is converted, and the channel
Page 1113: selection is moved to the next channel. Writing to JCHG[7:0] if JSCAN=0 resets the channel
Page 1114: Injected conversions can be launched by software or by a trigger. They are never
Page 1114: Regular conversions can be launched only by software (not by a trigger). A sequence of
Page 1115: 256    +/- 256    +/- 65536        +/- 131072      +/- 16777216        Result can overflow on full scale
Page 1115: the theory about digital filters (more resources can be downloaded from internet).
Page 1115: to one data output from the integrator. IOSR can be set in the range 1-256 (see IOSR[7:0]
Page 1116: interrupt/event/break generation can then be invoked.
Page 1117: –    can be used in case of parallel input data source (DATMPX[1:0] ≠ 0 in
Page 1117: channels. For each channel, the result can be recorded in a separate flag (fields
Page 1117: AWFOSR = 0 (analog watchdog filter is bypassed) cannot be used for analog watchdog
Page 1118: An analog watchdog event can be assigned to break output signal. There are four break
Page 1118: given time. This behavior can detect short-circuit or open circuit errors (e.g. overcurrent or
Page 1118: overvoltage). An interrupt/event/break generation can be invoked.
Page 1119: circuit event is invoked. Each input channel has its short-circuit detector. Any channel can
Page 1119: On each channel, a short-circuit detector event can be assigned to break output signal
Page 1119: Short circuit detector cannot be used in case of parallel input data channel selection
Page 1119: The minimum and maximum register values can be refreshed by software (by reading given
Page 1120: bit and data coming from the processing path can be up to 32 bits. This right bit-shift is
Page 1120: Each DFSDM input serial channel can be connected to one external Σ∆ modulator. An
Page 1120: external Σ∆ modulator can have 2 differential inputs (positive and negative) which can be
Page 1121: Injected conversions can be launched using the following methods:
Page 1121: configuration settings (JSCAN, JCHG, etc.).
Page 1121: If the scan conversion is enabled (bit JSCAN=1) then, each time an injected conversion is
Page 1121: If the scan conversion is disabled (bit JSCAN=0) then, each time an injected conversion is
Page 1121: next selected channel. Writing to the JCHG[7:0] bits when JSCAN=0 sets the channel
Page 1121: Only one injected conversion can be ongoing at a given time. Thus, any request to launch
Page 1121: Regular conversions can be launched using the following methods:
Page 1121: Only one regular conversion can be pending or ongoing at a given time. Thus, any request
Page 1121: already been issued but not yet completed. A regular conversion can be pending if it was
Page 1122: The regular conversions executing in continuous mode can be stopped by writing ‘0’ to
Page 1122: In continuous mode, the data rate can be increased by setting the FAST bit in the
Page 1122: Continuous mode is not available for injected conversions. Injected conversions can be
Page 1122: An injected conversion cannot be launched if another injected conversion is pending or
Page 1122: Similarly, a regular conversion cannot be launched if another regular conversion is pending
Page 1122: conversion can temporarily interrupt a sequence of continuous regular conversions. When
Page 1125: To decrease the CPU intervention, conversions can be transferred into memory using a
Page 1125: This value can be modified only when DFSDMEN=0 (in DFSDM_CH0CFGR1 register).
Page 1126: This value can only be modified when DFSDMEN=0 (in DFSDM_CH0CFGR1 register).
Page 1126: This value can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1126: There can be written one or two 16-bit data samples according DATPACK[1:0] bit field setting.
Page 1126: Note: This value can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1126: This value can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1127: This value can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1127: This value can only be modified when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1128: This value can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1128: This bit can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1128: This bit can be modified only when CHEN=0 (in DFSDM_CHyCFGR1 register).
Page 1130: Data can be written by CPU/DMA (if DATMPX[1:0]=2) or directly by internal ADC (if
Page 1130: Data can be written by CPU/DMA (if DATMPX[1:0]=2) or directly by internal ADC (if
Page 1130: Res.    JEXTEN[1:0]                JEXTSEL[4:0]               Res.    Res.          JSCAN JSYNC    Res.           DFEN
Page 1131: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1131: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1131: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1132: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1132: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1132: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1132: Bit 4 JSCAN: Scanning conversion mode for injected conversions
Page 1132: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1132: Writing JCHG if JSCAN=0 resets the channel selection to the lowest selected channel.
Page 1132: This bit can be modified only when DFEN=0 (DFSDM_FLTxCR1).
Page 1135: This bit is set by hardware. It can be cleared by software using the corresponding CLRSCDF[y] bit in
Page 1135: CKABF[y]=1 state by hardware when the transceiver is not yet synchronized.It can be cleared by
Page 1135: This bit is set by hardware. It can be cleared by software using the CLRROVRF bit in the
Page 1136: This bit is set by hardware. It can be cleared by software using the CLRJOVRF bit in the
Page 1136: Note:            For each of the flag bits, an interrupt can be enabled by setting the corresponding bit in
Page 1136: set and cannot be cleared by CLRCKABF[y].
Page 1137: If JSCAN=1, each of the selected channels is converted, one after another. The lowest channel
Page 1137: If JSCAN=0, then only one channel is converted from the selected channels, and the channel
Page 1137: selection is moved to the next channel. Writing JCHG, if JSCAN=0, resets the channel selection to
Page 1138: This bit can only be modified when DFEN=0 (DFSDM_FLTxCR1).
Page 1138: This bit can only be modified when DFEN=0 (DFSDM_FLTxCR1)
Page 1138: This bit can only be modified when DFEN=0 (DFSDM_FLTxCR1)
Page 1139: converted (because regular channel selection RCH[2:0] in DFSDM_FLTxCR1 register can be
Page 1141: AWHTF[y]=1 indicates a high threshold error on channel y. It is set by hardware. It can be cleared by
Page 1141: AWLTF[y]=1 indicates a low threshold error on channel y. It is set by hardware. It can be cleared by
Page 1148: JSCAN
Page 1149: Res.                                                                                            Res.                    AWDF                     AWDIE                            JSCAN               Res.                                                           Res.                              Res.               4
Page 1150: JSCAN
Page 1151: JSCAN
Page 1154: from the camera are stable and can be sampled. The maximum DCMI_PIXCLK period must
Page 1154: The digital camera interface is a synchronous parallel interface that can receive high-speed
Page 1154: The pixel clock has a programmable polarity, so that data can be captured on either the
Page 1154: The data received from the camera can be organized in lines/frames (raw YUB/RGB/Bayer
Page 1154: modes) or can be a sequence of JPEG images. To enable JPEG image reception, the JPEG
Page 1156: The camera interface can capture 8-bit, 10-bit, 12-bit or 14-bit data depending on the
Page 1157: 2. DCMI_HSYNC and DCMI_VSYNC can change states at the same time.
Page 1157: data at its input DCMI_D[0..9] and stores them as the 10 least significant bits of a 16-bit
Page 1157: word. The remaining most significant bits in the DCMI_DR register (bits 11 to 15) are
Page 1158: 12-bit data at its input DCMI_D[0..11] and stores them as the 12 least significant bits of a 16-
Page 1158: bit word. The remaining most significant bits are cleared to zero. So, in this case a 32-bit
Page 1158: 14-bit data at its input DCMI_D[0..13] and stores them as the 14 least significant bits of a 16-
Page 1158: bit word. The remaining most significant bits are cleared to zero. So, in this case a 32-bit
Page 1159: Transfer can then be continuous, with successive frames transferred by DMA to successive
Page 1160: Note:       Camera modules can have 8 such codes (in interleaved mode). For this reason, the
Page 1160: This mode can be supported by programming the following codes:
Page 1160: programmed code. You can therefore select a bit to compare in the embedded code and
Page 1160: detect a frame/line start or frame/line end. This means that there can be different codes for
Page 1161: 2. DCMI_HSYNC and DCMI_VSYNC can change states at the same time.
Page 1162: 2. DCMI_HSYNC and DCMI_VSYNC can change states at the same time.
Page 1162: In continuous grab mode, you can configure the FCRC bits in DCMI_CR to grab all pictures,
Page 1162: capture rate even further, the IT_VSYNC interrupt can be used to count the number of
Page 1162: With the crop feature, the camera interface can select a rectangular window from the
Page 1162: value can only be a multiple of 4 (two least significant bits are forced to 0) to allow the
Page 1163: 2. DCMI_HSYNC and DCMI_VSYNC can change states at the same time.
Page 1163: The crop feature and embedded synchronization codes cannot be used in the JPEG format.
Page 1164: Figure 239. Pixel raster scan order
Page 1165: in a raster scan order, that is from top to bottom for pixel rows, and from left to right within a
Page 1168: data enable. The crop and embedded synchronization features (ESS bit) cannot
Page 1182: can be used for other purposes.
Page 1184: The LCD controller can be reset by setting the corresponding bit in the RCC_APBRSTR
Page 1184: The LCD-TFT controller provides flexible configurable parameters. It can be enabled or
Page 1185: polarity can be programmed to active high or active low through the LTDC_GCR register.
Page 1186: A constant background color (RGB888) can programmed through the LTDC_BCCR register.
Page 1186: The dithering can be switched On and Off on the fly through the LTDC_GCR register.
Page 1186: Some configuration registers are shadowed. The shadow registers values can be reloaded
Page 1186: can only be read after the reload has taken place.
Page 1186: A register reload interrupt can be generated if enabled in the LTDC_IER register.
Page 1186: Up to two layers can be enabled, disabled and configured separately. The layer display
Page 1186: Every layer can be positioned and resized and it must be inside the active display area.
Page 1187: Up to 8 input pixel formats can be configured for every layer through the LTDC_LxPFCR
Page 1189: The CLUT can be enabled at run-time for every layer through the LTDC_LxCR register and
Page 1190: The blending is always active and the two layers can be blended following the blending
Page 1190: Every layer can have a default color in the format ARGB which is used outside the defined
Page 1190: A color key (RGB) can be configured to be representative for a transparent pixel.
Page 1190: The color key value can be configured and used at run-time to replace the pixel RGB value.
Page 1191: The interrupt sources can be enabled or disabled separately through the LTDC_IER
Page 1192: LTDC_LxCKCR registers. They can be also enabled on the fly.
Page 1192: •   All layer parameters can be modified on the fly except the CLUT. The new configuration
Page 1193: Bits 10:0 VSH[10:0]: vertical synchronization height (in units of horizontal scan line)
Page 1194: and the start of the active display part of the next scan line.
Page 1194: Bits 10:0 AVBP[10:0]: accumulated Vertical back porch (in units of horizontal scan line)
Page 1194: The vertical back porch is the number of horizontal scan lines at a start of frame to the start of
Page 1194: the first active scan line of the next frame.
Page 1194: The active width is the number of pixels in active display area of the panel scan line.
Page 1194: Bits 10:0 AAH[10:0]: accumulated active height (in units of horizontal scan line)
Page 1195: Bits 10:0 TOTALH[10:0]: total height (in units of horizontal scan line)
Page 1197: This bit is set by software and cleared only by hardware after reload (it cannot be cleared
Page 1211: disabled. The CLUT can be enabled or disabled in the LTDC_LxCR register.
Page 1217: The JPEG codec can decode a JPEG stream as defined in the ISO/IEC 10918-1
Page 1217: It can optionally parse the JPEG header and update accordingly the JPEG codec registers,
Page 1217: Input FIFO can be managed using interrupts or MDMA triggers through two flags according
Page 1217: •    Input FIFO not full flag: a 32-bit value can be written in.
Page 1217: •    Input FIFO threshold flag: 8 words (32 bytes) can be written in.
Page 1217: interrupt request / MDMA trigger may be pending. The FIFO can be flushed by setting the
Page 1217: The header parsing can be activated setting the HDR bit of the JPEG_CONFR1 register.
Page 1218: The output FIFO can be managed using interrupts or MDMA triggers through two flags
Page 1218: •    Output FIFO not empty flag: a 32-bit value can be read out.
Page 1218: •    Output FIFO Threshold flag: 8 words (32 bytes) can be read out.
Page 1218: JPEG_CONFR0 register, the output FIFO can be flushed. If the FIFO needs to be flushed, it
Page 1218: The JPEG codec can encode a JPEG stream as defined in the ISO/IEC 10918-1
Page 1218: It can optionally generate the JPEG Header.
Page 1219: Input FIFO can be managed using interrupts or MDMA triggers through two flags according
Page 1219: •    Input FIFO not full flag: a 32-bit value can be written in.
Page 1219: •    Input FIFO threshold flag: 8 words (32 bytes) can be written in.
Page 1219: interrupt request / MDMA trigger may be pending. The FIFO can be flushed by setting the
Page 1219: Output FIFO can be managed using interrupts or MDMA triggers through two flags
Page 1219: •    Output FIFO not empty flag: a 32-bit value can be read out.
Page 1219: •    Output FIFO threshold flag: 8 words (32 bytes) can be read out.
Page 1219: JPEG_CONFR0 register, the output FIFO can be flushed. The FIFO can be flushed by
Page 1220: The EOCF bit (end of conversion flag) of the JPEG_SR register can only be cleared when
Page 1220: An interrupt can be produced on the following events:
Page 1221: Bits 7: 6 NS[1:0]: Number of components for scan
Page 1221: This field defines the number of components minus 1 for scan header marker segment.
Page 1226: This bit flags that the input FIFO is not full (data can be written).
Page 1230: The RNG can be used to construct a NIST compliant Deterministic Random Bit Generator
Page 1230: •   It can be disabled to reduce power consumption.
Page 1233: A data output buffer can store up to four 32-bit words which have been output from the
Page 1234: Note:       An interrupt can be generated when an error is detected.
Page 1235: The associated initialization time can be found in Section 33.6: RNG processing time.
Page 1235: –     If above two conditions are true the content of the RNG_DR register can be read
Page 1235: buffer, four additional words can be read by the application (in this case the DRDY
Page 1236: additional words can be read by the application (in this case the DRDY bit will still be
Page 1236: If the power consumption is a concern to the application, low-power strategies can be used,
Page 1237: contents can still be used.
Page 1237: If power consumption is a concern, the RNG can be disabled as soon as the DRDY bit is set
Page 1237: •    If there are valid words in the output buffer four random numbers can still be read from
Page 1237: numbers can be still be read from the RNG_DR register. If it is not the case the RNG
Page 1238: In the RNG an interrupt can be produced on the following events:
Page 1238: The user can enable or disable the above interrupt sources individually by changing the
Page 1238: individual interrupt sources can be read from the RNG_SR register.
Page 1238: The conditioning stage can produce four 32-bit random numbers every 16x ------------  clock
Page 1238: tested the peripheral against AIS-31 PTG.2 set of tests. The results can be provided on
Page 1238: demand or the customer can reproduce the measurements using the AIS reference
Page 1240: The clock error detection cannot be enabled nor disabled on-the-fly when the RNG is
Page 1241: Note: The DRDY bit can rise when the peripheral is disabled (RNGEN=’0’ in the RNG_CR
Page 1244: The cryptographic processor (CRYP) can be used both to encrypt and decrypt data using
Page 1244: American National Standards Institute (ANSI X9.52)
Page 1247: Typical usage of the cryptographic processor in DES modes can be found
Page 1248: The following chaining algorithms are supported by the DES hardware and can be selected
Page 1248: A description of cryptographic processor typical usage in AES mode can be found in
Page 1249: The following chaining algorithms are supported by the cryptographic processor and can be
Page 1249: A quick introduction on these chaining modes can be found in the following subsections.
Page 1253: Like GCM CCM chaining mode, AES-CCM mode can be applied on a message composed
Page 1256: 6.   When the operation is complete, the cryptographic processor can be disabled by
Page 1256: b)   If it is not the last block, load the data into the IN FIFO. You can load only one
Page 1257: a)   Read the output data from the OUT FIFO. You can read only one block (2 words
Page 1257: FIFOs are empty (IFEM=1 and OFNE=0). You can disable the interrupt by clearing
Page 1258: scheduling operation can be performed only once for all the data to be decrypted with a
Page 1260: A message can be suspended if another message with a higher priority has to be
Page 1260: processed. When this highest priority message has been sent, the suspended message can
Page 1260: processing can be resumed as soon as cryptographic processor is enabled again to receive
Page 1260: A detailed description of suspend/resume operations can be found in each AES mode
Page 1261: Detailed DES/TDES encryption sequence can be found in Section 34.3.5: CRYP procedure
Page 1262: Detailed DES/TDES encryption sequence can be found in Section 34.3.5: CRYP procedure
Page 1264: Detailed DES/TDES encryption sequence can be found in Section 34.3.5: CRYP procedure
Page 1265: Detailed DES/TDES encryption sequence can be found in Section 34.3.5: CRYP procedure
Page 1265: CRYP_SR) and the BUSY bit is cleared. Alternatively, as the input FIFO can contain up
Page 1271: length. This length can be non-multiple of 16 bytes, in which case a plaintext padding is
Page 1273: peripheral increments the least significant 32 bits (leaving the other most significant 96 bits
Page 1274: message, and resume the message which was interrupted. Detailed CBC sequence can be
Page 1275: known length Len(A) that can be non-multiple of 16 bytes and cannot exceed 264-1
Page 1275: known length Len(P) that can be non-multiple of 16 bytes, and cannot exceed 232 -2
Page 1277: Note:    This phase can be skipped if there is no additional authenticated data, i.e. Len(A)=0.
Page 1278: Note:       This phase can be skipped if there is no payload data, i.e. Len(C)=0 (see GMAC mode).
Page 1280: GMAC is exactly the same as GCM algorithm except that only header phase (2) can be
Page 1281: –           Flags: most significant byte containing four flags for control information, as
Page 1281: Note:         The cryptographic peripheral can only manage padded plaintext/ciphertext messages of
Page 1282: known length, ALen, that can be a non-multiple of 16 bytes (see Figure 272). The
Page 1282: and encrypted as ciphertext C, with a known length of Plen. This length can be a non-
Page 1282: multiple of 16 bytes (see Figure 272) but cannot exceed 232 blocks of 128-bit.
Page 1282: Note:       CCM chaining mode can also be used with associated data only (i.e. no payload).
Page 1283: the most significant bits containing P byte length also zeroed, then incremented by one (see
Page 1283: Input data        most significant bits        B0[63:32]            B0[95:64]      bits are set to 0, except for
Page 1284: Note:       This phase can be skipped if there is no associated data (Alen=0).
Page 1285: Note:    This phase can be skipped if there is no payload data, i.e. Plen=0 or Clen=Tlen
Page 1287: is written at the end. CRYP_DIN data endianness can be described as below when
Page 1287: FIFO. The MSB of the output block is read at the end. CRYP_DOUT data endianness can
Page 1293: DMA can be enabled for writing data into the cryptographic peripheral by setting the DIEN
Page 1295: You can enable or disable CRYP interrupt sources individually by changing the mask bits in
Page 1295: The status of the individual maskable interrupt sources can be read either from the
Page 1295: interrupt status. The status of the individual source of event flags can be read from the
Page 1299: Writing KEYSIZE bits while BUSY=1 has no effect. These bits can only be
Page 1299: Writing DATATYPE bits while BUSY=1 has no effect. These bits can only be
Page 1299: Writing ALGOMODE bits while BUSY=1 has no effect. These bits can only be
Page 1299: Writing ALGODIR bit while BUSY=1 has no effect. It can only be configured
Page 1300: To fit different data sizes, the data can be swapped after processing by configuring the
Page 1301: To fit different data sizes, the data can be swapped after processing by configuring the
Page 1309: processor can then be used by the preemptive task. Then when the cryptographic
Page 1309: computation is complete, the saved context can be read from memory and written back into
Page 1316: bit, 256 bit and 128-bit output string called a message digest. The message digest can then
Page 1316: word, the most significant bit is stored in the left-most bit position. For example message
Page 1316: HASH_DIN data endianness when bit swapping is disabled (DATATYPE=”00”) can be
Page 1316: described as following: the least significant bit of the message has to be at MSB position in
Page 1318: transferred via DMA. Note that the processing of a block can start only once the last
Page 1318: processor is ready again (DINIS=1 in HASH_SR), the software can write new data
Page 1319: 4.   Once computed, the digest can be read from the output registers as described in
Page 1319: Algorithm         Valid output registers    Most significant bit    Digest size (in bits)
Page 1319: As the length (number of bits) of a message can be any integer value, the last word written
Page 1321: Note:    Endianness details can be found in Section 35.3.4: Message data feeding.
Page 1321: and computation starts, the HMAC result can be found in the HASH_H0...HASH_H7
Page 1324: When the DMA is not used to load the message into the hash processor, the context can be
Page 1325: The hash processor provides an interface to connect to the DMA controller. This DMA can
Page 1326: The above interrupt sources can be enabled or disabled individually by changing the mask
Page 1326: The status of the individual interrupt events can be read from the HASH_SR register.
Page 1326: The time required to process the last block of a message (or of a key in HMAC) can be
Page 1326: Compared to the processing of an intermediate block, it can be increased by the factor
Page 1331: the hash processor (that is the number of valid least significant bits in the last data
Page 1332: In all cases, the digest most significant bit is stored in HASH_HR0[31] and it is not used.
Page 1336: 1: A new block can be entered into the input buffer. An interrupt is generated if
Page 1337: values have to be saved in the system memory space. Then the hash processor can be
Page 1337: context can be read from memory and written back into the HASH_CSRx registers.
Page 1339: The high-resolution timer can generate up to 10 digital signals with highly accurate timings.
Page 1339: supplies or lighting systems, but can be of general purpose usage, whenever a very fine
Page 1340: –    10 outputs that can be controlled by any timing unit, up to 32 set/reset sources per
Page 1340: –    5 fault inputs can be combined and associated to any timing unit
Page 1340: •   Multiple HRTIM instances can be synchronized with external synchronization
Page 1341: The HRTIM can be partitioned into several sub entities:
Page 1341: The master timer is based on a 16-bit up counter. It can set/reset any of the 10 outputs via 4
Page 1341: The burst mode controller can take over the control of one or multiple timers in case of light-
Page 1341: load operation. The burst length and period can be programmed, as well as the idle state of
Page 1342: generalized using the “x” letter, where x can be any value from A to E.
Page 1343: HRTIM_CHC1,                         Main HRTIM timer outputs. They can be coupled by pairs (HRTIM_CHx1 &
Page 1343: hrtim_evt5[4:1]                   External events. Each of the 10 events can be selected among 4 sources,
Page 1345: HRTIM_MCR register), the prescaler cannot be modified.
Page 1346: The burst mode controller counter clock fBRST can be supplied by several sources, among
Page 1346: The fault input noise rejection filter has a time constant defined with fSAMPLING which can be
Page 1346: The fault input noise rejection filter has a time constant defined with fSAMPLING which can be
Page 1347: Each unit includes all control features for 2 outputs, so that it can operate as a standalone
Page 1348: Timer A..E can operate in continuous (free-running) mode or in single-shot manner where
Page 1348: The counter can be reset at any time.
Page 1348: The TxEN bit can be cleared at any time to disable the timer and stop the counting.
Page 1350: The reset of the timing unit counter can be triggered by up to 30 events that can be selected
Page 1350: Several events can be selected simultaneously to handle multiple reset sources. In this
Page 1351: The timing units have a repetition counter. This counter cannot be read, but solely
Page 1351: The repetition counter can also be used when the counter is reset before reaching the
Page 1352: Each of the timing units handles the set/reset crossbar for two outputs. These 2 outputs can
Page 1352: be set, reset or toggled by up to 32 events that can be selected among the following
Page 1352: The event sources are ORed and multiple events can be simultaneously selected.
Page 1353: Table 296 summarizes the events from other timing units that can be used to set and reset
Page 1353: For instance, Timer A outputs can be set or reset by the following events: Timer B
Page 1354: The capture of the timing unit counter can be triggered by up to 28 events that can be
Page 1354: Several events can be selected simultaneously to handle multiple capture triggers. In this
Page 1354: case, the concurrent trigger requests are ORed. The capture can generate an interrupt or a
Page 1355: instance an output change can happen with a programmed timing following a capture. In
Page 1355: the timing unit and cannot be read. The HRTIM_CMPxR preload register is not modified
Page 1355: and HRTIM_CMP4xR Compares cannot be programmed with a value below 3 fHRTIM clock
Page 1357: As an example, Figure 290 shows how the following signal can be generated:
Page 1358: A delayed compare is used for the output reset: the compare event can be generated only if
Page 1358: compare event can be generated and will happen when the counter is equal to 12, causing
Page 1359: Note:         The push-pull operation cannot be used when a deadtime is enabled (mutually exclusive
Page 1360: HRTIM_RSTx2R registers are not significant when DTEN bit is set.
Page 1360: Note:           The deadtime cannot be used simultaneously with the push-pull mode.
Page 1360: Two deadtimes can be defined in relationship with the rising edge and the falling edge of the
Page 1361: Negative deadtime values can be defined when some control overlap is required. This is
Page 1364: over any outputs, but still can be used indirectly by the set/reset crossbars.
Page 1364: •        It can only be reset by the external synchronization circuitry
Page 1365: Compare 4 simultaneously (i.e. when the effective set/reset cannot be determined a priori
Page 1366: The HRTIM timer can handle events not generated within the timer, referred to as “external
Page 1366: channel (with a 4:1 multiplexer) and to convert it into an information that can be processed
Page 1366: Up to 10 external event channels can be conditioned and are available simultaneously for
Page 1368: 8          -        Yes           -            Yes         PB6             -          TIM6_TRGO          TTCAN_TMP
Page 1368: 9          -        Yes           -            Yes         PB7       OPAMP1           TIM15_TRGO         TTCAN_RTP
Page 1368: 10          -        Yes           -             -         PG13             -          LPTIM2 OUT         TTCAN_SOC
Page 1368: 1. OPAMP1_VOUT can be used as High-resolution timer internal event source. In this case, OPAMP1_VOUT (PC4) pin must
Page 1368: trigger. If OPAMP1 is disabled, PC4 pin, configured in input mode, can be used as HRTIM external events.
Page 1369: the edge-sensitivity cannot be programmed.
Page 1369: A fast external event cannot be used to toggle an output: if must be enabled either in
Page 1369: When EExFAST bit is set, the output cannot be changed during the 11 fHRTIM clock periods
Page 1371: They can be used directly and are active as soon as the timing unit counter is enabled
Page 1371: They can also be filtered to have an action limited in time, usually related to the counting
Page 1371: period. Two operations can be performed:
Page 1372: selected timing unit counter reset to one of its compare match, or can be fully
Page 1374: given in Table 301. As an example, the external events in timer B can be filtered by a
Page 1376: Note:       The delayed idle mode cannot be exited immediately after having been entered, before the
Page 1376: before resuming the run mode. This can be done by waiting up to the next period, for
Page 1376: The delayed idle mode can be applied to a single output (DLYPRT[2:0] = x00 or x01) or to
Page 1376: An interrupt or a DMA request can be generated in response to a Delayed Idle mode entry.
Page 1376: When the Delayed Idle mode is triggered, the output states can be determined using
Page 1376: The delayed protection mode can be triggered only when the counter is enabled (TxCEN bit
Page 1380: push-pull is maintained for one additional period so that the shorten pulse can be repeated:
Page 1381: CMP4 event is reserved and cannot be used for another purpose.
Page 1381: The minimum pulsewidth that can be handled in balanced idle mode is 4 fHRTIM clock
Page 1381: the re-start sequence can be initiated for output 1 first. To do so, it is necessary to poll
Page 1381: The balanced idle protection mode can be triggered only when the counter is enabled
Page 1382: Balanced idle can be used together with the burst mode under the following conditions:
Page 1382: Most of HRTIM registers are buffered and can be preloaded if needed. Typically, this allows
Page 1382: Table 302 lists the registers which can be preloaded, together with a summary of available
Page 1383: registers. In this case, any pending hardware update request is cancelled.
Page 1383: Note: The update can take place immediately after the end of the burst sequence if
Page 1383: An interrupt or a DMA request can be generated by the master update event.
Page 1384: Each timer (TIMA..E) can also have the update done as follows:
Page 1384: the registers. In this case, any pending hardware update request is canceled.
Page 1384: •   Update done on the update event following a Burst DMA completion (the event can be
Page 1384: (the event can be enabled with TxREPU, MSTU or TxU). This is enabled when
Page 1384: can be updated simultaneously with TIMB). This is used for converters requiring
Page 1384: An interrupt or a DMA request can be generated by the Timx update event.
Page 1385: update request is ignored and the preload registers can be accessed without any risk to
Page 1385: update request is ignored and the preload registers can be accessed without any risk to
Page 1385: TAUDIS, TDUDIS and TEUDIS bits can be reset: the transfer from preload to active
Page 1385: the source event can be used to trigger a simultaneous update in any of TIMx timing units.
Page 1386: Software update                 MSWU = 1             No        the HRTIM_CR2 register and can be used for a
Page 1386: given event can be used to trigger a simultaneous update in another or multiple TIMx timers.
Page 1386: TyRST=1 in                      Can be done simultaneously with update in
Page 1387: Software update                  TySWU = 1             No     the HRTIM_CR2 register and can be used for a
Page 1387: Table 306 lists the counter reset sources and indicates whether they can be used to
Page 1388: Table 307 lists the update event sources and indicates whether they can be used to
Page 1388: No        HRTIM_CR2 register and can
Page 1389: •       RUN: this is the main operating mode, where the output can take the active or inactive
Page 1389: inputs. It can be permanently active, inactive or Hi-Z.
Page 1390: triggered. Faults can be triggered by any external or internal fault source, as listed in
Page 1390: Section 36.3.15, while the Idle state can be entered when the burst mode or delayed
Page 1391: During the HRTIM initialization, the output level can be prepositioned prior to have it in RUN
Page 1391: loads. It can significantly increase the efficiency of the converter by reducing the number of
Page 1392: •     A counter that can be clocked by various sources, either within or outside the HRTIM
Page 1393: It can operate in continuous or single-shot mode, using BMOM bit in the HRTIM_BMCR
Page 1393: The counters of the timing units and the master timer can be stopped and reset during the
Page 1393: The burst mode controller counter can be clocked by several sources, selected with
Page 1394: These sources can be combined to have multiple concurrent triggers.
Page 1396: DIDLx bits can be set only if one of the outputs has an active idle level during the burst
Page 1397: enable bit is set in the HRTIM_IER register. This interrupt can be used to synchronize the
Page 1398: Consequently, an output with an active idle state can be reset at the time the burst mode is
Page 1398: exited even if no transition is explicitly programmed. For symmetrical reasons, an output can
Page 1400: A high-frequency carrier can be added on top of the timing unit output signals to drive
Page 1401: The chopper parameters can be adjusted using the HRIM_CHPxR register, with the
Page 1401: The duty cycle can be adjusted by 1/8 step with CARDTY[2:0], from 0/8 up to 7/8 duty cycle.
Page 1401: waiting for the current carrier period to be completed. It can thus contain shorter pulses than
Page 1401: CARFRQ[2:0], CARDTY[2:0] and STRPW[3:0] bitfields cannot be modified while the
Page 1401: The HRTIM has 5 FAULT input channels; all of them are available and can be combined for
Page 1402: signal, that can be either a digital input or an internal event (built-in comparator output).
Page 1402: The polarity of the signal can be selected to define the active level, using the FLTxP polarity
Page 1402: The fault information can be filtered after the polarity setting. If FLTxF[3:0] bitfield is set to
Page 1404: HRTIM_FLTxR register, and they can be selected simultaneously (the sysfault is
Page 1406: The signal on the auxiliary output can be slightly distorted when exiting from the burst mode
Page 1407: This feature can also be used to synchronize the HRTIM with other timers, either external or
Page 1407: Four events can be selected as the source to be sent to the synchronization output. This is
Page 1408: The HRTIM can be synchronized by external sources, as per the programming of the
Page 1408: This bitfield cannot be changed once the destination timer (master timer or timing unit) is
Page 1408: counter can solely be re-started with the synchronization). Any reset
Page 1409: Single-shot                       counter can solely be started by the synchronization). A reset occurring
Page 1409: 0        1    occurring after the counter start has no effect (the counter can solely be
Page 1410: The ADCs can be triggered by the master and the 5 timing units.
Page 1410: the 2 ADCs. Up to 32 events can be combined (ORed) for each trigger output, in registers
Page 1410: The external events can be used as a trigger. They are taken right after the conditioning
Page 1410: phases can be sampled in a row using a single ADC trigger output.
Page 1411: HRTIM_ADC1R to HRTIM_ADC4R registers are preloaded and can be updated
Page 1411: The update events from the master timer and the timer units can generate DAC update
Page 1413: 7 interrupts can be generated by the master timer:
Page 1413: 14 interrupts can be generated by each timing unit:
Page 1415: Most of the events able to generate an interrupt can also generate a DMA request, even
Page 1416: The burst DMA feature is only available for one DMA channel, but any of the 6 channels can
Page 1418: from the counter value and can be combined with regular update events, if necessary
Page 1418: The HRTIM control registers can be initialized as per the power converter topology and the
Page 1419: The HRTIM operation can eventually be started by setting TxCEN or MCEN bits in
Page 1419: maintain a safe state during the execution stepping. The outputs can be enabled again
Page 1419: Fault status bits can be set and TxyOEN bits reset during the MCU halt if a fault occurs at
Page 1420: Buck converters are of common use as step-down converters. The HRTIM can control up to
Page 1421: replacing the freewheeling diode. Synchronous rectification can be turned on or off on the fly
Page 1422: Multiphase techniques can be applied to multiple power conversion topologies (buck,
Page 1422: The HRTIM is able to manage multiple converters. The number of converters that can be
Page 1423: The ADC trigger can be generated on TxCMP2 compare event. Since all ADC trigger
Page 1426: (either due to roll-over or reset events). MREPU can be set only if BRSTDMA[1:0] = 00 or 01.
Page 1426: A DAC synchronization event can be enabled and generated when the master timer update occurs.
Page 1428: Note: This parameter cannot be changed once the impacted timers are enabled.
Page 1428: 0: The timer is not re-triggerable: a counter reset can be done only if the counter is stopped (period
Page 1428: The prescaling ratio cannot be modified once the timer is enabled.
Page 1433: Holds the master timer counter value. This register can only be written when the master timer is
Page 1437: The update events, as mentioned below, can be: MSTU, TEU, TDU, TCU, TBU, TAU, TxRSTU,
Page 1440: The prescaling ratio cannot be modified once the timer is enabled.
Page 1441: significant in this configuration.
Page 1447: This register holds the Timerx counter value. It can only be written when the timer is stopped
Page 1449: This register can behave as an auto-delayed compare register, if enabled with DELCMP2[1:0] bits in
Page 1450: This register can behave as an auto-delayed compare register, if enabled with DELCMP4[1:0] bits in
Page 1455: This bit forces the output to its active state. This bit can only be set by software and is reset by
Page 1456: These bits are defining the source which can force the Tx1 output to its inactive state.
Page 1456: These bits are defining the source which can force the Tx2 output to its active state.
Page 1457: These bits are defining the source which can force the Tx2 output to its inactive state.
Page 1465: This bitfield cannot be modified when one of the CHPx bits is set.
Page 1465: This register defines the duty cycle of the carrier signal. This bitfield cannot be modified when one of
Page 1465: This bitfield cannot be modified when one of the CHPx bits is set.
Page 1470: This bit can delay the idle mode entry by forcing a deadtime insertion before switching the outputs to
Page 1470: Note: This parameter cannot be changed once the timer x is enabled.
Page 1470: DIDL=1 can be set only if one of the outputs is active during the burst mode (IDLES=1), and
Page 1470: Note: This parameter cannot be changed once the timer x is enabled.
Page 1470: Note: This parameter cannot be changed once the timer x is enabled (TxCEN bit set), if FLTENx bit is
Page 1470: Note: This bit is preloaded and can be changed during run-time, but must not be changed while the
Page 1471: Note: This parameter cannot be changed once the timer x is enabled.
Page 1471: Note: This parameter cannot be changed once the timer x is enabled (TxEN bit set).
Page 1471: Note: This parameter cannot be changed once the timer is operating (TxEN bit set) or if its outputs
Page 1471: This bit can delay the idle mode entry by forcing a deadtime insertion before switching the outputs to
Page 1471: Note: This parameter cannot be changed once the timer x is enabled.
Page 1471: DIDL=1 can be set only if one of the outputs is active during the burst mode (IDLES=1), and
Page 1472: Note: This parameter cannot be changed once the timer x is enabled.
Page 1472: Note: This parameter cannot be changed once the timer x is enabled (TxCEN bit set), if FLTENx bit is
Page 1472: Note: This bit is preloaded and can be changed during runtime, but must not be changed while burst
Page 1472: Note: This parameter cannot be changed once the timer x is enabled.
Page 1473: The FLTLCK bit is write-once. Once it has been set, it cannot be modified till the next system reset.
Page 1473: 1: Fault 5 input is active and can disable HRTIM outputs.
Page 1473: 1: Fault 4 input is active and can disable HRTIM outputs.
Page 1473: 1: Fault 3 input is active and can disable HRTIM outputs.
Page 1473: 1: Fault 2 input is active and can disable HRTIM outputs.
Page 1473: 1: Fault 1 input is active and can disable HRTIM outputs.
Page 1476: the preload to the active register and any pending update request is cancelled.
Page 1476: the preload to the active register in the master timer and any pending update request is cancelled.
Page 1482: Reading the bit returns the output disable status. It is not significant when the output is active
Page 1483: This bit defines how the timer behaves during a burst mode operation. This bitfield cannot be
Page 1483: This bit defines how the timer behaves during a burst mode operation. This bitfield cannot be
Page 1484: Defines the prescaling ratio of the fHRTIM clock for the burst mode controller. This bitfield cannot be
Page 1484: This bitfield defines the clock source for the burst mode counter. It cannot be changed while the
Page 1487: Note: BMCMP[15:0] cannot be set to 0x0000 when using the fHRTIM clock without a prescaler as the
Page 1489: This bit is only significant if EE1SNS[1:0] = 00.
Page 1489: Note: This parameter cannot be changed once the timer x is enabled. It must be configured prior to
Page 1489: Note: This parameter cannot be changed once the timer x is enabled. It must be configured prior to
Page 1500: The FLT5LCK bit modifies the write attributes of the fault programming bit, so that they can be
Page 1500: This bit is write-once. Once it has been set, it cannot be modified till the next system reset.
Page 1500: 1: FLT5E, FLT5P, FLT5SRC, FLT5F[3:0] bits can no longer be written (read-only mode)
Page 1501: Note: This bitfield can be written only when FLT5E enable bit is reset.
Page 1501: This bitfield cannot be modified when FLT5LOCK has been programmed.
Page 1501: Note: This bitfield can be written only when FLT5E enable bit is reset
Page 1501: Note: This bitfield can be written only when FLT5E enable bit is reset
Page 1506: 1. This register can be preloaded (see Table 302 on page 1383).
Page 1510: This register can be preloaded (see Table 302 on page 1383).
Page 1513: This register can be preloaded (see Table 302 on page 1383).
Page 1514: Pulse lengths and waveform periods can be modulated from a few microseconds to several
Page 1514: independent, and do not share any resources. They can be synchronized together as
Page 1516: related auto-reload register. The counter can count up, down or both up and down. The
Page 1516: counter clock can be divided by a prescaler.
Page 1516: The counter, the auto-reload register and the prescaler register can be written or read by
Page 1516: TIMx_CR1 register. It can also be generated by software. The generation of the update
Page 1516: The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
Page 1516: It can be changed on the fly as this control register is buffered. The new prescaler ratio is
Page 1518: The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1
Page 1522: The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1
Page 1525: In this mode, the DIR direction bit in the TIMx_CR1 register cannot be written. It is updated
Page 1525: The update event can be generated at each counter overflow and at each counter underflow
Page 1525: The UEV update event can be disabled by software by setting the UDIS bit in the TIMx_CR1
Page 1529: counter has reached zero. This can be useful when generating PWM signals.
Page 1531: The timer features an external trigger input ETR. It can be used as:
Page 1531: ETP bit in TIMxSMCR register. The trigger can be prescaled with the divider programmed
Page 1532: The counter clock can be provided by the following clock sources:
Page 1532: register) and UG bits (in the TIMx_EGR register) are actual control bits and can be changed
Page 1532: This mode is selected when SMS=111 in the TIMx_SMCR register. The counter can count at
Page 1534: The counter can count at each rising or falling edge on the external trigger input ETR.
Page 1536: Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be
Page 1539: a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was
Page 1539: already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be
Page 1539: cycles. We must program a filter duration longer than these 5 clock cycles. We can
Page 1539: Note:    IC interrupt and/or DMA requests can be generated by software by setting the
Page 1540: For example, the user can measure the period (in TIMx_CCR1 register) and the duty cycle
Page 1540: (OCxREF and then OCx/OCxN) can be forced to active or inactive level directly by software,
Page 1540: The OCxREF signal can be forced low by writing the OCxM bits to 0100 in the
Page 1541: performed and allows the flag to be set. Interrupt and DMA requests can be sent
Page 1541: elapsed. Channels 1 to 4 can be output, while Channel 5 and 6 are only available inside the
Page 1541: bit in the TIMx_CCER register). The output pin can keep its level (OCXM=0000), be set
Page 1541: active (OCxM=0001), be set inactive (OCxM=0010) or can toggle (OCxM=0011) on
Page 1541: The TIMx_CCRx registers can be programmed with or without preload registers using the
Page 1541: The timing resolution is one count of the counter. Output compare mode can also be used to
Page 1541: The TIMx_CCRx register can be updated at any time by software to control the output
Page 1542: The PWM mode can be selected independently on each channel (one PWM per OCx
Page 1542: can be programmed as active high or active low. OCx output is enabled by a combination of
Page 1545: can lead to unexpected results. In particular:
Page 1545: Asymmetric PWM mode can be selected independently on two channel (one OCx output
Page 1545: Note:     The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1545: bit is not contiguous with the 3 least significant ones.
Page 1545: can also be used. For instance, if an OC1REFC signal is generated on channel 1
Page 1545: Figure 380 represents an example of signals that can be generated using Asymmetric PWM
Page 1546: Combined PWM mode can be selected independently on two channels (one OCx output per
Page 1546: Note:        The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1546: bit is not contiguous with the 3 least significant ones.
Page 1546: Figure 381 represents an example of signals that can be generated using Asymmetric PWM
Page 1547: Combined 3-phase PWM mode can be selected independently on channels 1 to 3 by setting
Page 1548: The TRGO2 waveform shows how the ADC can be synchronized on given 3-phase PWM
Page 1548: The advanced-control timers (TIM1/TIM8) can output two complementary signals and
Page 1548: You can select the polarity of the outputs (main output OCx or complementary OCxN)
Page 1550: In output mode (forced, output compare or PWM), OCxREF can be re-directed to the OCx
Page 1550: internal MCU events can also be selected to trigger an output shut-down.
Page 1550: and can force the outputs to a predefined level (either active or inactive) after a deadtime
Page 1551: shut-down level, either active or inactive. The OCx and OCxN outputs cannot be
Page 1551: When exiting from reset, the break circuit is disabled and the MOE bit is low. You can enable
Page 1551: input polarities can be selected by configuring the BKP and BKP2 bits in the same register.
Page 1551: BKEx and BKPx can be modified at the same time. When the BKEx and BKPx bits are
Page 1551: Because MOE falling edge can be asynchronous, a resynchronization circuit has been
Page 1551: Break events can also be generated by software using BG and B2G bits in the TIMx_EGR
Page 1553: after a dead-time. Even in this case, OCx and OCxN cannot be driven to their
Page 1553: can be sent if the BDE bit in the TIMx_DIER register is set.
Page 1553: at the next update event (UEV). As an example, this can be used to perform a
Page 1553: case, it can be used for security and you can connect the break input to an alarm from
Page 1553: Note:    The break inputs are active on level. Thus, the MOE cannot be set while the break input is
Page 1553: cannot be cleared.
Page 1553: when disabled, OCxM configurations, break enable and polarity). The application can
Page 1553: LOCK bits can be written only once after an MCU reset.
Page 1555: –       The BRK input can either disable (inactive state) or force the PWM outputs to a
Page 1555: –       BRK2 can only disable (inactive state) the PWM outputs.
Page 1556: The OCxREF signal of a given channel can be cleared when a high level is applied on the
Page 1556: OCxREF remains low until the next update event (UEV) occurs. This function can only be
Page 1557: 3.   The External Trigger Polarity (ETP) and the External Trigger Filter (ETF) can be
Page 1558: COM commutation event. Thus you can program in advance the configuration for the next
Page 1558: step and change the configuration of all the channels at the same time. COM can be
Page 1558: A flag is set when the COM event occurs (COMIF bit in the TIMx_SR register), which can
Page 1559: Starting the counter can be controlled through the slave mode controller. Generating the
Page 1559: waveform can be done in output compare mode or PWM mode. You select One-pulse mode
Page 1559: A pulse can be correctly generated only if the compare value is different from the counter
Page 1560: register. You can optionally enable the preload registers by writing OC1PE=’1’ in the
Page 1560: minimum delay tDELAY min we can get.
Page 1560: If you want to output a waveform with the minimum delay, you can set the OCxFE bit in the
Page 1560: most significant bit are not contiguous with the 3 least significant ones.
Page 1561: register. When needed, you can program the input filter as well. CC1NP and CC2NP must
Page 1562: A quadrature encoder can be connected directly to the MCU without external interface logic.
Page 1563: current position. You can obtain dynamic information (speed, acceleration, deceleration) by
Page 1563: capture mode. The output of the encoder which indicates the mechanical zero can be used
Page 1563: for this purpose. Depending on the time between two events, the counter can also be read
Page 1563: at regular times. You can do this by latching the counter value into a third input capture
Page 1563: register if available (then the capture signal must be periodic and can be generated by
Page 1563: overwritten by the UIFCPY flag upon read access (the counter’s most significant bit is only
Page 1563: in an atomic way. In particular cases, it can ease the calculations by avoiding race
Page 1564: The XOR output can be used with all the timer input functions such as trigger or input
Page 1564: The “interfacing timer” can be used in output mode to generate a pulse which changes the
Page 1565: TIMx_CCMR1 register to ‘01’. You can also program the digital filter if needed,
Page 1565: written after a COM event for the next step (this can be done in an interrupt subroutine
Page 1567: can be synchronized in several modes: Reset mode, Gated mode, and Trigger mode.
Page 1567: The counter and its prescaler can be reinitialized in response to an event on a trigger input.
Page 1567: request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register).
Page 1568: The counter can be enabled depending on the level of a selected input.
Page 1568: The counter can start in response to an event on a selected input.
Page 1569: The external clock mode 2 can be used in addition to another slave mode (except external
Page 1569: input, and another input can be selected as trigger input (in reset mode, gated mode or
Page 1571: The timer can generate an ADC triggering event with various internal signals, such as reset,
Page 1571: a total of 16 possible events, which can be selected using the MMS2[3:0] bits in the
Page 1571: software overhead, but it can also be used to read several registers in a row, at regular
Page 1572: Note:       A null value can be written to the reserved registers.
Page 1572: disabled (as if the MOE bit was reset). The outputs can either be forced to an inactive state
Page 1572: outputs are disabled (as if the MOE bit was reset). The outputs can either be forced to an
Page 1574: These events can be:
Page 1574: Note: External clock, gated mode and encoder mode can work only if the CEN bit has been
Page 1574: previously set by software. However trigger mode can set the CEN bit automatically by
Page 1575: master timer can then be used as a prescaler for a slave timer.
Page 1576: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1576: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1576: timer can then be used as a prescaler for a slave timer.
Page 1578: prescaler can be enabled to reduce ETRP frequency. It is useful when inputting fast external
Page 1581: Refer to CC1IF description (Note: Channel 6 can only be configured as output)
Page 1581: Refer to CC1IF description (Note: Channel 5 can only be configured as output)
Page 1581: This flag is set by hardware as soon as the system break input goes active. It can be
Page 1582: This flag is set by hardware as soon as the break 2 input goes active. It can be cleared by
Page 1582: This flag is set by hardware as soon as the break input goes active. It can be cleared by
Page 1583: can occur if enabled.
Page 1583: DMA transfer can occur if enabled.
Page 1583: 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if
Page 1583: This bit can be set by software, it is automatically cleared by hardware
Page 1584: This bit can be set by software, it is automatically cleared by hardware.
Page 1584: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1584: can have a different meaning for the input stage and for the output stage.
Page 1586: Note: These bits can not be modified as long as LOCK level 3 has been programmed (LOCK
Page 1587: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the
Page 1587: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1587: 2: The PWM mode can be used without validating the preload register only in one
Page 1592: can actually be done into the input capture/compare register 1 (TIMx_CCR1) or not.
Page 1593: output state is defined by the GPIO controller and can be
Page 1593: Note: BRK2 can only be used if OSSI = OSSR = 1.
Page 1595: input capture 1 event (IC1). The TIMx_CCR1 register is read-only and cannot be
Page 1596: input capture 2 event (IC2). The TIMx_CCR2 register is read-only and cannot be
Page 1596: input capture 3 event (IC3). The TIMx_CCR3 register is read-only and cannot be
Page 1597: input capture 4 event (IC4). The TIMx_CCR4 register is read-only and cannot be
Page 1597: can be write-locked depending on the LOCK configuration, it can be necessary to configure
Page 1597: Note: This bit cannot be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1598: Note: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1598: Note: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1598: Note: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1599: 0: MOE can be set only by software
Page 1599: 1: MOE can be set by software or automatically at the next update event (if none of the break
Page 1599: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1599: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1599: Note: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1599: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1600: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1600: register and BKE/BKP/AOE bits in TIMx_BDTR register can no longer be written.
Page 1600: as OSSR and OSSI bits can no longer be written.
Page 1600: CCxS bits) can no longer be written.
Page 1600: Note: The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register
Page 1600: Note: This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1601: transfers. Transfers can be in half-words or in bytes (see example below).
Page 1602: Refer to the above CCMR1 register description. Channels 5 and 6 can only be configured in
Page 1603: This bit can either have immediate effect or be preloaded and taken into account after an
Page 1603: This bit can either have immediate effect or be preloaded and taken into account after an
Page 1603: This bit can either have immediate effect or be preloaded and taken into account after an
Page 1604: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1605: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1606: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1606: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1606: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1606: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1607: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1607: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1607: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1607: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1608: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1608: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1608: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1608: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1608: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1609: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1609: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1609: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1609: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1610: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1619: Pulse lengths and waveform periods can be modulated from a few microseconds to several
Page 1619: The timers are completely independent, and do not share any resources. They can be
Page 1621: reload register. The counter can count up, down or both up and down but also down or both
Page 1621: up and down. The counter clock can be divided by a prescaler.
Page 1621: The counter, the auto-reload register and the prescaler register can be written or read by
Page 1621: TIMx_CR1 register. It can also be generated by software. The generation of the update
Page 1621: The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
Page 1621: register). It can be changed on the fly as this control register is buffered. The new prescaler
Page 1623: An Update event can be generated at each counter overflow or by setting the UG bit in the
Page 1623: The UEV event can be disabled by software by setting the UDIS bit in TIMx_CR1 register.
Page 1626: An Update event can be generate at each counter underflow or by setting the UG bit in the
Page 1626: The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1
Page 1629: In this mode, the direction bit (DIR from TIMx_CR1 register) cannot be written. It is updated
Page 1629: The update event can be generated at each counter overflow and at each counter underflow
Page 1629: The UEV update event can be disabled by software by setting the UDIS bit in TIMx_CR1
Page 1633: The counter clock can be provided by the following clock sources:
Page 1633: example, you can configure Timer 13 to act as a prescaler for Timer 2. Refer to : Using
Page 1633: control bits and can be changed only by software (except UG which remains cleared
Page 1634: This mode is selected when SMS=111 in the TIMx_SMCR register. The counter can count at
Page 1635: The counter can count at each rising or falling edge on the external trigger input ETR.
Page 1637: Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be
Page 1639: a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was
Page 1639: already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be
Page 1639: cycles. We must program a filter duration longer than these 5 clock cycles. We can
Page 1639: Note:    IC interrupt and/or DMA requests can be generated by software by setting the
Page 1640: For example, you can measure the period (in TIMx_CCR1 register) and the duty cycle (in
Page 1640: 1. The PWM input mode can be used only with the TIMx_CH1/TIMx_CH2 signals due to the fact that only
Page 1641: (OCxREF and then OCx) can be forced to active or inactive level directly by software,
Page 1641: ocxref signal can be forced low by writing the OCxM bits to 100 in the TIMx_CCMRx
Page 1641: performed and allows the flag to be set. Interrupt and DMA requests can be sent
Page 1641: bit in the TIMx_CCER register). The output pin can keep its level (OCXM=000), be set
Page 1641: active (OCxM=001), be set inactive (OCxM=010) or can toggle (OCxM=011) on match.
Page 1641: The TIMx_CCRx registers can be programmed with or without preload registers using the
Page 1641: The timing resolution is one count of the counter. Output compare mode can also be used to
Page 1642: The TIMx_CCRx register can be updated at any time by software to control the output
Page 1642: The PWM mode can be selected independently on each channel (one PWM per OCx
Page 1642: can be programmed as active high or active low. OCx output is enabled by the CCxE bit in
Page 1642: of the counter). However, to comply with the OCREF_CLR functionality (OCREF can be
Page 1645: can lead to unexpected results. In particular:
Page 1646: Asymmetric PWM mode can be selected independently on two channels (one OCx output
Page 1646: Note:       The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1646: bit is not contiguous with the 3 least significant ones.
Page 1646: When a given channel is used as asymmetric PWM channel, its secondary channel can also
Page 1646: Figure 435 shows an example of signals that can be generated using Asymmetric PWM
Page 1646: Combined PWM mode can be selected independently on two channels (one OCx output per
Page 1647: Note:            The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1647: bit is not contiguous with the 3 least significant ones.
Page 1647: Figure 436 shows an example of signals that can be generated using Asymmetric PWM
Page 1647: The OCxREF signal of a given channel can be cleared when a high level is applied on the
Page 1647: OCxREF remains low until the next update event (UEV) occurs. This function can only be
Page 1648: The OCxREF signal for a given channel can be reset by applying a high level on the ETRF
Page 1648: This function can be used only in the output compare and PWM modes. It does not work in
Page 1648: For example, the OCxREF signal can be connected to the output of a comparator to be
Page 1648: 3.   The external trigger polarity (ETP) and the external trigger filter (ETF) can be
Page 1649: Starting the counter can be controlled through the slave mode controller. Generating the
Page 1649: waveform can be done in output compare mode or PWM mode. You select One-pulse mode
Page 1649: A pulse can be correctly generated only if the compare value is different from the counter
Page 1650: register. You can optionally enable the preload registers by writing OC1PE=1 in the
Page 1650: minimum delay tDELAY min we can get.
Page 1650: If you want to output a waveform with the minimum delay, you can set the OCxFE bit in the
Page 1650: Note:       In retriggerable one pulse mode, the CCxIF flag is not significant.
Page 1650: most significant bit is not contiguous with the 3 least significant ones.
Page 1651: register. CC1NP and CC2NP must be kept cleared. When needed, you can program the
Page 1652: An external incremental encoder can be connected directly to the MCU without external
Page 1653: current position. You can obtain dynamic information (speed, acceleration, deceleration) by
Page 1653: capture mode. The output of the encoder which indicates the mechanical zero can be used
Page 1653: for this purpose. Depending on the time between two events, the counter can also be read
Page 1653: at regular times. You can do this by latching the counter value into a third input capture
Page 1653: register if available (then the capture signal must be periodic and can be generated by
Page 1653: overwritten by the UIFCPY flag upon read access (the counter’s most significant bit is only
Page 1653: The XOR output can be used with all the timer input functions such as trigger or input
Page 1654: The TIMx Timers can be synchronized with an external trigger in several modes: Reset
Page 1654: The counter and its prescaler can be reinitialized in response to an event on a trigger input.
Page 1654: request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register).
Page 1654: The counter can be enabled depending on the level of a selected input.
Page 1655: The counter can start in response to an event on a selected input.
Page 1656: The external clock mode 2 can be used in addition to another slave mode (except external
Page 1656: input, and another input can be selected as trigger input when operating in reset mode,
Page 1657: one Timer is configured in Master Mode, it can reset, start, stop or clock the counter of
Page 1658: For example, you can configure TIM3 to act as a prescaler for TIM2. Refer to Figure 446. To
Page 1659: value by resetting both timers before starting TIM3. You can then write any value you want
Page 1659: in the timer counters. The timers can easily be reset by software using the UG bit in the
Page 1659: Figure 446 for connections. Timer 2 starts counting from its current value (which can be
Page 1660: As in the previous example, you can initialize both counters before starting counting.
Page 1661: bits). Both counters starts from 0, but you can easily insert an offset between them by
Page 1661: writing any of the counter registers (TIMx_CNT). You can see that the master/slave mode
Page 1661: software overhead, but it can also be used to read several registers in a row, at regular
Page 1662: Note:       A null value can be written to the reserved registers.
Page 1662: outputs are disabled (as if the MOE bit was reset). The outputs can either be forced to an
Page 1664: The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).
Page 1665: These events can be:
Page 1665: Note: External clock, gated mode and encoder mode can work only if the CEN bit has been
Page 1665: previously set by software. However trigger mode can set the CEN bit automatically by
Page 1666: timer can then be used as a prescaler for a slave timer.
Page 1667: prescaler can be enabled to reduce ETRP frequency. It is useful when inputting fast external
Page 1670: ITR6                                         -                      -                 fdcan1_soc
Page 1673: 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if
Page 1673: This bit can be set by software, it is automatically cleared by hardware.
Page 1673: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1673: can have a different meaning for the input stage and for the output stage.
Page 1675: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1676: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the
Page 1676: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1676: 2: The PWM mode can be used without validating the preload register only in one-
Page 1680: CC1 channel configured as input: This bit determines if a capture of the counter value can
Page 1681: CNT[31]: Most significant bit of counter value (on TIM2 and TIM5)
Page 1681: Bits 30:16 CNT[30:16]: Most significant part counter value (on TIM2 and TIM5)
Page 1681: Bits 15:0 CNT[15:0]: Least significant part of counter value
Page 1682: TIMx_CCR1 register is read-only and cannot be programmed.
Page 1682: TIMx_CCR2 register is read-only and cannot be programmed.
Page 1683: TIMx_CCR3 register is read-only and cannot be programmed.
Page 1683: TIMx_CCR4 register is read-only and cannot be programmed.
Page 1685: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1685: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1686: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1686: Note: These bits can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1690: 0001: fdcan1_tmp
Page 1690: 0010: fdcan1_rtp
Page 1694: Pulse lengths and waveform periods can be modulated from a few microseconds to several
Page 1694: resources. They can be synchronized together as described in Section 39.3.17: Timer
Page 1694: between 1 and 65536 (can be changed “on the fly”)
Page 1695: between 1 and 65536 (can be changed “on the fly”)
Page 1697: counter clock can be divided by a prescaler.
Page 1697: The counter, the auto-reload register and the prescaler register can be written or read by
Page 1697: reaches the overflow and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be
Page 1697: The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
Page 1697: It can be changed on the fly as this control register is buffered. The new prescaler ratio is
Page 1699: The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1
Page 1702: The counter clock can be provided by the following clock sources:
Page 1702: timer. For instance, another timer can be configured as a prescaler for TIM12. Refer to
Page 1702: register are then used as control bits and can be changed only by software (except for UG
Page 1703: This mode is selected when SMS=’111’ in the TIMx_SMCR register. The counter can count
Page 1704: Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be
Page 1706: a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was
Page 1706: already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be
Page 1706: clock cycles. We can validate a transition on TI1 when 8 consecutive samples with the
Page 1707: Note:    IC interrupt requests can be generated by software by setting the corresponding CCxG bit in
Page 1707: For example, you can measure the period (in TIMx_CCR1 register) and the duty cycle (in
Page 1708: 1. The PWM input mode can be used only with the TIMx_CH1/TIMx_CH2 signals due to the fact that only
Page 1708: (OCxREF and then OCx) can be forced to active or inactive level directly by software,
Page 1708: The OCxREF signal can be forced low by writing the OCxM bits to ‘0100’ in the
Page 1709: performed and allows the flag to be set. Interrupt requests can be sent accordingly. This is
Page 1709: bit in the TIMx_CCER register). The output pin can keep its level (OCxM=’0000’), be
Page 1709: set active (OCxM=’0001’), be set inactive (OCxM=’0010’) or can toggle (OCxM=’0011’)
Page 1709: The TIMx_CCRx registers can be programmed with or without preload registers using the
Page 1709: The timing resolution is one count of the counter. Output compare mode can also be used to
Page 1709: The TIMx_CCRx register can be updated at any time by software to control the output
Page 1710: The PWM mode can be selected independently on each channel (one PWM per OCx
Page 1710: It can be programmed as active high or active low. The OCx output is enabled by the CCxE
Page 1711: Combined PWM mode can be selected independently on two channels (one OCx output per
Page 1711: Note:     The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1711: bit is not contiguous with the 3 least significant ones.
Page 1711: Figure 471 represents an example of signals that can be generated using combined PWM
Page 1712: Starting the counter can be controlled through the slave mode controller. Generating the
Page 1712: waveform can be done in output compare mode or PWM mode. You select One-pulse mode
Page 1712: A pulse can be correctly generated only if the compare value is different from the counter
Page 1713: TIMx_CCMR1 register. You can optionally enable the preload registers by writing
Page 1714: minimum delay tDELAY min we can get.
Page 1714: If you want to output a waveform with the minimum delay, you can set the OCxFE bit in the
Page 1714: most significant bit are not contiguous with the 3 least significant ones.
Page 1715: UIFCPY flag. In particular cases, it can ease the calculations by avoiding race conditions
Page 1715: The XOR output can be used with all the timer input functions such as trigger or input
Page 1715: The TIM12 timer can be synchronized with an external trigger in several modes: Reset
Page 1715: The counter and its prescaler can be reinitialized in response to an event on a trigger input.
Page 1716: trigger flag is set (TIF bit in the TIMx_SR register) and an interrupt request can be sent if
Page 1716: The counter can be enabled depending on the level of a selected input.
Page 1717: The counter can start in response to an event on a selected input.
Page 1719: accesses can be done by bytes (8 bits), half-words (16 bits) or words (32 bits).
Page 1720: 0: Any of the following events generates an update interrupt if enabled. These events can
Page 1720: Note: External clock and gated mode can work only if the CEN bit has been previously set by
Page 1720: software. However trigger mode can set the CEN bit automatically by hardware.
Page 1721: timer can then be used as a prescaler for a slave timer.
Page 1724: 1: The TIF flag is set in the TIMx_SR register. Related interrupt can occur if enabled
Page 1725: This bit can be set by software, it is automatically cleared by hardware.
Page 1725: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1725: bit can have different meanings for the input stage and the output stage.
Page 1727: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new
Page 1727: Note: The PWM mode can be used without validating the preload register only in one-pulse
Page 1729: This bit determines if a capture of the counter value can actually be done into the input
Page 1735: accesses can be done by bytes (8 bits), half-words (16 bits) or words (32 bits).
Page 1736: Note: External clock and gated mode can work only if the CEN bit has been previously set by
Page 1736: software. However trigger mode can set the CEN bit automatically by hardware.
Page 1738: This bit can be set by software, it is automatically cleared by hardware.
Page 1738: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1738: can have a different meaning for the input stage and for the output stage.
Page 1739: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the new
Page 1739: Note: The PWM mode can be used without validating the preload register only in one pulse
Page 1741: This bit determines if a capture of the counter value can actually be done into the input
Page 1746: Pulse lengths and waveform periods can be modulated from a few microseconds to several
Page 1746: resources. TIM15 can be synchronized as described in Section 40.4.21: Timer
Page 1748: 1. The internal break event source can be:
Page 1749: 1. The internal break event source can be:
Page 1750: related auto-reload register. The counter clock can be divided by a prescaler.
Page 1750: The counter, the auto-reload register and the prescaler register can be written or read by
Page 1750: reaches the overflow and if the UDIS bit equals 0 in the TIMx_CR1 register. It can also be
Page 1750: The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
Page 1750: It can be changed on the fly as this control register is buffered. The new prescaler ratio is
Page 1752: The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1
Page 1756: has reached zero. This can be useful when generating PWM signals.
Page 1757: The counter clock can be provided by the following clock sources:
Page 1757: another timer, for example, you can configure TIM1 to act as a prescaler for TIM15.
Page 1757: register) and UG bits (in the TIMx_EGR register) are actual control bits and can be changed
Page 1758: This mode is selected when SMS=111 in the TIMx_SMCR register. The counter can count at
Page 1759: Then, an edge detector with polarity selection generates a signal (TIxFPx) which can be
Page 1762: a DMA request can be sent if they are enabled. If a capture occurs while the CCxIF flag was
Page 1762: already high, then the over-capture flag CCxOF (TIMx_SR register) is set. CCxIF can be
Page 1762: cycles. We must program a filter duration longer than these 5 clock cycles. We can
Page 1762: Note:       IC interrupt and/or DMA requests can be generated by software by setting the
Page 1763: For example, you can measure the period (in TIMx_CCR1 register) and the duty cycle (in
Page 1763: 1. The PWM input mode can be used only with the TIMx_CH1/TIMx_CH2 signals due to the fact that only
Page 1764: (OCxREF and then OCx/OCxN) can be forced to active or inactive level directly by software,
Page 1764: The OCxREF signal can be forced low by writing the OCxM bits to 100 in the TIMx_CCMRx
Page 1764: performed and allows the flag to be set. Interrupt and DMA requests can be sent
Page 1764: bit in the TIMx_CCER register). The output pin can keep its level (OCXM=000), be set
Page 1764: active (OCxM=001), be set inactive (OCxM=010) or can toggle (OCxM=011) on match.
Page 1764: The TIMx_CCRx registers can be programmed with or without preload registers using the
Page 1764: The timing resolution is one count of the counter. Output compare mode can also be used to
Page 1765: The TIMx_CCRx register can be updated at any time by software to control the output
Page 1765: The PWM mode can be selected independently on each channel (one PWM per OCx
Page 1766: can be programmed as active high or active low. OCx output is enabled by a combination of
Page 1767: Combined PWM mode can be selected independently on two channels (one OCx output per
Page 1767: Note:            The OCxM[3:0] bit field is split into two parts for compatibility reasons, the most significant
Page 1767: bit is not contiguous with the 3 least significant ones.
Page 1767: Figure 499 represents an example of signals that can be generated using Asymmetric PWM
Page 1768: The TIM15/TIM16/TIM17 general-purpose timers can output one complementary signal and
Page 1768: You can select the polarity of the outputs (main output OCx or complementary OCxN)
Page 1769: In output mode (forced, output compare or PWM), OCxREF can be re-directed to the OCx
Page 1770: application fault (from input pins and built-in comparator), and can force the outputs to a
Page 1770: down level, either active or inactive. The OCx and OCxN outputs cannot be set both to
Page 1770: polarity can be selected by configuring the BKP bit in the same register. BKE and BKP can
Page 1770: Because MOE falling edge can be asynchronous, a resynchronization circuit has been
Page 1770: The break can be generated from multiple sources which can be individually enabled and
Page 1772: after a dead-time. Even in this case, OCx and OCxN cannot be driven to their
Page 1772: •   The break status flag (BIF bit in the TIMx_SR register) is set. An interrupt can be
Page 1772: generated if the BIE bit in the TIMx_DIER register is set. A DMA request can be sent if
Page 1772: at the next update event UEV. This can be used to perform a regulation, for instance.
Page 1772: Else, MOE remains low until you write it to ‘1’ again. In this case, it can be used for
Page 1772: security and you can connect the break input to an alarm from power drivers, thermal
Page 1772: Note:       The break inputs is acting on level. Thus, the MOE cannot be set while the break input is
Page 1772: active (neither automatically nor by software). In the meantime, the status flag BIF cannot
Page 1772: The break can be generated by the BRK input which has a programmable polarity and an
Page 1772: when disabled, OCxM configurations, break enable and polarity). You can choose from 3
Page 1772: page 1820. The LOCK bits can be written only once after an MCU reset.
Page 1774: Starting the counter can be controlled through the slave mode controller. Generating the
Page 1774: waveform can be done in output compare mode or PWM mode. You select One-pulse mode
Page 1774: A pulse can be correctly generated only if the compare value is different from the counter
Page 1775: register. You can optionally enable the preload registers by writing OC1PE=’1’ in the
Page 1775: minimum delay tDELAY min we can get.
Page 1775: If you want to output a waveform with the minimum delay, you can set the OCxFE bit in the
Page 1775: most significant bit are not contiguous with the 3 least significant ones.
Page 1776: UIFCPY flag. In particular cases, it can ease the calculations by avoiding race conditions
Page 1777: The XOR output can be used with all the timer input functions such as trigger or input
Page 1778: The TIM15 timer can be synchronized with an external trigger in several modes: Reset
Page 1778: The counter and its prescaler can be reinitialized in response to an event on a trigger input.
Page 1778: request can be sent if enabled (depending on the TIE and TDE bits in TIMx_DIER register).
Page 1779: The counter can be enabled depending on the level of a selected input.
Page 1780: The counter can start in response to an event on a selected input.
Page 1780: software overhead, but it can also be used to read several registers in a row, at regular
Page 1781: Note:    A null value can be written to the reserved registers.
Page 1782: outputs are disabled (as if the MOE bit was reset). The outputs can either be forced to an
Page 1784: 0: Any of the following events generate an update interrupt if enabled. These events can be:
Page 1784: Note: External clock and gated mode can work only if the CEN bit has been previously set by
Page 1784: software. However trigger mode can set the CEN bit automatically by hardware.
Page 1784: Note: This bit cannot be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1784: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1784: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1785: timer can then be used as a prescaler for a slave timer.
Page 1789: This flag is set by hardware as soon as the break input goes active. It can be cleared by
Page 1790: DMA transfer can occur if enabled.
Page 1790: 1: The TIF flag is set in TIMx_SR register. Related interrupt or DMA transfer can occur if
Page 1791: This bit can be set by software, it is automatically cleared by hardware.
Page 1791: This bit can be set by software, it is automatically cleared by hardware.
Page 1791: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1791: can have a different meaning for the input stage and for the output stage.
Page 1793: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1794: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the
Page 1794: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1794: 2: The PWM mode can be used without validating the preload register only in one
Page 1797: CC1 channel configured as input: This bit determines if a capture of the counter value can
Page 1797: output state is defined by the GPIO controller and can be
Page 1801: Note: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1801: 0: MOE can be set only by software
Page 1801: 1: MOE can be set by software or automatically at the next update event (if the break input is
Page 1801: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1801: Note: 1: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1801: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1802: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1802: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1802: register and BKE/BKP/AOE bits in TIMx_BDTR register can no longer be written
Page 1802: as OSSR and OSSI bits can no longer be written.
Page 1802: CCxS bits) can no longer be written.
Page 1802: Note: The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register
Page 1802: Note: This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1804: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1804: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1804: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1804: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1804: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1805: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1805: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1808: These events can be:
Page 1809: Note: External clock and gated mode can work only if the CEN bit has been previously set by
Page 1809: software. However trigger mode can set the CEN bit automatically by hardware.
Page 1809: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1809: Note: This bit can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1811: This flag is set by hardware as soon as the break input goes active. It can be cleared by
Page 1812: DMA transfer can occur if enabled.
Page 1812: This bit can be set by software, it is automatically cleared by hardware.
Page 1812: This bit can be set by software, it is automatically cleared by hardware.
Page 1813: The channels can be used in input (capture mode) or in output (compare mode). The
Page 1813: can have a different meaning for the input stage and for the output stage.
Page 1813: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1814: 0: Preload register on TIMx_CCR1 disabled. TIMx_CCR1 can be written at anytime, the
Page 1814: Note: 1: These bits can not be modified as long as LOCK level 3 has been programmed
Page 1814: 2: The PWM mode can be used without validating the preload register only in one
Page 1816: This bit determines if a capture of the counter value can actually be done into the input
Page 1817: output state is defined by the GPIO controller and can be
Page 1820: This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1821: 0: MOE can be set only by software
Page 1821: 1: MOE can be set by software or automatically at the next update event (if the break input is
Page 1821: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1821: Note: 1. This bit can not be modified as long as LOCK level 1 has been programmed (LOCK
Page 1821: Note: 1. This bit cannot be modified when LOCK level 1 has been programmed (LOCK bits in
Page 1821: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1822: Note: This bit can not be modified as soon as the LOCK level 2 has been programmed (LOCK
Page 1822: register and BKE/BKP/AOE bits in TIMx_BDTR register can no longer be written.
Page 1822: as OSSR and OSSI bits can no longer be written.
Page 1822: CCxS bits) can no longer be written.
Page 1822: Note: The LOCK bits can be written only once after the reset. Once the TIMx_BDTR register
Page 1822: Note: This bit-field can not be modified as long as LOCK level 1, 2 or 3 has been programmed
Page 1823: transfers. Transfers can be in half-words or in bytes (see example below).
Page 1824: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1824: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1824: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1824: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1825: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1825: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1825: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1826: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1826: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1826: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1826: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1827: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1827: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1827: Note: This bit can not be modified as long as LOCK level 1 has been programmed (LOCK bits
Page 1831: register. The counter clock can be divided by a prescaler.
Page 1831: The counter, the auto-reload register and the prescaler register can be written or read by
Page 1831: 0 in the TIMx_CR1 register. It can also be generated by software. The generation of the
Page 1831: The prescaler can divide the counter clock frequency by any factor between 1 and 65536. It
Page 1831: It can be changed on the fly as the TIMx_PSC control register is buffered. The new
Page 1833: An update event can be generate at each counter overflow or by setting the UG bit in the
Page 1833: The UEV event can be disabled by software by setting the UDIS bit in the TIMx_CR1
Page 1836: UIFCPY flag. In particular cases, it can ease the calculations by avoiding race conditions
Page 1836: control bits and can be changed only by software (except for UG that remains cleared
Page 1837: The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).
Page 1838: These events can be:
Page 1838: Note: Gated mode can work only if the CEN bit has been previously set by software.
Page 1838: However trigger mode can set the CEN bit automatically by hardware.
Page 1839: master timer can then be used as a prescaler for a slave timer.
Page 1840: This bit can be set by software, it is automatically cleared by hardware.
Page 1843: no internal clock source, the LPTIM can be used as a “Pulse Counter” which can be useful
Page 1849: The LPTIM can be clocked using several clock sources. It can be clocked using an internal
Page 1849: clock signal which can be chosen among APB, LSI, LSE or HSI sources through the Reset
Page 1849: and Clock controller (RCC). Also, the LPTIM can be clocked using an external clock signal
Page 1853: SNGSTRT and CNTSTRT bits can only be set when the timer is enabled (The ENABLE bit
Page 1853: The detection of an active edge on one selected trigger input can be used to reset the
Page 1853: A low-power timeout function can be realized. The timeout value corresponds to the
Page 1853: The timer can generate the following waveforms:
Page 1854: The LPTIM output waveform can be configured through the WAVE bit as follow:
Page 1854: Signals with frequencies up to the LPTIM clock frequency divided by 2 can be generated.
Page 1854: Figure 528 below shows the three possible waveforms that can be generated on the LPTIM
Page 1855: to the same register can only be performed when the previous write operation is completed.
Page 1855: The LPTIM counter can be used to count external events on the LPTIM Input1 or it can be
Page 1855: In case the LPTIM is configured to count external events on Input1, the counter can be
Page 1855: The count modes below can be selected, depending on CKSEL and COUNTMODE values:
Page 1855: For this configuration, the LPTIM counter can be updated either on rising edges or
Page 1856: successive read accesses must be performed and compared. A read access can be
Page 1857: Also, an interrupt can be generated for both direction change events if enabled through the
Page 1860: changed from up to down. DOWN flag can be cleared by writing 1 to the DOWNCF bit in the
Page 1860: changed from down to up. UP flag can be cleared by writing 1 to the UPCF bit in the LPTIM_ICR
Page 1860: register has been successfully completed. ARROK flag can be cleared by writing 1 to the ARROKCF
Page 1860: not set. EXTTRIG flag can be cleared by writing 1 to the EXTTRIGCF bit in the LPTIM_ICR register.
Page 1860: LPTIM_ARR register’s value. ARRM flag can be cleared by writing 1 to the ARRMCF bit in the
Page 1865: The PRESC bits configure the prescaler division factor. It can be one among the following division
Page 1867: Caution: This bitfield is write-only. This means that the bit cannot be read back to verify the value
Page 1867: This bit can be set only when the LPTIM is enabled. It will be automatically reset by hardware.
Page 1867: This bit can only be set when the LPTIM is enabled. It will be automatically reset by hardware.
Page 1869: accesses must be performed and compared. A read access can be considered reliable when the
Page 1873: can be programmed to detect abnormally late or early application behavior.
Page 1874: WWDG_CR register, then it cannot be disabled again except by a reset.
Page 1875: Note:    The T6 bit can be used to generate a software reset (the WDGA bit is set and the T6 bit is
Page 1875: The early wakeup interrupt (EWI) can be used if specific safety operations or data logging
Page 1875: can be used to trigger specific actions (such as communications or data logging), before
Page 1875: In some applications, the EWI interrupt can be used to manage a software system check
Page 1875: Note:    When the EWI interrupt cannot be served, e.g. due to a system lock in a higher priority task,
Page 1877: The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).
Page 1877: watchdog can generate a reset.
Page 1878: The timebase of the prescaler can be modified as follows:
Page 1880: •     Clocked from an independent RC oscillator (can operate in Standby and Stop modes)
Page 1881: The IWDG can also work as a window watchdog by setting the appropriate window in the
Page 1881: When the window option it is not used, the IWDG can be configured as follows:
Page 1882: can continue counting or not during the Stop mode and the Standby mode respectively. If
Page 1882: the IWDG is kept running during Stop or Standby modes, it can wake up the device from this
Page 1882: Once running, the IWDG cannot be stopped.
Page 1883: The peripheral registers can be accessed by half-words (16-bit) or words (32-bit).
Page 1886: Window value can be updated only when WVU bit is reset.
Page 1886: Reload value can be updated only when RVU bit is reset.
Page 1886: Prescaler value can be updated only when PVU bit is reset.
Page 1889: automatically. Daylight saving time compensation can also be performed.
Page 1890: •       Programmable alarm with interrupt function. The alarm can be triggered by any
Page 1890: •       Reference clock detection: a more precise second source clock (50 or 60 Hz) can be
Page 1892: •     Tamper event detection can generate a timestamp event
Page 1892: •     Timestamp can be generated when a switch to VBAT occurs
Page 1895: The ck_spre clock can be used either to update the calendar or as timebase for the 16-bit
Page 1895: timer can also run with the RTCCLK divided by the programmable 4-bit asynchronous
Page 1896: are synchronized with PCLK (APB clock). They can also be accessed directly in order to
Page 1896: given for Alarm A, but can be translated in the same way for Alarm B.
Page 1896: RTC_ALRMAR. Each calendar field can be independently selected through the MSKx bits
Page 1896: Alarm A and Alarm B (if enabled by bits OSEL[1:0] in RTC_CR register) can be routed to the
Page 1896: RTC_ALARM output. RTC_ALARM output polarity can be configured through bit POL the
Page 1896: The wakeup timer range can be extended to 17 bits.
Page 1897: The wakeup timer clock input can be:
Page 1897: register, it can exit the device from low-power modes.
Page 1897: The periodic wakeup flag can be routed to the RTC_ALARM output provided it has been
Page 1897: enabled through bits OSEL[1:0] of RTC_CR register. RTC_ALARM output polarity can be
Page 1898: calendar counter is stopped and its value can be updated.
Page 1898: Note:       After a system reset, the application can read the INITS flag in the RTC_ISR register to
Page 1898: Using SUB1H or ADD1H, the software can subtract or add one hour to the calendar in one
Page 1898: In addition, the software can use the BKP bit to memorize this operation.
Page 1898: procedure below is given for Alarm A but can be translated in the same way for Alarm B.
Page 1900: software can just compare the two results of the least-significant calendar register.
Page 1900: The RTC can be synchronized to a remote clock with a high degree of precision. After
Page 1900: reading the sub-second field (RTC_SSR or RTC_TSSSR), a calculation can be made of the
Page 1900: RTC can then be adjusted to eliminate this offset by “shifting” its clock by a fraction of a
Page 1900: 1 / (PREDIV_S + 1) seconds. As a consequence, the resolution can be improved by
Page 1900: The RTC can be finely adjusted using the RTC shift control register (RTC_SHIFTR). Writing
Page 1900: to RTC_SHIFTR can shift (either delay or advance) the clock by up to a second with a
Page 1901: The update of the RTC calendar can be synchronized to a reference clock, RTC_REFIN,
Page 1902: The RTC frequency can be digitally calibrated with a resolution of about 0.954 ppm with a
Page 1902: resolution, the bit CALP can be used to increase the frequency by 488.5 ppm. Setting CALP
Page 1902: Using CALM together with CALP, an offset ranging from -511 to +512 RTCCLK cycles can
Page 1902: The CALP bit can not be set to 1 when the asynchronous prescaler value (PREDIV_A bits in
Page 1902: 244.1 ppm) can effectively be added during each 32-second cycle using only the CALM bits.
Page 1903: Measuring the precise frequency of the RTC over a limited interval can result in a
Page 1903: However, this measurement error can be eliminated if the measurement period is the same
Page 1903: •    CALW16 bit of the RTC_CALR register can be set to 1 to force a 16- second calibration
Page 1903: In this case, the RTC precision can be measured during 16 seconds with a maximum error
Page 1903: •    CALW8 bit of the RTC_CALR register can be set to 1 to force a 8- second calibration
Page 1903: In this case, the RTC precision can be measured during 8 seconds with a maximum error of
Page 1903: The calibration register (RTC_CALR) can be updated on-the-fly while RTC_ISR/INITF=0, by
Page 1904: close together, TSOVF can be seen as '1' while TSF is still '0'. As a consequence, it is
Page 1904: Optionally, a tamper event can cause a time-stamp to be recorded. See the description of
Page 1904: The RTC_TAMPx input events can be configured either for edge detection, or for level
Page 1904: The tamper detection can be configured for the following purposes:
Page 1905: Each input can be enabled by setting the corresponding TAMPxE bits to 1 in the
Page 1905: cannot be detected.
Page 1905: A new tamper occurring on the same pin cannot be detected during the latency described
Page 1905: When TAMPIE is cleared, each tamper pin event interrupt can be individually enabled by
Page 1905: The tamper event detection can be used as trigger input by the low-power timers.
Page 1906: can be optimized by using TAMPFREQ to determine the frequency of the sampling for level
Page 1907: The RTC_ALARM pin can be configured in output open drain or output push-pull using the
Page 1908: The peripheral registers can be accessed by words (32-bit).
Page 1911: This bit can be written by the user to memorize whether the daylight saving time change has
Page 1912: 1: Subtracts 1 hour to the current time. This can be used for winter time change outside
Page 1912: 1: Adds 1 hour to the current time. This can be used for summer time change outside
Page 1913: Note:       Bits 7, 6 and 4 of this register can be written in initialization mode only (RTC_ISR/INITF = 1).
Page 1913: Bits 2 to 0 of this register can be written only when RTC_CR WUTE bit = 0 and RTC_ISR
Page 1915: registers can be updated.
Page 1915: register mode (BYPSHAD=1). This bit can also be cleared by software.
Page 1916: wakeup timer values can be changed when WUTE bit is cleared and WUTWF is set.
Page 1916: This bit is set by hardware when Alarm B values can be changed, after the ALRBE bit has
Page 1916: This bit is set by hardware when Alarm A values can be changed, after the ALRAE bit has
Page 1918: This register can be written only when WUTWF is set to 1 in RTC_ISR.
Page 1918: becomes WUT[16] the most-significant bit to be reloaded into the timer.
Page 1919: This register can be written only when ALRAWF is set to 1 in RTC_ISR, or in initialization
Page 1920: This register can be written only when ALRBWF is set to 1 in RTC_ISR, or in initialization
Page 1921: Note: SS can be larger than PREDIV_S only after a shift operation. In that case, the correct
Page 1922: A fraction of a second can effectively be added to the clock (advancing the clock) when the
Page 1922: Note: Writing to SUBFS causes RSF to be cleared. Software can then wait until RSF=1 to be
Page 1929: bit is cleared, each tamper event interrupt can be individually enabled by setting
Page 1930: This register can be written only when ALRAE is reset in RTC_CR register, or in initialization
Page 1930: Bits 27:24 MASKSS[3:0]: Mask the most-significant bits starting at this bit
Page 1930: The overflow bits of the synchronous counter (bits 15) is never compared. This bit can be
Page 1931: This register can be written only when ALRBE is reset in RTC_CR register, or in initialization
Page 1931: Bits 27:24 MASKSS[3:0]: Mask the most-significant bits starting at this bit
Page 1931: The overflow bits of the synchronous counter (bits 15) is never compared. This bit can be
Page 1932: The application can write or read data to and from these registers.
Page 1935: DMA can be used to reduce CPU overload.
Page 1936: connected to the I2C bus by a data pin (SDA) and by a clock pin (SCL). It can be connected
Page 1936: This interface can also be connected to a SMBus with the data pin (SDA) and clock pin
Page 1938: The interface can operate in one of the four following modes:
Page 1938: the General Call address. The General Call address detection can be enabled or disabled
Page 1938: by software. The reserved SMBus addresses can also be enabled by software.
Page 1939: Acknowledge can be enabled or disabled by software. The I2C interface addresses can be
Page 1939: Then the I2C can be enabled by setting the PE bit in the I2C_CR1 register.
Page 1939: user can disable this analog filter by setting the ANFOFF bit, and/or select a digital filter by
Page 1941: The maximum tHD;DAT can be 3.45 µs, 0.9 µs and 0.45 µs for Standard-mode, Fast-mode
Page 1941: Note:    This condition can be violated when NOSTRETCH=0, because the device stretches SCL
Page 1943: A software reset can be performed by clearing the PE bit in the I2C_CR1 register. In that
Page 1945: it can be enabled by software by setting the SBC (Slave Byte Control) bit in the I2C_CR2
Page 1946: When RELOAD=0 in master mode, the counter can be used in 2 modes:
Page 1946: •     OA1 can be configured either in 7-bit mode (by default) or in 10-bit addressing mode by
Page 1946: •     If additional slave addresses are required, the 2nd slave address OA2 can be
Page 1946: configured. Up to 7 OA2 LSB can be masked by configuring the OA2MSK[2:0] bits in
Page 1946: These reserved addresses can be acknowledged if they are enabled by the specific
Page 1948: pulses. The user can read the data from the I2C_RXDR register, and then decide to
Page 1948: acknowledge is sent and next byte can be received.
Page 1948: NBYTES can be loaded with a value greater than 0x1, and in this case, the reception flow is
Page 1948: The RELOAD bit value can be changed when ADDR=1, or when TCR=1.
Page 1949: received (ADDR=1), the user can choose either to send the content of the I2C_TXDR
Page 1949: user cannot flush the I2C_TXDR register content in the ADDR subroutine, in order to
Page 1949: •    This data can be the data written in the last TXIS event of the previous transmission
Page 1949: •    If this data byte is not the one to be sent, the I2C_TXDR register can be flushed by
Page 1957: In case of an arbitration loss, the master automatically switches back to slave mode and can
Page 1958: •       If the slave address is in 10-bit format, the user can choose to send the complete read
Page 1959: A RESTART condition can be requested by setting the START bit in the I2C_CR2
Page 1959: A STOP condition can be requested by setting the STOP bit in the I2C_CR2
Page 1963: A RESTART condition can be requested by setting the START bit in the I2C_CR2
Page 1963: A STOP condition can be requested by setting the STOP bit in the I2C_CR2
Page 1968: devices can communicate with each other and with the rest of the system. It is based on I2C
Page 1968: This peripheral can be configured as master or slave device, and also as a host.
Page 1969: SMBus slave address conflicts can be resolved by dynamically assigning a new unique
Page 1969: The SMBus ALERT optional signal is supported. A slave-only device can signal the host
Page 1969: If the SMBus ALERT pin is not needed, the SMBA pin can be used as a standard GPIO if
Page 1971: A master can assume that the bus is free if it detects that the clock and data signals have
Page 1972: tLOW:MEXT for a master. As the standard specifies only a maximum, the user can choose
Page 1975: If no ACK software control is needed, the user can program PECBYTE=1 and, in the same
Page 1979: transfer, automatic end mode can be selected (AUTOEND=1). The PECBYTE bit must be
Page 1979: PEC byte reception, stretching the SCL line low. The RESTART condition can be
Page 1981: Only an ADDR interrupt can wakeup the MCU. Therefore do not enter Stop mode when the
Page 1981: set. This can be managed by clearing SLEEPDEEP bit in the ADDR interrupt routine and
Page 1983: DMA (Direct Memory Access) can be enabled for transmission by setting the TXDMAEN bit
Page 1983: START bit are programmed by software (the transmitted slave address cannot be
Page 1983: DMA (Direct Memory Access) can be enabled for reception by setting the RXDMAEN bit in
Page 1984: 1. The ADDR match event can wake-up the device from Stop mode only if the I2C instance supports the
Page 1985: can be generated according to the events described in the table below:
Page 1986: one is completed. The latency of the second write access can be up to 2 x i2c_pclk + 6 x
Page 1987: Note: When ALERTEN=0, the SMBA pin can be used as a standard GPIO.
Page 1987: Note: WUPEN can be set only when DNF = ‘0000’
Page 1987: Note: This bit can only be programmed when the I2C is disabled (PE = 0).
Page 1988: Note: This bit can only be programmed when the I2C is disabled (PE = 0).
Page 1988: This filter can only be programmed when the I2C is disabled (PE = 0).
Page 1989: one is completed. The latency of the second write access can be up to 2 x i2c_pclk + 6 x
Page 1990: sequence is sent, by an arbitration loss, by a timeout error detection, or when PE = 0. It can
Page 1990: The START bit can be set even if the bus is BUSY or I2C is in slave mode.
Page 1992: one is completed. The latency of the second write access can be up to 2 x i2c_pclk + 6 x
Page 1992: Note: This bit can be written only when OA1EN=0.
Page 1992: Note: These bits can be written only when OA1EN=0.
Page 1992: Note: These bits can be written only when OA1EN=0.
Page 1992: Note: This bit can be written only when OA1EN=0.
Page 1993: one is completed. The latency of the second write access can be up to 2 x i2c_pclk + 6 x
Page 1993: Note: These bits can be written only when OA2EN=0.
Page 1993: Note: These bits can be written only when OA2EN=0.
Page 1995: one is completed. The latency of the second write access can be up to 2 x i2c_pclk + 6 x
Page 1995: Note: These bits can be written only when TEXTEN=0.
Page 1995: Note: This bit can be written only when TIMOUTEN=0.
Page 1995: Note: These bits can be written only when TIMOUTEN=0.
Page 1998: This bit can be written to ‘1’ by software when NOSTRETCH=1 only, in order to generate a
Page 1998: This bit can be written to ‘1’ by software in order to flush the transmit data register
Page 2000: Note: These bits can be written only when TXE=1.
Page 2003: wide range of baud rates can be achieved through a fractional baud rate generator.
Page 2004: Each FIFO can be enabled/disabled by software and come with a status flag.
Page 2006: delivered by the RCC. The USART registers can consequently be written/read even
Page 2006: There is no constraint between usart_pclk and usart_ker_ck: usart_ker_ck can be faster
Page 2007: parallel, data can be received synchronously on RX pin. This mechanism can be used
Page 2008: The word length can be set to 7, 8 or 9 bits, by programming the M bits (M0: bit 12 and M1:
Page 2008: These values can be inverted, separately for each signal, through polarity configuration
Page 2010: The USART can operate in FIFO mode.
Page 2010: The transmitter can send data words of either 7 or 8 or 9 bits, depending on the M bit status.
Page 2010: During an USART transmission, data shifts out the least significant bit first (default
Page 2010: The number of stop bits can be configured to 0.5, 1, 1.5 or 2.
Page 2011: The number of stop bits to be transmitted with every character can be programmed in
Page 2013: –    the next data can be written to the USART_TDR register without overwriting the
Page 2013: –    the next data can be written to the USART_TDR register without overwriting the
Page 2013: Alternatively, interrupts can be generated and data can be written to the FIFO when the
Page 2013: TXFIFO threshold is reached. In this case, the CPU can write a block of data defined by
Page 2014: The USART can receive data words of either 7 or 8 or 9 bits depending on the M bits in the
Page 2016: During an USART reception, data are shifted out least significant bit first (default
Page 2016: can be read (as well as their associated error flags).
Page 2016: •    The error flags can be set if a frame error, noise, parity or an overrun error was
Page 2016: software read from the USART_RDR register. The RXNE flag can also be cleared
Page 2016: can also be cleared by programming RXFRQ bit to ‘1’ in USART_RQR. When the
Page 2016: generates an interrupt if the RXFNEIE bit is set. Alternatively, interrupts can be
Page 2017: generated and data can be read from RXFIFO when the RXFIFO threshold is
Page 2017: reached. In this case, the CPU can read a block of data defined by the
Page 2017: Data can not be transferred from the shift register to the RDR register until the RXNE
Page 2017: Data can not be transferred from the shift register to the USART_RDR register until
Page 2018: •   if RXNE=1, then the last valid data is stored in the receive register (RDR) and can be
Page 2018: in the RDR register. This case can occur when the last valid data is read in the RDR
Page 2018: the usart_ker_ck clock source can be configurable in the RCC (see Section 7: Reset and
Page 2018: The usart_ker_ck clock can be divided by a programmable factor, defined in the
Page 2018: The oversampling method can be selected by programming the OVER8 bit in the
Page 2021: The number of stop bits to be received can be configured through the control bits of
Page 2021: USART_CR: it can be either 1 or 2 in normal mode and 0.5 or 1.5 in Smartcard mode.
Page 2021: consequence, no framing error and no break frame can be detected when 0.5 stop bit
Page 2021: period after the beginning of the stop bit). The 1.5 stop bit can be broken into 2 parts:
Page 2023: can introduce an asymmetry between the low-to-high transition timing and the high-to-
Page 2024: The USART receiver can receive data correctly at up to the maximum tolerated deviation
Page 2024: The USART can detect and automatically set the USART_BRR register value based on the
Page 2025: register. If the line is noisy, the correct baud rate detection cannot be guaranteed. In this
Page 2025: The auto baud rate detection can be re-launched later by resetting the ABRF flag (by writing
Page 2026: connected in a network). For instance one of the USARTs can be the master with its TX
Page 2026: The non-addressed devices can be placed in Mute mode by means of the muting function.
Page 2026: •   none of the reception status bits can be set;
Page 2026: •   the RWU bit in USART_ISR register is set to ‘1’. RWU can be controlled automatically
Page 2026: The USART can enter or exit from Mute mode using one of two methods, depending on the
Page 2028: match interrupt (CMIE=1), the software is informed when a LF has been received and can
Page 2029: Parity control (generation of parity bit in transmission and parity checking in reception) can
Page 2030: independent from the normal USART receiver. A break can be detected whenever it occurs,
Page 2030: If a ‘1 is sampled before the 10 or 11 have occurred, the break detection circuit cancels the
Page 2032: In this mode, the USART can be used to control bidirectional synchronous serial
Page 2034: In this mode, the USART can be used to control bidirectional synchronous serial
Page 2035: The hardware or software slave select management can be set through the DIS_NSS bit in
Page 2036: The USART can be configured to follow a Single-wire Half-duplex protocol where the TX
Page 2037: The CLKEN bit can also be set to provide a clock to the Smartcard.
Page 2037: Figure 583 shows examples of what can be seen on the data line with and without parity
Page 2037: bits). The USART can handle automatic re-sending of data according to the protocol.
Page 2038: •   The assertion of the TC flag can be delayed by programming the Guard Time register.
Page 2038: reaches the programmed value TC is asserted high. The TCBGT flag can be used to
Page 2038: According to the ISO protocol, the duration of the received NACK can be 1 or 2 baud
Page 2038: Note:       Break characters are not significant in Smartcard mode. A 0x00 data with a framing error is
Page 2039: The USART can provide a clock to the Smartcard through the SCLK output. In Smartcard
Page 2039: USART_GTPR register. SCLK frequency can be programmed from usart_ker_ck_pres/2 to
Page 2039: In T=1 (block) mode, the parity error transmission can be deactivated by clearing the NACK
Page 2040: moment 2 conveys the most significant bit (MSB first). When decoded by inverse
Page 2040: moment 2 conveys the least significant bit (LSB first). When decoded by direct
Page 2042: •   The receiver can communicate with a low-power transmitter.
Page 2042: the width of the pulse is 3 times the low-power baud rate which can be a minimum of
Page 2044: DMA mode can be enabled for transmission by setting DMAT bit in the USART_CR3
Page 2044: is set in the DMA_ISR register), the TC flag can be monitored to make sure that the USART
Page 2045: DMA mode can be enabled for reception by setting the DMAR bit in USART_CR3 register.
Page 2047: RS232 RTS and CTS flow control can be enabled independently by writing the RTSE and
Page 2047: Data 2 can now be transmitted
Page 2048: signal can be configured using the DEP bit in the USART_CR3 control register.
Page 2049: In this case, the usart_wkup interrupt source can be:
Page 2049: usart_wkup interrupt source can be one of the following events:
Page 2049: For example, the application can set the threshold to the maximum RXFIFO size if the
Page 2049: Alternatively, a specific usart_wkup interrupt can be selected through the WUS bitfields.
Page 2050: Checking the BUSY flag cannot ensure that low-power mode is never entered when data
Page 2050: cannot work in low-power mode.
Page 2050: Note:       When FIFO management is enabled, Mute mode can be used with wakeup from low-power
Page 2052: During USART communications, an interrupt (usart_it) can be generated by different events.
Page 2052: The USART block can also generate a wakeup interrupt (usart_wkup).
Page 2055: This bitfield can only be written when the USART is disabled (UE=0).
Page 2055: Note: FIFO mode can be used on standard UART communication, in SPI master/slave mode
Page 2055: This bit can only be written when the USART is disabled (UE=0).
Page 2056: This bitfield can only be written when the USART is disabled (UE=0).
Page 2056: This bitfield can only be written when the USART is disabled (UE=0).
Page 2056: This bit can only be written when the USART is disabled (UE=0).
Page 2056: This bit enables the USART Mute mode function. When set, the USART can switch between
Page 2056: 1: Receiver can switch between Mute mode and active mode.
Page 2056: This bit can only be written when the USART is disabled (UE=0).
Page 2057: This bitfield can only be written when the USART is disabled (UE=0).
Page 2057: This bitfield can only be written when the USART is disabled (UE=0).
Page 2057: This bitfield can only be written when the USART is disabled (UE=0).
Page 2058: the software can poll the TEACK bit in the USART_ISR register.
Page 2058: When this bit is cleared, the USART cannot wake up the MCU from low-power mode.
Page 2058: When this bit is set, the USART can wake up the MCU from low-power mode.
Page 2059: equal to 1. It can also be used for character detection during normal reception, Mute mode inactive
Page 2059: This bitfield can only be written when reception is disabled (RE = 0) or the USART is disabled
Page 2059: This bitfield can only be written when reception is disabled (RE = 0) or the USART is disabled
Page 2059: This bitfield can only be written when ABREN = 0 or the USART is disabled (UE=0).
Page 2060: Bit 19 MSBFIRST: Most significant bit first
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2060: This bitfield can only be written when the USART is disabled (UE=0).
Page 2061: This bitfield can only be written when the USART is disabled (UE=0).
Page 2061: This bit can only be written when the USART is disabled (UE=0).
Page 2061: This bit can only be written when the USART is disabled (UE=0).
Page 2061: This bit can only be written when the USART is disabled (UE=0).
Page 2061: This bit can only be written when the USART is disabled (UE=0).
Page 2062: This bit can only be written when the USART is disabled (UE=0).
Page 2062: This bit can only be written when the USART is disabled (UE=0)
Page 2064: This bitfield can only be written when the USART is disabled (UE=0).
Page 2064: This bit can only be written when the USART is disabled (UE=0).
Page 2064: This bit can only be written when the USART is disabled (UE=0).
Page 2064: This bit can only be written when the USART is disabled (UE=0).
Page 2065: This bit can only be written when the USART is disabled (UE=0).
Page 2065: This bit can only be written when the USART is disabled (UE=0).
Page 2065: This bit can only be written when the USART is disabled (UE=0)
Page 2065: The nRTS output is asserted (pulled to 0) when data can be received.
Page 2065: This bit can only be written when the USART is disabled (UE=0).
Page 2066: This bitfield can only be written when the USART is disabled (UE=0).
Page 2066: This bitfield can only be written when the USART is disabled (UE=0).
Page 2066: This bit can only be written when the USART is disabled (UE=0).
Page 2066: This bit can only be written when the USART is disabled (UE=0).
Page 2066: This bit can only be written when the USART is disabled (UE=0).
Page 2067: This register can only be written when the USART is disabled (UE=0). It may be
Page 2068: This bitfield can only be written when the USART is disabled (UE=0).
Page 2068: The source clock is divided by the value given in the register (8 significant bits):
Page 2068: The value given in the register (5 significant bits) is multiplied by 2 to give the division factor
Page 2068: This bitfield can only be written when the USART is disabled (UE=0).
Page 2069: This bitfield can be used also in other modes. In this case, the Block length counter is reset
Page 2069: Note: This value can be programmed after the start of the block reception (using the data
Page 2069: Note:           RTOR can be written on-the-fly. If the new value is lower than or equal to the counter, the
Page 2071: data, this flag is cleared. The TXFE flag can also be set by writing 1 to the bit TXFRQ (bit 4)
Page 2072: It can be used to verify that the USART is ready for reception before entering low-power
Page 2072: It can be used when an idle frame request is generated by writing TE=0, followed by TE=1
Page 2072: When wakeup on IDLE mode is selected, this bit can only be set by software, writing 1 to the
Page 2074: the USART_TDR register. The TXE flag can also be set by writing 1 to the TXFRQ in the
Page 2074: meaning that data can be written in the USART_TDR. Every write operation to the
Page 2074: When the TXFIFO is full, this flag is cleared indicating that data can not be written into the
Page 2075: register. The RXNE flag can also be cleared by writing 1 to the RXFRQ in the USART_RQR
Page 2075: RXFNE bit is set by hardware when the RXFIFO is not empty, meaning that data can be
Page 2075: RXNE/RXFNE is cleared when the RXFIFO is empty. The RXNE/RXFNE flag can also be
Page 2076: When the line is noise-free, the NE flag can be disabled by programming the ONEBIT
Page 2079: This register can only be written when the USART is disabled (UE=0).
Page 2079: The USART input clock can be divided by a prescaler factor:
Page 2082: up to 9600 baud/s. Higher baud rates can be reached when the LPUART is clocked by clock
Page 2082: Even when the microcontroller is in low-power mode, the LPUART can wait for an incoming
Page 2082: DMA (direct memory access) can be used for data transmission/reception.
Page 2083: •   Higher baud rates can be achieved by using a higher frequency clock source
Page 2083: Each FIFO can be enabled/disabled by software and come with status flags for FIFOs
Page 2084: and delivered by the RCC. So, the LPUART registers can be written/read even when
Page 2084: There is no constraint between lpuart_pclk and lpuart_ker_ck: lpuart_ker_ck can be
Page 2085: The word length can be set to 7 or 8 or 9 bits, by programming the M bits (M0: bit 12 and
Page 2085: These values can be inverted, separately for each signal, through polarity configuration
Page 2086: The LPUART can operate in FIFO mode.
Page 2087: The transmitter can send data words of either 7 or 8 or 9 bits, depending on the M bit status.
Page 2087: During an LPUART transmission, data shifts out least significant bit first (default
Page 2087: The number of stop bits can be 1 or 2.
Page 2088: The number of stop bits to be transmitted with every character can be programmed in
Page 2089: –    the next data can be written to the LPUART_TDR register without overwriting the
Page 2089: – the next data can be written to the LPUART_TDR register without overwriting the
Page 2089: Alternatively, interrupts can be generated and data can be written to the TXFIFO when
Page 2089: the TXFIFO threshold is reached. In this case, the CPU can write a block of data
Page 2090: The LPUART can receive data words of either 7 or 8 or 9 bits depending on the M bits in the
Page 2091: During an LPUART reception, data are shifted in least significant bit first (default
Page 2091: shift register is transferred to the RDR. In other words, data has been received and can
Page 2091: •    The error flags can be set if a frame error, noise or an overrun error has been detected
Page 2091: software read from the LPUART_RDR register. The RXNE flag can also be
Page 2091: cleared. The RXFNE flag can also be cleared by writing 1 to the RXFRQ bit in the
Page 2092: Alternatively, interrupts can be generated and data can be read from RXFIFO
Page 2092: when the RXFIFO threshold is reached. In this case, the CPU can read a block of
Page 2092: Data can not be transferred from the shift register to the RDR register until the RXNE
Page 2092: Data can not be transferred from the shift register to the LPUART_RDR register until
Page 2093: •   if RXNE=1, then the last valid data is stored in the receive register (RDR) and can be
Page 2093: read in the RDR. This case can occur when the last valid data is read in the RDR at the
Page 2093: the lpuart_ker_ck clock source can be configured in the RCC (see Section Reset and clock
Page 2093: The lpuart_ker_ck can be divided by a programmable factor in the LPUART_PRESC
Page 2094: The number of stop bits to be received can be configured through the control bits of
Page 2094: LPUART_CR2: it can be either 1 or 2 in normal mode.
Page 2094: The maximum baud rate that can be reached when the LPUART clock source is the LSE, is
Page 2094: 9600 baud. Higher baud rates can be reached when the LPUART is clocked by clock
Page 2094: 100 MHz, the maximum baud rate that can be reached is about 33 Mbaud.
Page 2096: can introduce an asymmetry between the low-to-high transition timing and the high-to-
Page 2096: The LPUART receiver can receive data correctly at up to the maximum tolerated deviation
Page 2096: connected in a network). For instance one of the LPUARTs can be the master, with its TX
Page 2097: The non addressed devices can be placed in Mute mode by means of the muting function.
Page 2097: •    none of the reception status bits can be set;
Page 2097: •    the RWU bit in LPUART_ISR register is set to ‘1’. RWU can be controlled automatically
Page 2097: The LPUART can enter or exit from Mute mode using one of two methods, depending on
Page 2098: Parity control (generation of parity bit in transmission and parity checking in reception) can
Page 2099: The LPUART can be configured to follow a Single-wire Half-duplex protocol where the TX
Page 2100: perform continuous communication. When FIFO is disabled, you can clear the TXE/ RXNE
Page 2100: DMA mode can be enabled for transmission by setting DMAT bit in the LPUART_CR3
Page 2100: is set in the DMA_ISR register), the TC flag can be monitored to make sure that the
Page 2101: DMA mode can be enabled for reception by setting the DMAR bit in LPUART_CR3 register.
Page 2103: RS232 RTS and CTS flow control can be enabled independently by writing the RTSE and
Page 2103: Data 2 can now be transmitted
Page 2104: signal can be configured using the DEP bit in the LPUART_CR3 control register.
Page 2105: In this case, the lpuart_wkup interrupt source can be:
Page 2105: lpuart_wkup interrupt source can be one of the following events:
Page 2105: For example, the application can set the threshold to the maximum RXFIFO size if the
Page 2106: the BUSY flag cannot ensure that low-power mode is never entered when data reception is
Page 2106: cannot work in low-power mode.
Page 2110: This bit can only be written when the LPUART is disabled (UE=0).
Page 2111: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2111: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2111: This bit activates the Mute mode function of the LPUART. When set, the LPUART can switch
Page 2111: 1: Receiver can switch between Mute mode and active mode.
Page 2111: This bit can only be written when the LPUART is disabled (UE=0).
Page 2111: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2111: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2111: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2112: be immediately written to 1. In order to ensure the required duration, the software can
Page 2114: to 1. It can also be used for character detection during normal reception, Mute mode inactive (for
Page 2114: This bitfield can only be written when reception is disabled (RE = 0) or the LPUART is disabled
Page 2114: This bitfield can only be written when reception is disabled (RE = 0) or the LPUART is disabled
Page 2114: Bit 19 MSBFIRST: Most significant bit first
Page 2114: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2114: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2114: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2114: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2114: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2115: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2115: This bit can only be written when the LPUART is disabled (UE=0)
Page 2116: This bitfield can only be written when the LPUART is disabled (UE=0).
Page 2117: This bit can only be written when the LPUART is disabled (UE=0).
Page 2117: This bit can only be written when the LPUART is disabled (UE=0).
Page 2117: This bit can only be written when the LPUART is disabled (UE=0).
Page 2117: This bit can only be written when the LPUART is disabled (UE=0).
Page 2117: This bit can only be written when the LPUART is disabled (UE=0)
Page 2117: The nRTS output is asserted (pulled to 0) when data can be received.
Page 2117: This bit can only be written when the LPUART is disabled (UE=0).
Page 2118: This bit can only be written when the LPUART is disabled (UE=0).
Page 2118: This register can only be written when the LPUART is disabled (UE=0). It may be
Page 2120: data, this flag is cleared. The TXFE flag can also be set by writing 1 to the bit TXFRQ (bit 4)
Page 2120: It can be used to verify that the LPUART is ready for reception before entering low-power
Page 2120: It can be used when an idle frame request is generated by writing TE=0, followed by TE=1
Page 2121: When wakeup on IDLE mode is selected, this bit can only be set by software, writing 1 to the
Page 2122: data can be written in the LPUART_TDR. Every write in the LPUART_TDR places the data
Page 2122: flag is cleared indicating that data can not be written into the LPUART_TDR.
Page 2122: RXNE flag can also be cleared by writing 1 to the RXFRQ in the LPUART_RQR register.
Page 2122: RXFNE bit is set by hardware when the RXFIFO is not empty, and so data can be read from
Page 2122: The RXNE/RXFNE flag can also be cleared by writing 1 to the RXFRQ in the
Page 2125: This register can only be written when the LPUART is disabled (UE=0).
Page 2126: The LPUART input clock can be divided by a prescaler:
Page 2129: The serial peripheral interface (SPI) can be used to communicate with external devices
Page 2129: interface can be configured as master or slave and is capable of operating in multi slave or
Page 2129: clock (SCK) to the external slave device. The slave select signal can be provided by the
Page 2130: •    Dual clock domain, separated clock for the peripheral kernel which can be independent
Page 2130: •    Hardware CRC feature can secure communication at the end of transaction by:
Page 2131: devices. The application software can manage the communication by polling the status flag
Page 2132: correctly (e.g. when underrun or overrun is evaluated). This cannot be done when the bus
Page 2132: •    SS: Slave select pin. Depending on the SPI and SS settings, this pin can be used to
Page 2132: synchronous data transfer. Other signals can be added depending on the data exchange
Page 2132: MOSI and MISO pins can be inverted in any SPI mode (see the IOSWP bit at SPI_CFG2
Page 2133: signal can be helpful at this configuration to synchronize the data flow and it is used by
Page 2133: 1. The SS pin is configured at output mode at master. The pins can be left unconnected then SS is managed
Page 2133: The SPI can communicate in half-duplex mode by setting COMM[1:0]=11 in the SPI_CFG2
Page 2134: 1. The SS pin is configured at output mode at master. The pins can be left unconnected then SS is managed
Page 2134: 2. In this configuration, the MISO pin at master and MOSI pin at slave can be used as GPIOs
Page 2134: 3. A critical situation can happen when communication direction is changed not synchronously between two
Page 2134: communicated data). Both nodes can fight with opposite outputs levels on the line temporary till next node
Page 2134: The SPI can communicate in simplex mode by setting the SPI in transmit-only or in receive-
Page 2134: MISO or MOSI pins pair is not used for communication and can be used as standard
Page 2134: In slave configuration, the MISO output is disabled and the pin can be used as a GPIO.
Page 2134: Note:       At whatever master and slave modes, the data pin dedicated for transmission can be
Page 2134: Any simplex communication can be replaced by a variant of the half duplex communication
Page 2135: 1. The SS pin is configured at output mode at master. The pins can be left unconnected then SS is managed
Page 2135: 3. In this configuration, both the MISO pins can be used as GPIOs.
Page 2135: connected to the slave SS input (only one slave can control data on common MISO line at
Page 2135: configuration can be applied for each slave as all the communication sessions are
Page 2135: to read any information from slaves, the master can transmit the same information to the
Page 2136: The master can handle the SPI communication with all the slaves in time when a circular
Page 2137: (UDRCFG[1:0]=01). A session can start optionally with a single data pattern written into the
Page 2138: Unless the SPI bus is not designed for a multi-master capability primarily, the user can use
Page 2138: node can apply its output on a common data line at time.
Page 2138: appears (see mode fault MODF event). Then the user can apply some simple arbitration
Page 2138: communicate with the master. In master mode, the SS can be used either as an output or an
Page 2138: input. As an input it can prevent a multi master bus collision, and as an output it can drive a
Page 2138: slave select signal of a single slave. The SS signal can be managed internally (software
Page 2138: associated with the SS pin (hardware SS management). The user can configure which level
Page 2138: SSIOP bit setting. While low level is considered as active internally SSIOP=1 setting can
Page 2139: The hardware or software slave select management can be set using the SSM bit in the
Page 2139: master. That is why the hardware management mode cannot be used when the external SS
Page 2140: MIDI[3:0] and MSSI[3:0] bit fields the user can control timing of the SS signal between data
Page 2140: starts). This can be useful when the slave needs to slow down the flow to obtain sufficient
Page 2143: The SPI shift register can be set up to shift out MSB-first or LSB-first, depending on the
Page 2143: DSIZE[4:0] bits. It can be set from 4-bit up to 32-bit length and the setting applies for both
Page 2144: any later configurations changes of the SPI_CFG1 and SPI_CFG2 registers can
Page 2145: master. That is why the hardware management mode cannot be used when external SS pin
Page 2146: reads 0. RxFIFO can store up to N data frames (for frame size =< 8-bit), N/2 data frames
Page 2146: SPI_SR register. It happens when number of the last data received in a transfer cannot fully
Page 2146: aligned. Nevertheless the application software can still perform the standard number of
Page 2146: software can treat all the data in a transfer in the same way and is off-loaded to foresee the
Page 2146: data packet is lost. This can lead to oscillations of the TXP signal when data are released
Page 2146: can be pushed into the TxFIFO and, if so, uploads them packet by packet until TXP reads 0
Page 2146: The number of last data in a transfer can be shorter than the configured packet size in the
Page 2146: application software can still perform the standard number of data register writes used for
Page 2146: TxFIFO while redundant writes are discarded. Thanks to that, the application software can
Page 2146: Both TXP and RXP events can be polled or handled by interrupts. The DXP bit can be
Page 2146: software checks the DXP value to see if other packets can be pushed and popped in
Page 2147: description of OVR flag at Section 49.5.2: SPI error flags). An overrun event can be polled
Page 2147: A few data frames can be passed at single sequence to complete a message. The user can
Page 2147: applied). The transaction can be suspended at any time thanks to CSUSP which clears the
Page 2147: In master mode, the user can extend the number of data within the current session. When
Page 2147: user can write the next non-zero value into TSER before the next reload occurs, so an
Page 2147: unlimited number of data can be transacted while repeating this process.
Page 2148: frames permanently up to this moment. The reception can be suspended either by SW
Page 2148: While the master can provide all the transactions in continuous mode (SCK signal is
Page 2148: At multi-slave star topology, a single slave can be only enabled for the output data at a time.
Page 2148: SS can be managed by both software and hardware (Section 49.4.7: Slave select (SS) pin
Page 2149: In slave mode, the SPI communication can continue when the spi_pclk and spi_ker_ck
Page 2149: request condition is reached. The spi_pclk can generally be stopped by setting the system
Page 2149: The master in full duplex or transmit only mode can finish any transaction when it stops
Page 2149: TXC flag can be polled (or interrupt enabled with EOTIE=1) in order to wait for the last data
Page 2149: transmission session is (fully) completed. This check can be done in specific cases, too,
Page 2150: From user point of view there are two ways of data packing which can overlay each other:
Page 2150: Multiple data can be pushed or fetched effectively by single access if data size is
Page 2150: The user can define packets by FIFO threshold settings. Then all the FIFO occupancy
Page 2150: when a 32-bit access is done. the least significant half-word is used first. (regardless of the
Page 2150: This sequence can generate two or four RXP events in the receiver if the RxFIFO threshold
Page 2150: is set to 1 frame (and data is read on a frame basis, unpacked), or it can generate a single
Page 2151: remaining data can be read by any access. Any extra read is padded by zeros.
Page 2152: If the SPI is programmed in a transmit mode, TXP and UDR can be eventually set at slave
Page 2152: (the TXTF flag is set at SPI2C_SR register), the TXC flag can be monitored to ensure that
Page 2153: By specific setting of the SP[2:0] bit field at the SPI_CFG2 register the SPI can be
Page 2153: and any baud rate can be used to determine this moment with optimal flexibility. The delay
Page 2153: has not enough space to store these received data. This can happen if the software or the
Page 2154: master mode, the user can prevent the RxFIFO overrun by automatic communication
Page 2154: UDRCFG bits. The slave can provide out either data stored lastly to its TxFIFO or the data
Page 2154: register. The second configuration can be used at circular topography structure (see
Page 2154: transaction with a defined size just starts. First bits can be corrupted in this case, as well,
Page 2154: user cannot ensure to write data into the empty TxFIFO in time the UDRDET[1:0]=00 setting
Page 2155: slave device the MODF bit cannot be set except as the result of a previous multi master
Page 2155: (potential conflict can appear when another master occupies the bus. MODF is raised
Page 2155: polynomial is defined by the most significant bit of the value stored at the CRCPOLY
Page 2155: most significant bit of the polynomial string while keep its size always greater than data. The
Page 2155: CRCSIZE field in the SPI_CFG1 then defines how many the most significant bits from CRC
Page 2156: polynomial can be changed but only in case when there is no traffic on the bus.
Page 2156: TSIZE cannot be set to 0xFFFF value if CRC is enabled. A correct way of sending e.g.
Page 2156: phases). Initialization patterns for receiver and transmitter can be configured either to zero
Page 2157: In slave mode, the spi_ker_ck clock can be removed as well during the transfer of data
Page 2157: •   In most of the slave modes, the spi_ker_ck kernel clock can be disabled,
Page 2158: The fill-up of the TxFIFO is completed; the software can switch the system back to low-
Page 2159: Most of them can be enabled and disabled independently while using specific interrupt
Page 2160: •    Channel length can be 16 or 32 in master, any value in slave
Page 2160: •    Master clock can be output to drive an external audio component. The ratio is fixed at
Page 2161: The SPI/I2S block can work on I2S/PCM mode, when the bit I2SMOD is set to 1. A
Page 2161: An additional pin can be used when a master clock output is needed for some external
Page 2165: Can be 16 or 32 bits                           Can be 16 or 32 bits
Page 2168: A data size of 16 or 24 bits can be used when the channel length is set to 32 bits.
Page 2168: If the PCM protocol is used in slave mode, frame lengths can be different from 16 or 32 bits.
Page 2168: As shown in Figure 632, in slave mode various pulse widths of WS can be accepted as the
Page 2169: WS (I)       The falling edge can occur into this area           The falling edge can occur into this area
Page 2169: In slave mode, channel lengths different from 16 or 32 bits can be accepted, as long as the
Page 2170: This can be done by programming CKPOL and WSINV using the following sequence:
Page 2171: order to insure that the external slave device can detect properly WS transition. Other
Page 2172: and transmission of data can start.
Page 2172: The application can stop the I2S/PCM transfers by setting the SPE bit to 0. In that case the
Page 2172: selected) or mono sample are completely shifted in or out. Then the SPE bit can be set to 0.
Page 2172: WS signals go back to their inactive state, and the user can set SPE to 0.
Page 2174: Note:       CHLEN and ODD can be either 0 or 1.
Page 2174: I2SDIV can take any values from 0 to 255 when ODD = 0, but when ODD = 1, the value
Page 2174: Care must be taken when odd ratio is used: it can impact margin on setup and hold time.
Page 2174: For example if {(2 x I2SDIV) + ODD} = 5, then the duty cycle can be 40%.
Page 2174: The master clock MCK can be generated regardless to the SPE bit. The MCK generating is
Page 2175: The I2S interface can use a dedicated FIFO for the RX and the TX path. The samples to
Page 2175: transmit can be written into the TxFIFO via the SPI2S_TXDR register. The reading of
Page 2175: otherwise a data can be lost.
Page 2176: threshold levels. The FIFO threshold is common to RX and TxFIFOs can be adjusted via
Page 2176: For example, a FIFO with 16 basic elements can have a depth of:
Page 2176: interface. Both flags can generate an interrupt request. The receive interrupt is generated if
Page 2176: FTHLV new data to be transmitted can be written into SPI2S_TXDR. The TXP flag is reset
Page 2177: user can read those data via SPI2S_RXDR. It is reset when the RxFIFO contains less than
Page 2177: The UDR flag can trigger an interrupt if the UDRIE bit in the SPI_IER register is set. The
Page 2177: Note:     An underrun situation can occur in master or slave mode. In master mode, when an
Page 2178: Note:       An overrun situation can occur in master or slave mode. In master mode, when an overrun
Page 2178: user can set FIXCH to 1 and adjust accordingly CHLEN. As the SPI/I2S synchronize each
Page 2179: An interrupt can be generated if the TIFREIE bit is set. The frame error flag (TIFRE) is
Page 2179: This means that the expected channel length can be 16 or 32 bits, according to CHLEN. As
Page 2179: The frame error detection can be generally due to noisy environment disturbing the good
Page 2180: separated DMA channel for TX and RX paths. Each DMA channel can be enabled via
Page 2181: enabled. Then the SPI/I2S block can be enabled by setting the bit CSTART to 1.
Page 2182: enabled. Then the SPI/I2S block can be enabled by setting the bit CSTART to 1.
Page 2183: SPI/I2S block cannot control the sample rate of the received samples. In this example we
Page 2183: a channel length of 24 bits. So we cannot use the capability offered for frame error detection
Page 2183: 10. Finally the user can set the bit CSTART to 1 in order to enable the serial interface. The
Page 2184: In PCM/I2S mode an interrupt (spi_it) or a wakeup event signal (spi_wkup) can be
Page 2184: Interrupt events can be enabled and disabled separately.
Page 2185: When this bit is set, SPI_CFG2 register content cannot be modified any more.
Page 2186: In SPI mode, CSTART can be set only when SPE=1 and MASTER=1.
Page 2186: In I2S/PCM mode, CSTART can be set when SPE = 1.
Page 2186: below 8 bits. In this case, a safe suspension can be achieved by combination with delay
Page 2186: SPI_CR1 are write protected. They can be changed only when SPE=0.
Page 2186: SPE cannot be set when MODF error flag is active.
Page 2187: This register can be set by software when its content is cleared only. It is cleared by hardware
Page 2187: TSIZE cannot be set to 0xFFFF value when CRC is enabled.
Page 2188: Most significant bits are taken into account from polynomial calculation when CRC result is
Page 2188: Note: The most significant bit at CRCSIZE bit field is reserved at the peripheral instances
Page 2188: The user can define here when and how the underrun condition is detected at slave receiver
Page 2189: This register can be either locked to send value defined by the user or refreshed
Page 2189: Note: The most significant bit at DSIZE bit field is reserved at the peripheral instances where
Page 2190: Note: This bit can be also used in PCM and I2S modes.
Page 2190: 0: SS output is disabled and the SPI can work in multi-master configuration
Page 2190: 1: SS output is enabled. The SPI cannot work in a multi-master environment. It forces the SS
Page 2191: Note: This bit can be also used in PCM and I2S modes.
Page 2191: Note: This bit can be also used in PCM and I2S modes.
Page 2193: When the frame size is smaller than or equal to 16-bit, but larger than 8-bit, RXPLV[1:0] can
Page 2195: If DXP flag is used until TXTF flag is set and DXPIE is cleared, EOT can be used to
Page 2196: Note: DR can be accessed byte-wise (8-bit access): in this case only one data-byte is written
Page 2196: halfword-wise (16 bit access) in this case 2 data-bytes or 1 halfword-data can be
Page 2196: can be written by single access.
Page 2197: Note: DR can be accessed byte-wise (8-bit access): in this case only one data-byte is read
Page 2197: halfword-wise (16 bit access) in this case 2 data-bytes or 1 halfword-data can be read
Page 2197: can be read by single access
Page 2197: polynomial string where the most significant bit of the string is always kept hidden.
Page 2197: Length of the polynomial is given by the most significant bit of the value stored at this
Page 2200: I2SDIV can take any values except the value 1, when ODD is also equal to 1.
Page 2204: The SAI can work in master or slave configuration. The audio sub-blocks can be either
Page 2204: receiver or transmitter and can work synchronously or not (with respect to the other one).
Page 2204: The SAI can be connected with other SAIs to work synchronously.
Page 2205: •   Two independent audio sub-blocks which can be transmitters or receivers with their
Page 2205: •   Number of bits by frame can be configurable.
Page 2206: independent. They can be synchronous with each other.
Page 2206: audio block in the SAI. Some of these pins can be shared if the two sub-blocks are declared
Page 2206: as synchronous to leave some free to be used as general purpose I/Os. The MCLK pin can
Page 2206: If one SAI is configured to operate synchronously with another one, even more I/Os can be
Page 2206: The functional state machine can be configured to address a wide range of audio protocols.
Page 2207: The audio sub-block can be a transmitter or receiver, in master or slave mode. The master
Page 2207: Each audio sub-block of the SAI can be configured to be master or slave via MODE bits in
Page 2207: •     If needed, the SAI can also generate a master clock on MCLK_x pin.
Page 2208: In slave mode, MCLK_x pin is not used and can be assigned to another function.
Page 2208: Each audio sub-block can be independently defined as a transmitter or receiver through the
Page 2208: Two master audio blocks in the same SAI can be configured with two different MCLK and
Page 2208: An audio sub-block can be configured to operate synchronously with the second audio sub-
Page 2209: Typically, the audio block in synchronous mode can be used to configure the SAI in full
Page 2209: duplex mode. One of the two audio blocks can be configured as a master and the other as
Page 2209: The audio sub-blocks can also be configured to operate synchronously with another SAI.
Page 2209: This can be done as follow:
Page 2209: SAI block used. For example SAI2 can select the synchronization from SAI1 by setting SAI2
Page 2209: The audio frame can target different data sizes by configuring bit DS[2:0] in the SAI_xCR1
Page 2210: FS     The falling edge can occur into this area
Page 2210: The audio frame length can be configured to up to 256 bit clock cycles, by setting
Page 2210: If bit NOMCK is set, the (FRL+1) field can take any value from 8 to 256. Refer to
Page 2211: level of the Frame synchronization signal. The length can be set from 1 to 128 bit clock
Page 2211: As an example, the active length can be half of the frame length in I2S, LSB or MSB-justified
Page 2211: signal can be asserted when transmitting the last bit or the first bit of the audio frame (this is
Page 2211: The FS signal can have a different meaning depending on the FS function. FSDEF bit in the
Page 2213: Each slot can be defined as a valid slot, or not, by setting SLOTEN[15:0] bits of the
Page 2215: MCKDIV and OSR bits are ignored. In addition, MCLK_x I/O pin is released and can be
Page 2215: The bit clock strobing edge of (SCK_x) can be configured through CKSTR bit in the
Page 2215: driven Low if this pin is configured as the SAI pin in GPIO peripherals. MCKDIV can still be
Page 2215: If NOMCK is set to 0, the master clock is generated, and can be used as reference clock for
Page 2216: signal (SCK_x) can also have a duty cycle different from 50% if MCKDIV is odd, and if OSR
Page 2216: Note:       When NOMCK = 0, (FRL+1) can take any values from 8 to 256.
Page 2217: transmitter or a receiver, the FIFO can be written or read, respectively. There is therefore
Page 2219: Like interrupt generation, the SAI can use the DMA if DMAEN bit in the SAI_xCR1 register is
Page 2219: The FIFO pointers can be reinitialized when the SAI is disabled by setting bit FFLUSH in the
Page 2219: microphones. Up to 4 digital microphone pairs can be connected in parallel. Figure 649
Page 2219: (LR), a microphone can provide valid data on SAI_CK[m] rising edge while the other
Page 2219: TDM MASTER mode. It cannot be used with SAI_B sub-block. The PDM interface uses the
Page 2220: The PDM interface can be enabled through the PDMEN bit in SAI_PDMCR register.
Page 2220: To reduce the memory footprint, the user can select the amount of microphones the
Page 2220: application needs. This can be done through MICNBR[1:0] bits. It is possible to select
Page 2221: The slot width defines the amount of significant bits into each word available into the
Page 2224: LSBFIRST           X       This parameter can be used according to the wanted data format
Page 2225: MICNBR can be 0,1,2 or 3 (0 = 2 microphones., see Section 50.5.18)
Page 2226: When the PDM interface is enabled, the application can adjust on-the-fly the delay cells of
Page 2227: mode is selected, only data sizes of 16 or 20 bits can be used, otherwise the SAI behavior is
Page 2227: One SAI can be used to target an AC’97 point-to-point communication.
Page 2230: the SAI can only operate in transmitter mode. As a result, the following sequence should be
Page 2232: The SAI interface embeds specific features which can be useful depending on the audio
Page 2232: The mute mode can be used when the audio sub-block is a transmitter or a receiver.
Page 2232: In transmitter mode, the mute mode can be selected at anytime. The mute mode is active
Page 2232: is set and an interrupt can be generated if MUTEDETIE bit is set in SAI_xCR2.
Page 2232: In transmitter mode, the mono mode can be addressed, without any data preprocessing in
Page 2233: In reception mode, the MONO bit can be set and is meaningful only if the number of slots is
Page 2233: Telecommunication applications can require to process the data to be transmitted or
Page 2233: selected), the application software can choose to process or not the data before sending it
Page 2233: Both µ-Law or A-Law companding standard can be computed based on 1’s complement or
Page 2234: It is important to note that the two transmitters cannot attempt to drive the same SD output
Page 2234: transmissions, if the data is lower than 32-bit, the data can be extended to 32-bit by setting
Page 2236: The overrun or underrun errors share the same bit since an audio block can be either
Page 2237: The underrun event can occur when the audio sub-block is configured as master or slave.
Page 2238: The LFSDET flag in the SAI_xSR register can be set only when the SAI audio block
Page 2238: block state machine and shift the SAI data at a wrong frame position. This event can be
Page 2239: The SAI audio block can be disabled at any moment by clearing SAIEN bit in the SAI_xCR1
Page 2242: 1: Master clock generator is disabled. The clock divider controlled by MCKDIV can still be used to
Page 2243: Bit 8 LSBFIRST: Least significant bit first
Page 2244: 1: Master clock generator is disabled. The clock divider controlled by MCKDIV can still be used to
Page 2246: Bit 8 LSBFIRST: Least significant bit first
Page 2259: This flag can be set only if the audio block is configured in slave mode.
Page 2259: It can generate an interrupt if LFSDETIE bit is set in the SAI_xIM register.
Page 2259: This flag can be set only if the audio block is configured in slave mode.
Page 2259: It can generate an interrupt if AFSDETIE bit is set in SAI_xIM register.
Page 2259: It can generate an interrupt if CNRDYIE bit is set in SAI_xIM register.
Page 2260: This flag can generate an interrupt if FREQIE bit is set in SAI_xIM register.
Page 2260: It can generate an interrupt if WCKCFGIE bit is set in SAI_xIM register.
Page 2260: It can generate an interrupt if MUTEDETIE bit is set in SAI_xIM register.
Page 2260: The overrun and underrun conditions can occur only when the audio block is configured as a
Page 2260: It can generate an interrupt if OVRUDRIE bit is set in SAI_xIM register.
Page 2261: This flag can be set only if the audio block is configured in slave mode.
Page 2261: It can generate an interrupt if LFSDETIE bit is set in the SAI_xIM register.
Page 2261: This flag can be set only if the audio block is configured in slave mode.
Page 2261: It can generate an interrupt if AFSDETIE bit is set in SAI_xIM register.
Page 2261: It can generate an interrupt if CNRDYIE bit is set in SAI_xIM register.
Page 2262: This flag can generate an interrupt if FREQIE bit is set in SAI_xIM register.
Page 2262: It can generate an interrupt if WCKCFGIE bit is set in SAI_xIM register.
Page 2262: It can generate an interrupt if MUTEDETIE bit is set in SAI_xIM register.
Page 2262: The overrun and underrun conditions can occur only when the audio block is configured as a
Page 2262: It can generate an interrupt if OVRUDRIE bit is set in SAI_xIM register.
Page 2267: This field can be changed on-the-fly.
Page 2267: This field can be changed on-the-fly.
Page 2267: This field can be changed on-the-fly.
Page 2267: This field can be changed on-the-fly.
Page 2268: This field can be changed on-the-fly.
Page 2268: This field can be changed on-the-fly.
Page 2268: This field can be changed on-the-fly.
Page 2268: This field can be changed on-the-fly.0
Page 2271: This peripheral can be fully controlled via the APB1 bus, and can handle two DMA channels:
Page 2271: This signal can be connected to timer events, in order to compute frequency drift.
Page 2273: most significant bit (MSB) is carried by bit 27. When a 20-bit coding range is used, bits
Page 2276: spdifrx_ker_ck clock (acquisition clock). A simple filtering is applied in order cancel spurs.
Page 2279: Two kinds of phenomenon (at least!) can degrade the reception quality:
Page 2279: •   The long term jitter which reflects a cumulative effect of the cycle-to-cycle jitter. It can
Page 2279: The peripheral remains in this state until transitions are not detected. This function can be
Page 2279: The user can still set the SPDIFRX into STATE_IDLE by setting SPDIFRXEN to 0. If the
Page 2279: can program the number of allowed re-tries (NBTR) before setting SERR error flag.
Page 2279: (U) will start when the next “B” preamble is detected (see Figure 676).Then the user can
Page 2279: the user can then select the proper settings for DRFMT and RXSTEO. For example if the
Page 2279: user detects that the current audio stream transports encoded data, then he can put
Page 2279: RXSTEO cannot be modified when SPDIFRXEN = 11. Writes to these fields are ignored if
Page 2279: SPDIFRXEN is already 11, though these field can be changed with the same write
Page 2281: The software can control the state of the SPDIFRX through SPDIFRXEN field. The
Page 2281: SPDIFRX can be into one of the following states:
Page 2281: and channel status can be read via interrupt of DMA. The audio samples are not
Page 2281: channel status and audio samples can be read via interrupt or DMA channels. When
Page 2282: •     The software can transition to STATE_SYNC by setting SPDIFRXEN to 01 or 11
Page 2282: •     At any time the software can set SPDIFRXEN to 0, then SPDIFRX returns immediately
Page 2282: •     At any time the software can set SPDIFRXEN to 0, then SPDIFRX returns immediately
Page 2283: The SPDIFRX offers several way on handling the received data. The user can either have a
Page 2284: into the SPDIFRX_FMTx_DR register. The status information can be enabled or forced to
Page 2284: In this format the status information cannot be mixed with data, but the user can still get
Page 2285: The user can choose to use this mode in order to get the full flexibility of the handling of the
Page 2285: control flow. The user can select which field shall be kept into the data register
Page 2287: Ch B2 cannot be written into the RX_BUF because
Page 2287: Ch A3 can be written into the RX_BUF
Page 2287: RX_BUF cannot be emptied because SPDIF_RX is FULL                                                              D6 is available and RX_BUF is FULL è Overrun !
Page 2287: Then the incoming samples can be written normally into the RX_BUF even if the OVR flag is
Page 2288: Ch B2 cannot be written into the RX_BUF because                       Ch A3 cannot be written into the RX_BUF even if the
Page 2289: The DMA mode for the data can be enabled for reception by setting the RXDMAEN bit in the
Page 2290: Note:       The SBD event can only occur when the SPDIFRX is synchronized to the input stream
Page 2290: Note:       Note that each of the mask bits (PMSK, VMSK, …) can be changed “on-the-fly” at any IP
Page 2291: SPDIFRX can find synchronization. This can be done by checking if the bit TERR is
Page 2291: transitions of SPDIFRX_IN line. When activity is detected, then SPDIFRXEN can be
Page 2292: 1, others set to 0). Note that SYNCDIE can be set to 0.
Page 2292: •   The CPU can enter in WFI mode
Page 2293: If no error occurred (i.e. PERR), the CPU can start the decoding of channel information.
Page 2293: Thanks to that information, the user can then configure the RXSTEO bit and DRFMT
Page 2293: PCM then RXSTEO is set to 0, and DRFMT is set to 10. Then the user can enable the
Page 2293: For example in linear mode, if PE or V bit is set a special processing can be performed
Page 2297: consecutive symbols. This value can be used to estimate the S/PDIF symbol rate. Its accuracy is
Page 2300: This register can take 3 different formats according to DRFMT. Here is the format when
Page 2301: This register can take 3 different formats according to DRFMT. Here is the format when
Page 2302: This register can take 3 different formats according to DRFMT.
Page 2304: This field contains the current threshold LOW estimation. This value can be used to estimate the
Page 2304: spdifrx_ker_ck. The sampling rate can be estimated as follow:
Page 2304: This field contains the current threshold HIGH estimation. This value can be used to estimate the
Page 2304: spdifrx_ker_ck. The sampling rate can be estimated as follow:
Page 2308: HSI for swpmi_ker_ck. If this feature is not required, swpmi_pclk can be selected, and
Page 2309: The SWP bus can have the following states: DEACTIVATED, SUSPENDED, ACTIVATED.
Page 2310: Once the SWPMI is enabled, the user can request a SWPMI frame transmission. The
Page 2310: Once the SWPMI is enabled, the SWP can also move from the SUSPENDED to
Page 2310: can request to switch the SWP to the DEACTIVATED mode by disabling the SWPMI
Page 2312: significant byte of the first 32-bit word (bits [7:0]) written into the SWPMI_TDR register)
Page 2313: Note:    The low significant byte of the first 32-bit word written into the SWPMI_TDR register is
Page 2313: other value in the low significant byte will be ignored and the transmission will not start.
Page 2314: DMA. The DMA will refill the 32-bit SWPMI_TDR register, and the software can poll the end
Page 2314: least significant byte of the first word),
Page 2315: buffer update by software thanks to the DMA. The software can check the DMA counters at
Page 2315: bytes in the payload on the least significant byte of the first word)
Page 2316: user can update buffer1 in the RAM memory.
Page 2316: The Software can also read the DMA counter (number of data to transfer) in the DMA
Page 2316: RAM area. This is useful in case several frames are sent before the software can handle the
Page 2316: set the low significant byte of the first word to 0 in buffer3 and buffer4.
Page 2316: data bytes in the payload is read as 0 in the least significant byte of the first word.
Page 2317: the reception can take place immediately.
Page 2317: and an interrupt is generated if RIE bit is set in SWPMI_IER register. The user can read the
Page 2318: memory, and the software can poll the end of the frame reception using the SWPMI_RBFF
Page 2319: are stored in the RAM memory, together with the frame status flags. The software can check
Page 2320: the user can read the first frame payload received in the first buffer (at the RAM address set
Page 2320: In case the application software cannot ensure to handle the SMPMI interrupt before the
Page 2320: next frame reception, each buffer status is available in the most significant byte of the 8th
Page 2320: The software can also read the DMA counter (number of data to transfer) in the DMA
Page 2322: flag is set. When RXBFF flag is set, the user can check the RXOVRF flag. The user must
Page 2322: register can be set in order to generate an interrupt as soon as the overrun occurs.
Page 2323: The loopback mode can be used for test purposes. The user must set LPBK bit in the
Page 2323: A RESUME from SUSPENDED mode issued by the slave can wake up the
Page 2325: The peripheral registers can be accessed by words (32-bit).
Page 2325: Note: This bit cannot be written while SWPACT bit is set.
Page 2325: Note: This bit cannot be written while SWPACT bit is set.
Page 2326: Note: This bit cannot be written while SWPACT bit is set.
Page 2326: 0x00 (in the least significant byte of TDR for the first word of a frame). TXDMA is also
Page 2326: BR[7:0] cannot be written while SWPACT bit is set in the SWPMI_CR register.
Page 2327: SWPMI_TDR can be written to again
Page 2331: significant bits RFL[1:0] give the number of relevant bytes for the last SWPMI_RDR register
Page 2334: An MDIO bus can be useful in systems where a master chip needs to manage (configure
Page 2334: The MDIOS peripheral serves as a slave interface to an MDIO bus. An MDIO master can
Page 2334: The MDIOS can operate in Stop mode, optionally waking up the STM32 if the MDIO master
Page 2336: –       5 MDIOS register address bits, up to 32 MDIOS registers can be addressed in
Page 2336: clocks. The master can continue to keep MDIO at ‘1’, indicating the “idle” condition, when it
Page 2337: MDIOS which can be written and read. In reality, for each MDIOS register ‘n’ there are two
Page 2337: (DIN0 - DIN31) can be read by the firmware, but they can be written only by the MDIO
Page 2337: If the firmware uses the WRF interrupt and can guarantee that it reads the DINn register
Page 2337: before any new MDIOS write frame completes, the firmware can perform a single read.
Page 2338: does not contain the value which was written, then the firmware can simply try writing and
Page 2338: value which was just written), then the firmware can use a read interrupt to know when it is
Page 2339: Here is a procedure which can be used if the MDC clock is very slow:
Page 2339: this maximum delay cannot be guaranteed, go back to step #1.
Page 2339: can be cleared by writing ‘1’ to the corresponding bit in the clear flag register
Page 2340: If the DPC bit (Disable Preamble Check, MDIOS_CR[7]) is set, then the MDIO Master can
Page 2340: The MDIOS can operate in Stop mode, responding to all reads, performing all writes, and
Page 2341: of these interrupt sources can wake the STM32 up from Stop mode. All interrupt flags need
Page 2342: Can be written only when the peripheral is disabled (EN=0).
Page 2342: 1: MDIO Master can send each frame without a preceding preamble, and the MDIOS will not
Page 2342: MDIOS is enabled. Otherwise, the MDIOS can become desynchronized with the master.
Page 2342: This bit cannot be changed unless EN=0 (though it can be changed at the same time that EN is
Page 2355: •     By default, SDMMC_D0 line is used for data transfer. After initialization, the host can
Page 2355: data bus widths can be used.
Page 2355: •     For an SD or an SDIO card, 1-bit (SDMMC_D0) or 4-bit (SDMMC_D[3:0]) can be used.
Page 2355: •     When the sdmmc_ker_ck clock has 50 % duty cycle, it can be used even in bypass
Page 2355: SDMMC_CK can be selected through the NEGEDGE bit. The phase relation depends
Page 2356: DLYB delay block available on the device can be connected between sdmmc_io_in_ck
Page 2356: clock input can be selected to sample the receive data.
Page 2356: For an SD/SDIO/e•MMC card, the clock frequency can vary between 0 and 208 MHz
Page 2357: The DLYB delay block on the device can be used in conjunction with the SDMMC adapter,
Page 2361: WAITRESP in the command control register, the response can be either short or long,
Page 2363: can be sent or responses can be received. If the CPSM is not in the Send state, the
Page 2366: The card data bus width can be programmed in the clock control register bits WIDBUS. The
Page 2366: Next to the data bus width the data sampling mode can be programmed in the clock control
Page 2370: control register (DTMODE), the data transfer mode can be either block or stream:
Page 2371: can be cleared at the same time as the DHOLD flag.)
Page 2371: bit in the data control register, the data transfer mode can be either block, SDIO
Page 2373: Data can be transferred from the card to the host (transmit, send) or vice versa (receive).
Page 2375: The FIFO can be in one of the following states:
Page 2376: The data FIFO can be accessed in the following ways, see Table 449.
Page 2376: Data can be written to the transmit FIFO when the DPSM has been activated (DPSMACT =
Page 2377: Data can be read from the receive FIFO when the DPSM is activated (DPSMACT = 1).
Page 2378: and command response. The receive data clock source can be selected by the clock control
Page 2380: An IDMA transfer error can occur:
Page 2381: sdmmc_dataend_trg output. It can trigger the clearance of the DATAEND and CMDREND
Page 2382: In 4-bit mode the card can generate a synchronous or asynchronous interrupt as indicated
Page 2382: •    Asynchronous interrupt, can be generated when the SDMMC_CK is stopped, 4 cycles
Page 2385: In 4-bit mode interrupts can be differentiated from other signaling according Table 455.
Page 2386: the concept of suspend/resume. When a card supports suspend/resume, the host can
Page 2386: where after an other operation can start.
Page 2387: While receiving data from the card, the SDMMC can suspend the read operation after the
Page 2387: While sending data to the card, the SDMMC can suspend the write operation after the write
Page 2387: Firmware can stop filling the FIFO, after which the FIFO shall be reset with FIFORST.
Page 2388: The SDMMC can perform a ReadWait with register settings according Table 454.
Page 2389: As SDMMC_CK is stopped, no command can be issued to the card. During a ReadWait
Page 2389: interval, the SDMMC can still detect SDIO interrupts on SDMMC_D1.
Page 2390: During the ReadWait signaling on SDMMC_D2 commands can be issued to the card.
Page 2390: During the ReadWait interval, the SDMMC can detect SDIO interrupts on SDMMC_D1.
Page 2391: predefined block count Transaction can be aborted by sending the Stop Transmission command.
Page 2391: All data write and read commands can be aborted any time by a Stop Transmission
Page 2392: 6.   The write stream data can be aborted any time by clearing the WAITPEND bit. This will
Page 2395: In boot operation mode the host can read boot data from the card by either one of the 2 boot
Page 2395: The boot data can be read according the following configuration options, depending on card
Page 2395: boot data has been read. The host can terminate boot mode by pulling the SDMMC_CMD
Page 2396: 6.    The incorrect reception of the boot acknowledgment can be detected with ACKFAIL
Page 2396: indicate that a new command can be sent.
Page 2398: 7.   the reception of the boot acknowledgment can be detected with ACKFAIL flag when
Page 2399: and no command nor data can be transfered. The SDMMC_D[7:0], and SDMMC_CMD are
Page 2399: clocked after which the SDMMC is enabled and command and data can be transfered.
Page 2400: 7.    After 74 SDMMC_CK cycles the first command can be sent to the card.
Page 2400: clocked by SDMMC_CK are frozen, the AHB interfaces are still alive. The FIFO can thus be
Page 2401: case of SDR104 mode with a tOP and DtOP delay > 1 cycle, hardware flow control can NOT
Page 2403: The polarity of the SDMMC_CDIR, SDMMC_D0DIR and SDMMC_D123DIR signals can be
Page 2404: This bit can only be written when the SDMMC is in the power-off state (PWRCTRL = 00).
Page 2404: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2404: These bits can only be written when the SDMMC is not in the power-on state
Page 2405: These bits can only be written when the CPSM and DPSM are not active (CPSMACT = 0
Page 2405: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2405: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2405: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2406: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2406: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2406: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2406: For power saving, the SDMMC_CK clock output can be disabled when the bus is idle by
Page 2406: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2407: 2      The clock frequency can be changed to the maximum card bus frequency when relative
Page 2407: register. SDMMC_CK can also be stopped during the ReadWait interval for SD I/O cards: in
Page 2407: These bits can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2408: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2408: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0)
Page 2408: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2409: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2409: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2409: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2409: 2       MultiMediaCard can send two kinds of response: short responses, 48 bits, or long
Page 2409: responses,136 bits. SD card and SD I/O card can send only short responses, the argument
Page 2409: can vary according to the type of response: the software will distinguish the type of response
Page 2410: 1. The most significant bit of the card status is received first.
Page 2411: This bit can only be written when the CPSM and DPSM are not active (CPSMACT = 0 and
Page 2411: This register can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2412: This bit can only be written by firmware when IDMAEN= 0 and DPSM is active (DPSMACT =
Page 2412: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2412: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2412: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2413: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2413: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2413: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2413: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0). This bit is
Page 2415: At least half the number of words can be written into the FIFO. This bit is cleared when the
Page 2422: This bit can only be written by firmware when CPSM is disabled (CPSMEN = 0).
Page 2422: The receive and transmit FIFOs can be only read or written as word (32-bit) wide registers.
Page 2422: This register can only be read or written by firmware when the DPSM is active
Page 2422: The receive and transmit FIFOs can be read or written as 32-bit wide registers. The FIFOs
Page 2423: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0). When
Page 2423: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2423: This bit can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2423: These bits can only be written by firmware when DPSM is inactive (DPSMACT = 0).
Page 2424: This register can be written by firmware when DPSM is inactive (DPSMACT = 0), and can
Page 2424: This register can be written by firmware when DPSM is inactive (DPSMACT = 0), and can
Page 2428: FD controller area network (FDCAN)                                                              RM0433
Page 2428: 55          FD controller area network (FDCAN)
Page 2428: The controller area network (CAN) subsystem (see Figure 729) consists of two CAN
Page 2428: Both modules (FDCAN1 and FDCAN2) are compliant with ISO 11898-1: 2015 (CAN
Page 2428: protocol specification version 2.0 part A, B) and CAN FD protocol specification version 1.0.
Page 2428: In addition, the first CAN module FDCAN1 supports time triggered CAN (TTCAN), specified
Page 2428: time, and clock drift compensation. The FDCAN1 contains additional registers, specific to
Page 2428: the time triggered feature. The CAN FD option can be used together with event-triggered
Page 2428: and time-triggered CAN communication.
Page 2428: FIFOs, transmit buffers (and triggers for TTCAN). This message RAM is shared between
Page 2428: the FDCAN1 and FDCAN2 modules.
Page 2428: The common clock calibration unit is optional. It can be used to generate a calibrated clock
Page 2428: for both FDCAN1 and FDCAN2 from the HSI internal RC oscillator and the PLL, by
Page 2428: evaluating CAN messages received by the FDCAN1.
Page 2428: The CAN subsystem I/O signals and pins are detailed, respectively, in Table 459 and
Page 2428: Table 459. CAN subsystem I/O signals
Page 2428: fdcan_ker_ck                            CAN subsystem kernel clock input
Page 2428: fdcan_pclk                              CAN subsystem APB interface clock input
Page 2428: fdcan_cal_it          Digital output    FDCAN calibration interrupt
Page 2428: fdcan1_intr0_it                         FDCAN1 interrupt0
Page 2428: fdcan1_intr1_it                         FDCAN1 interrupt1
Page 2428: fdcan2_intr0_it                         FDCAN2 interrupt0
Page 2428: fdcan2_intr1_it                         FDCAN2 interrupt1
Page 2428: fdcan1_swt[0:3]                         Stop watch trigger input
Page 2428: fdcan1_evt[0:3]       Digital input     Event trigger input
Page 2428: fdcan1_ts[0:15]                         External timestamp vector
Page 2428: fdcan1_soc                              Start of cycle pulse
Page 2428: fdcan1_rtp            Digital output    Register time mark pulse
Page 2428: fdcan1_tmp                              Trigger time mark pulse
Page 2429: RM0433                                                      FD controller area network (FDCAN)
Page 2429: Table 460. CAN subsystem I/O pins
Page 2429: FDCAN1_RX           Digital input    FDCAN1 receive pin
Page 2429: FDCAN1_TX           Digital output   FDCAN1 transmit pin
Page 2429: FDCAN2_RX           Digital input    FDCAN2 receive pin
Page 2429: FDCAN2_TX           Digital output   FDCAN2 transmit pin
Page 2429: FDCAN1_TXFD_MODE Digital output      Indicates if the current TX CAN1 frame is in FD mode
Page 2429: FDCAN1_RXFD_MODE Digital output      Indicates if the current RX CAN1 frame is in FD mode
Page 2429: FDCAN2_TXFD_MODE Digital output      Indicates if the current TX CAN2 frame is in FD mode
Page 2429: FDCAN2_RXFD_MODE Digital output      Indicates if the current RX CAN2 frame is in FD mode
Page 2430: FD controller area network (FDCAN)                                                                                         RM0433
Page 2430: Figure 729. CAN subsystem
Page 2430: fdcan_ker_ck                                / 1..30                                          Clock
Page 2430: fdcan_cal         Calibration
Page 2430: _it                                              fdcan_tq_ck
Page 2430: FDCAN2_RXFD_MODE
Page 2430: FDCAN2_TXFD_MODE
Page 2430: fdcan1_intr0_it                       Interrupts
Page 2430: FDCAN1_RXFD_MODE
Page 2430: fdcan1_intr1_it                        Interface
Page 2430: FDCAN1_TXFD_MODE
Page 2430: fdcan2_intr0_it                                                                                              FDCAN1_RX
Page 2430: CAN core
Page 2430: fdcan2_intr1_it
Page 2430: FDCAN1_TX
Page 2430: FDCAN2_RX
Page 2430: FDCAN2_TX
Page 2430: fdcan1_rtp
Page 2430: fdcan_pclk                                                                                 fdcan1_tmp
Page 2430: fdcan1_soc
Page 2430: fdcan1_swt
Page 2430: fdcan1_evt                                                RX Handler
Page 2430: fdcan1_ts
Page 2430: FDCAN1
Page 2430: FDCAN2
Page 2431: RM0433                                                      FD controller area network (FDCAN)
Page 2431: 55.2     FDCAN main features
Page 2431: •   Conform with CAN protocol version 2.0 part A, B and ISO 11898-1: 2015, -4
Page 2431: •   CAN FD with max. 64 data bytes supported
Page 2431: •   TTCAN protocol level 1 and level 2 completely in hardware (FDCAN1 only)
Page 2431: •   Event synchronized time-triggered communication supported (FDCAN1 only)
Page 2431: •   CAN error logging
Page 2431: •   Both FDCAN1 and FDCAN2 modules share the same message RAM
Page 2431: •   Two clock domains: APB bus interface and CAN core kernel clock
Page 2432: FD controller area network (FDCAN)                                                                                     RM0433
Page 2432: 55.3                          FDCAN functional description
Page 2432: Figure 730. FDCAN block diagram
Page 2432: fdcan_tq_ck
Page 2432: fdcan_intr0_it                           Interrupts                                                      FDCAN_RXFD_MODE
Page 2432: fdcan_intr1_it                            Interface
Page 2432: FDCAN_TXFD_MODE
Page 2432: FDCAN_RX
Page 2432: CAN core
Page 2432: FDCAN_TX
Page 2432: fdcan_rtp
Page 2432: fdcan_tmp
Page 2432: fdcan_soc
Page 2432: fdcan1_swt[0..3]
Page 2432: fdcan1_evt[0..3]                                                              RX Handler
Page 2432: fdcan_pclk                                                                         clock domain
Page 2432: fdcan1_ts[0:15]                                                                                  FDCAN
Page 2432: The FDCAN peripheral provides two interrupt lines fdcan_intr0_it and fdcan_intr1_it. By
Page 2432: programming EINT0 and EINT1 bits in FDCAN_ILE register, the interrupt lines can be
Page 2432: CAN core
Page 2432: The CAN core contains the protocol controller and receive/transmit shift registers. It handles
Page 2432: The sync block synchronizes signals from the APB clock domain to the CAN kernel clock
Page 2433: RM0433                                                        FD controller area network (FDCAN)
Page 2433: Controls the message transfer from the message RAM to the CAN core. A maximum of 32
Page 2433: Tx buffers can be configured for transmission. Tx buffers can be used as dedicated Tx
Page 2433: stores Tx timestamps together with the corresponding message ID. Transmit cancellation is
Page 2433: On FDCAN1, the Tx handler also implements the frame synchronization entity (FSE) which
Page 2433: the reference messages on the CAN bus, controls cycle time and global time, and handles
Page 2433: Controls the transfer of received messages from the CAN core to the external message
Page 2433: can be defined for 11-bit IDs and up to 64 filters for 29-bit IDs.
Page 2433: Connects the FDCAN to the APB bus.
Page 2433: Connects the FDCAN access to an external 10 Kbytes message RAM through a RAM
Page 2433: Software initialization is started by setting INIT bit in FDCAN_CCCR register, either by
Page 2433: software or by a hardware reset, or by going Bus_Off. While INIT bit in FDCAN_CCCR
Page 2433: register is set, message transfer from and to the CAN bus is stopped, the status of the CAN
Page 2433: bus output FDCAN_TX is recessive (high). The counters of the error management logic
Page 2433: (EML) are unchanged. Setting INIT bit in FDCAN_CCCR does not change any configuration
Page 2433: register. Clearing INIT bit in FDCAN_CCCR finishes the software initialization. Afterwards
Page 2433: the bit stream processor (BSP) synchronizes itself to the data transfer on the CAN bus by
Page 2433: it can take part in bus activities and start the message transfer.
Page 2433: Access to the FDCAN configuration registers is only enabled when both INIT bit in
Page 2433: FDCAN_CCCR register and CCE bit in FDCAN_CCCR register are set.
Page 2433: CCE bit in FDCAN_CCCR register can only be set/cleared while INIT bit in FDCAN_CCCR
Page 2433: is set. CCE bit in FDCAN_CCCR register is automatically cleared when INIT bit in
Page 2433: FDCAN_CCCR is cleared.
Page 2434: FD controller area network (FDCAN)                                                              RM0433
Page 2434: The following registers are reset when CCE bit in FDCAN_CCCR register is set:
Page 2434: •   FDCAN_HPMS - high priority message status
Page 2434: •   FDCAN_ RXF0S - Rx FIFO 0 status
Page 2434: •   FDCAN_RXF1S - Rx FIFO 1 status
Page 2434: •   FDCAN_TXFQS - Tx FIFO/queue status
Page 2434: •   FDCAN_TXBRP - Tx buffer request pending
Page 2434: •   FDCAN_TXBTO - Tx buffer transmission occurred
Page 2434: •   FDCAN_TXBCF - Tx buffer cancellation finished
Page 2434: •   FDCAN_TXEFS - Tx event FIFO status
Page 2434: •   FDCAN_TTOST - TT operation status (FDCAN1 only)
Page 2434: •   FDCAN_TTLGT - TT local & global time, only global time FDCAN_TTLGT.GT is reset
Page 2434: (FDCAN1 only)
Page 2434: •   FDCAN_TTCTC - TT cycle time & count (FDCAN1 only)
Page 2434: •   FDCAN_TTCSM - TT cycle sync mark (FDCAN1 only)
Page 2434: The timeout counter value TOC bit in FDCAN_TOCV register is preset to the value
Page 2434: configured by TOP bit in FDCAN_TOCC register when CCE bit in FDCAN_CCCR is set.
Page 2434: CCE bit in FDCAN_CCCR is set.
Page 2434: The following registers can be written only when CCE bit in FDCAN_CCCR register is
Page 2434: •   FDCAN_TXBAR - Tx buffer add request
Page 2434: •   FDCAN_TXBCR - Tx buffer cancellation request
Page 2434: TEST bit in FDCAN_CCCR and MON bit in FDCAN_CCCR can only be set by software
Page 2434: while both INIT bit and CCE bit in FDCAN_CCCR register are set. Both bits may be reset at
Page 2434: any time. DAR bit in FDCAN_CCCR can only be set/cleared while both INIT bit in
Page 2434: FDCAN_CCCR and CCE bit in FDCAN_CCCR are set.
Page 2434: The FDCAN1 default operating mode after hardware reset is event-driven CAN
Page 2434: communication without time triggers (FDCAN_TTOCF.OM = 00). It is required that both INIT
Page 2434: bit and CCE bit in FDCAN_CCCR register are set before the TT operation mode can be
Page 2434: Once the FDCAN is initialized and INIT bit in FDCAN_CCCR register is cleared, the FDCAN
Page 2434: synchronizes itself to the CAN bus and is ready for communication.
Page 2434: For messages to be transmitted dedicated Tx buffers and/or a Tx FIFO or a Tx queue can
Page 2434: CAN FD operation
Page 2434: There are two variants in the FDCAN protocol, first the long frame mode (LFM) where the
Page 2434: data field of a CAN frame may be longer that eight bytes. The second variant is the fast
Page 2434: frame mode (FFM) where control field, data field, and CRC field of a CAN frame are
Page 2435: RM0433                                                         FD controller area network (FDCAN)
Page 2435: mode can be used in combination with long frame mode.
Page 2435: The previously reserved bit in CAN frames with 11-bit identifiers and the first previously
Page 2435: reserved bit in CAN frames with 29-bit identifiers will now be decoded as FDF bit. FDF
Page 2435: recessive signifies a CAN FD frame, while FDF dominant signifies a classic CAN frame. In a
Page 2435: CAN FD frame, the two bits following FDF, res and BRS, decide whether the bitrate inside
Page 2435: this CAN FD frame is switched. A CAN FD bitrate switch is signified by res dominant and
Page 2435: In case the M_TTCAN receives a frame with FDF recessive and res recessive, it will signal
Page 2435: a protocol exception event by setting bit FDCAN_PSR.PXE. When protocol exception
Page 2435: handling is enabled (FDCAN_CCCR.PXHD = 0), this causes the operation state to change
Page 2435: from receiver (FDCAN_PSR.ACT = 10) to Integrating (FDCAN_PSR.ACT = 00) at the next
Page 2435: sample point. In case protocol exception handling is disabled (FDCAN_CCCR.PXHD = 1),
Page 2435: the FDCAN will treat a recessive res bit as a form error and will respond with an error frame.
Page 2435: CAN FD operation is enabled by programming FDCAN_CCCR.FDOE. If
Page 2435: FDCAN_CCCR.FDOE = 1, transmission and reception of CAN FD frames is enabled.
Page 2435: Transmission and reception of classic CAN frames is always possible. Whether a CAN FD
Page 2435: frame or a classic CAN frame is transmitted can be configured via bit FDF in the respective
Page 2435: Tx buffer element. With FDCAN_CCCR.FDOE = 0, received frames are interpreted as
Page 2435: classic CAN frames, which leads to the transmission of an error frame when receiving a
Page 2435: CAN FD frame. When CAN FD operation is disabled, no CAN FD frames are transmitted,
Page 2435: even if bit FDF of a Tx buffer element is set. FDCAN_CCCR.FDOE and
Page 2435: FDCAN_CCCR.BRSE can only be changed while FDCAN_CCCR.INIT and
Page 2435: FDCAN_CCCR.CCE are both set.
Page 2435: With FDCAN_CCCR.FDOE = 0, the setting of bits FDF and BRS is ignored and frames are
Page 2435: transmitted in classic CAN format. With FDCAN_CCCR.FDOE = 1 and
Page 2435: FDCAN_CCCR.BRSE = 0, only bit FDF of a Tx buffer element is evaluated. With
Page 2435: FDCAN_CCCR.FDOE = 1 and FDCAN_CCCR.BRSE = 1, transmission of CAN FD frames
Page 2435: transmitted in CAN FD format with bitrate switching.
Page 2435: A mode change during CAN operation is only recommended under the following conditions:
Page 2435: •   The failure rate in the CAN FD data phase is significant higher than in the CAN FD
Page 2435: arbitration phase. In this case disable the CAN FD bitrate switching option for
Page 2435: •   During system startup all nodes are transmitting classic CAN messages until it is
Page 2435: verified that they are able to communicate in CAN FD format. If this is true, all nodes
Page 2435: switch to CAN FD operation.
Page 2435: •   Wake-up messages in CAN partial networking have to be transmitted in classic CAN
Page 2435: •   End-of-line programming in case not all nodes are CAN FD capable. Non CAN FD
Page 2435: back to classic CAN communication.
Page 2435: In the FDCAN format, the coding of the DLC differs from the standard CAN format. The DLC
Page 2435: codes 0 to 8 have the same coding as in standard CAN, the codes 9 to 15 (that in standard
Page 2435: CAN all code a data field of 8 bytes) are coded according to Table 461.
Page 2436: FD controller area network (FDCAN)                                                                  RM0433
Page 2436: Table 461. DLC coding in FDCAN
Page 2436: In CAN FD fast frames, the bit timing will be switched inside the frame, after the BRS (bitrate
Page 2436: Switch) bit, if this bit is recessive. Before the BRS bit, in the FDCAN arbitration phase, the
Page 2436: nominal CAN bit timing is used as defined by the bit timing and prescaler register
Page 2436: FDCAN_NBTP. In the following FDCAN data phase, the fast CAN bit timing is used as
Page 2436: defined by the fast bit fiming and prescaler register FDCAN_DBTP. The bit timing is
Page 2436: The maximum configurable bitrate in the CAN FD data phase depends on the FDCAN
Page 2436: kernel clock frequency. For example, with a FDCAN kernel clock frequency of 20 MHz and
Page 2436: In both data frame formats, CAN FD long frames and CAN FD fast frames, the value of the
Page 2436: transmitted dominant. In CAN FD remote frames the ESI bit is always transmitted dominant,
Page 2436: independent of the transmitter error state. The data length code of CAN FD remote frames
Page 2436: In case a FDCAN Tx buffer is configured for FDCAN transmission with DLC > 8, the first
Page 2436: data field is padded with 0xCC. When the FDCAN receives a FDCAN frame with DLC > 8,
Page 2436: During the data phase of a FDCAN transmission only one node is transmitting, all others are
Page 2436: receivers. The length of the bus line has no impact. When transmitting via pin FDCAN_TX
Page 2436: the protocol controller receives the transmitted data from its local CAN transceiver via pin
Page 2436: FDCAN_RX. The received data is delayed by the CAN transceiver loop delay. In case this
Page 2436: Without transceiver delay compensation, the bitrate in the data phase of a FDCAN frame is
Page 2436: The FDCAN implements a delay compensation mechanism to compensate the CAN
Page 2436: transceiver loop delay, thereby enabling transmission with higher bitrates during the FDCAN
Page 2436: data phase independent of the delay of a specific CAN transceiver.
Page 2436: enabled by setting bit FDCAN_DBTP.TDC.
Page 2437: RM0433                                                                   FD controller area network (FDCAN)
Page 2437: defined as the sum of the measured delay from the FDCAN transmit output pin FDCAN_TX
Page 2437: through the transceiver to the receive input pin FDCAN_RX plus the transmitter delay
Page 2437: compensation offset as configured by FDCAN_TDCR.TDCO. The transmitter delay
Page 2437: fdcan_tq_ck clock).
Page 2437: FDCAN_PSR.TDCV shows the actual transmitter delay compensation value, it is cleared
Page 2437: when FDCAN_CCCR.INIT is set and is updated at each transmission of an FD frame while
Page 2437: FDCAN_DBTP.TDC is set.
Page 2437: compensation implemented in the FDCAN:
Page 2437: •    The sum of the measured delay from m_ttcan_tx to m_ttcan_rx and the configured
Page 2437: transmitter delay compensation offset FDCAN_TDCR.TDCO has to be less than six bit
Page 2437: •    The sum of the measured delay from m_ttcan_tx to m_ttcan_rx and the configured
Page 2437: transmitter delay compensation offset FDCAN_TDCR.TDCO has to be less or equal
Page 2437: If transmitter delay compensation is enabled by programming FDCAN_DBTP.TDC = 1, the
Page 2437: measurement is started within each transmitted CAN FD frame at the falling edge of bit FDF
Page 2437: FDCAN_TX of the transmitter. The resolution of this measurement is one mtq.
Page 2437: m_ttcan_tx
Page 2437: m_ttcan_rx
Page 2437: m_ttcan_cclk
Page 2437: position) the use of a transmitter delay compensation filter window can be enabled by
Page 2438: FD controller area network (FDCAN)                                                                  RM0433
Page 2438: programming FDCAN_TDCR.TDCF. This defines a minimum value for the SSP position.
Page 2438: Dominant edges on m_ttcan_rx, that would result in an earlier SSP position are ignored for
Page 2438: least FDCAN_TDCR.TDCF and FDCAN_RX is low.
Page 2438: itself to the CAN communication. The error counters (FDCAN_ECR.REC,
Page 2438: FDCAN_ECR.TEC) are frozen while error logging (FDCAN_ECR.CEL) is active. The
Page 2438: software can set the FDCAN into restricted operation mode by setting bit
Page 2438: FDCAN_CCCR.ASM. The bit can only be set by software when both FDCAN_CCCR.CCE
Page 2438: and FDCAN_CCCR.INIT are set to 1. The bit can be cleared by software at any time.
Page 2438: has to reset FDCAN_CCCR.ASM.
Page 2438: The restricted operation mode can be used in applications that adapt themselves to different
Page 2438: CAN bitrates. In this case the application tests different bitrates and leaves the restricted
Page 2438: FDCAN_CCCR.ASM is also controlled by the clock calibration unit. Wen the clock
Page 2438: FDCAN_CCR.ASM bit is set. Once the calibration is completed, FDCAN_CCR.ASM bit is
Page 2438: The FDCAN is set in bus monitoring mode by setting FDCAN_CCCR.MON bit or when error
Page 2438: level S3 (FDCAN_TTOST.EL = 11) is entered. In bus monitoring mode (For more details
Page 2438: please refer to ISO11898-1, 10.12 bus monitoring), the FDCAN is able to receive valid data
Page 2438: frames and valid remote frames, but cannot start a transmission. In this mode, it sends only
Page 2438: recessive bits on the CAN bus, if the FDCAN is required to send a dominant bit (ACK bit,
Page 2438: overload flag, active error flag), the bit is rerouted internally so that the FDCAN monitors this
Page 2438: dominant bit, although the CAN bus may remain in recessive state. In bus monitoring mode
Page 2438: register FDCAN_TXBRP is held in reset state.
Page 2438: The bus monitoring mode can be used to analyze the traffic on a CAN bus without affecting
Page 2438: it by the transmission of dominant bits. Figure 732 shows the connection of FDCAN_TX and
Page 2438: FDCAN_RX signals to the FDCAN in bus monitoring mode.
Page 2439: RM0433                                                           FD controller area network (FDCAN)
Page 2439: FDCAN_TX            FDCAN_RX
Page 2439: FDCAN
Page 2439: According to the CAN Specification (see ISO11898-1, 6.3.3 recovery management), the
Page 2439: FDCAN provides means for automatic retransmission of frames that have lost arbitration or
Page 2439: the automatic retransmission may be disabled via FDCAN_CCCR.DAR.
Page 2439: In DAR mode all transmissions are automatically canceled after they started on the CAN
Page 2439: bus. A Tx buffer Tx request pending bit FDCAN_TXBRP.TRPx is reset after successful
Page 2439: transmission, when a transmission has not yet been started at the point of cancellation, has
Page 2439: –    Corresponding Tx buffer transmission occurred bit FDCAN_TXBTO.TOx set
Page 2439: –    Corresponding Tx buffer cancellation finished bit FDCAN_TXBCF.CFx not set
Page 2439: •   Successful transmission in spite of cancellation:
Page 2439: –    Corresponding Tx buffer transmission occurred bit FDCAN_TXBTO.TOx set
Page 2439: –    Corresponding Tx buffer cancellation finished bit FDCAN_TXBCF.CFx set
Page 2439: –    Corresponding Tx buffer transmission occurred bit FDCAN_TXBTO.TOx not set
Page 2439: –    Corresponding Tx buffer cancellation finished bit FDCAN_TXBCF.CFx set
Page 2439: event FIFO element is written with event type ET = 10 (transmission in spite of cancellation).
Page 2439: The FDCAN can be set into power down mode controlled by clock stop request input via
Page 2439: register FDCAN_CCCR.CSR. As long as the clock stop request is active, bit
Page 2439: FDCAN_CCCR.CSR is read as 1.
Page 2440: FD controller area network (FDCAN)                                                              RM0433
Page 2440: When all pending transmission requests have completed, the FDCAN waits until bus idle
Page 2440: state is detected. Then the FDCAN sets FDCAN_CCCR.INIT to 1 to prevent any further
Page 2440: CAN transfers. Now the FDCAN acknowledges that it is ready for power down by setting
Page 2440: FDCAN_CCCR.CSA to 1. In this state, before the clocks are switched off, further register
Page 2440: accesses can be made. A write access to FDCAN_CCCR.INIT will have no effect. Now the
Page 2440: resetting CC control register flag FDCAN_CCCR.CSR. The FDCAN will acknowledge this
Page 2440: by resetting FDCAN_CCCR.CSA. Afterwards, the application can restart CAN
Page 2440: communication by resetting bit FDCAN_CCCR.INIT.
Page 2440: To enable write access to FDCAN Test register (see Section 55.4.4 on page 2493), bit
Page 2440: FDCAN_CCCR.TEST has to be set to 1, thus enabling the configuration of test modes and
Page 2440: Four output functions are available for the CAN transmit pin FDCAN_TX by programming
Page 2440: FDCAN_TEST.TX. Additionally to its default function – the serial data output – it can drive
Page 2440: the CAN Sample Point signal to monitor the FDCAN bit timing and it can drive constant
Page 2440: dominant or recessive values. The actual value at pin FDCAN_RX can be read from
Page 2440: FDCAN_TEST.RX. Both functions can be used to check the CAN bus physical layer.
Page 2440: Due to the synchronization mechanism between CAN kernel clock and APB clock domain,
Page 2440: there may be a delay of several APB clock periods between writing to FDCAN_TEST.TX
Page 2440: until the new configuration is visible at FDCAN_TX output pin. This applies also when
Page 2440: reading FDCAN_RX input pin via FDCAN_TEST.RX.
Page 2440: FDCAN_TX pin interferes with all CAN protocol functions. It is not recommended to use test
Page 2440: The FDCAN can be set in external loop back mode by programming FDCAN_TEST.LBCK
Page 2440: to 1. In loop back mode, the FDCAN treats its own transmitted messages as received
Page 2440: side) shows the connection of transmit and receive signals FDCAN_TX and FDCAN_RX to
Page 2440: the FDCAN in external loop back mode.
Page 2440: the FDCAN ignores acknowledge errors (recessive bit sampled in the acknowledge slot of a
Page 2440: data/remote frame) in loop back mode. In this mode the FDCAN performs an internal
Page 2440: feedback from its transmit output to its receive input. The actual value of the FDCAN_RX
Page 2440: input pin is disregarded by the FDCAN. The transmitted messages can be monitored at the
Page 2440: FDCAN_TX transmit pin.
Page 2440: Internal loop back mode is entered by programming bits FDCAN_TEST.LBCK and
Page 2440: FDCAN_CCCR.MON to 1. This mode can be used for a “Hot Selftest”, meaning the FDCAN
Page 2440: can be tested without affecting a running CAN system connected to the FDCAN_TX and
Page 2440: FDCAN_RX pins. In this mode, FDCAN_RX pin is disconnected from the FDCAN and
Page 2440: FDCAN_TX pin is held recessive. Figure 733 (right side) shows the connection of
Page 2440: FDCAN_TX and FDCAN_RX pins to the FDCAN in case of internal loop back mode.
Page 2441: RM0433                                                        FD controller area network (FDCAN)
Page 2441: FDCANx_Tx            FDCAN_Rx                   FDCANx_Tx            FDCAN_Rx
Page 2441: FDCAN                                           FDCAN
Page 2441: Application watchdog (FDCAN1 only)
Page 2441: The application watchdog is served by reading register FDCAN_TTOST. When the
Page 2441: application watchdog is not served in time, bit FDCAN_TTOST.AWE is set, all TTCAN
Page 2441: communication is stopped, and the FDCAN1 is set into bus monitoring mode.
Page 2441: The TT application watchdog can be disabled by programming the application watchdog
Page 2441: limit FDCAN_TTOCF.AWL to 0x00. The TT application watchdog should not be disabled in
Page 2441: a TTCAN application program
Page 2441: For timestamp generation the FDCAN supplies a 16-bit wraparound counter. A prescaler
Page 2441: FDCAN_TSCC.TCP can be configured to clock the counter in multiples of CAN bit times
Page 2441: (1 … 16). The counter is readable via FDCAN_TSCV.TCV. A write access to register
Page 2441: FDCAN_TSCV resets the counter to 0. When the timestamp counter wraps around interrupt
Page 2441: flag FDCAN_IR.TSW is set.
Page 2441: By programming bit FDCAN_TSCC.TSS, a 16-bit timestamp can be used.
Page 2441: To signal timeout conditions for Rx FIFO 0, Rx FIFO 1, and the Tx event FIFO the FDCAN
Page 2441: controlled by FDCAN_TSCC.TCP as the timestamp counter. The timeout counter is
Page 2441: configured via register FDCAN_TOCC. The actual counter value can be read from
Page 2441: FDCAN_TOCV.TOC. The timeout counter can only be started while
Page 2441: FDCAN_CCCR.INIT = 0. It is stopped when FDCAN_CCCR.INIT = 1, e.g. when the FDCAN
Page 2441: The operation mode is selected by FDCAN_TOCC.TOS. When operating in Continuous
Page 2441: mode, the counter starts when FDCAN_CCCR.INIT is reset. A write to FDCAN_TOCV
Page 2442: FD controller area network (FDCAN)                                                                     RM0433
Page 2442: presets the counter to the value configured by FDCAN_TOCC.TOP and continues
Page 2442: counter to the value configured by FDCAN_TOCC.TOP. Down-counting is started when the
Page 2442: first FIFO element is stored. Writing to FDCAN_TOCV has no effect.
Page 2442: When the counter reaches 0, interrupt flag FDCAN_IR.TOO is set. In Continuous mode, the
Page 2442: counter is immediately restarted at FDCAN_TOCC.TOP.
Page 2442: Note:       The clock signal for the timeout counter is derived from the CAN core sample point signal.
Page 2442: synchronization/re-synchronization mechanism of the CAN core. If the baudrate switch
Page 2442: feature in FDCAN is used, the timeout counter is clocked differently in arbitration and data
Page 2442: The message RAM has a width of 32 bits. The FDCAN module can be configured to allocate
Page 2442: When the FDCAN addresses the message RAM it addresses 32-bit words, not single bytes.
Page 2442: evaluated, the two least significant bits are ignored.
Page 2442: Note:       The FDCAN does not check for erroneous configuration of the message RAM. Especially
Page 2443: RM0433                                                          FD controller area network (FDCAN)
Page 2443: The FDCAN offers the possibility to configure two sets of acceptance filters, one for
Page 2443: standard identifiers and one for extended identifiers. These filters can be assigned to Rx
Page 2443: •    Each filter element can be configured as
Page 2443: •    Each filter element can be enabled/disabled individually
Page 2443: •    Global filter configuration (FDCAN_GFC)
Page 2443: •    Standard ID filter configuration (FDCAN_SIDFC)
Page 2443: •    Extended ID filter configuration (FDCAN_XIDFC)
Page 2443: •    Extended ID AND Mask (FDCAN_XIDAM)
Page 2443: •    Set high priority message interrupt flag FDCAN_IR.HPM
Page 2443: •    Set high priority message interrupt flag FDCAN_IR.HPM and store received frame in
Page 2443: •    Set high priority message interrupt flag FDCAN_IR.HPM and store received frame in
Page 2443: matching Rx buffer or Rx FIFO. If the CAN protocol controller has detected an error
Page 2443: received data. For error type see FDCAN_PSR.LEC and FDCAN_PSR.DLEC.
Page 2444: FD controller area network (FDCAN)                                                                  RM0433
Page 2444: overwritten with received data. For error type see FDCAN_PSR.LEC and
Page 2444: FDCAN_PSR.DLEC. In case the matching Rx FIFO is operated in overwrite mode, the
Page 2444: Mask (FDCAN_XIDAM) before the range filter is applied
Page 2444: •    EFT = 11: The extended ID AND Mask (FDCAN_XIDAM) is not used for range filtering
Page 2444: A filter element can be configured to filter for one or two specific message IDs. To filter for
Page 2445: RM0433                                                                                       FD controller area network (FDCAN)
Page 2445: Controlled by the global filter configuration (FDCAN_GFC) and the standard ID filter
Page 2445: configuration (FDCAN_SIDFC) message ID, remote transmission request bit (RTR), and the
Page 2446: FD controller area network (FDCAN)                                                                                                             RM0433
Page 2446: Controlled by the global filter configuration FDCAN_GFC and the extended ID filter
Page 2446: configuration FDCAN_XIDFC message ID, remote transmission request bit (RTR), and the
Page 2446: The extended ID AND Mask (FDCAN_XIDAM) is AND-ed with the received identifier before
Page 2446: Rx FIFO 0 and Rx FIFO 1 can be configured to hold up to 64 elements each. Configuration
Page 2446: of the two Rx FIFOs is done via registers FDCAN_RXF0C and FDCAN_RXF1C.
Page 2447: RM0433                                                         FD controller area network (FDCAN)
Page 2447: element is described in Section 55.3.17: FDCAN Rx buffer and FIFO element.
Page 2447: When an Rx FIFO full condition is signaled by FDCAN_IR.RFnF, no further messages are
Page 2447: FDCAN_IR.RFnL is set.
Page 2447: To avoid an Rx FIFO overflow, the Rx FIFO watermark can be used. When the Rx FIFO fill
Page 2447: level reaches the Rx FIFO watermark configured by FDCAN_RXFnC.FnWM, interrupt flag
Page 2447: FDCAN_IR.RFnW is set.
Page 2447: signaled by RXFnS.FnF = 1. In addition interrupt flag FDCAN_IR.RFnF is set.
Page 2447: interrupt flag FDCAN_IR.RFnL is set.
Page 2447: that it can happen that a received message is written to the message RAM (put index) while
Page 2447: The FDCAN supports up to 64 dedicated Rx buffers. The start address of the dedicated Rx
Page 2447: buffer section is configured via FDCAN_RXBC.RBSA.
Page 2448: FD controller area network (FDCAN)                                                                RM0433
Page 2448: Section 55.3.20: FDCAN standard message ID filter element and Section 55.3.21: FDCAN
Page 2448: as for an Rx FIFO element. In addition the flag FDCAN_IR.DRX (message stored in
Page 2448: •    Reset interrupt flag FDCAN_IR.DRX
Page 2448: FDCAN_IR.DRX are set. The reception of debug messages can be monitored via
Page 2448: FDCAN_RXF1S.DMS.
Page 2449: RM0433                                                          FD controller area network (FDCAN)
Page 2449: and the Tx queue. It controls the transfer of transmit messages to the CAN core, the put and
Page 2449: get Indices, and the Tx event FIFO.Up to 32 Tx buffers can be set up for message
Page 2449: size (FDCAN_RXESC), between two and sixteen 32-bit words (Rn = 3 ... 17) are used for
Page 2449: storage of a CAN message data field.
Page 2449: FDCAN_CCCR                   Tx buffer element
Page 2449: Ignored             0            Ignored        Ignored                Classic CAN
Page 2449: 0                1               0           Ignored                Classic CAN
Page 2449: 1                1               0           Ignored                Classic CAN
Page 2449: Note:    AUTOSAR requires at least three Tx queue buffers and support of transmit cancellation.
Page 2449: The Tx handler starts a Tx scan to check for the highest priority pending Tx request (Tx
Page 2449: FDCAN_TXBRP is updated, or when a transmission has been started.
Page 2449: This feature is intended for use in CAN systems where the CAN message identifiers are
Page 2449: (permanently) specified to specific values and cannot easily be changed. These message
Page 2449: identifiers may have a higher CAN arbitration priority than other defined messages, while in
Page 2449: case where one ECU sends a burst of CAN messages that cause another ECU CAN
Page 2449: messages to be delayed because that other messages have a lower CAN arbitration priority.
Page 2449: If, as an example, CAN ECU-1 has the feature enabled and is requested by its application
Page 2449: wait for two CAN bit times of bus idle before it is allowed to start the next requested
Page 2450: FD controller area network (FDCAN)                                                             RM0433
Page 2450: message releases the CAN bus.
Page 2450: The feature is controlled by TXP bit in FDCAN_CCCR register. If the bit is set, the FDCAN
Page 2450: will, each time it has successfully transmitted a message, pause for two CAN bit times
Page 2450: before starting the next transmission. This enables other CAN nodes in the network to
Page 2450: (FDCAN_CCCR.TXP = 0).
Page 2450: FDCAN_TXBAR.ARn. The requested messages arbitrate internally with messages from an
Page 2450: optional Tx FIFO or Tx queue and externally with messages on the CAN bus, and are sent
Page 2450: transmit buffer index (0 … 31) to the Tx buffer start address FDCAN_TXBC.TBSA.
Page 2450: FDCAN_TXESC.TBDS[2;0]              Data field (bytes)         Element size (RAM words)
Page 2450: Tx FIFO operation is configured by programming FDCAN_TXBC.TFQM to 0. Messages
Page 2450: FDCAN_TXFQS.TFGI. After each transmission the get index is incremented cyclically until
Page 2450: Tx FIFO. The FDCAN calculates the Tx FIFO free level FDCAN_TXFQS.TFFL as difference
Page 2451: RM0433                                                         FD controller area network (FDCAN)
Page 2451: referenced by the put index FDCAN_TXFQS.TFQPI. An add request increments the put
Page 2451: Full (FDCAN_TXFQS.TFQF = 1) is signaled. In this case no further messages should be
Page 2451: 1 to the FDCAN_TXBAR bit related to the Tx buffer referenced by the Tx FIFO put index.
Page 2451: FDCAN_TXBAR. The put index is then cyclically incremented by n. The number of
Page 2451: When a transmission request for the Tx buffer referenced by the get index is canceled, the
Page 2451: FIFO free level is recalculated. When transmission cancellation is applied to any other Tx
Page 2451: index FDCAN_TXFQS.TFQPI (0 … 31) to the Tx buffer start address FDCAN_TXBC.TBSA.
Page 2451: Tx queue operation is configured by programming FDCAN_TXBC.TFQM to 1. Messages
Page 2451: FDCAN_TXFQS.TFQPI. An add request cyclically increments the put index to the next free
Page 2451: Tx buffer. In case that the Tx queue is full (FDCAN_TXFQS.TFQF = 1), the put index is not
Page 2451: canceled.
Page 2451: The application may use register FDCAN_TXBRP instead of the put index and may place
Page 2451: queue put index FDCAN_TXFQS.TFQPI (0 … 31) to the Tx buffer start address
Page 2451: FDCAN_TXBC.TBSA.
Page 2451: FDCAN_TXBC.NDTB. The number of Tx buffers assigned to the Tx FIFO is configured by
Page 2451: FDCAN_TXBC.TFQS. In case, FDCAN_TXBC.TFQS is programmed to 0, only dedicated
Page 2452: FD controller area network (FDCAN)                                                                RM0433
Page 2452: •    Scan dedicated Tx buffers and oldest pending Tx FIFO buffer (referenced by
Page 2452: FDCAN_TXFS.TFGI)
Page 2452: FDCAN_TXBC.NDTB. The number of Tx queue buffers is configured by
Page 2452: FDCAN_TXBC.TFQS. If FDCAN_TXBC.TFQS is programmed to 0, only dedicated Tx
Page 2452: •    Scan all Tx buffers with activated transmission request
Page 2453: RM0433                                                         FD controller area network (FDCAN)
Page 2453: Transmit cancellation
Page 2453: The FDCAN supports transmit cancellation. To cancel a requested transmission from a
Page 2453: position (= number of Tx buffer) of register FDCAN_TXBCR. Transmit cancellation is not
Page 2453: Successful cancellation is signaled by setting the corresponding bit of register
Page 2453: FDCAN_TXBCF to 1.
Page 2453: In case a transmit cancellation is requested while a transmission from a Tx buffer is already
Page 2453: ongoing, the corresponding FDCAN_TXBRP bit remains set as long as the transmission is
Page 2453: in progress. If the transmission was successful, the corresponding FDCAN_TXBTO and
Page 2453: FDCAN_TXBCF bits are set. If the transmission was not successful, it is not repeated and
Page 2453: only the corresponding FDCAN_TXBCF bit is set.
Page 2453: Note:    In case a pending transmission is canceled immediately before this transmission could have
Page 2453: To support Tx event handling the FDCAN has implemented a Tx event FIFO. After the
Page 2453: FDCAN has transmitted a message on the CAN bus, message ID and timestamp are stored
Page 2453: The Tx event FIFO can be configured to a maximum of 32 elements. The Tx event FIFO
Page 2453: (FDCAN_TXESC), between two and sixteen 32-bit words (Tn = 3 ..17) are used for storage
Page 2453: of a CAN message data field.
Page 2453: especially when operating a dynamically managed transmit queue, that a Tx buffer can be
Page 2453: When a Tx event FIFO full condition is signaled by FDCAN_IR.TEFF, no further elements
Page 2453: FIFO is full, this event is discarded and interrupt flag FDCAN_IR.TEFL is set.
Page 2453: To avoid a Tx event FIFO overflow, the Tx event FIFO watermark can be used. When the Tx
Page 2453: FDCAN_TXEFC.EFWM, interrupt flag FDCAN_IR.TEFW is set.
Page 2453: FDCAN_TXEFS.EFGI has to be added to the Tx event FIFO start address
Page 2453: FDCAN_TXEFC.EFSA.
Page 2453: the corresponding FIFO acknowledge index, see FDCAN Rx FIFO 0 acknowledge register
Page 2454: FD controller area network (FDCAN)                                                              RM0433
Page 2454: (FDCAN_RXF0A), FDCAN Rx FIFO 1 acknowledge register (FDCAN_RXF1A), and FDCAN
Page 2454: Tx event FIFO configuration register (FDCAN_TXEFC). Writing to the FIFO acknowledge
Page 2454: Due to the fact that the CPU has free access to the FDCAN message RAM, special care
Page 2454: The FDCAN does not check for erroneous values.
Page 2454: PROP_SEG and PHASE_SEG1 of the CAN standard, its duration is programmable
Page 2454: PHASE_SEG2 of the CAN standard, its duration is programmable between one and
Page 2455: RM0433                                                          FD controller area network (FDCAN)
Page 2455: –    tq = (FDCAN_NBTP.NBRP[8:0] + 1) * tfdcan_tq_clk
Page 2455: –    tBS1 = tq * (FDCAN_NBTP.NTSEG1[7:0] + 1)
Page 2455: –    tBS2 = tq * (FDCAN_NBTP.NTSEG2[6:0] + 1)
Page 2455: –    tq = (FDCAN_DBTP.DBRP[4:0] + 1) * tfdcan_tq_clk
Page 2455: –    tBS1 = tq * (FDCAN_DBTP.DTSEG1[4:0] + 1)
Page 2455: –    tBS2 = tq * (FDCAN_DBTP.DTSEG2[3:0] + 1)
Page 2455: only possible while the device is in Standby mode. Registers FDCAN_DBTP and
Page 2455: FDCAN_NBTP (dedicated, respectively, to data and nominal bit timing) are only accessible
Page 2455: when FDCAN_CCCR.CCE and FDCAN_CCCR.INIT are set.
Page 2455: Note:    For a detailed description of the CAN bit timing and resynchronization mechanism, refer to
Page 2455: 55.3.5   Clock calibration on CAN
Page 2455: the FDCAN1 and FDCAN2. The CCU has to be initialized via FDCAN_CCFG register. The
Page 2455: FDCAN_CCFG register can be written only when FDCAN1 has both FDCAN_CCCR.CCE
Page 2455: and FDCAN_CCCR.INIT bits set. In consequence the CCU and the FDCAN1 initialization
Page 2455: needs to be completed before any FDCAN1 and/or FDCAN2 module can operate.
Page 2455: Clock calibration is bypassed when FDCAN_CCFG.BCC = 1 (see Figure 740).
Page 2456: FD controller area network (FDCAN)                                                                      RM0433
Page 2456: fdcan_ker_ck                          / 1..30                          Clock
Page 2456: fdcan_tq_ck
Page 2456: fdcan_pclk
Page 2456: The clock calibration on CAN unit is designed to operate under the following conditions:
Page 2456: •    a CAN kernel clock frequency fdcan_ker_ck up to 80 MHz
Page 2456: •    FDCAN bitrates:
Page 2456: The clock calibration on FDCAN unit generates a calibrated time quanta clock fdcan_tq_ck
Page 2456: Note:       The FDCAN requires that the CAN time quanta clock is always below or equal to the APB
Page 2456: clock (fdcan_tq_ck < fdcan_pclk). This has to be considered when the clock calibration on
Page 2456: CAN unit is bypassed (FDCAN_CCFG.BCC = 1).
Page 2456: •    Dynamic clock tolerance at the CAN kernel clock input fdcan_ker_ck
Page 2456: a maximum error of one fdcan_pclk period. The number of bits used for measurement
Page 2456: of the bit time is 32 or 64-bit, depending on configuration of FDCAN_CCFG.CFL.
Page 2456: requirements of the FDCAN1 module.
Page 2456: Calibration of the time quanta clock fdcan_tq_ck via CAN messages is performed by
Page 2456: adapting a clock divider that generates the CAN protocol time quantum tq from the clock
Page 2456: fdcan_ker_ck.
Page 2456: dominant is measured, this time to be assumed two CAN bit times, counted in PLL
Page 2456: clock periods. The clock divider (FDCAN_CCFG.CDIV) is updated each time a new
Page 2457: RM0433                                                                     FD controller area network (FDCAN)
Page 2457: when the CAN protocol controller detects a valid CAN message.
Page 2457: CAN frame by counting the number of fdcan_ker_ck periods. The length of this bit
Page 2457: sequence can be configured to 32 or 64 bits via FDCAN_CCFG.CLF. For a calibration
Page 2457: A change in the calibration state sets interupt flag FDCAN_CCU_IR.CSC, if enabled by the
Page 2457: interupt enable FDCAN_CCU_IE.CSCE. it remains set until cleared by writing 1 in
Page 2457: FDCAN_CCU_IR.CSC.
Page 2457: Until precision calibration is achieved, FDCAN1 and FDCAN2 operate in a restricted mode
Page 2457: calibration of the fdcan_ker_clk is done by software by evaluating the calibration status from
Page 2457: register CCU_CSTAT, FDCAN1 and FDCAN2 have to be set to restricted operation mode
Page 2457: (FDCAN_CCCR.ASM = 1) until the calibration on CAN unit is in state Precision_Calibrated
Page 2457: Precision calibration may be performed only on valid CAN frames transmitted by a node
Page 2457: with a stable, quartz-controlled clock. calibration frames are detected by the FDCAN1
Page 2457: acceptance filtering A filter element and a Rx buffer have to be configured in the FDCAN1 to
Page 2458: FD controller area network (FDCAN)                                                                  RM0433
Page 2458: In case there is only one CAN transmitter with a quartz clock in the network, this node has to
Page 2458: field or in the identifier. This assures that the non-quartz nodes can enter state
Page 2458: Note:       When the clock calibration on CAN unit transits from state Precision_Calibrated back to
Page 2458: Basic_Calibrated, the calibration OK signal is deasserted, the FDCAN1 complete ongoing
Page 2458: The clock calibration on CAN unit is configured via register FDCAN_CCFG, i.e. when
Page 2458: FDCAN1 has FDCAN_CCCR.CCE and FDCAN_CCCR.INIT bits set.
Page 2458: falling edges at pin FDCAN1_RX is measured. The number of clock periods depends on the
Page 2458: clock frequency applied at input fdcan_ker_ck. In case the measured number of clock
Page 2458: periods is below the minimum configured by FDCAN_CCFG.OCPM (as an example,
Page 2458: because of a glitch on FDCAN1_RX) the value is discarded and measurement continues.
Page 2458: It is recommended to configure FDCAN_CCFG.OCPM slightly below two CAN bit times:
Page 2458: FDCAN_CCFG.OCPM < ((2 x CAN bit time) / fdcan_ker_ck period) / 32
Page 2458: The length of the bit field used for precision calibration can be configured to 32 or 64 bits via
Page 2458: FDCAN_CCFG.CFL. The number of bits used for precision calibration has an impact on
Page 2458: The number of time quanta per bit time configured by FDCAN_CCFG.TQBT is used
Page 2458: together with the measured number of oscillator clock periods FDCAN_CCU_CSTAT.OCPC
Page 2458: When the clock calibration is bypassed by configuring FDCAN_CCFG.BCC = 1, the internal
Page 2458: clock divider has to be configured via FDCAN_CCFG.CDIV to fulfill the condition
Page 2458: fdcan_tq_ck < fdcan_pclk.
Page 2458: Note:       When clock calibration on CAN is active (FDCAN_CCFG.BCC = 0), the baudrate prescalers
Page 2458: of FDCAN1 and FDCAN2 have to be configured to inactive.
Page 2458: The status of the clock calibration on CAN unit can be monitored by reading register
Page 2458: FDCAN_CCU_CSTAT. When in state Precision_Calibrated the oscillator clock period
Page 2458: counter FDCAN_CCU_CSTAT.OCPC signals the number of oscillator clock periods in the
Page 2458: calibration field while FDCAN_CCU_CSTAT.TQC signals the number of time quanta in the
Page 2458: The calibration state is monitored by FDCAN_CCU_CSTAT.CALS. A change in the
Page 2458: calibration state sets interupt flag FDCAN_CCU_IR.CSC, if enabled by the interrupt enable
Page 2458: FDCAN_CCU_IE.CSCE. it remains set until cleared by writing 1 in CCU_IR.CSC.
Page 2458: A calibration watchdog event also sets interrupt flag FDCAN_CCU_IR.CWE. If enabled by
Page 2458: FDCAN_CCU_IE.CWEE, interrupt line cu_int is activated (set to high). Interrupt line cu_int
Page 2458: remains active until interrupt flag FDCAN_CCU_IR.CWE is reset
Page 2459: RM0433                                                          FD controller area network (FDCAN)
Page 2459: (FDCAN_CCFG.CDIV = 0x0000). In this operation mode the input clock fdcan_ker_ck is
Page 2459: directly routed to the clock output fdcan_tq_ck. In this case fdcan_tq_ck is independent from
Page 2459: the configuration and status of FDCAN1and FDCAN2 connected to the CCU. With a
Page 2459: fdcan_ker_ck of 20 / 40 / 80 MHz CAN FD operation is possible.
Page 2459: The clock calibration on CAN unit also supports software calibration of fdcan_ker_ck by
Page 2459: fixed to 1, the clock from fdcan_ker_ck is routed to output fdcan_tq_ck
Page 2459: (FDCAN_CCFG.BCC = 1).
Page 2459: The input clock fdcan_ker_ck must be in the range between 80MHz and 100 MHz. The
Page 2459: clock divider of CCU has to be configured via FDCAN_CCFG.CDIV to bring fdcan_tq_ck to
Page 2459: a valid range. All other configuration parameters have to be set via FDCAN_CCFG. For
Page 2459: correct operation of tFDCAN1and FDCAN2, the APB clock fdcan_pclk needs to be equal or
Page 2459: higher than the time quanta clock (fdcan_tq_ck). CAN FD operation is not possible.
Page 2459: For startup FDCAN1 and FDCAN2 have to be both configured for restricted operation
Page 2459: (FDCAN_CCCR.ASM = 1) before FDCAN_CCCR.INIT is reset. The input clock
Page 2459: fdcan_ker_ck has to be adjusted until the clock calibration on CAN unit has reached state
Page 2459: Precision_Calibrated. Now the software can reset FDCAN_CCCR.ASM and the CANFD1
Page 2459: and CANFD2 can start normal operation.
Page 2459: During operation the software has to check regularly whether the clock calibration on CAN
Page 2459: unit is still in state Precision_Calibrated. In case the clock calibration on CAN unit has left
Page 2459: state Precision_Calibrated due to drift of fdcan_ker_ck, FDCAN1 and FDCAN2 have to be
Page 2459: set into restricted operation mode by programming FDCAN_CCCR.INIT,
Page 2459: FDCAN_CCCR.CCE, and FDCAN_CCCR.ASM to 1. After fdcan_ker_ck has been adjusted
Page 2459: successfully (clock calibration on CAN unit is in state Precision_Calibrated), FDCAN1 and
Page 2459: FDCAN2 can resume normal operation.
Page 2459: Note:    Trimming accuracy needs to be to sufficient to meet the CAN clock tolerance requirements
Page 2459: This operation mode is entered by resetting FDCAN_CCFG.BCC to 0. In this operation
Page 2459: mode the CCU output signals cu_cok and fdcan_ker_ck are controlled by the CCU. When
Page 2459: Generation of CCU output signals fdcan_tq_ck and cu_cok depends on the state of the
Page 2459: FDCAN1. Input clock fdcan_ker_ck must be in the range between 80 and 100 MHz.
Page 2459: Configuration of the CCU and FDCAN1 is required. CAN FD operation is not possible.
Page 2459: In case FDCAN1 turns to Bus_Off or when its INIT bit is set by Host command
Page 2459: (FDCAN_CCCR.INIT = 1), the CCU enters state Not_Calibrated and output cu_cok is reset
Page 2459: to 0. CANFD1 and CANFD2 enter restricted operation mode.
Page 2459: Note:    This is the default operation mode after reset in case the reset value of FDCAN_CCFG.BCC
Page 2460: FD controller area network (FDCAN)                                                                    RM0433
Page 2460: 55.3.6        TTCAN operations (FDCAN1 only)
Page 2460: A reference message is a data frame characterized by a specific CAN identifier. It is
Page 2460: message may be extended by other data up to the sum of eight CAN data bytes. All bits of
Page 2460: configured via register FDCAN_TTRMC.
Page 2460: Level 1 operation is configured via FDCAN_TTOCF.OM = 01 and FDCAN_TTOCF.GEN.
Page 2460: Level 2 operation is configured via FDCAN_TTOCF.OM = 10 and FDCAN_TTOCF.GEN.
Page 2460: shown in Table 467. Cycle_Count and the lower four bits of FDCAN_NTU_Res are optional.
Page 2460: The TTCAN does not evaluate NTU_Res[3:0] from received reference messages, it always
Page 2461: RM0433                                                          FD controller area network (FDCAN)
Page 2461: Level 0 operation is configured via FDCAN_TTOCF.OM = 11. External event-synchronized
Page 2461: The TTCAN does not evaluate NTU_Res[3:0] from received reference messages, it always
Page 2461: 55.3.7   TTCAN configuration
Page 2461: TTCAN timing
Page 2461: TTCAN level 1 the NTU is the nominal CAN bit time. In TTCAN level 0 and level 2 the NTU
Page 2461: In TTCAN level 0 and level 2 the length of the NTU is defined by the time unit Ratio TUR.
Page 2461: TUR = FDCAN_TURNA.NAV / FDCAN_TURCF.DC. The NTU length is given by
Page 2461: NTU = CAN clock period x TUR.
Page 2462: FD controller area network (FDCAN)                                                            RM0433
Page 2462: The TUR numerator configuration NC is an 18-bit number, FDCAN_TURCF[NCL[15:0]] can
Page 2462: be programmed in the range 0x0000–0xFFFF. FDCAN_TURCF[NCH[17:16]] is hard wired
Page 2462: to 0b01. When 0xnnnn is written to FDCAN_TURCF[NCL[15:0]], FDCAN_TURNA.NAV
Page 2462: FDCAN_TURCF.DC is a 14-bit number. FDCAN_TURCF.DC may be programmed in the
Page 2462: In level 1, NC must be equal or higher than 4 x FDCAN_TURCF.DC. In level 0 and level 2
Page 2462: NC must be equal or higher than 8 x FDCAN_TURCF.DC to get the 3-bit resolution for the
Page 2462: A hardware reset presets FDCAN_TURCF.DC to 0x1000 and FDCAN_TURCF.NCL to
Page 2462: 0x10000, resulting in an NTU consisting of sixteen CAN clock periods. Local time and
Page 2462: application watchdog are not started before either the FDCAN_CCCR.INIT is reset, or
Page 2462: FDCAN_TURCF.ELT is set. FDCAN_TURCF.ELT may not be set before the NTU is
Page 2462: configured. Setting FDCAN_TURCF.ELT to 1 also locks the write access to register
Page 2462: FDCAN_TURCF.
Page 2462: At startup FDCAN_TURNA.NAV is updated from NC (= FDCAN_TURCF.NCL + 0x10000)
Page 2462: when FDCAN_TURCF.ELT is set. In TTCAN level 1 there is no drift compensation.
Page 2462: FDCAN_TURNA.NAV does not change during operation, it is always equal to NC.
Page 2462: In TTCAN level 0 and level 2 there are two possibilities for FDCAN_TURNA.NAV to change.
Page 2462: When operating as time slave or backup time master, and when FDCAN_TTOCF.ECC is
Page 2462: set, FDCAN_TURNA.NAV is updated automatically to the value calculated from the
Page 2462: monitored global time speed, as long as the TTCAN is in synchronization state In_Schedule
Page 2462: time master, and when FDCAN_TTOCF.EECS is set, the Host may update
Page 2462: FDCAN_TURCF.NCL. When the Host sets FDCAN_TTOCN.ECS, FDCAN_TURNA.NAV
Page 2462: FDCAN_TTOST.WECS as is set when FDCAN_TTOCN.ECS is set and is cleared when
Page 2462: FDCAN_TURNA.NAV is updated. FDCAN_TURCF.NCL is write locked while
Page 2462: FDCAN_TTOST.WECS is set.
Page 2462: In TTCAN level 0 and level 2 the clock calibration process adapts FDCAN_TURNA.NAV in
Page 2462: the range of the synchronization deviation limit SDL of NC ± 2(FDCAN_TTOCF.LDSDL + 5).
Page 2462: FDCAN_TURCF.NCL should be programmed to the largest applicable numerical value in
Page 2462: order to achieve the best accuracy in the calculation of FDCAN_TURNA.NAV.
Page 2462: The synchronization deviation SD is the difference between NC and FDCAN_TURNA.NAV
Page 2462: (SD = | NC - FDCAN_TURNA.NAV |). It is limited by the synchronization deviation limit SDL,
Page 2462: which is configured by its dual logarithm FDCAN_TTOCF.LDSDL
Page 2462: (SDL = 2 (FDCAN_TTOCF.LDSDL + 5)) and should not exceed the clock tolerance given by
Page 2462: the CAN bit timing configuration. SD is calculated at each new basic cycle. When the
Page 2462: reference message is set, the drift compensation is suspended and FDCAN_TTIR.GTE is
Page 2462: set and FDCAN_TTOSC.QCS is reset, or in case of the Disc_Bit = 1, FDCAN_TTIR.GTD is
Page 2462: FDCAN
Page 2463: RM0433                                                          FD controller area network (FDCAN)
Page 2463: FDCAN_TTOCN.ECS schedules NC for activation by the next reference message.
Page 2463: FDCAN_TTOCN.SGT schedules FDCAN_TTGTP.TP for activation by the next reference
Page 2463: message. Setting FDCAN_TTOCN.ECS and FDCAN_TTOCN.SGT requires
Page 2463: FDCAN_TTOCF.EECS to be set (external clock synchronization enabled) while the FDCAN
Page 2463: The TTCAN module provides an application watchdog to verity the function of the
Page 2463: application program. The Host has to serve this watchdog regularly, else all CAN bus
Page 2463: activity is stopped. The application watchdog limit FDCAN_TTOCF.AWL specifies the
Page 2463: of NTUs is 256. The application watchdog is served by reading register FDCAN_TTOST.
Page 2463: FDCAN_TTOST.AWE indicates whether the watchdog has been served in time. In case the
Page 2463: application failed to serve the application watchdog, interrupt flag FDCAN_TTIR.AW is set.
Page 2463: FDCAN_TTOCF.AWL to 0x00, see Section 55.4.49: FDCAN TT operation configuration
Page 2463: register (FDCAN_TTOCF).
Page 2463: The timing events which cause a pulse at output FDCAN trigger time mark interrupt pulse
Page 2463: m_ttcan_tmp and FDCAN register time mark interrupt pulsem_ttcan_rtp are generated in
Page 2463: the CAN clock domain. There is a clock domain crossing delay to be considered before the
Page 2463: same event is visible in the APB clock domain (when FDCAN_TTIR.TTMI is set or
Page 2463: FDCAN_TTIR.RTMI is set). As an example, the signals can be connected to the timing
Page 2463: input(s) of another FDCAN node (fdcan_swt/fdcan_evt), in order to automatically
Page 2463: synchronize two TTCAN networks.
Page 2463: Output FDCAN start of cyclem_ttcan_soc gets active whenever a reference message is
Page 2463: FDCAN_TTOCF.TM controls whether the TTCAN operates as potential time master or as a
Page 2463: FDCAN_TTRMC.RID define the master priority, 0 giving the highest and 7 giving the lowest.
Page 2463: There cannot be two nodes in the network using the same master priority.
Page 2463: FDCAN_TTRMC.RID is used for recognition of reference messages.
Page 2463: FDCAN_TTRMC.RMPS is not relevant for time slaves.
Page 2463: The initial reference trigger offset FDCAN_TTOCF.IRTO is a 7-bit-value that defines (in
Page 2463: recommended value for FDCAN_TTOCF.IRTO is the master priority multiplied with a factor
Page 2463: FDCAN_TTOCF.OM decides whether the node operates in TTCAN level 0, level 1, or level
Page 2463: TTCAN operation mode via FDCAN_TTOCF.OM is the last step in the setup. With
Page 2463: FDCAN_TTOCF.OM = 00 (event-driven CAN communication), the FDCAN operates
Page 2463: according to ISO 11898-1: 2015, without time triggers.With FDCAN_TTOCF.OM = 01 (level
Page 2464: FD controller area network (FDCAN)                                                                 RM0433
Page 2464: 1), the FDCAN operates according to ISO 11898-4, but without the possibility to synchronize
Page 2464: ignored. With FDCAN_TTOCF.OM = 10 (level 2), the TTCAN operates according to ISO
Page 2464: FDCAN_TTOCF.OM = 11 (level 0), the FDCAN operates as event-driven CAN but maintains
Page 2464: FDCAN_TTOCF.EECS enables the external clock synchronization, allowing the application
Page 2464: FDCAN_TTMLM.ENTT in the TT matrix limits register specifies the number of expected
Page 2464: An inaccurate configuration of FDCAN_TTMLM.ENTT will result either in a TxCount
Page 2464: Underflow (FDCAN_TTIR.TXU = 1 and FDCAN_TTOST.EL = 01, severity 1), or in a Tx
Page 2464: count Overflow (FDCAN_TTIR.TXO = 1 and FDCAN_TTOST.EL = 10, severity 2).
Page 2464: FDCAN_TTMLM.CCM specifies the number of the last basic cycle in the system matrix. The
Page 2464: FDCAN_TTMLM.CCM would be 7. FDCAN_TTMLM.CCM is ignored by time slaves, a
Page 2464: FDCAN_TTMLM.TXEW specifies the length of the Tx enable window in NTUs. The Tx
Page 2464: may be started. If a transmission of a message cannot be started inside the Tx enable
Page 2464: the transmission cannot be started in that time window at all. FDCAN_TTMLM.TXEW has to
Page 2464: The trigger memory is part of the external message RAM to which the TTCAN is connected
Page 2464: to (see Section 55.4.26: FDCAN Rx FIFO 0 configuration register (FDCAN_RXF0C)). It
Page 2464: Section 55.3.22: FDCAN trigger memory element).
Page 2465: RM0433                                                         FD controller area network (FDCAN)
Page 2465: time mark. The FDCAN reacts on the transmission request at the next sample point. A new
Page 2465: time can never (with the exception of initialization) be seen at a value lower than n, with n
Page 2465: Length of a basic cycle: Tx_Ref_Trigger time mark + 1 NTU + 1 CAN bit time.
Page 2465: The trigger list will be different for all nodes in the FDCAN network. Each node knows only
Page 2465: (FDCAN_TTOST.EL = 11, severity 3) is detected when a time slave encounters a
Page 2465: time-triggered operation mode. In that mode, Tx_Ref_Trigger is ignored when the FDCAN
Page 2465: synchronization state is In_Gap (FDCAN_TTOST.SYS = 10).
Page 2465: type Tx_Trigger_Arbitration. A configuration error (FDCAN_TTOST.EL = 11, severity 3) is
Page 2465: number of Tx_Triggers (FDCAN_TTMLM.ENTT) is calculated.
Page 2466: FD controller area network (FDCAN)                                                                 RM0433
Page 2466: mode. In that mode, a Watch_Trigger is ignored when the FDCAN synchronization state is
Page 2466: In_Gap (FDCAN_TTOST.SYS = 10).
Page 2466: (FDCAN_TTOST.EL = 11, severity 3) is detected when an End_of_List trigger is
Page 2466: FDCAN_TTOST.SYS = 10) will never become active. The watch triggers themselves will not
Page 2466: when FDCAN_TTOST.SYS = 10) must be set to trigger type End_of_List.
Page 2467: RM0433                                                                  FD controller area network (FDCAN)
Page 2467: FDCAN_TTOCF.IRTO. In case error level 2 is reached (FDCAN_TTOST.EL = 10), the
Page 2467: cycle count is configured by FDCAN_TTMLM.CCM. The cycle code CC is composed of
Page 2467: repeat factor (= value of most significant 1) and the number of the first basic cycle in the
Page 2467: system matrix (= bit field after most significant 1).
Page 2467: a maximum cycle count of FDCAN_TTMLM.CCM = 0x3F matches occur at cycle counts 3,
Page 2468: FD controller area network (FDCAN)                                                                       RM0433
Page 2468: In addition a trigger element can be configured for generation of time mark event internal
Page 2468: The FSE starts the basic cycle with scanning the trigger list starting from 0 until a trigger with
Page 2468: A configuration error is signaled via FDCAN_TTOST.EL = 11 (severity 3) when:
Page 2469: RM0433                                                           FD controller area network (FDCAN)
Page 2469: •    The FSE of a node with FDCAN_TTOCF.TM=0 (time slave) encounters a
Page 2469: FDCAN_TTMLM.TXEW) of a Tx_Trigger with a matching cycle code.
Page 2469: offset FDCAN_TTOST.RTO causes a reversal of their sequential order measured in
Page 2469: TTCAN schedule initialization
Page 2469: The synchronization to the TTCAN message schedule starts when FDCAN_CCCR.INIT is
Page 2469: reset. The TTCAN can operate strictly time-triggered (FDCAN_TTOCF.GEN = 0) or external
Page 2469: event-synchronized time-triggered (FDCAN_TTOCF.GEN = 1). All nodes start with cycle
Page 2469: time 0 at the beginning of their trigger list with FDCAN_TTOST.SYS = 00 (out of
Page 2469: Init_Watch_Trigger, interrupt flag FDCAN_TTIR.IWT is set, the FSE is frozen, and the cycle
Page 2469: time will become invalid, but the node will still be able to take part in CAN bus
Page 2469: the Watch_Triggers, it will assume a fatal error (FDCAN_TTOST.EL = 11, severity 3), set
Page 2469: interrupt flag FDCAN_TTIR.WT, switch off its CAN bus output, and enter the bus monitoring
Page 2469: mode (FDCAN_CCCR.MON set to 1). In the bus monitoring mode it is still able to receive
Page 2469: messages, but it cannot send any dominant bits and therefore cannot give acknowledge.
Page 2469: Note:    To leave the fatal error state, the Host has to set FDCAN_CCCR.INIT = 1. After reset of
Page 2469: FDCAN_CCCR.INIT, the node restarts TTCAN communication.
Page 2469: FDCAN_TTOST.SYS = 01 (Synchronizing), the second sets the FDCAN synchronization
Page 2469: state (depending on its Next_is_Gap bit) to FDCAN_TTOST.SYS = 11 (In_Schedule) or
Page 2469: FDCAN_TTOST.SYS = 10 (In_Gap), enabling all Tx_Triggers and Rx_Triggers.
Page 2470: FD controller area network (FDCAN)                                                                   RM0433
Page 2470: Init_Watch_Trigger, the attempted transmission is aborted, interrupt flag FDCAN_TTIR.IWT
Page 2470: to take part in CAN bus communication (to give acknowledge or to send error flags).
Page 2470: Resetting FDCAN_TTIR.IWT will re-enable the transmission of reference messages until
Page 2470: next time the Init_Watch_Trigger condition is met, or another CAN message is received. The
Page 2470: message but the reference message, it will assume a fatal error (FDCAN_TTOST.EL = 11,
Page 2470: severity 3), set interrupt flag FDCAN_TTIR.WT, switch off its CAN bus output, and enter the
Page 2470: bus monitoring mode (FDCAN_CCCR.MON set to 1). In bus monitoring mode, it is still able
Page 2470: to receive messages, but cannot send any dominant bits and therefore cannot give
Page 2470: FDCAN_TTOST.SYS = 01 (synchronizing), the second sets the FDCAN synchronization
Page 2470: state (depending on its Next_is_Gap bit) to FDCAN_TTOST.SYS = 11 (In_Schedule) or
Page 2470: FDCAN_TTOST.SYS = 10 (In_Gap), enabling all Tx_Triggers and Rx_Triggers.
Page 2470: A potential time master is current time master (FDCAN_TTOST.MS = 11) when it was the
Page 2470: (FDCAN_TTOST.MS = 10).
Page 2470: 55.3.9      TTCAN gap control
Page 2470: All functions related to Gap control apply only when the FDCAN is operated in external
Page 2470: event synchronized time-triggered mode (FDCAN_TTOCF.GEN = 1). In this operation mode
Page 2470: the FDCAN message schedule may be interrupted by inserting Gaps between the basic
Page 2470: cycles of the system matrix. All nodes connected to the CAN network have to be configured
Page 2470: During a Gap, all transmissions are stopped and the CAN bus remains idle. A Gap is
Page 2470: The current time master has two options to initiate a Gap. A Gap can be initiated under
Page 2470: software control when the application program writes FDCAN_TTOCN.NIG = 1. The
Page 2470: Next_is_Gap bit will be transmitted as 1 with the next reference message. A Gap can also
Page 2470: input pin fdcan_evt by writing FDCAN_TTOCN.GCS = 1. When a reference message is
Page 2470: started and FDCAN_TTOCN.GCS is set, a HIGH level at event trigger pin fdcan_evt will set
Page 2470: As soon as that reference message is completed, the FDCAN_TTOST.WFE bit will
Page 2470: For the actual time master and the potential time masters, FDCAN_TTOST.GSI will be set
Page 2470: slaves, bit FDCAN_TTOST.GSI will remain at 0.
Page 2470: (FDCAN_TTOST.SYS = 10), it has four options to intentionally finish a Gap:
Page 2471: RM0433                                                           FD controller area network (FDCAN)
Page 2471: 1.   Under software control by writing FDCAN_TTOCN.FGP = 1.
Page 2471: 2.   Under hardware control (FDCAN_TTOCN.GCS = 1) an edge from HIGH to LOW at the
Page 2471: event-trigger input pin fdcan_evt sets FDCAN_TTOCN.FGP and restarts the schedule.
Page 2471: 3.   The third option is a time-triggered restart. When FDCAN_TTOCN.TMG = 1, the next
Page 2471: register time mark interrupt (FDCAN_TTIR.RTMI = 1) will set FDCAN_TTOCN.FGP
Page 2471: None of these options can cause a basic cycle to be interrupted with a reference message.
Page 2471: Setting of FDCAN_TTOCN.FGP after the Gap time has started will start the transmission of
Page 2471: When FDCAN_TTOCN.FGP is set before the Gap time has started (while the basic cycle is
Page 2471: ignored, as well as the event-trigger input pin fdcan_evt and the bits FDCAN_TTOCN.NIG,
Page 2471: FDCAN_TTOCN.FGP, and FDCAN_TTOCN.TMG.
Page 2471: The stop watch function enables capturing of FDCAN internal time values (local time, cycle
Page 2471: cycle time, or global time as stop watch source via FDCAN_TTOCN.SWS. When
Page 2471: FDCAN_TTOCN.SWS is different from 00 and TT interrupt register flag FDCAN_TTIR.SWE
Page 2471: is 0, the actual value of the time selected by FDCAN_TTTOCN.SWS will be copied into
Page 2471: FDCAN_TTCPT.SWV on the next rising / falling edge (as configured via
Page 2471: FDCAN_TTOCN.SWP) on stop watch trigger pin fdcan_swt. This will set interrupt flag
Page 2471: FDCAN_TTIR.SWE. After the application program has read FDCAN_TTCPT.SWV, it may
Page 2471: enable the next stop watch event by resetting FDCAN_TTIR.SWE to 0.
Page 2471: There are two possible levels in time-triggered CAN:
Page 2471: is represented by a 3-bit counter which can be regarded as a fractional part (three binary
Page 2471: NTU. If the length of the NTU is shorter than eight CAN clock periods (as may be configured
Page 2471: same manner by all FDCAN nodes, including the time master. Any message received or
Page 2472: FD controller area network (FDCAN)                                                                   RM0433
Page 2472: FDCAN_TTCSM. The most significant 16 bits of the difference between Ref_Mark and the
Page 2472: The cycle time that can be read from FDCAN_TTCTC.CT is the difference of the node local
Page 2472: The global time exists for TTCAN level 0 and level 2 only, in level 1 it is invalid. The node
Page 2472: Master_Ref_Marks in the reference message (bytes 3 and 4). The global time that can be
Page 2472: read from FDCAN_TTLGT.GT is the sum of the node local time and its local offset, both
Page 2473: RM0433                                                            FD controller area network (FDCAN)
Page 2473: program by register FDCAN_TTLGT is smoothed by a low-pass filtering to have a
Page 2473: Figure 743. TTCAN level 0 and level 2 drift compensation
Page 2473: Figure 743 describes how in TTCAN levels 0 and 2 each time receiving node compensates
Page 2473: and the Disc_Bit in the reference message is not set, a new value for FDCAN_TURNA.NAV
Page 2473: is calculated. If the synchronization deviation SD = | NC - FDCAN_TURNA.NAV | ≤ SDL
Page 2473: (synchronization deviation limit), the new value for FDCAN_TURNA.NAV takes effect. Else
Page 2473: In TTCAN level 0 and level 2, FDCAN_TTOST.QCS indicates whether the automatic drift
Page 2473: compensation is active or suspended. In TTCAN level 1, FDCAN_TOST.QCS is always 1.
Page 2473: an external clock source. This is enabled by bit FDCAN_TTOCF.EECS.
Page 2474: FD controller area network (FDCAN)                                                                  RM0433
Page 2474: FDCAN_TURCF.NCL (FDCAN_TURCF.DC cannot be updated during operation). The new
Page 2474: value takes effect by writing FDCAN_TTOCN.ECS to 1.
Page 2474: Preset register FDCAN_TTGTP. The new value takes effect by writing
Page 2474: FDCAN_TTOCN.SGT to 1. The first reference message transmitted after the global time
Page 2474: FDCAN_TTOST.QGTP shows whether the node global time is in phase with the time master
Page 2474: global time. FDCAN_TTOST.QGTP is permanently 0 in TTCAN level 1 and when the
Page 2474: synchronization deviation limit is exceeded in TTCAN level 0, 2 (FDCAN_TTOST.QCS = 0).
Page 2474: contained a Disc_Bit = 1 or when FDCAN_TTOST.QCS = 0.
Page 2474: 55.3.12     TTCAN error level
Page 2474: FDCAN_TTOST.RTO set to the maximum value of 127.
Page 2474: 4.   S3 - Severe error - Notification of application. All CAN bus operations are stopped, i.e.
Page 2474: transmission of dominant bits is not allowed, and FDCAN_CCCR.MON is set. The S3
Page 2474: FDCAN_CCCR.CCE).
Page 2474: is detected, the application is notified by FDCAN_TTIR.ELC. The error level is monitored by
Page 2474: FDCAN_TTOST.EL.
Page 2474: The TTCAN signals the following error conditions as required by ISO 11898-4:
Page 2474: –    Sets error level FDCAN_TTOST.EL to 11 when a merged arbitrating time window
Page 2474: –    Sets error level FDCAN_TTOST.EL to 11 when a watch trigger was reached
Page 2474: –    Sets error level FDCAN_TTOST.EL to 11 when the application failed to serve the
Page 2474: FDCAN_TTOCF.AWL. It is served by reading register FDCAN_TTOST. When the
Page 2474: watchdog is not served in time, bit FDCAN_TTOST.AWE and interrupt flag
Page 2475: RM0433                                                          FD controller area network (FDCAN)
Page 2475: FDCAN_TTIR.AW are set, all FDCAN communication is stopped, and the FDCAN
Page 2475: is set into bus monitoring mode (FDCAN_CCCR.MON set to 1).
Page 2475: •   CAN_Bus_Off (S3)
Page 2475: –     Entering CAN_Bus_Off state sets error level FDCAN_TTOST.EL to 11.
Page 2475: CAN_Bus_Off state is signaled by FDCAN_PSR.BO = 1 and
Page 2475: FDCAN_CCCR.INIT = 1.
Page 2475: –     Sets error level FDCAN_TTOST.EL to 10 if the MSC of one Tx_Trigger has
Page 2475: reached 7. In addition interrupt flag FDCAN_TTIR.SE2 is set. The error level
Page 2475: FDCAN_TTOST.EL is reset to 00 at the beginning of a matrix cycle when no
Page 2475: –     Sets error level FDCAN_TTOST.EL to 10 when the Tx count is equal or higher
Page 2475: than the expected number of Tx_T riggers FDCAN_TTMLM.ENTT and a
Page 2475: Tx_Trigger event occurs. In addition interrupt flag FDCAN_TTIR.TXO is set. The
Page 2475: error level FDCAN_TTOST.EL is reset to 00 when the Tx count is no more than
Page 2475: FDCAN_TTMLM.ENTT at the start of a new matrix cycle.
Page 2475: –    Sets error level FDCAN_TTOST.EL to 01 if within one matrix cycle the difference
Page 2475: FDCAN_TTIR.SE1 is set. If within one matrix cycle none of these conditions is
Page 2475: valid, the error level FDCAN_TTOST.EL is reset to 00.
Page 2475: –    Sets error level FDCAN_TTOST.EL to 01 when the Tx count is less than the
Page 2475: expected number of Tx_Triggers FDCAN_TTMLM.ENTT at the start of a new
Page 2475: matrix cycle. In addition interrupt flag FDCAN_TTIR.TXU is set. The error level
Page 2475: FDCAN_TTOST.EL is reset to 00 when the Tx count is at least
Page 2475: FDCAN_TTMLM.ENTT at the start of a new matrix cycle.
Page 2475: 55.3.13   TTCAN message handling
Page 2475: FDCAN_TTRMC.RID. No dedicated Tx buffer is required for transmission of the reference
Page 2475: message. When a reference message is transmitted, the first data byte for TTCAN level 1
Page 2475: (that is, the first four data bytes for TTCAN level 0 and the first four data bytes for TTCAN
Page 2475: In case the reference message Payload select FDCAN_TTRMC.RMPS is set, the rest of the
Page 2475: FDCAN_TTRMC.RMPS         FDCAN_TXBRP.TRP0           Level 0        Level 1         Level 2
Page 2476: FD controller area network (FDCAN)                                                                  RM0433
Page 2476: FDCAN_TTRMC.RMPS          FDCAN_TXBRP.TRP0           Level 0         Level 1         Level 2
Page 2476: pending bit FDCAN_TXBRP.TRP0 of message buffer 0 must be set (see Table 472). In case
Page 2476: bit FDCAN_TXBRP.TRP0 is not set when a reference message is started, the reference
Page 2476: FDCAN_TTRMC.RID is used.
Page 2476: Message reception is done via the two Rx FIFOs in the same way as for event-driven CAN
Page 2476: has to be initialized to 0 during configuration. It is updated while the TTCAN is in
Page 2476: For time-triggered message transmission the TTCAN supplies 32 dedicated Tx buffers (see
Page 2476: Transmit pause). A Tx FIFO or Tx queue is not available when the FDCAN is configured for
Page 2476: time-triggered operation (FDCAN_TTOCF.OM = 01 or 10).
Page 2477: RM0433                                                        FD controller area network (FDCAN)
Page 2477: •   Check whether the previous transmission has completed by reading FDCAN_TXBTO
Page 2477: •   Issue a cancellation request to reset the Tx buffer request pending bit
Page 2477: •   Check whether the cancellation has finished by reading FDCAN_TXBCF
Page 2477: CAN bus was not idle within the corresponding transmit enable window or when the
Page 2477: was disabled (TTCAN in error level S2 or Host has disabled this particular message).
Page 2477: FDCAN_TXBRP.
Page 2477: issue a cancellation request and check whether the cancellation has completed by reading
Page 2477: FDCAN_TXBCF before it starts updating.
Page 2477: time the transmit message may not be updated and its FDCAN_TXBRP bit may not be
Page 2477: has to be large enough to guarantee that the Tx handler can read four words from the
Page 2478: FD controller area network (FDCAN)                                                                  RM0433
Page 2478: CAN arbitration. It is not intended for burst transmission by a node. Since the node does not
Page 2478: cancellation.
Page 2478: number of the trigger element. In merged arbitrating time windows, it can handle up to three
Page 2478: the first is transmitted (or canceled by the Host), the four the request will be ignored.
Page 2478: be started in the order of their Tx_Triggers, so a message with low CAN priority may prevent
Page 2478: 55.3.14     TTCAN interrupt and error handling
Page 2478: The TT interrupt register FDCAN_TTIR consists off our segments. Each interrupt can be
Page 2478: FDCAN_TTIE. The flags remain set until the Host clears them. A flag is cleared by writing a
Page 2478: condition where the CAN communication is stopped. With the exception of IWT, these error
Page 2478: conditions require a re-configuration of the FDCAN module before the communication can
Page 2478: indicates an error condition where the CAN communication is disturbed. If they are caused
Page 2478: by a transient failure, e.g. by disturbances on the CAN bus, they will be handled by the
Page 2478: FDCAN protocol failure handling and do not require intervention by the application program.
Page 2479: RM0433                                                          FD controller area network (FDCAN)
Page 2479: program. With a stop watch event triggered by a rising edge on pin fdcan_swt internal time
Page 2479: referenced by FDCAN_TTOCN.TMC (cycle, local, or global) equals time mark
Page 2479: FDCAN_TTTMK.TM. It can also be used to finish a Gap.
Page 2479: TTCAN level 0 is not part of ISO11898-4. This operation mode makes the hardware, that in
Page 2479: TTCAN level 2 maintains the calibrated global time base, also available for event-driven
Page 2479: CAN according to ISO11898-1.
Page 2479: Level 0 operation is configured via FDCAN_TTOCF.OM = 11. In this mode the FDCAN
Page 2479: operates in event driven CAN communication, there is no fixed schedule, the configuration
Page 2479: of FDCAN_TTOCF.GEN is ignored. External event-synchronized operation is not available
Page 2479: time mark interrupt flag (FDCAN_TTIR.TTMI) is set when the cycle time has reached
Page 2479: FDCAN_TTOCF.IRTO ´ 0x200, it reminds the Host to set a transmission request for
Page 2479: message buffer 0. The Watch_Trigger interrupt flag (FDCAN_TTIR.WT) is set when the
Page 2479: Register time mark interrupts (FDCAN_TTIR.RTMI) are also possible.
Page 2479: messages are recognized by the identifier configured in register FDCAN_TTRMC. For the
Page 2479: •    FDCAN_TTRMC
Page 2479: •    FDCAN_TTOCF except EVTP, AWL, GEN
Page 2479: •    FDCAN_TTMLM except ENTT, TXEW
Page 2479: •    FDCAN_TURCF
Page 2479: •    FDCAN_TTOCN except NIG, TMG, FGP, GCS, TTMIE
Page 2479: •    FDCAN_TTGTP
Page 2479: •    FDCAN_TTTMK
Page 2479: •    FDCAN_TTIR excluding bits CER, AW, IWT SE2, SE1, TXO, TXU, SOG (no function)
Page 2479: •    FDCAN_TTIR the following bits have changed function
Page 2479: FDCAN_TTOCF.IRTO 0x200
Page 2480: FD controller area network (FDCAN)                                                              RM0433
Page 2480: Figure 744 describes the states and the state transitions in TTCAN level 0 operation. level 0
Page 2480: •    CAN_Bus_Off (S3)
Page 2480: Since no S1 and S2 errors are possible, the error level can only switch between S0 (No
Page 2480: error) and S3 (Severe error). In TTCAN level 0 an S3 error is handled differently. When error
Page 2480: level S3 is reached, both FDCAN_TTOST.SYS and FDCAN_TTOST.MS are reset, and
Page 2480: interrupt flags FDCAN_TTIR.GTE and FDCAN_TTIR.GTD are set.
Page 2480: When error level S3 (FDCAN_TTOST.EL = 11) is entered, bus monitoring mode is (contrary
Page 2480: to TTCAN level 1 and level 2) not entered. S3 error level is left automatically after
Page 2481: RM0433                                                                    FD controller area network (FDCAN)
Page 2481: Figure 745 describes the master slave relation in TTCAN level 0. In case of an S3 error the
Page 2481: FDCAN returns to state Master_Off.
Page 2481: This feature can be used to synchronize the phase of the FDCAN schedule to an external
Page 2481: schedule (e.g. that of a second TTCAN network or FlexRay network). It is applicable only
Page 2481: when the FDCAN is current time master (FDCAN_TTOST.MS = 11).
Page 2481: External synchronization is controlled by event trigger input pin fdcan_evt. If bit
Page 2481: FDCAN_TTOCN.ESCN is set, a rising edge at event trigger pin fdcan_evt the FDCAN
Page 2481: FDCAN_TTGTP.CTP.
Page 2481: Before setting FDCAN_TTOCN.ESCN the Host has to adapt the phases of the two time
Page 2481: schedules e.g. by using the FDCAN gap control (see Section 55.3.9: TTCAN gap control).
Page 2481: When the Host sets FDCAN_TTOCN.ESCN, FDCAN_TTOSTSPL is set.
Page 2481: If the difference between the cycle time and the target phase value FDCAN_TTGTP.CTP at
Page 2481: the rising edge at event trigger pin fdcan_evt is greater than 9 NTU, the phase lock bit
Page 2481: FDCAN_TTOST.SPL is reset, and interrupt flag FDCAN_TTIR.CSM is set.
Page 2482: FD controller area network (FDCAN)                                                                         RM0433
Page 2482: FDCAN_TTOST.SPL is also reset (and FDCAN_TTIR.CSM is set), when another node
Page 2482: If both FDCAN_TTOST.SPL and FDCAN_TTOCN.ESCN are set, and if the difference
Page 2482: between the cycle time and the target phase value FDCAN_TTGTP.CTP at the rising edge
Page 2482: at event trigger pin fdcan_evt is lower or equal to nine NTU, the phase lock bit
Page 2482: FDCAN_TTOST.SPL remains set, and the measured difference is used as reference trigger
Page 2482: Note:       The rising edge detection at event trigger pin fdcan_evt is enabled with the start of each
Page 2482: FDCAN_TTGTP.CTP. All further edges until the beginning of the next basic cycle are
Page 2482: 55.3.17     FDCAN Rx buffer and FIFO element
Page 2482: Up to 64 Rx buffers and two Rx FIFOs can be configured in the message RAM. Each Rx
Page 2482: FIFO section can be configured to store up to 64 received messages. The structure of a
Page 2482: The element size can be configured for storage of CAN FD messages with up to 64 bytes
Page 2482: data field via register FDCAN_RXESC.
Page 2483: RM0433                                                                 FD controller area network (FDCAN)
Page 2483: Acceptance of non-matching frames may be enabled via FDCAN_GFC.ANFS and
Page 2483: FDCAN_GFC.ANFE.
Page 2483: Range is 0 to FDCAN_SIDFC.LSS. - 1 or FDCAN_XIDFC.LSE. - 1.
Page 2483: 1: FDCAN frame format (new DLC-coding and CRC)
Page 2483: R1 bits 19:16 0-8: Classic CAN + CAN FD: received frame has 0-8 data bytes
Page 2483: DLC[3:0]     9-15: Classic CAN: received frame has 8 data bytes
Page 2483: 9-15: CAN FD: received frame has 12/16/20/24/32/48/64 data bytes
Page 2483: on configuration of the timestamp counter prescaler FDCAN_TSCC.TCP.
Page 2484: FD controller area network (FDCAN)                                                                           RM0433
Page 2484: 55.3.18     FDCAN Tx buffer element
Page 2484: The Tx buffers section can be configured to hold dedicated Tx buffers as well as a
Page 2484: buffer configuration FDCAN_TXBC.TFQS and FDCAN_TXBC.NDTB. The element size can
Page 2484: be configured for storage of CAN FD messages with up to 64 bytes data field via register
Page 2484: FDCAN_TXESC.
Page 2484: 0: ESI bit in CAN FD format depends only on error passive flag
Page 2484: 1: ESI bit in CAN FD format transmitted recessive
Page 2485: RM0433                                                             FD controller area network (FDCAN)
Page 2485: 0: Frame transmitted in classic CAN format
Page 2485: 1: Frame transmitted in CAN FD format
Page 2485: 0: CAN FD frames transmitted without bitrate switching
Page 2485: 1: CAN FD frames transmitted with bitrate switching
Page 2485: T1 bits 19:16 0 - 8: Classic CAN + CAN FD: received frame has 0-8 data bytes
Page 2485: DLC[3:0]    9-15: Classic CAN: received frame has 8 data bytes
Page 2485: 9 - 15: CAN FD: received frame has 12/16/20/24/32/48/64 data bytes
Page 2486: FD controller area network (FDCAN)                                                                                     RM0433
Page 2486: the transmitted FD frame. As required by the CAN FD protocol specification, an error active node may
Page 2486: 2. When RTR = 1, the FDCAN transmits a remote frame according to ISO11898-1, even if
Page 2486: FDCAN_CCCR.FDOE enables the transmission in CAN FD format.
Page 2486: 3. Bits ESI, FDF, and BRS are only evaluated when CAN FD operation is enabled FDCAN_CCCR.FDOE = 1.
Page 2486: Bit BRS is only evaluated when in addition FDCAN_CCCR.BRSE = 1.
Page 2486: 55.3.19     FDCAN Tx event FIFO element
Page 2486: information about the Tx event FIFO can be obtained from register FDCAN_TXEFS.
Page 2487: RM0433                                                               FD controller area network (FDCAN)
Page 2487: EFC       – 10: Transmission in spite of cancellation (always set for transmissions in DAR
Page 2487: – 1: FDCAN frame format (new DLC-coding and CRC)
Page 2487: depending on configuration of the timestamp counter prescaler FDCAN_TSCC.TCP.
Page 2487: 55.3.20   FDCAN standard message ID filter element
Page 2487: Up to 128 filter elements can be configured for 11-bit standard IDs. When accessing a
Page 2487: FDCAN_SIDFC.FLSSA plus the index of the filter element (0 … 127).
Page 2488: FD controller area network (FDCAN)                                                                                     RM0433
Page 2488: FDCAN_IR.HPM and, if enabled, an interrupt is generated. In this case register
Page 2488: FDCAN_HPMS is updated with the status of the priority match.
Page 2488: – 111: Store into Rx buffer or as debug message, configuration of FDCAN_SFT[1:0]
Page 2488: SFID2[8:6]     duration of one m_ttcan_hclk period in case the filter matches.
Page 2488: Defines the offset to the Rx buffer start address FDCAN_RXBC.RBSA for storage of
Page 2489: RM0433                                                                   FD controller area network (FDCAN)
Page 2489: 55.3.21    FDCAN extended message ID filter element
Page 2489: Up to 64 filter elements can be configured for 29-bit extended IDs. When accessing an
Page 2489: FDCAN_XIDFC.FLESA plus two times the index of the filter element (0 … 63).
Page 2489: FDCAN_IR.HPM and, if enabled, an interrupt is generated. In this case register
Page 2489: FDCAN_HPMS is updated with the status of the priority match.
Page 2489: FDCAN_XIDAM masking mechanism.
Page 2489: – 11: Range filter from EF1ID to EF2ID (EF2ID ≥ EF1ID), FDCAN_XIDAM mask not
Page 2490: FD controller area network (FDCAN)                                                                                 RM0433
Page 2490: EFID2[8:6]      duration of one m_ttcan_hclk period in case the filter matches.
Page 2490: Defines the offset to the Rx buffer start address FDCAN_RXBC.RBSA for storage of
Page 2490: 55.3.22         FDCAN trigger memory element
Page 2490: Up to 64 trigger memory elements can be configured. When accessing a trigger memory
Page 2490: element, its address is the trigger memory start address FDCAN_TTTMC.TMSA plus the
Page 2491: RM0433                                                                  FD controller area network (FDCAN)
Page 2491: – 1: FDCAN_TTIR.TTMI is set when trigger memory element becomes active
Page 2491: TMEX         – 1: Pulse at output m_ttcan_tmp with the length of one period is generated when the
Page 2491: FDCAN_TTOCN.TTMIE = 1
Page 2491: function for arbitrating messages and in event-driven CAN communication
Page 2491: 1. The trigger memory elements have to be written when the FDCAN is in INIT state. Write access to the
Page 2492: FD controller area network (FDCAN)                                                                          RM0433
Page 2492: 55.4           FDCAN registers
Page 2492: 55.4.1         FDCAN core release register (FDCAN_CREL)
Page 2492: 55.4.2         FDCAN Endian register (FDCAN_ENDN)
Page 2492: 55.4.3         FDCAN data bit timing and prescaler register (FDCAN_DBTP)
Page 2492: FDCAN_CCCR.CCE and FDCAN_CCCR.INIT are set. The CAN time quantum may be
Page 2492: programmed in the range from 1 to 32 FDCAN clock periods. tq = (DBRP + 1) FDCAN clock
Page 2493: RM0433                                                                              FD controller area network (FDCAN)
Page 2493: Note:           With a FDCAN clock of 8 MHz, the reset value 0x00000A33 configures the FDCAN for a fast
Page 2493: 55.4.4          FDCAN test register (FDCAN_TEST)
Page 2493: Write access to this register has to be enabled by setting bit FDCAN_CCCR.TEST to 1. All
Page 2493: register functions are set to their reset values when bit FDCAN_CCCR.TEST is reset.
Page 2493: Loop back mode and software control of Tx pin FDCANx_TX are hardware test modes.
Page 2493: Programming TX differently from 00 may disturb the message transfer on the CAN bus.
Page 2494: FD controller area network (FDCAN)                                                                                RM0433
Page 2494: Monitors the actual value of transmit pin FDCANx_RX
Page 2494: 0: The CAN bus is dominant (FDCANx_RX = 0)
Page 2494: 1: The CAN bus is recessive (FDCANx_RX = 1)
Page 2494: 00: Reset value , FDCANx_TX TX is controlled by the CAN core, updated at the end of
Page 2494: the CAN bit time
Page 2494: 01: Sample point can be monitored at pin FDCANx_TX
Page 2494: 10: Dominant (0) level at pin FDCANx_TX
Page 2494: 11: Recessive (1) at pin FDCANx_TX
Page 2494: 55.4.5          FDCAN RAM watchdog register (FDCAN_RWD)
Page 2494: FDCAN_RWD.WDC bits.
Page 2494: The counter is reloaded with FDCAN_RWD.WDC bits when the message RAM signals
Page 2494: FDCAN_IR.WDI bit is set. The RAM watchdog counter is clocked by the fdcan_pclk clock.
Page 2495: RM0433                                                                          FD controller area network (FDCAN)
Page 2495: FDCAN_CCCR register are set to 1.
Page 2495: 55.4.6          FDCAN CC control register (FDCAN_CCCR)
Page 2495: If this bit is set, the FDCAN uses the CAN FD frame format as specified by the Bosch CAN
Page 2495: 0: CAN FD frame format according to ISO11898-1
Page 2495: 1: CAN FD frame format according to Bosch CAN FD Specification V1.0
Page 2495: If this bit is set, the FDCAN pauses for two CAN bit times before starting the next
Page 2495: Bit 9 BRSE: FDCAN bitrate Switching
Page 2496: FD controller area network (FDCAN)                                                                       RM0433
Page 2496: Bit MON can only be set by software when both CCE and INIT are set to 1. The bit can be
Page 2496: after all pending transfer requests have been completed and the CAN bus reached idle.
Page 2496: 1: FDCAN may be set in power down by stopping APB clock and kernel clock
Page 2496: different CAN bitrates. The application tests different bitrates and leaves the restricted
Page 2496: it waits for the occurrence of bus idle condition to resynchronize itself to the CAN
Page 2496: communication. The error counters are not incremented. Bit ASM can only be set by
Page 2496: software when both CCE and INIT are set to 1. The bit can be reset by the software at any
Page 2496: If the FDCAN is connected to a clock calibration on CAN unit, ASM bit is set by hardware
Page 2496: 0: Normal CAN operation
Page 2496: (while FDCAN_CCCR.INIT = 1)
Page 2496: delay until the value written to INIT can be read back. Therefore the programmer has to
Page 2497: RM0433                                                                    FD controller area network (FDCAN)
Page 2497: 55.4.7        FDCAN nominal bit timing and prescaler register (FDCAN_NBTP)
Page 2497: only writable if bits FDCAN_CCCR.CCE and FDCAN_CCCR.INIT are set. The CAN bit time
Page 2497: may be programed in the range of 4 to 81 tq. The CAN time quantum may be programmed
Page 2497: in the range of [1 … 1024] FDCAN kernel clock periods.
Page 2497: tq = (BRP + 1) FDCAN clock period fdcan_tq_ck
Page 2497: FDCAN_CCCR register are set to 1.
Page 2497: FDCAN_CCCR register are set to 1.
Page 2497: FDCAN_CCCR register are set to 1.
Page 2497: Note:         With a CAN kernel clock of 8 MHz, the reset value of 0x00000A33 configures the FDCAN
Page 2498: FD controller area network (FDCAN)                                                                             RM0433
Page 2498: 55.4.8          FDCAN timestamp counter configuration register (FDCAN_TSCC)
Page 2498: Configures the timestamp and timeout counters time unit in multiples of CAN bit times
Page 2498: In CAN FD mode the internal timestamp counter TCP does not provide a constant time
Page 2498: base due to the different CAN bit times between arbitration phase and data phase. Thus
Page 2498: CAN FD requires an external counter for timestamp generation (TSS = 10).
Page 2498: FDCAN_CCCR register are set to 1.
Page 2498: FDCAN_CCCR register are set to 1.
Page 2498: 55.4.9          FDCAN timestamp counter value register (FDCAN_TSCV)
Page 2499: RM0433                                                                        FD controller area network (FDCAN)
Page 2499: Tx). When FDCAN_TSCC.TSS = 01, the timestamp counter is incremented in multiples of
Page 2499: CAN bit times [1 … 16] depending on the configuration of FDCAN_TSCC.TCP. A wrap
Page 2499: around sets interrupt flag FDCAN_IR.TSW. Write access resets the counter to 0. When
Page 2499: FDCAN_TSCC.TSS = 10, TSC reflects the external timestamp counter value. A write
Page 2499: write access to FDCAN_TSCV.
Page 2499: 55.4.10        FDCAN timeout counter configuration register (FDCAN_TOCC)
Page 2499: FDCAN_CCCR register are set to 1.
Page 2499: When operating in Continuous mode, a write to FDCAN_TOCV presets the counter to the
Page 2499: value configured by FDCAN_TOCC.TOP and continues down-counting. When the timeout
Page 2499: configured by FDCAN_TOCC.TOP. Down-counting is started when the first FIFO element
Page 2499: FDCAN_CCCR register are set to 1.
Page 2499: (INIT) of FDCAN_CCCR register are set to 1.
Page 2500: FD controller area network (FDCAN)                                                                              RM0433
Page 2500: 55.4.11        FDCAN timeout counter value register (FDCAN_TOCV)
Page 2500: The timeout counter is decremented in multiples of CAN bit times [1 … 16] depending on
Page 2500: the configuration of FDCAN_TSCC.TCP. When decremented to 0, interrupt flag
Page 2500: FDCAN_IR.TOO is set and the timeout counter is stopped. Start and reset/restart
Page 2500: conditions are configured via FDCAN_TOCC.TOS.
Page 2500: 55.4.12        FDCAN error counter register (FDCAN_ECR)
Page 2500: Bits 23:16 CEL[7:0]: CAN error logging
Page 2500: The counter is incremented each time when a CAN protocol error causes the transmit
Page 2500: FDCAN_IR.ELO.
Page 2501: RM0433                                                                         FD controller area network (FDCAN)
Page 2501: When FDCAN_CCCR.ASM is set, the CAN protocol controller does not increment TEC
Page 2501: and REC when a CAN protocol error is detected, but CEL is still incremented.
Page 2501: 55.4.13        FDCAN protocol status register (FDCAN_PSR)
Page 2501: FDCAN_TX to FDCAN_RX and FDCAN_TDCR.TDCO. The SSP position is, in the data
Page 2501: Bit 13 REDL: Received FDCAN message
Page 2501: 0: Since this bit was reset by the CPU, no FDCAN message has been received
Page 2501: 1: Message in FDCAN format with EDL flag set has been received
Page 2501: Bit 12 RBRS: BRS flag of last received FDCAN message
Page 2501: 0: Last received FDCAN message did not have its BRS flag set
Page 2501: 1: Last received FDCAN message had its BRS flag set
Page 2502: FD controller area network (FDCAN)                                                                   RM0433
Page 2502: Bit 11 RESI: ESI flag of last received FDCAN message
Page 2502: 0: Last received FDCAN message did not ha ve its ESI flag set
Page 2502: 1: Last received FDCAN message had its ESI flag set
Page 2502: Type of last error that occurred in the data phase of a FDCAN format frame with its BRS
Page 2502: flag set. Coding is the same as for LEC. This field will be cleared to 0 when a FDCAN
Page 2502: 0: The FDCAN is not Bus_Off
Page 2502: 1: The FDCAN is in Bus_Off state
Page 2503: RM0433                                                              FD controller area network (FDCAN)
Page 2503: 0: The FDCAN is in the Error_Active state. It normally takes part in bus communication
Page 2503: 1: The FDCAN is in the Error_Passive state
Page 2503: Monitors the module CAN communication state.
Page 2503: 00: Synchronizing: node is synchronizing on CAN communication
Page 2503: The LEC indicates the type of the last error to occur on the CAN bus. This field will be
Page 2503: 011: AckError: The message transmitted by the FDCAN was not acknowledged by
Page 2503: When the LEC shows the value 7, no CAN bus event was detected since the last CPU
Page 2503: Note:    When a frame in FDCAN format has reached the data phase with BRS flag set, the next
Page 2503: CAN event (error or valid frame) will be shown in FLEC instead of LEC. An error in a fixed
Page 2503: stuff bit of a FDCAN CRC sequence will be shown as a Form error, not Stuff error
Page 2503: Note:    The Bus_Off recovery sequence (see CAN Specification Rev. 2.0 or ISO11898-1) cannot be
Page 2503: shortened by setting or resetting FDCAN_CCCR.INIT. If the device goes Bus_Off, it will set
Page 2503: FDCAN_CCCR.INIT of its own, stopping all bus activities. Once FDCAN_CCCR.INIT has
Page 2503: after the reset of FDCAN_CCCR.INIT, each time a sequence of 11 recessive bits has been
Page 2503: monitored, a Bit0 error code is written to FDCAN_PSR.LEC, enabling the CPU to readily
Page 2503: check up whether the CAN bus is stuck at dominant or continuously disturbed and to
Page 2503: monitor the Bus_Off recovery sequence. FDCAN_ECR.REC is used to count these
Page 2504: FD controller area network (FDCAN)                                                                                      RM0433
Page 2504: 55.4.14        FDCAN transmitter delay compensation register (FDCAN_TDCR)
Page 2504: Offset value defining the distance between the measured delay from FDCAN_TX to
Page 2504: FDCAN_RX and the secondary sample point. Valid values are 0 to 127 mtq.
Page 2504: when the bit CCE and bit INIT of FDCAN_CCCR register are set to 1.
Page 2504: Defines the minimum value for the SSP position, dominant edges on FDCAN_RX that
Page 2504: when the bit CCE and bit INIT of FDCAN_CCCR register are set to 1.
Page 2504: 55.4.15        FDCAN interrupt register (FDCAN_IR)
Page 2505: RM0433                                                             FD controller area network (FDCAN)
Page 2505: 0: CAN error logging counter did not overflow
Page 2505: 1: Overflow of CAN error logging counter occurred
Page 2506: FD controller area network (FDCAN)                                                                      RM0433
Page 2506: handler access failure the M_TTCAN is switched into restricted operation mode (see
Page 2506: reset FDCAN_CCCR.ASM.
Page 2506: Bit 10 TCF: Transmission cancellation finished
Page 2506: 0: No transmission cancellation finished
Page 2506: 1: Transmission cancellation finished
Page 2507: RM0433                                                                        FD controller area network (FDCAN)
Page 2507: 55.4.16        FDCAN interrupt enable register (FDCAN_IE)
Page 2508: FD controller area network (FDCAN)                                                   RM0433
Page 2509: RM0433                                                         FD controller area network (FDCAN)
Page 2509: Bit 10 TCFE: Transmission cancellation finished interrupt enable
Page 2510: FD controller area network (FDCAN)                                                                                 RM0433
Page 2510: 55.4.17        FDCAN interrupt line select register (FDCAN_ILS)
Page 2510: interrupt line has to be enabled via FDCAN_ILE.EINT0 and FDCAN_ILE.EINT1.
Page 2510: Bit 10 TCFL: Transmission cancellation finished interrupt line
Page 2511: RM0433                                                                          FD controller area network (FDCAN)
Page 2511: 55.4.18        FDCAN interrupt line enable register (FDCAN_ILE)
Page 2511: Each of the two interrupt lines to the CPU can be enabled/disabled separately by
Page 2511: 0: Interrupt line fdcan_intr0_it disabled
Page 2511: 1: Interrupt line fdcan_intr0_it enabled
Page 2511: 0: Interrupt line fdcan_intr1_it disabled
Page 2511: 1: Interrupt line fdcan_intr1_it enabled
Page 2512: FD controller area network (FDCAN)                                                                              RM0433
Page 2512: 55.4.19        FDCAN global filter configuration register (FDCAN_GFC)
Page 2512: FDCAN_CCCR register are set to 1.
Page 2512: FDCAN_CCCR register are set to 1.
Page 2512: FDCAN_CCCR register are set to 1.
Page 2512: FDCAN_CCCR register are set to 1.
Page 2513: RM0433                                                                   FD controller area network (FDCAN)
Page 2513: 55.4.20        FDCAN standard ID filter configuration register (FDCAN_SIDFC)
Page 2513: FDCAN_CCCR register are set to 1.
Page 2513: possible only when bit CCE and bit INIT of FDCAN_CCCR register are set to 1.
Page 2513: 55.4.21        FDCAN extended ID filter configuration register (FDCAN_XIDFC)
Page 2513: Settings for 29-bit extended message ID filtering. The FDCAN extended ID filter
Page 2514: FD controller area network (FDCAN)                                                                           RM0433
Page 2514: FDCAN_CCCR register are set to 1.
Page 2514: FDCAN_CCCR register are set to 1.
Page 2514: 55.4.22        FDCAN extended ID and mask register (FDCAN_XIDAM)
Page 2514: FDCAN_CCCR register are set to 1.
Page 2515: RM0433                                                                                 FD controller area network (FDCAN)
Page 2515: 55.4.23        FDCAN high priority message status register (FDCAN_HPMS)
Page 2515: priority event match. This can be used to monitor the status of incoming high priority
Page 2515: Index of matching filter element. Range is 0 to FDCAN_SIDFC[LSS] - 1 or
Page 2515: FDCAN_XIDFC[LSE] - 1.
Page 2515: 55.4.24        FDCAN new data 1 register (FDCAN_NDAT1)
Page 2516: FD controller area network (FDCAN)                                                                                  RM0433
Page 2516: 55.4.25        FDCAN new data 2 register (FDCAN_NDAT2)
Page 2516: 55.4.26        FDCAN Rx FIFO 0 configuration register (FDCAN_RXF0C)
Page 2517: RM0433                                                                         FD controller area network (FDCAN)
Page 2517: FIFO 0 can be operated in blocking or in overwrite mode.
Page 2517: 1-64: Level for Rx FIFO 0 watermark interrupt (FDCAN_IR.RF0W)
Page 2517: FDCAN_CCCR register are set to 1.
Page 2517: 55.4.27        FDCAN Rx FIFO 0 status register (FDCAN_RXF0S)
Page 2517: This bit is a copy of interrupt flag FDCAN_IR.RF0L. When FDCAN_IR.RF0L is reset, this
Page 2518: FD controller area network (FDCAN)                                                                             RM0433
Page 2518: 55.4.28        FDCAN Rx FIFO 0 acknowledge register (FDCAN_RXF0A)
Page 2518: FIFO 0 get index FDCAN_RXF0S.F0GI to F0AI + 1 and update the FIFO 0 fill level
Page 2518: FDCAN_RXF0S.F0FL.
Page 2518: 55.4.29        FDCAN Rx buffer configuration register (FDCAN_RXBC)
Page 2519: RM0433                                                                    FD controller area network (FDCAN)
Page 2519: FDCAN_CCCR register are set to 1.
Page 2519: 55.4.30       FDCAN Rx FIFO 1 configuration register (FDCAN_RXF1C)
Page 2519: FIFO 1 can be operated in blocking or in overwrite mode.
Page 2519: 1-64: Level for Rx FIFO 1 watermark interrupt (FDCAN_IR.RF1W)
Page 2519: FDCAN_CCCR register are set to 1.
Page 2519: FDCAN_CCCR register are set to 1.
Page 2519: FDCAN_CCCR register are set to 1.
Page 2520: FD controller area network (FDCAN)                                                                             RM0433
Page 2520: 55.4.31        FDCAN Rx FIFO 1 status register (FDCAN_RXF1S)
Page 2520: This bit is a copy of interrupt flag FDCAN_IR.RF1L. When FDCAN_IR.RF1L is reset, this
Page 2521: RM0433                                                                        FD controller area network (FDCAN)
Page 2521: 55.4.32        FDCAN Rx FIFO 1 acknowledge register (FDCAN_RXF1A)
Page 2521: FIFO 1 get index FDCAN_RXF1S.F1GI. to F1AI + 1 and update the FIFO 1 fill level
Page 2521: FDCAN_RXF1S.F1FL.
Page 2521: 55.4.33        FDCAN Rx buffer element size configuration register
Page 2521: (FDCAN_RXESC)
Page 2521: sizes higher than 8 bytes are intended for CAN FD operation only.
Page 2522: FD controller area network (FDCAN)                                                                              RM0433
Page 2522: 55.4.34        FDCAN Tx buffer configuration register (FDCAN_TXBC)
Page 2522: FDCAN_CCCR register are set to 1.
Page 2522: FDCAN_CCCR register are set to 1.
Page 2523: RM0433                                                                           FD controller area network (FDCAN)
Page 2523: FDCAN_CCCR register are set to 1.
Page 2523: FDCAN_CCCR register are set to 1.
Page 2523: Note:          The sum of TFQS and NDTB cannot be larger than 32. There is no check for erroneous
Page 2523: 55.4.35        FDCAN Tx FIFO/queue status register (FDCAN_TXFQS)
Page 2523: FDCAN_TXBRP. Therefore the effect of add/cancellation requests may be delayed due to a
Page 2523: running Tx scan (FDCAN_TXBRP not yet updated).
Page 2523: configured (FDCAN_TXBC.TFQM = 1)
Page 2524: FD controller area network (FDCAN)                                                                            RM0433
Page 2524: zero when Tx queue operation is configured (FDCAN_TXBC.TFQM = 1).
Page 2524: 55.4.36        FDCAN Tx buffer element size configuration register
Page 2524: (FDCAN_TXESC)
Page 2524: bytes are intended for CAN FD operation only.
Page 2525: RM0433                                                                   FD controller area network (FDCAN)
Page 2525: 55.4.37       FDCAN Tx buffer request pending register (FDCAN_TXBRP)
Page 2525: FDCAN_TXBAR. The bits are reset after a requested transmission has completed or has
Page 2525: been canceled via register FDCAN_TXBCR.
Page 2525: FDCAN_TXBRP bits are set only for those Tx buffers configured via FDCAN_TXBC. After
Page 2525: a FDCAN_TXBRP bit has been set, a Tx scan (see Filtering for Debug messages) is
Page 2525: A cancellation request resets the corresponding transmission request pending bit of
Page 2525: register FDCAN_TXBRP. In case a transmission has already been started when a
Page 2525: cancellation is requested, this is done at the end of the transmission, regardless whether
Page 2525: the transmission was successful or not. The cancellation request bits are reset directly
Page 2525: after the corresponding FDCAN_TXBRP bit has been reset.
Page 2525: After a cancellation has been requested, a finished cancellation is signaled via
Page 2525: FDCAN_TXBCF
Page 2525: – after successful transmission together with the corresponding FDCAN_TXBTO bit
Page 2525: – when the transmission has not yet been started at the point of cancellation
Page 2525: In DAR mode all transmissions are automatically canceled if they are not successful. The
Page 2525: corresponding FDCAN_TXBCF bit is set for all unsuccessful transmissions.
Page 2525: Note:         FDCAN_TXBRP bits set while a Tx scan is in progress are not considered during this
Page 2525: particular Tx scan. In case a cancellation is requested for such a Tx buffer, this add request
Page 2525: is canceled immediately, the corresponding FDCAN_TXBRP bit is reset.
Page 2526: FD controller area network (FDCAN)                                                                           RM0433
Page 2526: 55.4.38      FDCAN Tx buffer add request register (FDCAN_TXBAR)
Page 2526: for multiple Tx buffers with one write to FDCAN_TXBAR. FDCAN_TXBAR bits are set only
Page 2526: for those Tx buffers configured via FDCAN_TXBC. When no Tx scan is running, the bits
Page 2526: are reset immediately, else the bits remain set until the Tx scan process has completed.
Page 2526: (corresponding FDCAN_TXBRP bit already set), the request is ignored.
Page 2526: 55.4.39      FDCAN Tx buffer cancellation request register (FDCAN_TXBCR)
Page 2526: Bits 31:0 CR[31:0]: Cancellation request
Page 2526: Each Tx buffer has its own cancellation request bit. Writing a 1 will set the corresponding
Page 2526: cancellation request bit; writing a 0 has no impact.
Page 2526: This enables the Host to set cancellation requests for multiple Tx buffers with one write to
Page 2526: FDCAN_TXBCR. FDCAN_TXBCR bits are set only for those Tx buffers configured via
Page 2526: FDCAN_TXBC. The bits remain set until the corresponding FDCAN_TXBRP bit is reset.
Page 2526: 0: No cancellation pending
Page 2526: 1: Cancellation pending
Page 2527: RM0433                                                                FD controller area network (FDCAN)
Page 2527: 55.4.40       FDCAN Tx buffer transmission occurred register (FDCAN_TXBTO)
Page 2527: corresponding FDCAN_TXBRP bit is cleared after a successful transmission. The bits are
Page 2527: register FDCAN_TXBAR.
Page 2527: 55.4.41       FDCAN Tx buffer cancellation finished register (FDCAN_TXBCF)
Page 2527: Bits 31:0 CF[31:0]: Cancellation finished
Page 2527: Each Tx buffer has its own cancellation finished bit. The bits are set when the
Page 2527: corresponding FDCAN_TXBRP bit is cleared after a cancellation was requested via
Page 2527: FDCAN_TXBCR. In case the corresponding FDCAN_TXBRP bit was not set at the point
Page 2527: of cancellation, CF is set immediately. The bits are reset when a new transmission is
Page 2527: requested by writing a 1 to the corresponding bit of register FDCAN_TXBAR.
Page 2527: 0: No transmit buffer cancellation
Page 2527: 1: Transmit buffer cancellation finished
Page 2527: 55.4.42       FDCAN Tx buffer transmission interrupt enable register
Page 2527: (FDCAN_TXBTIE)
Page 2528: FD controller area network (FDCAN)                                                                           RM0433
Page 2528: 55.4.43        FDCAN Tx buffer cancellation finished interrupt enable register
Page 2528: (FDCAN_ TXBCIE)
Page 2528: Bits 31:0 CFIE[31:0]: Cancellation finished interrupt enable.
Page 2528: Each Tx buffer has its own cancellation finished interrupt enable bit.
Page 2528: 0: Cancellation finished interrupt disabled
Page 2528: 1: Cancellation finished interrupt enabled
Page 2528: 55.4.44        FDCAN Tx event FIFO configuration register (FDCAN_TXEFC)
Page 2529: RM0433                                                                           FD controller area network (FDCAN)
Page 2529: 1-32: Level for Tx event FIFO watermark interrupt (FDCAN_IR.TEFW)
Page 2529: FDCAN_CCCR register are set to 1.
Page 2529: FDCAN_CCCR register are set to 1.
Page 2529: FDCAN_CCCR register are set to 1.
Page 2529: 55.4.45        FDCAN Tx event FIFO status register (FDCAN_TXEFS)
Page 2529: This bit is a copy of interrupt flag FDCAN_IR.TEFL. When FDCAN_IR.TEFL is reset, this
Page 2530: FD controller area network (FDCAN)                                                                                    RM0433
Page 2530: 55.4.46        FDCAN Tx event FIFO acknowledge register (FDCAN_TXEFA)
Page 2530: the Tx event FIFO get index FDCAN_TXEFS.EFGI to EFAI + 1 and update the FIFO 0 fill
Page 2530: level FDCAN_TXEFS.EFFL.
Page 2530: 55.4.47        FDCAN TT trigger memory configuration register (FDCAN_TTTMC)
Page 2531: RM0433                                                                       FD controller area network (FDCAN)
Page 2531: FDCAN_CCCR register are set to 1.
Page 2531: FDCAN_CCCR register are set to 1.
Page 2531: 55.4.48       FDCAN TT reference message configuration register
Page 2531: (FDCAN_TTRMC)
Page 2531: of FDCAN_CCCR register are set to 1.
Page 2531: FDCAN_CCCR register are set to 1.
Page 2532: FD controller area network (FDCAN)                                                                                RM0433
Page 2532: FDCAN_CCCR register are set to 1.
Page 2532: 55.4.49        FDCAN TT operation configuration register (FDCAN_TTOCF)
Page 2532: FDCAN_CCCR register are set to 1.
Page 2532: 0: Automatic clock calibration in FDCAN level 0, 2 is disabled
Page 2532: 1: Automatic clock calibration in FDCAN level 0, 2 is enabled
Page 2532: FDCAN_CCCR register are set to 1.
Page 2532: 0: Global time filtering in FDCAN level 0, 2 is disabled
Page 2532: 1: Global time filtering in FDCAN level 0, 2 is enabled
Page 2532: FDCAN_CCCR register are set to 1.
Page 2532: The application watchdog can be disabled by programming AWL to 0x00.
Page 2532: FDCAN_CCCR register are set to 1.
Page 2533: RM0433                                                              FD controller area network (FDCAN)
Page 2533: If enabled, TUR configuration (FDCAN_TURCF.NCL only) may be updated during
Page 2533: FDCAN operation.
Page 2533: 0: External clock synchronization in FDCAN level 0, 2 disabled
Page 2533: 1: External clock synchronization in FDCAN level 0, 2 enabled
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: clock tolerance given by the CAN bit timing configuration.
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: 00: Event-driven CAN communication, default
Page 2533: 01: TTCAN level 1
Page 2533: 10: TTCAN level 2
Page 2533: 11: TTCAN level 0
Page 2533: FDCAN_CCCR register are set to 1.
Page 2533: 55.4.50   FDCAN TT matrix limits register (FDCAN_TTMLM)
Page 2534: FD controller area network (FDCAN)                                                                           RM0433
Page 2534: FDCAN_CCCR register are set to 1.
Page 2534: FDCAN_CCCR register are set to 1.
Page 2534: FDCAN_CCCR register are set to 1.
Page 2534: FDCAN_CCCR register are set to 1.
Page 2534: 55.4.51        FDCAN TUR configuration register (FDCAN_TURCF)
Page 2534: The length of the NTU is given by: NTU = CAN clock period x NC/DC.
Page 2535: RM0433                                                                          FD controller area network (FDCAN)
Page 2535: FDCAN_TURNA.NAV[15:0]. DC is set to 0x1000 by hardware reset and it may not be
Page 2535: •         Level 1: NC 4 × DC and NTU = CAN bit time
Page 2535: The actual value of FDCAN_TUR may be changed by the clock drift compensation function
Page 2535: of TTCAN level 0 and level 2 in order to adjust the node local view of the NTU to the time
Page 2535: FDCAN_TURNA.NAV may be adjusted around NC in the range of the synchronization
Page 2535: deviation limit given by FDCAN_TTOCF.LDSDL. NC and DC should be programmed to the
Page 2535: FDCAN_CCCR register are set to 1.
Page 2535: the next hardware reset. FDCAN_TURCF.DC is locked when
Page 2535: FDCAN_TURCF.ELT = 1. If ELT is written to 0, the readable value will stay at 1
Page 2535: until the new value has been synchronized into the CAN clock domain. During this
Page 2535: FDCAN_CCCR register are set to 1.
Page 2535: with FDCAN_TURCF.ELT = 0 or if FDCAN_TTOCF.EECS (external clock synchronization
Page 2535: new value takes effect when FDCAN_TTOST.WECS is cleared to 0. NCL is locked
Page 2535: FDCAN_TTOST.WECS is 1.
Page 2535: FDCAN_CCCR register are set to 1.
Page 2536: FD controller area network (FDCAN)                                                                              RM0433
Page 2536: Note:          If NC < 7 × DC in TTCAN level 1, it is required that subsequent time marks in the trigger
Page 2536: 55.4.52        FDCAN TT operation control register (FDCAN_TTOCN)
Page 2536: Set by a write access to register FDCAN_TTOCN. Reset when the updated configuration
Page 2536: synchronized into the CAN clock domain.
Page 2536: 0: Write access to FDCAN_TTOCN enabled
Page 2536: 1: Write access to FDCAN_TTOCN locked
Page 2536: If enabled the FDCAN synchronizes its cycle time phase to an external event signaled by
Page 2536: This bit can only be set when the FDCAN is the actual time master and when it is
Page 2536: (FDCAN_TTOCF.GEN = 1)
Page 2536: 1: Next reference message started when register time mark interrupt FDCAN_TTIR.RTMI
Page 2537: RM0433                                                               FD controller area network (FDCAN)
Page 2537: and the FDCAN is in synchronization state In_Schedule or In_Gap.
Page 2537: 0: Trigger time mark interrupt output m_ttcan_tmp disabled
Page 2537: 1: Trigger time mark interrupt output m_ttcan_tmp enabled
Page 2537: recommended to first write TMC = 00, then reconfigure FDCAN_TTTMK, and
Page 2537: finally set FDCAN_TMC to the intended time reference.
Page 2537: Register time mark interrupts are configured by register FDCAN_TTTMK. A register time
Page 2537: mark interrupt pulse with the length of one m_ttcan_clk period is generated when time
Page 2537: referenced by FDCAN_TTOCN.TMC (cycle, local, or global) equals FDCAN_TTTMK.TM,
Page 2537: 01: Actual value of cycle time is copied to FDCAN_TTCPT.SWV
Page 2537: 10: Actual value of local time is copied to FDCAN_TTCPT.SWV
Page 2537: 11: Actual value of global time is copied to FDCAN_TTCPT.SWV
Page 2537: Writing a 1 to ECS sets FDCAN_TTOST.WECS if the node is the actual time master. ECS
Page 2537: Writing a 1 to SGT sets FDCAN_TTOST.WGDT if the node is the actual time master. SGT
Page 2537: value written to FDCAN_TTGTP.
Page 2537: 55.4.53   FDCAN TT global time preset register (FDCAN_TTGTP)
Page 2538: FD controller area network (FDCAN)                                                                           RM0433
Page 2538: the node is not the current time master. TP is locked while FDCAN_TTOST.WGTD = 1 after
Page 2538: setting FDCAN_TTOCN.SGT until the reference message with Disc_Bit = 1 becomes valid
Page 2538: CTP is write-protected while FDCAN_TTOCN.ESCN or FDCAN_TTOST.SPL are set (see
Page 2538: TP is write-protected while FDCAN_TTOST.WGTD is set.
Page 2538: 55.4.54       FDCAN TT time mark register (FDCAN_TTTMK)
Page 2538: A time mark interrupt (FDCAN_TTIR.TMI = 1) is generated when the time base indicated by
Page 2538: FDCAN_TTOCN.TMC (cycle time, local time, or global time) has the same value as TM.
Page 2538: Always set by a write access to registers FDCAN_TTOCN. Set by write access to register
Page 2538: FDCAN_TTTMK when FDCAN_TTOCN.TMC 00. Reset when the registers have been
Page 2538: synchronized into the CAN clock domain.
Page 2538: 0: Write access to FDCAN_TTTMK enabled
Page 2538: 1: Write access to FDCAN_TTTMK locked
Page 2539: RM0433                                                                         FD controller area network (FDCAN)
Page 2539: Note:          When using byte access to register FDCAN_TTTMK it is recommended to first disable the
Page 2539: time mark compare function (FDCAN_TTOCN.TMC = 00) to avoid comparisons on
Page 2539: 55.4.55        FDCAN TT interrupt register (FDCAN_TTIR)
Page 2540: FD controller area network (FDCAN)                                                              RM0433
Page 2540: Synchronization deviation SD exceeds limit specified by FDCAN_TTOCF.LDSDL, TTCAN
Page 2540: Section 55.3.22: FDCAN trigger memory element). Set when the trigger memory element
Page 2540: becomes active, and the FDCAN is in synchronization state In_Gap or In_Schedule.
Page 2540: 1: Time mark reached (level 0: cycle time FDCAN_TTOCF.RTO x 0x200)
Page 2540: FDCAN_TTTMK.TM, independently from the synchronization state.
Page 2541: RM0433                                                                        FD controller area network (FDCAN)
Page 2541: also set when FDCAN_TTOST.SPL is reset
Page 2541: 55.4.56        FDCAN TT interrupt enable register (FDCAN_TTIE)
Page 2542: FD controller area network (FDCAN)                                               RM0433
Page 2543: RM0433                                                                           FD controller area network (FDCAN)
Page 2543: 55.4.57        FDCAN TT interrupt line select register (FDCAN_TTILS)
Page 2543: generation the respective interrupt line has to be enabled via FDCAN_ILE.EINT0 and
Page 2543: FDCAN_ILE.EINT1.
Page 2544: FD controller area network (FDCAN)                                              RM0433
Page 2544: 55.4.58     FDCAN TT operation status register (FDCAN_TTOST)
Page 2545: RM0433                                                                       FD controller area network (FDCAN)
Page 2545: (FDCAN_TTOCN.ESCN = 1). In this case it signals that the difference between cycle time
Page 2545: configured by FDCAN_TTGTP.CTP and the cycle time at the rising edge at event trigger
Page 2545: The application watchdog is served by reading FDCAN_TTOST. When the watchdog is
Page 2545: not served in time, bit AWE is set, all FDCAN communication is stopped, and the FDCAN
Page 2545: Set when the CPU writes FDCAN_TTOCN.FGP, or by a time mark interrupt if TMG = 1, or
Page 2545: via input pin (event trigger) if FDCAN_TTOCN.GCS = 1. Not set by Ref_Trigger_Gap or
Page 2545: 1: Gap finished by FDCAN
Page 2546: FD controller area network (FDCAN)                                                                       RM0433
Page 2546: (0x7F). There is no notification when the lower limit of-127 is reached. In case the FDCAN
Page 2546: between Host and CAN clock domain. For time slaves the value configured by
Page 2546: FDCAN_TTOCF.IRTO is read.
Page 2546: Only relevant in TTCAN level 0 and level 2, otherwise fixed to 1.
Page 2546: Only relevant in TTCAN level 0 and level 2, otherwise fixed to 0.
Page 2546: 01: Synchronizing to FDCAN communication
Page 2546: 55.4.59     FDCAN TUR numerator actual register (FDCAN_TURNA)
Page 2546: There is no drift compensation in TTCAN level 1 (NAV = NC). In TTCAN level 0 and level 2,
Page 2546: calculated NAV) is lower than 2 * (FDCAN_TTOCF.LDSDL + 5). With
Page 2546: FDCAN_TTOCF.LDSDL < 7, this results in a maximum range for NAV of
Page 2547: RM0433                                                                          FD controller area network (FDCAN)
Page 2547: 55.4.60        FDCAN TT local and global time register (FDCAN_TTLGT)
Page 2547: 0x0000–FFFF Global time value of FDCAN network
Page 2547: 0x0000–FFFF Local time value of FDCAN node
Page 2547: 55.4.61        FDCAN TT cycle time and count register (FDCAN_TTCTC)
Page 2548: FD controller area network (FDCAN)                                                                                RM0433
Page 2548: 0x0000–FFFF Cycle time value of FDCAN basic cycle
Page 2548: 55.4.62        FDCAN TT capture time register (FDCAN_TTCPT)
Page 2548: On a rising / falling edge (as configured via FDCAN_TTOCN.SWP) at the stop watch
Page 2548: trigger pin, when FDCAN_TTOCN.SWS] is different from 00 and FDCAN_TTIR.SWE is 0,
Page 2548: the actual time value as selected by FDCAN_TTOCN.SWS (cycle, local, global) is copied
Page 2548: to SWV and TFDCAN_TIR.SWE will be set to 1.Capturing of the next stop watch value is
Page 2548: enabled by resetting FDCAN_TTIR.SWE.
Page 2548: 55.4.63        FDCAN TT cycle sync mark register (FDCAN_TTCSM)
Page 2549: RM0433                                                                    FD controller area network (FDCAN)
Page 2549: 55.4.64        FDCAN TT trigger select register (FDCAN_TTTS)
Page 2549: The settings in the FDCAN_TTTS register select the input to be used as event trigger and
Page 2549: 00: fdcan1_swt0
Page 2549: 01: fdcan1_swt1
Page 2549: 10: fdcan1_swt2
Page 2549: 11: fdcan1_swt3
Page 2549: 00: fdcan1_evt0
Page 2549: 01: fdcan1_evt1
Page 2549: 10: fdcan1_evt2
Page 2549: 11: fdcan1_evt3
Page 2550: FD controller area network (FDCAN)                                                                                                                                                                                              RM0433
Page 2550: 55.4.65        FDCAN register map and reset value table
Page 2550: Table 485. FDCAN register map and reset values
Page 2550: FDCAN_CREL
Page 2550: FDCAN_ENDN                                                                                                           ETV[31:0]
Page 2550: FDCAN_DBTP                                                                                         DBRP[4:0]                                            DTSEG1[4:0]                    DTSEG2[3:0]                      DSJW[3:0]
Page 2550: FDCAN_TEST
Page 2550: FDCAN_RWD                                                                                                                                        WDV[7:0]                                                     WDC[7:0]
Page 2550: FDCAN
Page 2550: FDCAN_NBTP                   NSJW[6:0]                                               NBRP[8:0]                                               NTSEG1[7:0]                                                      NTSEG2[6:0]
Page 2550: FDCAN_TSCC                                                                                           NBRP[3:0]
Page 2550: FDCAN_TSCV                                                                                                                                                                   TSC[15:0]
Page 2550: FDCAN_TOCC                                                   TOP[15:0]
Page 2550: FDCAN_TOCV                                                                                                                                                                 TOC[15:0]
Page 2550: FDCAN_ECR                                                                              TDCV[7:0]                                                    REC[6:0]                                                  TEC[7:0]
Page 2551: FDCAN
Page 2551: FDCAN
Page 2551: FDCAN
Page 2551: FDCAN
Page 2551: FDCAN
Page 2551: FDCAN_IE
Page 2551: FDCAN_IR
Page 2551: FDCAN_ILE
Page 2551: FDCAN_ILS
Page 2551: FDCAN_PSR
Page 2551: FDCAN_GFC
Page 2551: FDCAN_TDCR
Page 2551: Table 485. FDCAN register map and reset values (continued)
Page 2551: FD controller area network (FDCAN)
Page 2552: FD controller area network (FDCAN)                                                                                                                                                                                                                             RM0433
Page 2552: Table 485. FDCAN register map and reset values (continued)
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN_RXBC                                                                                                                                                                               RBSA[13:0]
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN_TXBC                                TFQS[5:0]                                                       NDTB[5:0]                                                                      TBSA[13:0]
Page 2552: FDCAN
Page 2552: FDCAN
Page 2552: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: FDCAN
Page 2553: Table 485. FDCAN register map and reset values (continued)
Page 2553: FD controller area network (FDCAN)
Page 2554: FD controller area network (FDCAN)                                                                                                                                                                                                             RM0433
Page 2554: Table 485. FDCAN register map and reset values (continued)
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN_TTIR
Page 2554: FDCAN_TTIE
Page 2554: FDCAN_TTILS
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN
Page 2554: FDCAN
Page 2555: RM0433                                                                                                                                        FD controller area network (FDCAN)
Page 2555: Table 485. FDCAN register map and reset values (continued)
Page 2555: FDCAN
Page 2556: FD controller area network (FDCAN)                                                                                   RM0433
Page 2556: 55.5.1          Clock calibration unit core release register (FCCAN_CCU_CREL)
Page 2556: 55.5.2          Calibration configuration register (FCCAN_CCU_CCFG)
Page 2556: Registers FDCAN_CCFG, CCU_CSTAT and the calibration watchdog configuration
Page 2556: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2556: FDCAN_CCCR.INIT = 1.
Page 2557: RM0433                                                              FD controller area network (FDCAN)
Page 2557: to ensure that the FDCAN requirement is fulfilled.
Page 2557: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2557: FDCAN_CCCR.INIT = 1.
Page 2557: Configures the minimum number of periods in two CAN bit times. OCPM is used in basic
Page 2557: 100 MHz) and the bitrate configured in FDCAN1 and FDCAN2 (from 125 kbit/s up to 1
Page 2557: Mbit/s). It is recommended to configure a value slightly below two CAN bit times. The
Page 2557: reset value is 1.6 bit times at 80 MHz fdcan_ker_ck and 1 Mbit/s CAN bitrate.
Page 2557: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2557: FDCAN_CCCR.INIT = 1.
Page 2557: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2557: FDCAN_CCCR.INIT = 1.
Page 2557: If this bit is set, the clock input fdcan_ker_ck is routed to the time quanta clock through a
Page 2557: prescaler of the connected FDCANs has to be configured to generate the FDCAN internal
Page 2557: Note: As long as fdcan_ker_ck is equal or above 80 MHz the clock calibration on CAN
Page 2557: unit is functional, even when BCC = 1. The calibration state can be read from
Page 2558: FD controller area network (FDCAN)                                                                                RM0433
Page 2558: Configures the number of time quanta per bit time. Same value as configured in FDCAN1
Page 2558: and FDCAN2. The range of the resulting time quanta clock fdcan_tq_ck is from 0.5 MHz
Page 2558: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2558: FDCAN_CCCR.INIT = 1.
Page 2558: 55.5.3        Calibration status register (FCCAN_CCU_CSTAT)
Page 2558: 55.5.4        Calibration watchdog register (FCCAN_CCU_CWD)
Page 2558: (CCU_CSTAT.CALS = 00), the counter is reloaded with FDCAN_RWD.WDC and basic
Page 2559: RM0433                                                                   FD controller area network (FDCAN)
Page 2559: Not_Calibrated (CCU_CSTAT.CALS = 00), the counter is reloaded with FDCAN_RWD.WDC
Page 2559: node is received by the attached TTCAN until the calibration watchdog has counted down to
Page 2559: The signal is active when the CAN protocol engine on the attached TTCAN is started i.e.
Page 2559: possible only when the FDCAN control bits FDCAN_CCCR.CCE = 1 AND
Page 2559: FDCAN_CCCR.INIT = 1.
Page 2559: 55.5.5        Clock calibration unit interrupt register (FCCAN_CCU_IR)
Page 2560: FD controller area network (FDCAN)                                                                               RM0433
Page 2560: 55.5.6          Clock calibration unit interrupt enable register (FCCAN_CCU_IE)
Page 2561: RM0433                                                                                                                                         FD controller area network (FDCAN)
Page 2561: FCCAN_                                                                 SUBSTEP
Page 2561: FCCAN_
Page 2561: FCCAN_
Page 2561: FCCAN_
Page 2561: FCCAN_
Page 2561: FCCAN_
Page 2562: Specification. It can also be configured as a host-only or device-only controller, fully
Page 2563: The main features can be divided into three categories: general, host-mode and device-
Page 2564: –    Each FIFO can hold multiple packets
Page 2567: 1. This instance cannot be used in HS mode for pinning reasons                                                                                                 MSv40735V3
Page 2570: host negotiation protocol (HNP). The current device status can be read by the combined
Page 2571: The powered state can be exited by software with the soft disconnect feature. The DP pull-
Page 2572: –    Each of them can be configured to support the isochronous, bulk or interrupt
Page 2572: –    Each of them can be configured to support the isochronous, bulk or interrupt
Page 2573: The following transfer parameters can be programmed:
Page 2573: respectively) is set. Before the application can read these registers, it must first read the
Page 2574: the 5 V VBUS line. The external charge pump can be driven by any GPIO output. This is
Page 2574: register (SRPCAP bit in OTG_GUSBCFG). With the SRP feature enabled, the host can
Page 2575: the 5 V VBUS line. The external charge pump can be driven by any GPIO output or via an
Page 2575: The charge pump overcurrent flag can also be used to prevent electrical damage. Connect
Page 2575: If SRP or HNP are enabled, even if USB peripherals or B-devices can be attached at any
Page 2576: the speed of the enumerated peripheral can be read from the port speed field in the host
Page 2576: The suspended state can be optionally exited on the remote device’s initiative (remote
Page 2576: Each host channel can be configured to support in/out and any type of periodic/nonperiodic
Page 2577: •   The following transfer parameters can be programmed:
Page 2577: OTG_GINTSTS) is set. Before the application can read these registers, it must first read the
Page 2577: for nonperiodic). Each request queue can hold up to 8 entries. Each entry represents a
Page 2578: can be used by the application to read the status of each request queue. They contain:
Page 2578: As request queues can hold a maximum of 8 entries each, the application can push to
Page 2579: the input capture feature, the output compare feature and the timer can be triggered by the
Page 2579: on the USB (SOF bit in OTG_GINTSTS). The corresponding frame number can be read
Page 2579: timer can be triggered by the SOF pulse.
Page 2579: feature can be used to determine if all of the isochronous traffic for that frame is complete.
Page 2582: •    The OTG_HS core can fill in the receive FIFO up to the limit for any host sequence of
Page 2583: •    The OTG_HS core can fill in the receive FIFO up to the limit for any sequence of IN
Page 2584: •   The OTG_HS core can fill in the periodic (nonperiodic) transmit FIFO up to the limit for
Page 2584: (PTXFELVL bit in OTG_GAHBCFG). The application can push the transmission data in
Page 2584: (OTG_HPTXSTS) can be read to know how much space is available in both.
Page 2584: in OTG_GAHBCFG). The application can push the transmission data as long as free space
Page 2584: nonperiodic transmit FIFO and queue status register (OTG_HNPTXSTS) can be read to
Page 2584: being transferred to the CPU, the USB can receive the subsequent packet.
Page 2585: to the CPU, the USB can receive the subsequent packet.
Page 2585: packet is under transfer to the USB, the CPU can get the next packet.
Page 2588: status registers can be accessed in both host and device modes. When the OTG_HS
Page 2592: IN, the FIFO can only be read on the channel. Similarly, if a host channel is of type OUT, the
Page 2592: FIFO can only be written on the channel.
Page 2594: In OTG mode, the user can use this bit to determine if the device is connected or
Page 2595: application can clear this bit by writing a 0 when the host negotiation success status change
Page 2596: The application sets this bit to initiate a session request on the USB. The application can
Page 2597: application can start driving USB reset after seeing this interrupt. This bit is only valid when
Page 2598: This register can be used to configure the core after power-on or a change in mode. This
Page 2599: This register can be used to configure the core after power-on or a changing to host mode
Page 2600: states stp and data. Any pull-up or pull-down resistors employed by this feature can be
Page 2601: PHY can usually operate on a 48 MHz clock to save power.
Page 2601: B-device, it cannot request the connected A-device (host) to activate VBUS and start a
Page 2602: introduced by the PHY. This can be required, because the delay introduced by the PHY in
Page 2602: generating the line state condition can vary from one PHY to another.
Page 2603: This bit selectively flushes a single or all transmit FIFOs, but cannot do so if the core is in the
Page 2604: The application can flush the entire Rx FIFO using this bit, but must first ensure that the core
Page 2604: The application can write to this bit any time it wants to reset the core. This is a self-clearing
Page 2604: bit and the core clears this bit after all the necessary logic is reset in the core, which can take
Page 2606: a NAK response to the host. To avoid this scenario, the application can check the FetSusp
Page 2606: handshake. Alternatively, the application can mask the “IN token received when FIFO
Page 2607: OTG_DCTL), set by the application, has taken effect in the core. This bit can be cleared by
Page 2608: sampled the Global IN NAK bit set by the application. This bit can be cleared by clearing the
Page 2608: the USB. The application can read the OTG_DSTS register to get the current frame number.
Page 2608: device is established. If the bit is set after power on reset the application can clear the
Page 2612: This is the least significant 4 bits of the frame number in which the packet is received on the
Page 2614: This is the least significant 4 bits of the frame number in which the packet is received on the
Page 2616: The application can program the RAM size that must be allocated to the Rx FIFO.
Page 2619: enabled, the USB PHY is fully controlled by BCD and cannot be used for normal
Page 2619: If it is above, it means that the DM is externally pulled high. This can be caused by
Page 2621: Indicates that the device or host can start resume from Sleep state. This bit is valid in LPM
Page 2621: 1: The application or host can start resume from Sleep state
Page 2621: 0: The application or host cannot start resume from Sleep state
Page 2623: If the core operates as a non-LPM-capable host, it cannot request the connected device or
Page 2623: If the core operates as a non-LPM-capable device, it cannot respond to any LPM
Page 2624: can be categorized as follows:
Page 2625: application can make the core enumerate as an FS host, even if the connected device
Page 2626: 0: The HFIR can be dynamically reloaded during run time.
Page 2626: 1: The HFIR cannot be reloaded dynamically
Page 2626: PHY clocks that constitute the required frame interval. The application can write a value to
Page 2628: When a significant event occurs on a channel, the host all channels interrupt register
Page 2629: bits in this register can trigger an interrupt to the application through the host port interrupt
Page 2630: reset on the port. The application can leave it set for another 10 ms in addition to the
Page 2630: intervention and clears this bit at the end of resume.This bit can be set or cleared by both
Page 2631: cannot set this bit by a register write. It can only clear it to disable the port. This bit does not
Page 2633: application can read this register, it must first read the host all channels interrupt
Page 2634: read/write operation. The application can read the corresponding DMA channel address
Page 2637: periodic frame interrupt. This can be used to determine if all the isochronous traffic for that
Page 2638: The application can use this field to select the handshake the core sends on receiving a
Page 2638: maximum speed the application can support. However, the actual bus speed is determined
Page 2641: can only perform a soft disconnect recover.
Page 2641: OTG_DIEPINTx register can be masked by writing to the corresponding bit in this register.
Page 2642: OTG_DOEPINTx register can be masked by writing into the corresponding bit in this
Page 2644: When a significant event occurs on an endpoint, a OTG_DAINT register interrupts the
Page 2646: amount of data received on the USB before the core can start transmitting on the AHB. The
Page 2646: can start transmitting on the USB. The threshold length has to be at least eight 32-bit words.
Page 2648: OTG_DOEPINT1 register can be masked by writing into the corresponding bit in this
Page 2649: OTG_DOEPINT1 register can be masked by writing into the corresponding bit in this
Page 2651: Using this bit, the application can control the transmission of NAK handshakes on an
Page 2651: endpoint. The core can also set this bit for OUT endpoints on a transfer completed interrupt,
Page 2652: Only the application can clear this bit, never the core.
Page 2652: The application can only set this bit, and the core clears it, when a SETUP token is received
Page 2653: Before the application can read this register, it must first read the device all endpoints
Page 2654: This bit can be cleared when the application clears the IN endpoint NAK by writing to the
Page 2654: read/write. The application can read the corresponding endpoint DMA address register to
Page 2655: (EPENA in OTG_DIEPCTL0), the core modifies this register. The application can only read
Page 2655: after it has exhausted the transfer size amount of data. The transfer size can be set to the
Page 2656: OTG_DIEPCTLx), the core modifies this register. The application can only read this register
Page 2657: the application after it has exhausted the transfer size amount of data. The transfer size can
Page 2657: The application cannot disable control OUT endpoint 0.
Page 2658: Using this bit, the application can control the transmission of NAK handshakes on an
Page 2658: endpoint. The core can also set this bit on a transfer completed interrupt, or after a SETUP
Page 2658: The application can only set this bit, and the core clears it, when a SETUP token is received
Page 2659: Before the application can read this register, it must first read the OTG_DAINT register to
Page 2659: address. Because of the above behavior, OTG_HS can receive any number of back to back
Page 2660: The application can use this interrupt to ACK or STALL the status phase, after it has
Page 2660: application can decode the received SETUP data packet.
Page 2660: read/write. The application can read the corresponding endpoint DMA address register to
Page 2661: OTG_DOEPCTL0), the core modifies this register. The application can only read this
Page 2661: This field specifies the number of back-to-back SETUP data packets the endpoint can
Page 2661: after it has exhausted the transfer size amount of data. The transfer size can be set to the
Page 2663: Using this bit, the application can control the transmission of NAK handshakes on an
Page 2663: endpoint. The core can also set this bit for OUT endpoints on a transfer completed interrupt,
Page 2663: priority. Only the application can clear this bit, never the core.
Page 2663: The application can only set this bit, and the core clears it, when a SETUP token is received
Page 2665: OTG_DOEPCTLx), the core modifies this register. The application can only read this
Page 2665: This field specifies the number of back-to-back SETUP data packets the endpoint can
Page 2665: the application after it has exhausted the transfer size amount of data. The transfer size can
Page 2666: When this bit is set, core internal clock gating is enabled in Sleep state if the core cannot
Page 2677: 4.   The software can read the CMOD bit in OTG_GINTSTS to determine whether the
Page 2679: The application must initialize one or more channels before it can communicate with
Page 2679: endpoint characteristics, such as type, speed, direction, and so forth. (The channel can
Page 2679: The application can disable any channel by programming the OTG_HCCHARx register with
Page 2680: periodic request queue (when disabling a periodic channel). The application can simply
Page 2680: the transmit FIFO).This is valid in slave mode only. In Slave mode, the application can send
Page 2680: application can continue the data transaction only after receiving an ACK from the OUT
Page 2682: –    The non-periodic transmit FIFO can hold two packets (1 KB for HS).
Page 2683: (ch_1)                 1                    3                   can hold 4 entries.
Page 2685: space is available in the transmit FIFO and the request queue. The application can
Page 2686: –    The receive FIFO can contain at least one maximum-packet-size packet and two
Page 2687: (ch_1)                  1                   3                   can hold 4 entries.
Page 2688: –    The periodic transmit FIFO can hold one packet (1 KB)
Page 2690: 1                                      can hold 4 entries.
Page 2693: –       The receive FIFO can hold at least one maximum-packet-size packet and two
Page 2695: 1                                         can hold 4 entries.
Page 2696: –    The periodic transmit FIFO can hold one packet (1 KB).
Page 2697: (ch_1)               1                                      can hold 4 entries.
Page 2699: –   The receive FIFO can hold at least one maximum-packet-size packet and two
Page 2700: (ch_1)                1                                      can hold 4 entries.
Page 2702: MPS                                can hold 4 entries.
Page 2702: application can utilize these interrupts, in which case the NAK or NYET interrupt is
Page 2704: can hold 4 entries.
Page 2705: 1                                       queue can hold
Page 2706: 1                                       queue can hold
Page 2707: 2                   queue can hold
Page 2708: 2                   queue can hold
Page 2713: 2.   The application can mask the RXFLVL interrupt (in OTG_GINTSTS) by writing to
Page 2713: due to RXFLVL in OTG_GINTSTS. Reading an empty receive FIFO can result in
Page 2715: interrupts the application with an STUP interrupt (OTG_DOEPINTx), indicating it can
Page 2716: specification does not limit the number of back-to-back SETUP packets a host can send to
Page 2716: 4.   Once the application detects this interrupt, it can assume that the core is in Global OUT
Page 2716: NAK mode. The application can clear this interrupt by clearing the SGONAK bit in
Page 2717: 3.   The application can receive valid OUT packets after it has set SGONAK in OTG_DCTL
Page 2717: 4.   The application can temporarily mask this interrupt by writing to the GONAKEFFM bit in
Page 2718: can be less than the programmed transfer size.
Page 2718: isochronous OUT data packets that the host, which cannot detect the ACK, re-
Page 2719: –    This step can be repeated many times, depending on the transfer size.
Page 2719: always be set to the number of maximum-packet-size packets that can be received in a
Page 2719: single frame and no more. Isochronous OUT data transfers cannot span more than 1
Page 2720: –    This step can be repeated many times, depending on the transfer size.
Page 2720: 5.   This interrupt cannot always be detected for isochronous OUT transfers. Instead, the
Page 2720: application can detect the INCOMPISOOUT interrupt in OTG_GINTSTS.
Page 2720: The application can discard invalid data packets.
Page 2720: –    When the receive FIFO cannot accommodate the complete ISO OUT data packet,
Page 2721: –   When all data are emptied from the receive FIFO, the application can detect the
Page 2721: –   Because the core can take some time to disable the endpoint, the application may
Page 2721: This section describes how the application can stall a non-isochronous endpoint.
Page 2723: 1.   The application can either choose the polling or the interrupt mode.
Page 2723: The application can write multiple packets for the same endpoint into the transmit FIFO, if
Page 2723: microframe. It can write packets for the next periodic transaction only after getting transfer
Page 2723: 4.   Once this interrupt is seen by the application, the application can assume that the
Page 2723: endpoint is in IN NAK mode. This interrupt can be cleared by the application by setting
Page 2723: 3.   The core can transmit valid IN data on the endpoint after the application has set the
Page 2723: 4.   The application can mask this interrupt temporarily by writing to the INEPNEM bit in
Page 2724: the application can re-enable the endpoint at a later point.
Page 2726: to determine whether there is enough space in the data FIFO. The application can
Page 2726: –    The application can only transmit multiples of maximum-packet-size data packets
Page 2726: –    The application cannot transmit a zero-length data packet at the end of a transfer.
Page 2726: It can transmit a single zero-length data packet by itself. To transmit a single zero-
Page 2726: 2.   The application can only schedule data transfers one frame at a time.
Page 2727: interrupt. If it is not enabled, enable the endpoint so that the data can be transmitted on
Page 2728: empty interrupt in OTG_DIEPINTx. The application can ignore this interrupt, as it
Page 2728: 1.   The application can ignore the IN token received when Tx FIFO empty interrupt in
Page 2728: This section describes how the application can stall a non-isochronous endpoint.
Page 2730: If the AHB is running at a higher frequency than the PHY, the application can use a smaller
Page 2731: VBUS power. A device must perform both data-line pulsing and VBUS pulsing, but a host can
Page 2732: OTG_HS controller can request a new session from the host.
Page 2733: time can be obtained from the transceiver vendor and varies from one transceiver to
Page 2737: IEEE 802.3 specifications and the reduced media independent interface (RMII). It can be
Page 2740: transfers are driven by software descriptors structure. The application can use a set of
Page 2740: intervention (each descriptor can transfer up to 32 Kbytes of data)
Page 2744: transfers such as packets in Ethernet. The controller can be programmed to interrupt the
Page 2744: in the physical memory address space of the application. Each descriptor can point to a
Page 2744: packet or part of a packet, but cannot exceed a single packet. Buffers contain only data. The
Page 2744: data buffers. However, a single descriptor cannot span multiple packets. The DMA skips to
Page 2744: arbitrations are supported and can be selected through DMA mode register
Page 2746: Transmit process can simultaneously acquire two packets without closing the Status
Page 2747: 8.   The DMA can exit Suspend mode and enter the Run state (it goes either to step 1 or to
Page 2751: received. The MTL also indicates the queue fill level so that the DMA can initiate
Page 2754: + FCS) are cut off at the RPE module. In addition, you can use a programmable
Page 2754: fixed timeout of 2,048 or 10,240 bytes. You can disable the watchdog timer by
Page 2756: the MAC can process up to two VLAN tags (inner and outer).
Page 2756: The inner or outer VLAN tag can be of C-VLAN and S-VLAN type. The VLAN
Page 2757: VLAN tag deletion can be enabled for outer or inner tag through VLC field in
Page 2757: VLAN tag insertion or replacement can be enabled for outer or inner tag
Page 2757: Outer or inner VLAN tag- The MAC can filter packets based on the outer or inner VLAN tag
Page 2757: C-VLAN or S-VLAN tag-    The MAC can filter packets based on the C-VLAN or S-VLAN type
Page 2757: Outer and Inner VLAN Tag The MAC can strip the outer and inner VLAN Tags from received frame
Page 2757: The MAC can provide the 16-bit outer and inner VLAN Tag and Type in
Page 2757: The MAC can disable or skip checking of outer VLAN Tag type to
Page 2757: The software can use the SA (source address) insertion or replacement feature to instruct
Page 2758: SA insertion or replacement feature can be enabled for all Transmit packets or selective
Page 2758: insertion or replacement whatever of the value of the most-significant bit of the SA Insertion
Page 2758: The software can use the VLAN insertion, replacement, or deletion feature to instruct the
Page 2759: You can enable the VLAN insertion, replacement, or deletion feature for all Tx packets or
Page 2759: The three filter types can be cascaded. Figure 781 shows the filtering sequence for Rx
Page 2760: The MacAddr1 to MacAddr3 addresses are selected with an individual enable bit. You can
Page 2761: The MAC can perform perfect filtering based on the source address field of received pack-
Page 2761: ters. You can configure the MAC Address registers to use SA instead of DA for comparison
Page 2761: The MAC also supports group filtering with SA. You can filter a group of addresses by mask-
Page 2761: For DA and SA filtering, you can invert the filter-match result at the final output by setting the
Page 2763: with VLAN tag match status and drops the VLAN packets that do not match. You can also
Page 2763: (ETH_MACVTR). In addition, you can enable matching of S-VLAN tagged packets along
Page 2763: VTHM bit is set, the most significant four bits of CRC-32 of VLAN tag are used to index the
Page 2763: When ETV bit is reset, most significant four bits of CRC-32 of VLAN Tag are inverted and
Page 2763: When ETV bit is set, most significant four bits of CRC-32 of VLAN Tag are directly used to
Page 2764: status is Fail. In Table 509, value X means that this column can have any value.
Page 2765: The MAC drops the packets that do not match any of the enabled fields. You can use
Page 2765: filters. You can optionally program the MAC to drop all non-TCP or UDP over IP
Page 2766: Destination Address. In addition, you can match the complete IP address or mask the lower
Page 2766: For IPv6 packets filtering, you can enable the last four data registers of a register set to
Page 2766: For IPv4 packet filtering, you can enable the second and third data registers of a register set
Page 2766: Destination Port numbers. However, you can program only one type (TCP or UDP) at a
Page 2769: In telecom applications, the ordinary clock can be associated with a timing demarcation
Page 2769: The ordinary clock can be a grandmaster or a slave clock. It supports the following
Page 2769: –   Transmission and reception of PTP messages. The timestamp snapshot can be
Page 2769: The table below shows the messages for which you can take the timestamp snapshot
Page 2769: For an ordinary clock, you can take the snapshot of either of the following PTP
Page 2769: message types: version 1 or version 2. You cannot take the snapshots for both PTP
Page 2769: message types. You can take the snapshot by setting the TSVER2ENA bit and
Page 2770: (ETH_MACTSCR). You can take the snapshot by setting the SNAPTYPSEL bits to 10
Page 2770: in the Timestamp control Register (ETH_MACTSCR). You can take the snapshot by
Page 2771: You can take the snapshot by setting the SNAPTYPESEL bit to 11 in Timestamp
Page 2771: You can set these modes through TSCTRLSSR bit in Timestamp control Register
Page 2772: In this mode, only frequency of the PPS output can be changed by setting the
Page 2772: MAC also sets the Target Time Reached interrupt event. The application can cancel the
Page 2772: has elapsed, the cancel command has no effect.
Page 2772: You can configure up to four auxiliary snapshot inputs and store up to 4 snapshots. A FIFO
Page 2772: application can read the Timestamp status register (ETH_MACTSSR) to know the
Page 2772: to store the next snapshot. You can clear a FIFO by setting the ATSFC bit in Auxiliary
Page 2773: transmitted or received at the MII. The System Time counter can be initialized or corrected
Page 2774: occurs. The slave clock can then determine a precise MasterToSlaveDelay value and re-
Page 2775: on the MII interface. The packets, for which you want to capture timestamps, can be
Page 2775: controlled on per-packet basis. Each Transmit packet can be marked to indicate whether a
Page 2775: specify the packets for which you want to capture timestamps. You can specify the packets
Page 2775: field holds the 32 least significant bits of the timestamp.
Page 2775: The MAC can be programmed to capture the timestamp of all packets received on the MII
Page 2775: interface or to process packets to identify the valid PTP messages. You can control the
Page 2775: least significant bits of the timestamp.
Page 2776: Egress correction register. The egress correction can be positive or negative. It is
Page 2777: You can enable the one-step timestamp feature for a packet by setting bit 20 (OSTC) in ATI
Page 2777: when the MAC operates as a specific node in the PTP network. These packets can be gen-
Page 2777: erated periodically or triggered by the host software. In other modes, this feature can parse
Page 2780: TCP header in TDES3[22:19]. The maximum length of TCP packet payload that can be seg-
Page 2780: The TCP payload can begin from buffer 2 of the first normal descriptor and continue to buf-
Page 2782: pointing. Buffer 2 of the first descriptor can be used for payload and TDES0 and TDES1 of
Page 2782: The context descriptor can provide the maximum segment size (MSS) value for
Page 2783: The application can read the interrupt status through CDE bit of Status register
Page 2783: Loopback function is disabled, but it can be enabled by programming the LM bit of the Oper-
Page 2783: application can request the MAC to send a Pause packet or initiate backpressure by using
Page 2785: You can enable the Pause flow control by setting the RFE bit in the Rx flow control register
Page 2785: engine can be controlled for each packet by setting the CIC bits (TDES3 bits[17:16]).
Page 2786: corresponding field in the header. The Tx COE can work in the following two modes:
Page 2788: You can enable the Receive Checksum Offload Engine (Rx COE) by selecting the Enable
Page 2790: The counters in the MAC Management Counters (MMC) module can be viewed as an
Page 2790: Interrupts can be generated from the MAC as a result of various events. These interrupt
Page 2790: The Interrupt status register (ETH_MACISR) describes the events that can cause an
Page 2790: interrupt from the MAC. The MAC interrupts are enabled by default. Each event can be
Page 2791: The application can access the PHY registers through the station management agent (SMA)
Page 2791: The SMA module supports accessing up to 32 PHYs. The application can address one of
Page 2791: the 32 registers from any 32 PHYs. Only one register in one PHY can be addressed at a
Page 2795: significant bit, TXD[3] is the most significant bit. While TX_EN is deasserted the
Page 2795: data) on the assertion of the RX_DV signal. RXD[0] is the least significant bit, RXD[3] is
Page 2795: the most significant bit. While RX_EN is deasserted and RX_ER is asserted, a specific
Page 2799: The EEE specifies the negotiation methods that the link partners can use to determine
Page 2799: The MAC cannot start the transmission until the wakeup time specified for the PHY
Page 2799: The MAC transmitter can be programmed to enter/exit LPI mode automatically based on
Page 2800: When both LPIATE and LPITXA bits are cleared, you can directly control the entry and exit
Page 2800: The LPI interrupt can be cleared by reading the LPI control status register
Page 2800: packet (remote wakeup packet and magic packet) can be selected. RWKPKTEN and MGK-
Page 2800: PKTEN bits of the PMT control status register (ETH_MACPCSR) can be set to generate
Page 2801: the PMT block again scans the 48’hFF_FF_FF_FF_FF_FF pattern in the incoming packet.
Page 2801: The 16 repetitions can be anywhere in the packet, but must be preceded by the synchroni-
Page 2801: zation stream (48’hFF_FF_FF_FF_FF_FF). The device can also accept a multicast packet,
Page 2801: If the MAC address of a node is 48'h00_11_22_33_44_55, the MAC scans for the following
Page 2802: These transmissions can be detected when Transmit Interrupt (bit 0 of the
Page 2802: memory. This can be done by reading the corresponding Debug register bits in the
Page 2803: The Ethernet peripheral generates a single interrupt signal (eth_sbd_intr_it). This signal can
Page 2803: generated only once for multiple events. The driver must scan the Interrupt status register
Page 2805: The MTL interrupts are enabled by default. Each event can be prevented from asserting the
Page 2805: The Interrupt status register (ETH_MACISR) describes the events that can cause an
Page 2805: interrupt from the MAC. The MAC interrupts are enabled by default. Each event can be
Page 2807: The following MAC Initialization operations can be performed after DMA initialization. If the
Page 2808: goes into Suspend state. The transmission or reception can be resumed by freeing the
Page 2808: pointer can be read in ETH_DMACCATXDR and ETH_DMACCARXDR registers (see
Page 2808: receive buffer address pointer can be read in ETH_DMACCATXDR and
Page 2809: 2.   Wait for any previous frame transmissions to complete. You can check this by reading
Page 2809: 3.   Wait for any previous frame transmissions to complete. You can check this by reading
Page 2810: Transmit/Receive clock is stopped. This can be checked by reading the Debug register
Page 2810: The timestamp feature can be enabled by setting bit 0 of the Timestamp control Register
Page 2811: active. This can be done by enabling the Timestamp Trigger interrupt after the system
Page 2812: When the PPSCMD is executed (PPSCMD bits = 0), you can cancel the pulse generation by
Page 2812: giving the Cancel Start Command (PPSCMD=0011) before the programmed start time has
Page 2812: elapsed. You can also program the behavior of the next pulse in advance. To program the
Page 2813: The pulse train can be stopped at any time by programming 0101 in the PPSCMD field.
Page 2813: Similarly, the Stop Pulse train command (given in Step 5) can be canceled by programming
Page 2813: The pulse train generation can be stopped by programming PPSCMD to 0011 before the
Page 2815: There is no limit to the number of descriptors that can be used for a single packet.
Page 2816: current descriptor that the DMA can process. The descriptors up to one location less than
Page 2817: features control fields which can be used to manage the MAC operation on per-transmit
Page 2820: These bits control the checksum calculation and insertion. They can take
Page 2822: The DMA updates this field with least significant 32 bits of the timestamp captured
Page 2822: The DMA updates this field with the most significant 32 bits of the timestamp
Page 2823: payload. This failure can be either caused by insufficient bytes, as
Page 2824: arrived late from the system memory. The underflow error can occur
Page 2825: The Transmit context descriptor can be provided any time before a packet descriptor. The
Page 2825: the last valid VLAN tag to the MTL. The application cannot invalidate the valid VLAN tag
Page 2826: For one-step correction, the driver can provide the lower 32 bits of timestamp in
Page 2826: For one-step correction, the driver can provide the upper 32 bits of timestamp in
Page 2829: ring with a length that can accommodate at least two complete packets received by the
Page 2830: The application can program a byte-aligned address for this buffer, which
Page 2830: means that the LS bits of this field can be non-zero. However, while
Page 2831: 25     BUF2V      RDES0 is valid. The application must set this bit so that the DMA can use the
Page 2831: points in RDES1, can be used by the DMA to write received packet data.
Page 2839: This descriptor is read-only for the application. This descriptor can be written only by the
Page 2839: 31:0    RTSL The DMA updates this field with least significant 32 bits of the timestamp captured
Page 2840: 31:0   RTSH The DMA updates this field with most significant 32 bits of the timestamp captured
Page 2847: bus. You can program PBL with any of the following values: 1, 2, 4, 8, 16, or 32. Any other
Page 2848: bus. You can program PBL with any of the following values: 1, 2, 4, 8, 16, or 32. Any other
Page 2850: You can write to this register only when the Tx DMA has stopped, that is, the ST bit is set to
Page 2850: zero in ETH_DMACiTXCR register. When stopped, this register can be written with a new
Page 2851: be written to before the receive Start command is given. You can write to this register only
Page 2851: When stopped, this register can be written with a new descriptor list address.
Page 2862: DMA cannot acquire it. The Rx process is suspended. To resume processing Rx descriptors,
Page 2862: DMA cannot acquire it. Transmission is suspended. The TPS0 field of the
Page 2871: When high, this bit indicates that the MTL Tx Status FIFO is full. Therefore, the MTL cannot
Page 2880: When this bit is set, the MAC can recognize an incoming ARP request packet and schedules
Page 2880: field when a packet is being transmitted, only the subsequent packet can use the
Page 2881: In the half-duplex mode, the minimum IPG can be configured only for 64-bit times (IPG =
Page 2882: When this bit is set, the MAC disables the watchdog timer on the receiver. The MAC can
Page 2882: When this bit is set, the MAC disables the jabber timer on the transmitter. The MAC can
Page 2882: When this bit is set, the MAC operates in the full-duplex mode in which it can transmit and
Page 2883: MAC can even abort the transmission.
Page 2886: The value in this field is applicable when the EIPGEN bit is set. This field (as Most Significant
Page 2891: content of the Hash table. The most significant bits determines the register to be used (Hash
Page 2892: content of the Hash table. The most significant bits determines the register to be used (Hash
Page 2893: When this bit is set, the most significant four bits of CRC of VLAN Tag are used to index the
Page 2894: Bit 12: Canonical Format Indicator (CFI) or Drop Eligible Indicator (DEI)
Page 2896: field when a packet is being transmitted, only the subsequent packet can use the
Page 2896: Bit 12: Canonical Format Indicator (CFI) or Drop Eligible Indicator (DEI)
Page 2898: field when a packet is being transmitted, only the subsequent packet can use the
Page 2898: Bit 12: Canonical Format Indicator (CFI) or Drop Eligible Indicator (DEI)
Page 2900: 802.3. When this bit is set, the MAC can also detect Pause packets with unicast address of
Page 2905: The application can also clear this bit before the expected wakeup frame is received. In such
Page 2906: down mode is disabled. The software can clear this bit before the expected magic packet or
Page 2906: Note: You can gate-off the CSR clock during the power-down mode. However, when the CSR
Page 2906: clock is gated-off, you cannot perform any read or write operations on this register.
Page 2906: Therefore, the Software cannot clear this bit.
Page 2911: should be up (OKAY) before the LPI pattern can be transmitted to the PHY. The MAC does
Page 2914: Ethernet peripheral. The software driver can use this register to dynamically enable or
Page 2917: Ethernet peripheral. The software driver can use this register to dynamically enable or
Page 2919: are transmitted). The software can thus initiate the next command which will be executed
Page 2919: of transmission of MDIO frame. The valid values can be from 0 to 7. Programming the value
Page 2920: When Bit 11 is set, you can achieve a higher frequency of the MDC clock than the frequency
Page 2924: You can filter a group of addresses (known as group address filtering) by masking one or
Page 2926: The counters are cleared when the least significant byte lane (Bits[7:0]) is read.
Page 2926: when the respective MMC counter that caused the interrupt is read. The least significant
Page 2927: The least significant byte lane (Bits[7:0]) of the respective counter must be read to clear the
Page 2933: and Exit, the Timer value can have an error of +/- 1 microsecond.
Page 2934: and Exit, the Timer value can have an error of +/- 1 microsecond.
Page 2936: either IPv6 DA or SA can be checked for filtering.
Page 2937: either IPv6 SA or DA can be checked for filtering.
Page 2941: either IPv6 DA or SA can be checked for filtering.
Page 2942: either IPv6 SA or DA can be checked for filtering.
Page 2942: You can configure the Layer 3 and Layer 4 Address Registers to be double-synchronized by
Page 2947: complete. The Timestamp Higher Word register (if enabled during core configuration) can
Page 2953: The software can read this register to find the triggers that are set when the timestamp is
Page 2956: You can store multiple snapshots in this FIFO. Bits[29:25] in ETH_MACTSSR indicate the
Page 2957: The value can also be negative, which is represented in 2's complement form with bit 31
Page 2963: 0011: Cancel START
Page 2963: This command cancels the START Single Pulse and START Pulse Train commands if the
Page 2963: 0110: Cancel STOP Pulse train
Page 2963: This command cancels the STOP pulse train at time command if the programmed stop time
Page 2979: isolate the CEC pin from the bus in such conditions. This can be done by using a MOS
Page 2980: All these blocks are made of a 8-bit payload - most significant bit is transmitted first -
Page 2980: The acknowledge bit is always set to high impedance by the initiator so that it can be driven
Page 2983: can start.
Page 2984: Three kinds of error flag can be detected when the CEC interface is receiving a data bit:
Page 2984: In the case of a BRE detection, the message reception can be stopped according to the
Page 2984: BRESTP bit value and an error bit can be generated if BREGEN bit is set.
Page 2984: can be disabled by configuring BREGEN=0, BRDNOGEN=1.
Page 2984: LBPEGEN=0 to enforce initiator’s retry of the failed transmission. Error bit generation can
Page 2988: An interrupt can be produced:
Page 2990: TXSOM can be also used as a status bit informing application whether any transmission request is
Page 2990: pending or under execution. The application can abort a transmission request at any time by
Page 2994: arbitration lost event following the TXSOM command. ARBLST can be due either to a contending
Page 2998: The debug features can be controlled via a JTAG/Serial-wire debug access port, using
Page 2998: detection and program counter sampling. Single-wire trace can be maintained even
Page 2998: The processor can be debugged using equipment connected to the JTAG/SWD debug
Page 2998: Instead of streaming it off-chip, the combined trace information can be stored on-chip in
Page 2998: a circular buffer. The trace storage can be started and stopped by a debugger
Page 2998: The stored trace can be dumped off-chip to the trace port analyzer. The buffer draining
Page 2998: can be initiated by the debugger, software, external trigger, internal event etc.
Page 2998: The debugger can read the contents of the trace buffer via the debug port. This is
Page 2998: The trace buffer can be read by the processor core, or transferred into system memory
Page 2998: The stored trace can also be uploaded to a host machine using one of the MCU’s many
Page 2998: communications interfaces (USB, USART, SPI, I2C, Ethernet, CAN etc). This is
Page 3000: 1. TRGIO can be configured as an input or an output by the TRGOEN bit in the DBGMCU. If configured as an
Page 3002: All the debug clocks (except DAPCLK) can be enabled and disabled by register bits in the
Page 3003: can access any of the debug features on the device. It should be disabled at power up and
Page 3003: The port can be configured as:
Page 3003: A debugger can select the SW-DP by transmitting the following serial data sequence on
Page 3003: In SW-DP mode, the unused JTAG lines JTDI, JTDO and nJTRST can be used for other
Page 3004: All SWJ port IOs can be reconfigured to other functions by software, in which case
Page 3005: cancelled, unless overrun detection is enabled, in which case the data will be ignored by the
Page 3006: Idle                                  Scan                                  Scan           JTMS=1
Page 3006: state machine is shown in Figure 819. It controls two scan chains, one associated with an
Page 3006: instruction register (IR) scan chain. The IR scan chain is connected between JTDI and
Page 3006: While the TAPSM is in the Shift-IR state, the IR scan chain shifts one bit for each rising edge
Page 3006: •     The LSB of the IR scan chain is output on JTDO.
Page 3006: •     Bit [n] of the IR scan chain is transferred to bit [n-1].
Page 3006: •     The value on JTDI is transferred to the MSB of the IR scan chain.
Page 3006: When the TAPSM goes through the Update-IR state, the value scanned into the IR scan
Page 3006: data registers onto one of the DR scan chains, connected between JTDI and JTDO.
Page 3007: scan chain, is selected.
Page 3007: When the TAPSM goes through the Update-DR state, the value scanned into the DR scan
Page 3007: Scan
Page 3008: Scan
Page 3008: The debugger can access the DP registers as follows:
Page 3018: The debugger can access the AP registers as follows:
Page 3018: The debugger can access the memory mapped debug component registers through the
Page 3020: This bit determines whether the debugger can access secure memory. This field is reserved
Page 3021: This bit defines whether the AP can be accessed or not.
Page 3031: trace analyzer to recover the chronological order of trace packets, which can be lost when
Page 3031: and interpolated to increase its resolution if the processor clock is significantly faster than
Page 3039: example, a transition detected on an external trigger input can start code trace.
Page 3039: Each CTI has up to 8 trigger inputs and 8 trigger outputs. Any input can be connected to any
Page 3041: An input can be connected to more than one channel (up to four), so an input can be routed
Page 3041: to several outputs. Similarly, an output can be connected to several inputs. It is also possible
Page 3048: For each channel, defines whether an event on that channel can propagate over the CTM to
Page 3058: settings to be configured. The priorities can be modified only when trace is disabled. The
Page 3058: buffering, or where data loss can not be tolerated. Low priority should be assigned to less
Page 3068: The ETF can be used in three modes (selected in the mode register):
Page 3068: the trace port. Since the trace data can be very bursty in nature, the peak data rate can
Page 3068: rate at the trace port, which can then be sized according to the average rate rather than
Page 3069: the trace log can be very big.
Page 3069: The trace memory is used as a FIFO that can be read through the RRD Register while
Page 3069: over the Trace port. This can be done by setting the DRAINBUF bit in the
Page 3069: –    via the Debug port - the debugger can read the buffer via the RRD register that is
Page 3069: –    by software - the processor can read the buffer via the RRD register, since the
Page 3069: The ETF can transition between the following states:
Page 3069: Trace capture is stopped in this state, but the contents of the buffer can be read out or
Page 3072: can be programmed with a byte address, 64-bit aligned (that is, bits 0 to 3 should be zero).
Page 3072: This register can only be written in Disabled state. It can be read in Disabled state, in
Page 3073: can be programmed with a byte address, 64-bit aligned (that is, bits 0 to 3 should be zero).
Page 3073: This register can only be written in Disabled state. It can be read in Disabled state, in
Page 3075: In this mode, the trace memory is used as a FIFO that can be read through the RRD Register
Page 3077: The value programmed into this register indicates the required threshold vacancy level in 32-
Page 3077: mode, this functionality can be obtained by programming the RWP to the required vacancy
Page 3077: vacancy level has fallen below the required level.
Page 3077: The maximum value that can be written into this register is MEM_SIZE - 1. In this case, the
Page 3078: the AFVALIDS output. A flush can be initiated by the flush control bits in the ETF_FFCR
Page 3080: TRGONTRGEV, and TRGONTRGIN in the FFCR Register. This bit can only be changed
Page 3084: 0x3: Captures trace data from the ATB slave interface into RAM that can be drained through
Page 3084: data can be drained out in Hardware FIFO mode.
Page 3090: hence the quantity of trace information that can be output in real time. The TRACECK
Page 3090: before trace is sent to the TPIU. Furthermore, the TRACECK frequency can be
Page 3091: the range of supported port sizes (1-4). Only one bit can be set, or unpredictable behavior
Page 3096: the AFVALIDS output. A flush can be initiated by the flush control bits in the TPIU_FFCR
Page 3110: The bit always returns 0 as the SWO formatter cannot be stopped in this device.
Page 3131: •          stop the clock to certain peripherals (CAN, SMBUS timeout, Watchdogs, Timers, RTC)
Page 3151: The DWT provides four comparators that can be used as:
Page 3152: For address matching, the comparator can use a mask, so it matches a range of addresses.
Page 3157: matching by comparator n. A debugger can write 0b11111 to this field and then read the
Page 3158: When the DATAVMATCH and LNK1ENA bits are both 1, this field can hold the comparator
Page 3158: When the DATAVMATCH and LNK1ENA bits are both 1, this field can hold the comparator
Page 3164: The ITM generates trace information as packets. There are four sources that can generate
Page 3164: Software can write directly to any of 32 x 32-bit ITM stimulus registers to generate
Page 3164: packets. The permission level for each port can be programmed. When software writes
Page 3165: Timestamps can also be generated using the system-wide 64-bit count value coming
Page 3165: 1: Stimulus port can accept new write data
Page 3182: Indicates whether the ETM registers are stable and can be read.
Page 3195: 0x0: Only one processor can be traced
Page 3199: 1: Reset enabled; multiple matches can occur
Page 3214: The electronic signature is stored in the Flash memory area. It can be read using the
Page 3214: device and in any context. These bits can never be altered by the user.
Page 3214: The 96-bit unique device identifier can also be read in single bytes/half-words/words in
Page 3222: Section 56: FD Controller Area Network (FDCAN)
Page 3222: Added F0OM bit (bit 31) and F1OM bit (bit 31) in FDCAN Rx FIFO 0
Page 3222: Configuration Register (FDCAN_RXF0C) and FDCAN Rx FIFO 1
Page 3222: Configuration Register (FDCAN_RXF1C), respectively.
Page 3232: Section 55: FD controller area network (FDCAN)
Page 3232: Changed fdcan_ker_ck max value from 500 MHz to 100 MHz.
Page 3238: F                                                                  FDCAN_TTTMC . . . . . . . . . . . . . . . . . . . . . 2530
Page 3238: FDCAN_TTTMK . . . . . . . . . . . . . . . . . . . . . 2538
Page 3238: FCCAN_CCU_CCFG . . . . . . . . . . . . . . . . . .2556
Page 3238: FDCAN_TTTS . . . . . . . . . . . . . . . . . . . . . . . 2549
Page 3238: FCCAN_CCU_CREL . . . . . . . . . . . . . . . . . .2556
Page 3238: FDCAN_TURCF . . . . . . . . . . . . . . . . . . . . . 2534
Page 3238: FCCAN_CCU_CSTAT . . . . . . . . . . . . . . . . .2558
Page 3238: FDCAN_TURNA . . . . . . . . . . . . . . . . . . . . . 2546
Page 3238: FCCAN_CCU_CWD . . . . . . . . . . . . . . . . . .2558
Page 3238: FDCAN_TXBAR . . . . . . . . . . . . . . . . . . . . . 2526
Page 3238: FCCAN_CCU_IE . . . . . . . . . . . . . . . . . . . . .2560
Page 3238: FDCAN_TXBC . . . . . . . . . . . . . . . . . . . . . . 2522
Page 3238: FCCAN_CCU_IR . . . . . . . . . . . . . . . . . . . . .2559
Page 3238: FDCAN_TXBCF . . . . . . . . . . . . . . . . . . . . . 2527
Page 3238: FDCAN_ TXBCIE . . . . . . . . . . . . . . . . . . . . .2528
Page 3238: FDCAN_TXBCR . . . . . . . . . . . . . . . . . . . . . 2526
Page 3238: FDCAN_CCCR . . . . . . . . . . . . . . . . . . . . . .2495
Page 3238: FDCAN_TXBRP . . . . . . . . . . . . . . . . . . . . . 2525
Page 3238: FDCAN_CREL . . . . . . . . . . . . . . . . . . . . . . .2492
Page 3238: FDCAN_TXBTIE . . . . . . . . . . . . . . . . . . . . . 2527
Page 3238: FDCAN_DBTP . . . . . . . . . . . . . . . . . . . . . . .2492
Page 3238: FDCAN_TXBTO . . . . . . . . . . . . . . . . . . . . . 2527
Page 3238: FDCAN_ECR . . . . . . . . . . . . . . . . . . . . . . . .2500
Page 3238: FDCAN_TXEFA . . . . . . . . . . . . . . . . . . . . . 2530
Page 3238: FDCAN_ENDN . . . . . . . . . . . . . . . . . . . . . . .2492
Page 3238: FDCAN_TXEFC . . . . . . . . . . . . . . . . . . . . . 2528
Page 3238: FDCAN_GFC . . . . . . . . . . . . . . . . . . . . . . . .2512
Page 3238: FDCAN_TXEFS . . . . . . . . . . . . . . . . . . . . . 2529
Page 3238: FDCAN_HPMS . . . . . . . . . . . . . . . . . . . . . .2515
Page 3238: FDCAN_TXESC . . . . . . . . . . . . . . . . . . . . . 2524
Page 3238: FDCAN_IE . . . . . . . . . . . . . . . . . . . . . . . . . .2507
Page 3238: FDCAN_TXFQS . . . . . . . . . . . . . . . . . . . . . 2523
Page 3238: FDCAN_ILE . . . . . . . . . . . . . . . . . . . . . . . . .2511
Page 3238: FDCAN_XIDAM . . . . . . . . . . . . . . . . . . . . . . 2514
Page 3238: FDCAN_ILS . . . . . . . . . . . . . . . . . . . . . . . . .2510
Page 3238: FDCAN_XIDFC . . . . . . . . . . . . . . . . . . . . . . 2513
Page 3238: FDCAN_IR . . . . . . . . . . . . . . . . . . . . . . . . . .2504
Page 3238: FDCAN_NBTP . . . . . . . . . . . . . . . . . . . . . . .2497
Page 3238: FDCAN_NDAT1 . . . . . . . . . . . . . . . . . . . . . .2515
Page 3238: FDCAN_NDAT2 . . . . . . . . . . . . . . . . . . . . . .2516
Page 3238: FDCAN_PSR . . . . . . . . . . . . . . . . . . . . . . . .2501
Page 3238: FDCAN_RWD . . . . . . . . . . . . . . . . . . . . . . .2494
Page 3238: FDCAN_RXBC . . . . . . . . . . . . . . . . . . . . . . .2518
Page 3238: FDCAN_RXESC . . . . . . . . . . . . . . . . . . . . .2521
Page 3238: FDCAN_RXF0A . . . . . . . . . . . . . . . . . . . . . .2518
Page 3238: FDCAN_RXF0C . . . . . . . . . . . . . . . . . . . . . .2516
Page 3238: FDCAN_RXF0S . . . . . . . . . . . . . . . . . . . . . .2517
Page 3238: FDCAN_RXF1A . . . . . . . . . . . . . . . . . . . . . .2521
Page 3238: FDCAN_RXF1C . . . . . . . . . . . . . . . . . . . . . .2519
Page 3238: FDCAN_RXF1S . . . . . . . . . . . . . . . . . . . . . .2520
Page 3238: FDCAN_SIDFC . . . . . . . . . . . . . . . . . . . . . .2513
Page 3238: FDCAN_TDCR . . . . . . . . . . . . . . . . . . . . . . .2504
Page 3238: FDCAN_TEST . . . . . . . . . . . . . . . . . . . . . . .2493
Page 3238: FDCAN_TOCC . . . . . . . . . . . . . . . . . . . . . . .2499
Page 3238: FDCAN_TOCV . . . . . . . . . . . . . . . . . . . . . . .2500
Page 3238: FDCAN_TSCC . . . . . . . . . . . . . . . . . . . . . . .2498
Page 3238: FDCAN_TSCV . . . . . . . . . . . . . . . . . . . . . . .2498
Page 3238: FDCAN_TTCPT . . . . . . . . . . . . . . . . . . . . . .2548
Page 3238: FDCAN_TTCSM . . . . . . . . . . . . . . . . . . . . .2548
Page 3238: FDCAN_TTCTC . . . . . . . . . . . . . . . . . . . . . .2547
Page 3238: FDCAN_TTGTP . . . . . . . . . . . . . . . . . . . . . .2537
Page 3238: FDCAN_TTIE . . . . . . . . . . . . . . . . . . . . . . . .2541
Page 3238: FDCAN_TTILS . . . . . . . . . . . . . . . . . . . . . . .2543
Page 3238: FDCAN_TTIR . . . . . . . . . . . . . . . . . . . . . . . .2539
Page 3238: FDCAN_TTLGT . . . . . . . . . . . . . . . . . . . . . .2547
Page 3238: FDCAN_TTMLM . . . . . . . . . . . . . . . . . . . . .2533
Page 3238: FDCAN_TTOCF . . . . . . . . . . . . . . . . . . . . . .2532
Page 3238: FDCAN_TTOCN . . . . . . . . . . . . . . . . . . . . .2536
Page 3238: FDCAN_TTOST . . . . . . . . . . . . . . . . . . . . . .2544
Page 3238: FDCAN_TTRMC . . . . . . . . . . . . . . . . . . . . .2531
